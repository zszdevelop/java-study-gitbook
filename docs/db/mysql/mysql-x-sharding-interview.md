---
order: 312
category:
  - Mysql
  - 数据库

---



# MySQL - 分表分库（面试场景切入）

![image-20221015102643032](https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221015102643032.png)

## 1. 为什么要进行分库分表？

**面试官**：小伙子，看到你的简历上面写了项目中有对MySQL进行分库分表，为什么要进行分库分表？

**我**：当MySQL单表数据量过大，比如超过5千万条的时候，读写性能变得很差。而且常规的优化手段已经不起作用了，比如：SQL调优、添加索引、主从复制、读写分离。这时候就需要用到MySQL终极优化方案 — 分库分表。

## 2. 怎么判断项目是需要分库还是要分表？

**面试官**：不错，我该怎么判断项目是需要分库还是要分表？是先分库还是先分表？

**我**：

1. 当数据库的QPS过高，数据库连接数不足的时候，就需要分库。
2. 当单表数据量过大，读写性能较差，就需要分表。
3. 当两者都有的时候，就需要分库分表。

至于先分库还是先分表？建议先分表，如果分表能解决问题，就不需要分库了，毕竟需要单独服务器资源，成本更高。

## 3. 分库分表有哪些拆分方案？

**面试官**：小伙子，总结的挺全。分库分表有哪些拆分方案呢？

**我**：分库分表有垂直拆分和水平拆分。垂直拆分又有垂直分库、垂直分表。

1. 垂直分库，不同的业务拆分到不同的数据库。
2. 垂直分表，把长度较大或者访问频次较低的字段，拆分到扩展表中。
3. 水平分表，单表数据量过大时，按照订单ID拆分到多张表中。

![image-20221015101757167](https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221015101757167.png)

![image-20221015101814377](https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221015101814377.png)

## 4. 分库分表缺点？

**面试官**：小伙子，有点东西。都知道分库分表好使，就没有什么缺点吗？

**我**：分库分表带来了低耦合、高性能的优点，可是缺点却是一大堆。

**垂直分库**：
不同库多表之间无法join关联查询，只能通过接口聚合，复杂度直线上升。 横跨多个数据库导致无法使用本地事务，数据强一致性就别想了，只能引入更为复杂的分布式事务，勉强实现数据的最终一致性，可用性直线下降。

**垂直分表**：
本来一张表能查出来的数据，现在需要多张表join关联查询，这不瞎耽误事。

**水平分表**：
多张表关联查询时，无法实现分页、排序功能。

## 5. 分库分表问题如何解决？

**面试官**：分库分表带来这么多问题，你没有没考虑过相应的解决方案？

> 我怎么可能没有解决方案，难道我提出问题给自己挖坑？

**我**：当然有考虑过，“有问题就会有答案”。

### 5.1 **跨库查询问题：**

采用**字段冗余**方案，比如订单表存储店铺ID、店铺名称，就不需要再查询商户数据库了。 不过这种方案要求冗余字段要很少变动，就算变动后，也能容忍返回旧数据。

### 5.2 **多表分页查询问题：**

这个处理起来就很需要技术含量了。 比如：订单表按照订单ID分片，(order_id % 128)，分成了128张表。 Leader看了说：每张表的数据量差不多，分的很均匀，以后不要再分了。

同一个用户的订单散落在不同的表，用户想查询自己的订单，根本无法做到分页查询。难道一次全部查询该用户的所有订单，然后做内存分页，多大的机器内存都让你搞挂。
想要实现用户订单分页查询，可以采用按照用户ID分片，(user_id % 128)，这样同一个用户的订单只会存储在一张表中，咋分页展示都行。

> **没有完美的分片方案，如果商户想要分页查看自己店铺的订单怎么办？**
> 那就把订单再冗余存储一份，按照店铺ID分片，(shop_id % 128)。不过由于商户数量较少，可以搞个异步线程往商户订单分片表同步。
>
> 
>
> **订单按照用户ID分片后，发生数据倾斜怎么办？**
> 因为不同用户的订单量是不同的，一个爱好购物的小姐姐的订单量抵得上几十个老爷们。导致一张表数据几百条，另一张表数据量千万级，这该咋整？
> 做冷热数据分离，基础库只存储3个月内的订单，其他的移动到历史订单库。这个要跟产品商量好，3个月前的订单需要单独的查询页面。

### 5.3 **跨库事务问题：**

这个问题就更复杂了。

![image-20221015102445584](https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221015102445584.png)

下一个订单需要调用多个服务，只能使用分布式事务。 分布式事务的实现非常复杂，常用的有以下几种解决方案：

> - 二阶段提交
>
> - TCC
>
> - 本地消息表
>
> - MQ事务消息
>
> - 分布式事务中间件

## 6. 总结

![image-20221015102643032](https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221015102643032.png)

## 参考文章

[面试官竟然问我怎么分库分表？幸亏我总结了一套八股文](https://zhuanlan.zhihu.com/p/455694017)