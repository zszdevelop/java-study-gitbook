# Jså¼‚æ­¥è§£å†³æ–¹æ¡ˆ-Generator(äº”)

## 1. ç®€ä»‹

Generatoræ˜¯åç¨‹åœ¨ES6çš„å®ç°ï¼Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒ

æˆ‘ä»¬å¯ä»¥é€šè¿‡ yield å…³é”®å­—ï¼ŒæŠŠå‡½æ•°çš„æ‰§è¡ŒæµæŒ‚èµ·ï¼Œä¸ºæ”¹å˜æ‰§è¡Œæµç¨‹æä¾›äº†å¯èƒ½ï¼Œä»è€Œä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›è§£å†³æ–¹æ¡ˆ

Generatorçš„è‹±æ–‡æ˜¯ç”Ÿæˆå™¨

æƒ³è¦äº†è§£ç”Ÿæˆå™¨(Generator)ï¼Œè¿˜æ˜¯ç»•ä¸è¿‡è¿­ä»£å™¨(Iterator)è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•ä»‹ç»ä¸‹

## 2. è¿­ä»£å™¨(Iterator)

### 2.1 Iteratorç®€ä»‹

è¿­ä»£å™¨æ˜¯ä¸€ç§æ¥å£ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§è§„èŒƒ

jsä¸­ä¸åŒçš„æ•°æ®ç±»å‹å¦‚(Array/Object/Set)ç­‰ç­‰éå†æ–¹å¼éƒ½å„æœ‰ä¸åŒï¼Œæ¯”å¦‚å¯¹è±¡éå†æˆ‘ä»¬ä¼šä½¿ç”¨`for..in..`ï¼Œæ•°ç»„å¯ä»¥ä½¿ç”¨`forå¾ªç¯/for..in../forEach`ç­‰ç­‰

é‚£ä¹ˆæœ‰æ²¡æœ‰ç»Ÿä¸€çš„æ–¹å¼éå†è¿™äº›æ•°æ®å‘¢ï¼Ÿè¿™å°±æ˜¯è¿­ä»£å™¨å­˜åœ¨çš„æ„ä¹‰ï¼Œå®ƒå¯ä»¥æä¾›ç»Ÿä¸€çš„éå†æ•°æ®çš„æ–¹å¼ï¼Œåªè¦åœ¨æƒ³è¦éå†çš„æ•°æ®ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ªæ”¯æŒè¿­ä»£å™¨çš„å±æ€§å³å¯

### 2.2 Iteratorè¯­æ³•

```js
const obj = {
    [Symbol.iterator]:function(){}
}
```

`[Symbol.iterator]` å±æ€§åæ˜¯å›ºå®šçš„å†™æ³•ï¼Œåªè¦æ‹¥æœ‰äº†è¯¥å±æ€§çš„å¯¹è±¡ï¼Œå°±èƒ½å¤Ÿç”¨è¿­ä»£å™¨çš„æ–¹å¼è¿›è¡Œéå†

è¿­ä»£å™¨çš„éå†æ–¹æ³•æ˜¯é¦–å…ˆè·å¾—ä¸€ä¸ªè¿­ä»£å™¨çš„æŒ‡é’ˆï¼Œåˆå§‹æ—¶è¯¥æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€æ¡æ•°æ®ä¹‹å‰

æ¥ç€é€šè¿‡è°ƒç”¨ `next` æ–¹æ³•ï¼Œæ”¹å˜æŒ‡é’ˆçš„æŒ‡å‘ï¼Œè®©å…¶æŒ‡å‘ä¸‹ä¸€æ¡æ•°æ®

æ¯ä¸€æ¬¡çš„ `next` éƒ½ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æœ‰ä¸¤ä¸ªå±æ€§

- value ä»£è¡¨æƒ³è¦è·å–çš„æ•°æ®
- done å¸ƒå°”å€¼ï¼Œfalseè¡¨ç¤ºå½“å‰æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æœ‰å€¼ï¼Œtrueè¡¨ç¤ºéå†å·²ç»ç»“æŸ

### 2.3 Iteratorè¯¦è§£

åœ¨JSä¸­ï¼Œ`Array/Set/Map/String`éƒ½é»˜è®¤æ”¯æŒè¿­ä»£å™¨

ç”±äºæ•°ç»„å’Œé›†åˆéƒ½æ”¯æŒè¿­ä»£å™¨ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½å¯ä»¥ç”¨åŒä¸€ç§æ–¹å¼æ¥éå†

es6ä¸­æä¾›äº†ä¸€ç§æ–°çš„å¾ªç¯æ–¹æ³•å«åš`for-of`ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨è¿­ä»£å™¨æ¥è¿›è¡Œéå†

æ¢å¥è¯è¯´åªæœ‰æ”¯æŒäº†è¿­ä»£å™¨çš„æ•°æ®ç»“æ„æ‰èƒ½ä½¿ç”¨`for-of`å¾ªç¯

**æ•°ç»„ä¸­ä½¿ç”¨è¿­ä»£å™¨éå†**

```js
let arr = [{num:1},2,3]
let it = arr[Symbol.iterator]() // è·å–æ•°ç»„ä¸­çš„è¿­ä»£å™¨
console.log(it.next()) 	// { value: Object { num: 1 }, done: false }
console.log(it.next()) 	// { value: 2, done: false }
console.log(it.next()) 	// { value: 3, done: false }
console.log(it.next()) 	// { value: undefined, done: true }
```

æ•°ç»„æ˜¯æ”¯æŒè¿­ä»£å™¨éå†çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è·å–å…¶è¿­ä»£å™¨ï¼Œé›†åˆä¹Ÿæ˜¯ä¸€æ ·

**é›†åˆä¸­ä½¿ç”¨è¿­ä»£å™¨éå†**

```js
let list = new Set([1,3,2,3])
let it = list.entries() 	// è·å–seté›†åˆä¸­è‡ªå¸¦çš„çš„è¿­ä»£å™¨
console.log(it.next()) 	// { value: [ 1, 1 ], done: false }
console.log(it.next()) 	// { value: [ 3, 3 ], done: false }
console.log(it.next()) 	// { value: [ 2, 2 ], done: false }
console.log(it.next()) 	// { value: undefined, done: true }
```

é›†åˆä¸æ•°ç»„ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Setä¸­çš„`entries`æ–¹æ³•è·å–è¿­ä»£å™¨

Seté›†åˆä¸­æ¯æ¬¡éå†å‡ºæ¥çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„ç¬¬ä¸€å’Œç¬¬äºŒä¸ªå…ƒç´ éƒ½æ˜¯ä¸€æ ·çš„

**è‡ªå®šä¹‰å¯¹è±¡ä¸­ä½¿ç”¨è¿­ä»£å™¨éå†**

é¦–å…ˆè‡ªå®šä¹‰çš„å¯¹è±¡æ²¡æœ‰è¿­ä»£å™¨å±æ€§ï¼Œæ‰€ä»¥ä¸æ”¯æŒè¿­ä»£å™¨è¿­ä»£ï¼Œæˆ‘ä»¬ä¹Ÿéƒ½çŸ¥é“`for..of`æ˜¯æ— æ³•éå†å¯¹è±¡çš„ï¼ŒåŸå› å°±åœ¨è¿™é‡Œï¼Œå› ä¸º`for..of`æ˜¯ä½¿ç”¨è¿­ä»£å™¨è¿­ä»£ï¼Œæ‰€ä»¥å¯¹è±¡ä¸èƒ½ç”¨`for..of`

æ—¢ç„¶çŸ¥é“æ˜¯å› ä¸ºè‡ªå®šä¹‰å¯¹è±¡æ— è¿­ä»£å™¨å±æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸ºå®ƒåŠ ä¸Š`Symbol.iterator`è¿™æ ·ä¸€ä¸ªå±æ€§ï¼Œå¹¶ä¸ºå®ƒå®ç°ä¸€ä¸ªè¿­ä»£å™¨æ–¹æ³•ï¼Œå¦‚ä¸‹

```js
let obj = {
  name : 'tom',
  age : 18,
  gender : 'ç”·',
  intro : function(){
    console.log('my name is '+this.name)
  },
  [Symbol.iterator]:function(){
    let i = 0;
    // è·å–å½“å‰å¯¹è±¡çš„æ‰€æœ‰å±æ€§å¹¶å½¢æˆä¸€ä¸ªæ•°ç»„
    let keys = Object.keys(this); 
    return {
      next: function(){
        return {
          // å¤–éƒ¨æ¯æ¬¡æ‰§è¡Œnextéƒ½èƒ½å¾—åˆ°æ•°ç»„ä¸­çš„ç¬¬iä¸ªå…ƒç´ 
          value:keys[i++], 
          // å¦‚æœæ•°ç»„çš„æ•°æ®å·²ç»éå†å®Œåˆ™è¿”å›true
          done:i > keys.length 
        }
      }
    }
  }
}

for(let attr of obj){
  console.log(attr);
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼ŒåŠ ä¸Š`[Symbol.iterator]`è¿™ä¸ªè¿­ä»£å™¨å±æ€§æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ªè¿­ä»£å™¨æ–¹æ³•ï¼Œå°±å¯ä»¥ä½¿ç”¨`for..of`æ–¹æ³•äº†

### 2.4 Iteratorä½œç”¨

Iterator çš„ä½œç”¨æœ‰ä¸‰ä¸ªï¼š

- ä¸ºå„ç§æ•°æ®ç»“æ„ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„ã€ç®€ä¾¿çš„è®¿é—®æ¥å£
- ä½¿å¾—æ•°æ®ç»“æ„çš„æˆå‘˜èƒ½å¤ŸæŒ‰æŸç§æ¬¡åºæ’åˆ—
- ES6 åˆ›é€ äº†ä¸€ç§æ–°çš„éå†å‘½ä»¤`for..of`å¾ªç¯ï¼ŒIterator æ¥å£ä¸»è¦ä¾›`for..of`æ¶ˆè´¹

Iteratoræˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œåˆ°è¿™å°±ç†è§£ä¸Šæ–‡Iteratorå‚æ•°æ˜¯ä»€ä¹ˆäº†å§ï¼Œå°±æ˜¯ä»£è¡¨ä¸€ä¸ªæœ‰è¿­ä»£å™¨å±æ€§çš„å‚æ•°

## 3. åˆè¯†Generator

Generatorå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°

æ™®é€šå‡½æ•°ï¼Œä½ è¿è¡Œäº†è¿™ä¸ªå‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨ä¸ä¼šåœï¼Œç›´åˆ°è¿™ä¸ªå‡½æ•°ç»“æŸ

Generatorè¿™ä¸ªå‡½æ•°ç‰¹æ®Šä¹‹å¤„å°±æ˜¯ï¼Œä¸­é—´å¯ä»¥åœ

### 3.1 Generatorå‡½æ•°ç‰¹ç‚¹

```js
function *generatorFn() {
  console.log("a");
  yield '1';
  console.log("b");
  yield '2'; 
  console.log("c");
  return '3';
}

let it = generatorFn()
it.next()
it.next()
it.next()
it.next()
```

ä¸Šé¢è¿™ä¸ªç¤ºä¾‹å°±æ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œé¦–å…ˆæˆ‘ä»¬è§‚å¯Ÿå®ƒçš„ç‰¹ç‚¹ï¼Œä¸€ä¸ªä¸€ä¸ªè¿›è¡Œåˆ†æ

- ä¸åŒäºæ™®é€šå‡½æ•°ï¼ŒGeneratorå‡½æ•°åœ¨

  ```
  function
  ```

  åé¢ï¼Œå‡½æ•°åä¹‹å‰æœ‰ä¸ª

  ```
  *
  ```

  - `*`ç”¨æ¥è¡¨ç¤ºå‡½æ•°ä¸º Generator å‡½æ•°
  - å†™æ³•å¾ˆå¤šï¼Œ`function* fn()`ã€`function*fn()`å’Œ`function *fn()`éƒ½å¯ä»¥

- å‡½æ•°å†…éƒ¨æœ‰

  ```
  yield
  ```

  å­—æ®µ

  - `yield`ç”¨æ¥å®šä¹‰å‡½æ•°å†…éƒ¨çš„çŠ¶æ€ï¼Œå¹¶è®©å‡ºæ‰§è¡Œæƒ
  - è¿™ä¸ªå…³é”®å­—åªèƒ½å‡ºç°åœ¨ç”Ÿæˆå™¨å‡½æ•°ä½“å†…ï¼Œä½†æ˜¯ç”Ÿæˆå™¨ä¸­ä¹Ÿå¯ä»¥æ²¡æœ‰ yield å…³é”®å­—ï¼Œå‡½æ•°é‡åˆ° yield çš„æ—¶å€™ä¼šæš‚åœï¼Œå¹¶æŠŠ yield åé¢çš„è¡¨è¾¾å¼ç»“æœæŠ›å‡ºå»

- è°ƒç”¨åå…¶å‡½æ•°è¿”å›å€¼ä½¿ç”¨äº†

  ```
  next
  ```

  æ–¹æ³•

  - è°ƒç”¨ Generator å‡½æ•°å’Œè°ƒç”¨æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œåœ¨å‡½æ•°ååé¢åŠ ä¸Š()å³å¯
  - Generator å‡½æ•°ä¸ä¼šåƒæ™®é€šå‡½æ•°ä¸€æ ·ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€å¯¹è±¡çš„æŒ‡é’ˆ
  - æ‰€ä»¥è¦è°ƒç”¨è¿­ä»£å™¨å¯¹è±¡ Iterator çš„ `next` æ–¹æ³•ï¼ŒæŒ‡é’ˆå°±ä¼šä»å‡½æ•°å¤´éƒ¨æˆ–è€…ä¸Šä¸€æ¬¡åœä¸‹æ¥çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œ
  - `next` æ–¹æ³•å…¶å®å°±æ˜¯å°†ä»£ç çš„æ§åˆ¶æƒäº¤è¿˜ç»™ç”Ÿæˆå™¨å‡½æ•°

### 3.2 åˆ†ææ‰§è¡Œè¿‡ç¨‹

æ¥ç€æˆ‘ä»¬æ¥åˆ†æå®ƒçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œçº¿æ¥çœ‹å®ƒçš„æ‰“å°ç»“æœï¼Œè¿˜æ˜¯ä¸Šé¢é‚£ä¸ªä¾‹å­

```js
let it = generatorFn()
it.next()
// a
// {value: "1", done: false}

it.next()
// b
// {value: "1", done: false}

it.next()
// c
// {value: "1", done: true}

it.next()
// {value: undefined, done: true}
```

é¦–å…ˆï¼ŒGenerator å‡½æ•°æ‰§è¡Œï¼Œè¿”å›äº†ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€å¯¹è±¡çš„æŒ‡é’ˆï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•è¾“å‡º

ç¬¬ä¸€æ¬¡è°ƒç”¨`next`æ–¹æ³•ï¼Œä» Generator å‡½æ•°çš„å¤´éƒ¨å¼€å§‹æ‰§è¡Œï¼Œå…ˆæ˜¯æ‰“å°äº† a ï¼Œæ‰§è¡Œåˆ°`yield`å°±åœä¸‹æ¥ï¼Œå¹¶å°†`yield`åè¾¹è¡¨è¾¾å¼çš„å€¼ '1'ï¼Œä½œä¸ºè¿”å›å¯¹è±¡çš„ value å±æ€§å€¼ï¼Œæ­¤æ—¶å‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œ è¿”å›å¯¹è±¡çš„ done å±æ€§å€¼æ˜¯ false

ç¬¬äºŒæ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼ŒåŒä¸Šæ­¥

ç¬¬ä¸‰æ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œå…ˆæ˜¯æ‰“å°äº† c ï¼Œç„¶åæ‰§è¡Œäº†å‡½æ•°çš„è¿”å›æ“ä½œï¼Œå¹¶å°† return åé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼Œä½œä¸ºè¿”å›å¯¹è±¡çš„ value å±æ€§å€¼ï¼Œæ­¤æ—¶å‡½æ•°å·²ç»ç»“æŸï¼Œæ‰€ä»¥ done å±æ€§å€¼ä¸ºtrue

ç¬¬å››æ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œ æ­¤æ—¶å‡½æ•°å·²ç»æ‰§è¡Œå®Œäº†ï¼Œæ‰€ä»¥è¿”å› value å±æ€§å€¼æ˜¯ undefinedï¼Œdone å±æ€§å€¼æ˜¯ true ï¼Œå¦‚æœæ‰§è¡Œç¬¬ä¸‰æ­¥æ—¶ï¼Œæ²¡æœ‰ return è¯­å¥çš„è¯ï¼Œå°±ç›´æ¥è¿”å› `{value: undefined, done: true}`

ç®€å•çš„ç†è§£ï¼ŒGeneratorå‡½æ•°`yield`æ”¾åˆ°å“ªé‡Œå®ƒå°±åœåˆ°å“ªé‡Œï¼Œè°ƒç”¨æ—¶ä½¿ç”¨`next`æ–¹æ³•è¸¹ä¸€æ­¥å°±èµ°ä¸€æ­¥

### 3.3 nextå‚æ•°ä¼ é€’

`yield`æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œ`next`æ–¹æ³•ç›´æ¥è°ƒç”¨ä¸ä¼ å…¥å‚æ•°çš„æ—¶å€™ï¼Œ`yield` è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯ undefined

å½“ next ä¼ å…¥å‚æ•°çš„æ—¶å€™ï¼Œè¯¥å‚æ•°ä¼šä½œä¸º**ä¸Šä¸€æ­¥**`yield`çš„è¿”å›å€¼

æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹æ¥ç†è§£

```js
function *geFn(){
  cosnole.log("start")
  let a = yield "1"
  
  console.log(a)
  let b = yield "2"
  
  console.log(b)
  let c = yield "3"
  
  console.log(c)
  return 4
}

let it = geFn()
it.next()
// start
// { value:1, done: false }

it1.next()
// undefined   		æœªä¼ å€¼ï¼Œæ‰€ä»¥a=undefined
// { value:2, done: false }

it.next("hahaha")
// hahaha	     		ä¼ å€¼ï¼Œæ‰€ä»¥b=hahaha
// { value:3, done: false }

it.next("omg")
// omg				 		ä¼ å€¼ï¼Œæ‰€ä»¥c=omg
// {value: 4, done: true}
```

ç”±äº `next` æ–¹æ³•çš„å‚æ•°è¡¨ç¤ºä¸Šä¸€ä¸ª `yield` è¯­å¥çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡ä½¿ç”¨ `next` æ–¹æ³•æ—¶ï¼Œä¸èƒ½å¸¦æœ‰å‚æ•°

V8å¼•æ“ä¼šç›´æ¥å¿½ç•¥ç¬¬ä¸€æ¬¡ä½¿ç”¨ `next` æ–¹æ³•æ—¶çš„å‚æ•°ï¼Œåªæœ‰ä»ç¬¬äºŒæ¬¡ä½¿ç”¨ `next` æ–¹æ³•å¼€å§‹ï¼Œå‚æ•°æ‰æ˜¯æœ‰æ•ˆçš„

æ²¡æœ‰æ¥åˆ°ä¼ å€¼æ—¶ï¼Œ`yield`è¯­å¥çš„è¿”å›å€¼å°±æ˜¯undefinedï¼Œæ­£å¦‚ä¸Šé¢ç¤ºä¾‹è¾“å‡ºé‚£æ ·

é€šè¿‡ `next` æ–¹æ³•çš„å‚æ•°ï¼Œå°±æœ‰åŠæ³•åœ¨Generatorå‡½æ•°å¼€å§‹è¿è¡Œä¹‹åï¼Œç»§ç»­å‘å‡½æ•°ä½“å†…éƒ¨æ³¨å…¥å€¼ï¼Œè¿™ä»£è¡¨äº†æˆ‘ä»¬å¯ä»¥åœ¨Generatorå‡½æ•°è¿è¡Œçš„ä¸åŒé˜¶æ®µï¼Œä»å¤–éƒ¨å‘å†…éƒ¨æ³¨å…¥ä¸åŒçš„å€¼ï¼Œä»è€Œè°ƒæ•´å‡½æ•°è¡Œä¸º

### 3.4 å†æ¬¡ç†è§£yield

æˆ‘ä»¬å†æ¥çœ‹ä¸€æ®µä»£ç ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£`yield`

```js\
function *geFn(){
  console.log("start")
  let a = yield console.log("1")
  console.log(a)
  let b = yield console.log("2")
  console.log(b)
  return console.log("3")
}

let it = geFn()
it.next()
// start
// 1
// {value: undefined, done: false}

it.next("æˆ‘æ˜¯a")
// æˆ‘æ˜¯a
// 2
// {value: undefined, done: false}

it.next("æˆ‘æ˜¯b")
// æˆ‘æ˜¯b
// 3
// {value: undefined, done: true}
```

é€šè¿‡`next`è°ƒç”¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å°±è¾“å‡ºäº†`start & 1` ï¼Œæ„å‘³ç€`yield`åœæ­¢æ—¶ï¼Œåé¢ä»£ç æ˜¯æ‰§è¡Œäº†çš„



![image-20210617201526090](https://gitee.com/zszdevelop/blogimage/raw/master/image-20210617201526090.png)



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœå°†è¯´`yield`æ¯”åšä¸€é“å¢™ï¼Œé‚£ä¹ˆå¢™å³è¾¹å’Œä¸Šé¢æ˜¯ä¸€å—ï¼Œå¢™å·¦è¾¹å’Œä¸‹é¢æ˜¯ä¸€å—ï¼Œè¿™æ ·è¯´åº”è¯¥å¤Ÿç›´ç™½äº†å§

### 3.5 for..of éå†Generator

ä¸Šæ–‡æˆ‘ä»¬å°±çŸ¥é“äº†`for...of`å†…éƒ¨å®ç°å°±æ˜¯åœ¨ä½¿ç”¨è¿­ä»£å™¨è¿­ä»£ï¼Œé‚£ä¹ˆ`for...of`å¾ªç¯ç›´æ¥ç”¨åœ¨Generatoréå†å™¨ä¸Šå²‚ä¸æ˜¯å®Œç¾

æ˜¯çš„ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨éå†Generatorå‡½æ•°ï¼Œè€Œä¸”æ­¤æ—¶ä¸å†éœ€è¦è°ƒç”¨nextæ–¹æ³•ï¼Œä¸€æ—¦nextæ–¹æ³•çš„è¿”å›å¯¹è±¡çš„doneå±æ€§ä¸ºtrueï¼Œ`for...of`å¾ªç¯å°±ä¼šä¸­æ­¢ï¼Œä¸”ä¸åŒ…å«è¯¥è¿”å›å¯¹è±¡

```js
function *foo() {
  yield 1
  yield 2
  yield 3
  yield 4
  yield 5
  return 6
}
for (let v of foo()) {
  console.log(v)
}
// 1 2 3 4 5
```

### 3.6 yield* è¡¨è¾¾å¼

åœ¨`yield`å‘½ä»¤åé¢åŠ ä¸Šæ˜Ÿå·ï¼Œè¡¨æ˜å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªéå†å™¨ï¼Œè¿™è¢«ç§°ä¸º`yield*`è¡¨è¾¾å¼

```js
function *foo(){
  yield "foo1"
  yield "foo2"
}
function *bar(){
  yield "bar1"
  yield* foo()
  yield "bar2"
}
for(let val of bar()){
  console.log(val)
}

// bar1 foo1 foo2 bar2
```

`yield`å‘½ä»¤åé¢å¦‚æœä¸åŠ æ˜Ÿå·ï¼Œè¿”å›çš„æ˜¯æ•´ä¸ªæ•°ç»„ï¼ŒåŠ äº†æ˜Ÿå·å°±è¡¨ç¤ºè¿”å›çš„æ˜¯æ•°ç»„çš„éå†å™¨

```js
function* gen1(){
  yield ["a", "b", "c"]
}
for(let val of gen1()){
  console.log(a)
}
// ["a", "b", "c"]

// ------------------- ä¸Šä¸‹åˆ†å‰²

function* gen2(){
  yield* ["a", "b", "c"]
}
for(let val of gen2()){
  console.log(a)
}
// a b c
```

### 3.7 Generatorä¸­çš„return

return æ–¹æ³•è¿”å›ç»™å®šå€¼ï¼Œå¹¶ç»“æŸéå† Generator å‡½æ•°

å½“ return æ— å€¼æ—¶ï¼Œå°±è¿”å› undefinedï¼Œæ¥çœ‹ä¾‹å­

```js
function* foo(){
  yield 1
  yield 2
  yield 3
}

var f = foo()
f.next()
// {value: 1, done: false}

f.return("hahaha")
// ç”±äºè°ƒç”¨äº†returnæ–¹æ³•ï¼Œæ‰€ä»¥éå†å·²ç»“æŸï¼Œdoneå˜true
// {value: "hahaha", done: true}

f.next()
// {value: undefined, done: true}
```

### 3.8Generatoré”™è¯¯å¤„ç†throw

`throw`æ–¹æ³•å¯ä»¥å† Generator å‡½æ•°ä½“å¤–é¢æŠ›å‡ºå¼‚å¸¸ï¼Œå†å‡½æ•°ä½“å†…éƒ¨æ•è·ï¼Œå¬ç€æ˜¯å¾ˆå¥½ç†è§£

è¿™é‡Œä¸€ä¸å°å¿ƒè¿˜æ˜¯æŒºå®¹æ˜“å…¥å‘çš„ï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¾‹å­å§

```js
function *foo(){
  try{
    yield 'hahaha'
  }catch(err){
    console.log('inside error: ' + err)
  }
}
var f = foo()
try{
    it.throw('this is err')
}catch(err){
    console.log('out error: ' + err)
}
```

ä¸Šé¢ä»£ç ä¼šè¾“å‡ºå“ªä¸ªé”™è¯¯å‘¢ï¼Ÿ

å…¶å®ç­”æ¡ˆå¾ˆç®€å•ï¼Œä¸Šè¿°ä»£ç ä¼šè¾“å‡º`out errorï¼šthis is err`

å› ä¸ºè°ƒç”¨`throw`çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ‰§è¡Œ`next`æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™å†…éƒ¨çš„`try{}catch{}`ä»£ç éƒ½è¿˜æ²¡æ‰§è¡Œï¼Œå› æ­¤åªä¼šè¢«å¤–é¢æ•æ‰

æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è°ƒç”¨`throw`ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ä¸€é`next`ï¼Œè¿™ä¸ªæ—¶å€™å‡½æ•°ä½“å†…éƒ¨å·²ç»æ‰§è¡Œäº†`try{}catch{}`ï¼Œé‚£ä¹ˆæ‰§è¡Œåˆ°`throw`æ—¶ï¼Œå†…å¤–éƒ½æœ‰é”™è¯¯æ•æ‰ï¼Œ**`throw`æ–¹æ³•ä¼šå…ˆè¢«å†…éƒ¨æ•æ‰**ï¼Œä»è€Œæ‰“å°`inside errorï¼šthis is err`

é™¤æ­¤ï¼Œ**`throw`æ–¹æ³•ä¼šé™„å¸¦æ‰§è¡Œä¸‹ä¸€ä¸ª`yield`**ï¼Œæˆ‘ä»¬æ¥çœ‹ç¤ºä¾‹

```js
var foo = function* foo(){
  try {
    yield console.log('1')
    yield console.log('2')
  } catch (e) {
    console.log('inside err')
  }
  yield console.log('3')
  yield console.log('4') 
}
var g = foo()
g.next()
g.throw()
g.next()
```

æˆ‘ä»¬æ¥çœ‹ä¸Šè¿°ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹

é¦–å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ª`next`æ–¹æ³•ï¼Œè¿›å…¥`try()catch()`ï¼Œè¾“å‡º 1

æ¥ç€ï¼Œæ‰§è¡Œ`throw`æ–¹æ³•ï¼Œå†…éƒ¨æ•æ‰åˆ°ï¼Œè¾“å‡º`inside err`ï¼Œæ­¤æ—¶`try()catch()`ä»£ç å—å·²ç»æ‰§è¡Œäº†`catch`ï¼Œ`try()catch()`ä»£ç å—å·²ç»ç»“æŸäº†ï¼Œæ‰€ä»¥é™„å¸¦æ‰§è¡Œä¸€ä¸ª`yield`ä¼šç»§ç»­å‘ä¸‹æ‰¾ï¼Œæ‰€ä»¥å†è¾“å‡º3

æœ€åæ‰§è¡Œ`next`æ–¹æ³•ï¼Œè¾“å‡º 4

æœ€ç»ˆè¾“å‡ºç»“æœä¸º`1 3 4`

## 4. Generatoræ‰©å……

åœ¨Generatorå¼€å¤´æœ‰ä¸€å¥è¯ï¼Œä¸çŸ¥é“å¤§å®¶ç†è§£æ²¡æœ‰

- Generatoræ˜¯åç¨‹åœ¨ES6çš„å®ç°ï¼Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒ

### 4.1 ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ

è¿™é‡Œä½¿ç”¨é˜®ä¸€å³°è€å¸ˆçš„æ–‡ç« å‚è€ƒé“¾æ¥ã€8ã€‘ä¸­å¯¹åç¨‹çš„è§£é‡Šå¹¶ç•¥å¸¦ä¿®æ”¹åŠè¡¥å……

è¿›ç¨‹å’Œçº¿ç¨‹å¤§å®¶åº”è¯¥éƒ½æ¸…æ¥šï¼Œé‚£ä¹ˆåç¨‹æ˜¯ä»€ä¹ˆå‘¢

ä¸çŸ¥é“å¤§å®¶çŸ¥ä¸çŸ¥é“ç”¨æˆ·ç©ºé—´çº¿ç¨‹ï¼Œå…¶å®å°±æ˜¯ä¸€ç§ç”±ç¨‹åºå‘˜è‡ªå·±å†™ç¨‹åºæ¥ç®¡ç†ä»–çš„è°ƒåº¦çš„çº¿ç¨‹ï¼Œå¯¹å†…æ ¸æ¥è¯´ä¸å¯è§

åç¨‹(coroutine)ï¼Œå¯ä»¥ç†è§£å°±æ˜¯ä¸€ç§â€œç”¨æˆ·ç©ºé—´çº¿ç¨‹â€ï¼Œä¹Ÿå¯ç†è§£ä¸ºå¤šä¸ªâ€œçº¿ç¨‹â€ç›¸äº’åä½œï¼Œå®Œæˆå¼‚æ­¥ä»»åŠ¡

ç”±äºçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œå› æ­¤ä¹Ÿå¯ä»¥å¾—å‡ºï¼Œåç¨‹æ˜¯åŸºäºçº¿ç¨‹å®ç°çš„ï¼Œä¸è¿‡å®ƒè¦æ¯”çº¿ç¨‹è¦è½»å¾ˆå¤š

åç¨‹ï¼Œæœ‰å‡ ä¸ªç‰¹ç‚¹ï¼š

- ååŒï¼Œå› ä¸ºæ˜¯ç”±ç¨‹åºå‘˜è‡ªå·±å†™çš„è°ƒåº¦ç­–ç•¥ï¼Œå…¶é€šè¿‡åä½œè€Œä¸æ˜¯æŠ¢å æ¥è¿›è¡Œåˆ‡æ¢
- åœ¨ç”¨æˆ·æ€å®Œæˆåˆ›å»ºï¼Œåˆ‡æ¢å’Œé”€æ¯
- ç¼–ç¨‹è§’åº¦ä¸Šçœ‹ï¼Œåç¨‹çš„æ€æƒ³æœ¬è´¨ä¸Šå°±æ˜¯æ§åˆ¶æµçš„ä¸»åŠ¨è®©å‡º(yield)å’Œæ¢å¤(resume)æœºåˆ¶

å®ƒçš„è¿è¡Œæµç¨‹å¦‚ä¸‹

- åç¨‹Aå¼€å§‹æ‰§è¡Œ
- åç¨‹Aæ‰§è¡Œåˆ°ä¸€åŠï¼Œæš‚åœæ‰§è¡Œï¼Œæ‰§è¡Œçš„æƒåˆ©è½¬äº¤ç»™åç¨‹Bã€‚
- ä¸€æ®µæ—¶é—´åBäº¤è¿˜æ‰§è¡Œæƒ
- åç¨‹Aé‡å¾—æ‰§è¡Œæƒï¼Œç»§ç»­æ‰§è¡Œ

ä¸Šé¢çš„åç¨‹Aå°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå› ä¸ºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œæƒè¢«BæŠ¢äº†ï¼Œè¢«è¿«åˆ†æˆä¸¤æ­¥å®Œæˆ

ä¸¾ä¾‹æ¥è¯´ï¼Œè¯»å–æ–‡ä»¶çš„åç¨‹å†™æ³•å¦‚ä¸‹

```js
function asnycJob() {
  // ...å…¶ä»–ä»£ç 
  var f = yield readFile(fileA)
  // ...å…¶ä»–ä»£ç 
}
```

ä¸Šé¢ä»£ç çš„å‡½æ•° asyncJob æ˜¯ä¸€ä¸ªåç¨‹ï¼Œå…¶ä¸­çš„ `yield` å‘½ä»¤ï¼Œå®ƒè¡¨ç¤ºæ‰§è¡Œåˆ°æ­¤å¤„ï¼Œæ‰§è¡Œæƒå°†äº¤ç»™å…¶ä»–åç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`yield`å‘½ä»¤æ˜¯å¼‚æ­¥ä¸¤ä¸ªé˜¶æ®µçš„åˆ†ç•Œçº¿

åç¨‹é‡åˆ° `yield` å‘½ä»¤å°±æš‚åœï¼Œç­‰åˆ°æ‰§è¡Œæƒè¿”å›ï¼Œå†ä»æš‚åœçš„åœ°æ–¹ç»§ç»­å¾€åæ‰§è¡Œï¼Œå®ƒçš„æœ€å¤§ä¼˜ç‚¹ï¼Œå°±æ˜¯ä»£ç çš„å†™æ³•éå¸¸åƒåŒæ­¥æ“ä½œï¼Œåªå¤šäº†ä¸€ä¸ª`yield`å‘½ä»¤

### 4.2 Generatorä¸åç¨‹

JSæ˜¯å•çº¿ç¨‹çš„ï¼ŒES6ä¸­çš„Generatorçš„å®ç°ï¼Œç±»ä¼¼äºå¼€äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ä¾ç„¶åŒæ—¶åªèƒ½è¿›è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œä¸è¿‡å¯ä»¥åˆ‡æ¢

å°±åƒæ±½è½¦åœ¨å…¬è·¯ä¸Šè¡Œé©¶ï¼Œjså…¬è·¯åªæ˜¯å•è¡Œé“(ä¸»çº¿ç¨‹)ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šè½¦é“(è¾…åŠ©çº¿ç¨‹)éƒ½å¯ä»¥æ±‡å…¥è½¦æµ(å¼‚æ­¥ä»»åŠ¡å®Œæˆåå›è°ƒè¿›å…¥ä¸»çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—)

è€Œ Generator æŠŠjså…¬è·¯å˜æˆäº†å¤šè½¦é“(åç¨‹å®ç°)ï¼Œä½†æ˜¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè½¦é“ä¸Šçš„è½¦èƒ½å¼€(æ‰€ä»¥ä¾ç„¶æ˜¯å•çº¿ç¨‹)ï¼Œä¸è¿‡å¯ä»¥è‡ªç”±å˜é“(ç§»äº¤æ§åˆ¶æƒ)

### 4.3 Generatorä¹‹Thunkå‡½æ•°

thunkå‡½æ•°çš„è¯ç”Ÿæºäºä¸€ä¸ªç¼–è¯‘å™¨è®¾è®¡çš„é—®é¢˜ï¼š`æ±‚å€¼ç­–ç•¥`ï¼Œå³å‡½æ•°çš„å‚æ•°åˆ°åº•åº”è¯¥ä½•æ—¶æ±‚å€¼

```js
var x = 1
function fn(n) {
    return n * 10
}
fn(x + 5)
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œå…¶ä¸­fnæ–¹æ³•è°ƒç”¨æ—¶`x+5`è¿™ä¸ªè¡¨è¾¾å¼åº”è¯¥ä»€ä¹ˆæ—¶å€™æ±‚å€¼ï¼Œæœ‰ä¸¤ç§æ€è·¯

- **ä¼ å€¼è°ƒç”¨(call by value)**ï¼Œå…ˆè®¡ç®—`x+5`çš„å€¼ï¼Œå†å°†è¿™ä¸ªå€¼ `6` ä¼ å…¥å‡½æ•°fnï¼Œä¾‹å¦‚cè¯­è¨€ï¼Œè¿™ç§åšæ³•çš„å¥½å¤„æ˜¯å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æœ‰å¯èƒ½ä¼šé€ æˆæ€§èƒ½æŸå¤±(ä¾‹å¦‚ä¸€ä¸ªå‡½æ•°ä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä½†æ˜¯å‡½æ•°ä½“å†…æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå…ˆè®¡ç®—å‡ºå€¼å°±ä¼šæŸè€—æ€§èƒ½ä¸”æ— æ„ä¹‰)
- **ä¼ åè°ƒç”¨(call by name)**ï¼Œå³ç›´æ¥å°†è¡¨è¾¾å¼`x+5`ä¼ å…¥å‡½æ•°ä½“ï¼Œåªåœ¨ç”¨åˆ°å®ƒçš„æ—¶å€™æ±‚å€¼

Thunk å‡½æ•°çš„å®šä¹‰ï¼Œå°±æ˜¯ä¼ åè°ƒç”¨çš„ä¸€ç§å®ç°ç­–ç•¥ï¼Œç”¨æ¥æ›¿æ¢æŸä¸ªè¡¨è¾¾å¼ï¼Œå®ç°æ€è·¯å…¶å®ä¹Ÿå¾ˆç®€å•

å…ˆå°†å‚æ•°æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶å‡½æ•°ä¹‹ä¸­ï¼Œå†å°†è¿™ä¸ªä¸´æ—¶å‡½æ•°ä¼ å…¥å‡½æ•°ä½“ï¼Œå°±åƒä¸‹é¢è¿™æ ·

```js
function fn(m){
  return m * 2    
}
fn(x + 5)

// thunkå®ç°æ€è·¯
var thunk = function () {
  return x + 5
}

function fn(thunk){
  return thunk() * 2
}
```

JSæ˜¯ä¼ å€¼è°ƒç”¨ï¼Œå®ƒçš„Thunckå‡½æ•°å«ä¹‰æœ‰æ‰€ä¸åŒ

åœ¨JSä¸­ï¼ŒThunkå‡½æ•°æ›¿æ¢çš„ä¸æ˜¯è¡¨è¾¾å¼ï¼Œæ˜¯å¯¹å‡½æ•°ç‚é‡ŒåŒ–çš„ä¸€ç§è¿ç”¨ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠæ˜¯å¤šå‚æ•°å‡½æ•°æ›¿æ¢æˆä¸€ä¸ªåªæ¥å—å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°çš„å•å‚æ•°å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„ç®€å•å®ç°

```js
fs.readFile(fileName, callback)

const Thunk = function(fn){
  return function(...args){
    return function(callback){
      return fn.call(this,...args,callback)
    }
  }
}

// ä½¿ç”¨ä¸Šé¢çš„Thunkè½¬åŒ–å™¨ï¼Œç”Ÿæˆfs.readFileçš„Thunkå‡½æ•°
var readFileThunk = Thunk(fs.readFile)
readFileThunk(fileName)(callback)
```

å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒè¦ä½¿ç”¨Thunkå‡½æ•°çš„è¯ï¼Œä½¿ç”¨Thunkifyæ¨¡å—å°±å¯ä»¥ï¼Œå…¶å®å®ƒæ ¸å¿ƒæºç å°±æ˜¯ä¸Šé¢æˆ‘ä»¬å†™çš„Thunkï¼ŒThunkifyé‡Œå¤šäº†ä¸€ä¸ªæ£€æŸ¥æœºåˆ¶è€Œå·²ï¼Œæ¯”è¾ƒç®€å•ï¼Œå¯è‡ªè¡Œç™¾åº¦Thunkifyæ¨¡å—äº†è§£

Thunkè¿™ä¸œè¥¿åœ¨ES6å‰å…¶å®æ²¡æœ‰å¤ªå¤§ç”¨å¤„ï¼Œä½†æ˜¯åœ¨Generatorå‡½æ•°å‡ºæ¥åï¼ŒThunkå‡½æ•°å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒå¯ä»¥ç”¨äºGeneratorå‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†ï¼Œæ¥æ”¶å’Œäº¤æ¢ç¨‹åºçš„æ‰§è¡Œæƒ

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåŸºäºThunkå‡½æ•°çš„Generatorè‡ªåŠ¨æ‰§è¡Œå™¨

```js
// åŸºäºThunkå‡½æ•°çš„Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
function run(fn) {
  let gen = fn()
  function next(err, data) {
    // å°†æŒ‡é’ˆç§»åŠ¨åˆ°Generatorå‡½æ•°çš„ä¸‹ä¸€æ­¥
    let result = gen.next(data)
    // åˆ¤æ–­æ˜¯å¦ç»“æŸ
    if (result.done) return
    // é€’å½’,æŠŠnextæ”¾è¿›.valueä¸­
    result.value(next)
  }
  next()
}

// æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•
let sleep = function(n, callback) {
  setTimeout(() => {
    console.log(n)
    callback && callback(n)
  }, n)
}

// æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•è¿›è¡ŒThunkè½¬æ¢
let sleepThunk = Thunk(sleep)

// Generatorå‡½æ•°
let gen = function*() {
  let f1 = yield sleepThunk(1000)
  let f2 = yield sleepThunk(1500)
  // ...
  let fn = yield sleepThunk(2000)
}

// è°ƒç”¨Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
run(gen)
```

ä¸Šé¢ä»£ç çš„ run å‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ª Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ï¼Œå†…éƒ¨çš„ next å‡½æ•°å°±æ˜¯ Thunk çš„å›è°ƒå‡½æ•°

next å‡½æ•°å…ˆå°†æŒ‡é’ˆç§»åˆ° Generator å‡½æ•°çš„ä¸‹ä¸€æ­¥(gen.next æ–¹æ³•)

ç„¶ååˆ¤æ–­ Generator å‡½æ•°æ˜¯å¦ç»“æŸ(result.done å±æ€§)

å¦‚æœæ²¡ç»“æŸï¼Œå°±å°† next å‡½æ•°å†ä¼ å…¥ Thunk å‡½æ•°(result.value å±æ€§)ï¼Œå¦åˆ™å°±ç›´æ¥é€€å‡º

ä»£ç ä¸­æ¨¡æ‹Ÿäº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œ`sleep`æ–¹æ³•ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºäº†Thunkæ–¹æ³•(ä½¿ç”¨ä¸Šæ–‡æˆ‘ä»¬å®ç°çš„é‚£ä¸ªç®€æ˜“ç‰ˆThunk)

å‡½æ•° gen å°è£…äº† n ä¸ªå¼‚æ­¥æ“ä½œï¼Œåªè¦æ‰§è¡Œ run å‡½æ•°ï¼Œè¿™äº›æ“ä½œå°±ä¼šè‡ªåŠ¨å®Œæˆ

è¿™æ ·ä¸€æ¥ï¼Œå¼‚æ­¥æ“ä½œä¸ä»…å¯ä»¥å†™å¾—åƒåŒæ­¥æ“ä½œï¼Œè€Œä¸”ä¸€è¡Œä»£ç å°±å¯ä»¥æ‰§è¡Œï¼Œæå…¶æ–¹ä¾¿

ä¸è¿‡ç›¸ä¿¡å¤§å®¶ä¹Ÿçœ‹åˆ°äº†ï¼Œè¿™ç§è‡ªåŠ¨æ‰§è¡Œå™¨ä¼ å…¥çš„Generatorå‡½æ•°ï¼Œ**yieldæ–¹æ³•åé¢å¿…é¡»æ˜¯ä¸€ä¸ªThunk å‡½æ•°**

--------ğŸ‘‡--------

Thunkå°±ç®€å•ä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œæ›´å¤šThunkç›¸å…³æ¨èçœ‹é˜®ä¸€å³°æ–‡å‚è€ƒé“¾æ¥ã€9ã€‘

æˆ‘ä»¬åªéœ€è¦æ˜ç™½Thunkæ˜¯ä»€ä¹ˆï¼Œå®ƒå’ŒGeneratoræœ‰ä»€ä¹ˆå…³ç³»å°±å¯ä»¥

### 4.4 Generatorä¹‹coå‡½æ•°åº“

co å‡½æ•°åº“æ˜¯è‘—åç¨‹åºå‘˜ TJ Holowaychuk äº2013å¹´6æœˆå‘å¸ƒçš„ä¸€ä¸ªå°å·¥å…·ï¼Œç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œ

[coå‡½æ•°åº“æºç ä¼ é€é—¨](https://github.com/tj/co)

co å‡½æ•°åº“å…¶å®å°±æ˜¯å°†ä¸¤ç§è‡ªåŠ¨æ‰§è¡Œå™¨(Thunk å‡½æ•°å’Œ Promise å¯¹è±¡)ï¼ŒåŒ…è£…æˆä¸€ä¸ªåº“ï¼Œæ‰€ä»¥è¯´ä½¿ç”¨ co çš„å‰ææ¡ä»¶æ˜¯ï¼ŒGenerator å‡½æ•°çš„ yield å‘½ä»¤åé¢ï¼Œåªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡

coå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªPromiseï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åæ¥`then`ç­‰æ–¹æ³•

åŸºäºThunkå‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ä¸Šé¢ä»‹ç»äº†ä¸‹ï¼Œé‚£ä¹ˆåŸºäºPromiseçš„å…¶å®ä¹Ÿå·®ä¸å¤šï¼Œæˆ‘ä»¬ç®€å•å®ç°ä¸‹

```js
// åŸºäºPromiseå‡½æ•°çš„Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
function run(gen) {
  let g = gen()

  function next(data) {
    // å°†æŒ‡é’ˆç§»åŠ¨åˆ°Generatorå‡½æ•°çš„ä¸‹ä¸€æ­¥
    let result = g.next(data)
    // åˆ¤æ–­æ˜¯å¦ç»“æŸï¼Œç»“æŸè¿”å›valueï¼Œvalueæ˜¯ä¸€ä¸ªPromise
    if (result.done) return result.value
    // é€’å½’
    result.value.then(data => {
      next(data)
    })
  }
  next()
}

// æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•è¿›è¡ŒPromiseè½¬æ¢
let sleepPromise = function(n) {
  return new Promise(function(resolve, reject) {
    setTimeout(() => {
      console.log(n)
      resolve(n)
    }, n)
  })
}

// Generatorå‡½æ•°
let gen = function*() {
  let f1 = yield sleepPromise(1000)
  let f2 = yield sleepPromise(1500)
  // ...
  let fn = yield sleepPromise(2000)
}

// è°ƒç”¨Genertorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œå™¨
run(gen)
```

å¦‚ä¸Šä»£ç ï¼Œå’ŒThunkå‡½æ•°é‚£é‡ŒåŒºåˆ«å°±æ˜¯yieldåé¢ä¸€ä¸ªè·ŸThunkå‡½æ•°ï¼Œä¸€ä¸ªè·ŸPromiseå¯¹è±¡

å¦‚æœThunkè‡ªæ‰§è¡Œå™¨ä½ ç†è§£äº†ï¼ŒPromiseä½¿ç”¨ä¹Ÿokçš„è¯ï¼Œè¿™å—ä»£ç çœ‹çœ‹å°±æ‡‚äº†ï¼Œä¹Ÿæ²¡å•¥è§£é‡Šçš„

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹coåº“çš„æºç 

coå‡½æ•°åº“çš„æºç ä¹Ÿå¾ˆç®€å•ï¼Œåªæœ‰å‡ åè¡Œä»£ç 

é¦–å…ˆï¼Œco å‡½æ•°æ¥å— Generator å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡

```js
function co(gen) {
  var ctx = this
  return new Promise(function(resolve, reject) {
  })
}
```

åœ¨è¿”å›çš„ Promise å¯¹è±¡é‡Œé¢ï¼Œco å…ˆæ£€æŸ¥å‚æ•° gen æ˜¯å¦ä¸º Generator å‡½æ•°

å¦‚æœæ˜¯ï¼Œå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªå†…éƒ¨æŒ‡é’ˆå¯¹è±¡

å¦‚æœä¸æ˜¯å°±è¿”å›ï¼Œå¹¶å°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º resolved

```js
function co(gen) {
  var ctx = this

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx)
    if (!gen || typeof gen.next !== 'function') return resolve(gen)
  })
}
```

æ¥ç€ï¼Œco å°† Generator å‡½æ•°çš„å†…éƒ¨æŒ‡é’ˆå¯¹è±¡çš„ next æ–¹æ³•ï¼ŒåŒ…è£…æˆ onFulefilled å‡½æ•°

ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿæ•æ‰æŠ›å‡ºçš„é”™è¯¯

```js
function co(gen) {
  var ctx = this

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx)
    if (!gen || typeof gen.next !== 'function') return resolve(gen)

    onFulfilled()
    function onFulfilled(res) {
      var ret
      try {
        ret = gen.next(res)
      } catch (e) {
        return reject(e)
      }
      next(ret)
    }    
  })
}
```

æœ€åï¼Œå°±æ˜¯å…³é”®çš„ next å‡½æ•°ï¼Œå®ƒä¼šåå¤è°ƒç”¨è‡ªèº«

```js
function next(ret) {
  if (ret.done) return resolve(ret.value)
  var value = toPromise.call(ctx, ret.value)
  if (value && isPromise(value)) return value.then(onFulfilled, onRejected)
  return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, but the following object was passed: "' + String(ret.value) + '"'))
    }
})
```

`next`æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€è¡Œï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦ä¸º Generator å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œå¦‚æœæ˜¯å°±è¿”å›

ç¬¬äºŒè¡Œï¼Œç¡®ä¿æ¯ä¸€æ­¥çš„è¿”å›å€¼ï¼Œæ˜¯ Promise å¯¹è±¡

ç¬¬ä¸‰è¡Œï¼Œä½¿ç”¨ then æ–¹æ³•ï¼Œä¸ºè¿”å›å€¼åŠ ä¸Šå›è°ƒå‡½æ•°ï¼Œç„¶åé€šè¿‡ onFulfilled å‡½æ•°å†æ¬¡è°ƒç”¨ next å‡½æ•°

ç¬¬å››è¡Œï¼Œåœ¨å‚æ•°ä¸ç¬¦åˆè¦æ±‚çš„æƒ…å†µä¸‹(å‚æ•°é Thunk å‡½æ•°å’Œ Promise å¯¹è±¡)ï¼Œå°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º rejectedï¼Œä»è€Œç»ˆæ­¢æ‰§è¡Œ

co æ”¯æŒå¹¶å‘çš„å¼‚æ­¥æ“ä½œï¼Œå³å…è®¸æŸäº›æ“ä½œåŒæ—¶è¿›è¡Œï¼Œç­‰åˆ°å®ƒä»¬å…¨éƒ¨å®Œæˆï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å¹¶å‘çš„æ“ä½œæ”¾åœ¨æ•°ç»„æˆ–å¯¹è±¡é‡Œé¢ï¼Œå¦‚ä¸‹

```js
// æ•°ç»„çš„å†™æ³•
co(function* () {
  var res = yield [
    Promise.resolve(1),
    Promise.resolve(2)
  ]
  console.log(res)
}).catch(onerror)

// å¯¹è±¡çš„å†™æ³•
co(function* () {
  var res = yield {
    1: Promise.resolve(1),
    2: Promise.resolve(2),
  }
  console.log(res)
}).catch(onerror)
```

-------ğŸ‘‡-------

ä»¥ä¸Šå°±æ˜¯coçš„å†…å®¹äº†ï¼Œè¿™é‡ŒæåŠåªæ˜¯ä¸ºäº†è®©å¤§å®¶äº†è§£coè¿™ç§å‡½æ•°åº“ï¼Œè™½ç„¶ç›®å‰ç”¨çš„ä¸å¤šï¼Œä½†æ˜¯å¯¹æˆ‘ä»¬ç†è§£Generatoræœ‰å¸®åŠ©ï¼Œå³ä½¿è¿™é‡Œæœ‰äº›è¿·ç³Šï¼Œä¹Ÿæ— ä¼¤å¤§é›…ï¼ŒçŸ¥é“coæ˜¯ä»€ä¹ˆï¼Œcoçš„è‡ªåŠ¨æ‰§è¡ŒåŸç†å¤§æ¦‚æ˜¯æ€ä¹ˆå®ç°çš„å°±è¡Œ

è¿™å—å’ŒThunkä¸€æ ·ï¼Œä¹Ÿæ˜¯å‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„æ–‡ç« ï¼Œæ‰€ä»¥æœ‰å…´è¶£çš„è¯å¯ä»¥çœ‹ä¸‹å‚è€ƒé“¾æ¥ã€10ã€‘

## 5. Generatorä¼˜/ç¼º

### 5.1 ä¼˜ç‚¹

ä¼˜é›…çš„æµç¨‹æ§åˆ¶æ–¹å¼ï¼Œå¯ä»¥è®©å‡½æ•°å¯ä¸­æ–­æ‰§è¡Œï¼Œåœ¨æŸäº›ç‰¹æ®Šéœ€æ±‚é‡Œè¿˜æ˜¯å¾ˆå®ç”¨çš„

ä½¿ç”¨è¿‡React-dvaçš„åŒå­¦å¯èƒ½ä¼šæ›´æœ‰æ„Ÿè§¦ä¸€äº›

ä¹‹å‰Nodeçš„koaæ¡†æ¶ä¹Ÿç”¨Generatorï¼Œä¸è¿‡åæ¥è¢«async/awaitæ›¿ä»£äº†

### 5.2 ç¼ºç‚¹

Generator å‡½æ•°çš„æ‰§è¡Œå¿…é¡»é æ‰§è¡Œå™¨ï¼Œæ‰€ä»¥æ‰æœ‰äº† co å‡½æ•°åº“ï¼Œä½†coæ¨¡å—çº¦å®šï¼Œyieldå‘½ä»¤åé¢åªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡ï¼Œåªé’ˆå¯¹å¼‚æ­¥å¤„ç†æ¥è¯´ï¼Œè¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿

## å‚è€ƒæ–‡ç« 

[ã€Œç¡¬æ ¸JSã€æ·±å…¥äº†è§£å¼‚æ­¥è§£å†³æ–¹æ¡ˆ](https://juejin.cn/post/6844904064614924302#heading-41)