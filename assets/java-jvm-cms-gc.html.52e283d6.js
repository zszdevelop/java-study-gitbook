import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";import{o,c,a as n,b as t,e as p,d as s,r as i}from"./app.8cb28480.js";const l={},u=p('<h1 id="gc-java-\u5783\u573E\u56DE\u6536\u5668\u4E4Bcms-gc\u95EE\u9898\u5206\u6790\u4E0E\u89E3\u51B3" tabindex="-1"><a class="header-anchor" href="#gc-java-\u5783\u573E\u56DE\u6536\u5668\u4E4Bcms-gc\u95EE\u9898\u5206\u6790\u4E0E\u89E3\u51B3" aria-hidden="true">#</a> GC - Java \u5783\u573E\u56DE\u6536\u5668\u4E4BCMS GC\u95EE\u9898\u5206\u6790\u4E0E\u89E3\u51B3</h1><h2 id="_1-\u5199\u5728\u524D\u9762" tabindex="-1"><a class="header-anchor" href="#_1-\u5199\u5728\u524D\u9762" aria-hidden="true">#</a> 1. \u5199\u5728\u524D\u9762</h2><blockquote><p>\u672C\u6587\u4E3B\u8981\u9488\u5BF9 Hotspot VM \u4E2D\u201CCMS + ParNew\u201D\u7EC4\u5408\u7684\u4E00\u4E9B\u4F7F\u7528\u573A\u666F\u8FDB\u884C\u603B\u7ED3\u3002\u91CD\u70B9\u901A\u8FC7\u90E8\u5206\u6E90\u7801\u5BF9\u6839\u56E0\u8FDB\u884C\u5206\u6790\u4EE5\u53CA\u5BF9\u6392\u67E5\u65B9\u6CD5\u8FDB\u884C\u603B\u7ED3\uFF0C\u6392\u67E5\u8FC7\u7A0B\u4F1A\u7701\u7565\u8F83\u591A\uFF0C\u53E6\u5916\u672C\u6587\u4E13\u4E1A\u672F\u8BED\u8F83\u591A\uFF0C\u6709\u4E00\u5B9A\u7684\u9605\u8BFB\u95E8\u69DB\uFF0C\u5982\u672A\u4ECB\u7ECD\u6E05\u695A\uFF0C\u8FD8\u8BF7\u81EA\u884C\u67E5\u9605\u76F8\u5173\u6750\u6599\u3002</p></blockquote><h3 id="_1-1-\u5F15\u8A00" tabindex="-1"><a class="header-anchor" href="#_1-1-\u5F15\u8A00" aria-hidden="true">#</a> 1.1 \u5F15\u8A00</h3><p>\u81EA Sun \u53D1\u5E03 Java \u8BED\u8A00\u4EE5\u6765\uFF0C\u5F00\u59CB\u4F7F\u7528 GC \u6280\u672F\u6765\u8FDB\u884C\u5185\u5B58\u81EA\u52A8\u7BA1\u7406\uFF0C\u907F\u514D\u4E86\u624B\u52A8\u7BA1\u7406\u5E26\u6765\u7684\u60AC\u6302\u6307\u9488\uFF08Dangling Pointer\uFF09\u95EE\u9898\uFF0C\u5F88\u5927\u7A0B\u5EA6\u4E0A\u63D0\u5347\u4E86\u5F00\u53D1\u6548\u7387\uFF0C\u4ECE\u6B64 GC \u6280\u672F\u4E5F\u4E00\u4E3E\u6210\u540D\u3002GC \u6709\u7740\u975E\u5E38\u60A0\u4E45\u7684\u5386\u53F2\uFF0C1960 \u5E74\u6709\u7740\u201CLisp \u4E4B\u7236\u201D\u548C\u201C\u4EBA\u5DE5\u667A\u80FD\u4E4B\u7236\u201D\u4E4B\u79F0\u7684 John McCarthy \u5C31\u5728\u8BBA\u6587\u4E2D\u53D1\u5E03\u4E86 GC \u7B97\u6CD5\uFF0C60 \u5E74\u4EE5\u6765\uFF0C GC \u6280\u672F\u7684\u53D1\u5C55\u4E5F\u7A81\u98DE\u731B\u8FDB\uFF0C\u4F46\u4E0D\u7BA1\u662F\u591A\u4E48\u524D\u6CBF\u7684\u6536\u96C6\u5668\u4E5F\u90FD\u662F\u57FA\u4E8E\u4E09\u79CD\u57FA\u672C\u7B97\u6CD5\u7684\u7EC4\u5408\u6216\u5E94\u7528\uFF0C\u4E5F\u5C31\u662F\u8BF4 GC \u8981\u89E3\u51B3\u7684\u6839\u672C\u95EE\u9898\u8FD9\u4E48\u591A\u5E74\u4E00\u76F4\u90FD\u6CA1\u6709\u53D8\u8FC7\u3002\u7B14\u8005\u8BA4\u4E3A\uFF0C\u5728\u4E0D\u592A\u8FDC\u7684\u5C06\u6765\uFF0C GC \u6280\u672F\u4F9D\u7136\u4E0D\u4F1A\u8FC7\u65F6\uFF0C\u6BD4\u8D77\u65E5\u65B0\u6708\u5F02\u7684\u65B0\u6280\u672F\uFF0CGC \u8FD9\u95E8\u53E4\u5178\u6280\u672F\u66F4\u503C\u5F97\u6211\u4EEC\u5B66\u4E60\u3002</p><p>\u76EE\u524D\uFF0C\u4E92\u8054\u7F51\u4E0A Java \u7684 GC \u8D44\u6599\u8981\u4E48\u662F\u4E3B\u8981\u8BB2\u89E3\u7406\u8BBA\uFF0C\u8981\u4E48\u5C31\u662F\u9488\u5BF9\u5355\u4E00\u573A\u666F\u7684 GC \u95EE\u9898\u8FDB\u884C\u4E86\u5256\u6790\uFF0C\u5BF9\u6574\u4E2A\u4F53\u7CFB\u603B\u7ED3\u7684\u8D44\u6599\u5C11\u4E4B\u53C8\u5C11\u3002\u524D\u8F66\u4E4B\u9274\uFF0C\u540E\u4E8B\u4E4B\u5E08\uFF0C\u7F8E\u56E2\u7684\u51E0\u4F4D\u5DE5\u7A0B\u5E08\u641C\u96C6\u4E86\u5185\u90E8\u5404\u79CD GC \u95EE\u9898\u7684\u5206\u6790\u6587\u7AE0\uFF0C\u5E76\u7ED3\u5408\u4E2A\u4EBA\u7684\u7406\u89E3\u505A\u4E86\u4E00\u4E9B\u603B\u7ED3\uFF0C\u5E0C\u671B\u80FD\u8D77\u5230\u201C\u629B\u7816\u5F15\u7389\u201D\u7684\u4F5C\u7528\uFF0C\u6587\u4E2D\u82E5\u6709\u9519\u8BEF\u4E4B\u5904\uFF0C\u8FD8\u8BF7\u5927\u5BB6\u4E0D\u541D\u6307\u6B63\u3002</p><p>GC \u95EE\u9898\u5904\u7406\u80FD\u529B\u80FD\u4E0D\u80FD\u7CFB\u7EDF\u6027\u638C\u63E1\uFF1F\u4E00\u4E9B\u5F71\u54CD\u56E0\u7D20\u90FD\u662F\u4E92\u4E3A\u56E0\u679C\u7684\u95EE\u9898\u8BE5\u600E\u4E48\u5206\u6790\uFF1F\u6BD4\u5982\u4E00\u4E2A\u670D\u52A1 RT \u7A81\u7136\u4E0A\u6DA8\uFF0C\u6709 GC \u8017\u65F6\u589E\u5927\u3001\u7EBF\u7A0B Block \u589E\u591A\u3001\u6162\u67E5\u8BE2\u589E\u591A\u3001CPU \u8D1F\u8F7D\u9AD8\u56DB\u4E2A\u8868\u8C61\uFF0C\u5230\u5E95\u54EA\u4E2A\u662F\u8BF1\u56E0\uFF1F\u5982\u4F55\u5224\u65AD GC \u6709\u6CA1\u6709\u95EE\u9898\uFF1F\u4F7F\u7528 CMS \u6709\u54EA\u4E9B\u5E38\u89C1\u95EE\u9898\uFF1F\u5982\u4F55\u5224\u65AD\u6839\u56E0\u662F\u4EC0\u4E48\uFF1F\u5982\u4F55\u89E3\u51B3\u6216\u907F\u514D\u8FD9\u4E9B\u95EE\u9898\uFF1F\u9605\u8BFB\u5B8C\u672C\u6587\uFF0C\u76F8\u4FE1\u4F60\u5C06\u4F1A\u5BF9 CMS GC \u7684\u95EE\u9898\u5904\u7406\u6709\u4E00\u4E2A\u7CFB\u7EDF\u6027\u7684\u8BA4\u77E5\uFF0C\u66F4\u80FD\u6E38\u5203\u6709\u4F59\u5730\u89E3\u51B3\u8FD9\u4E9B\u95EE\u9898\uFF0C\u4E0B\u9762\u5C31\u8BA9\u6211\u4EEC\u5F00\u59CB\u5427\uFF01</p><h3 id="_1-2-\u6982\u89C8" tabindex="-1"><a class="header-anchor" href="#_1-2-\u6982\u89C8" aria-hidden="true">#</a> 1.2 \u6982\u89C8</h3><p>\u60F3\u8981\u7CFB\u7EDF\u6027\u5730\u638C\u63E1 GC \u95EE\u9898\u5904\u7406\uFF0C\u7B14\u8005\u8FD9\u91CC\u7ED9\u51FA\u4E00\u4E2A\u5B66\u4E60\u8DEF\u5F84\uFF0C\u6574\u4F53\u6587\u7AE0\u7684\u6846\u67B6\u4E5F\u662F\u6309\u7167\u8FD9\u4E2A\u7ED3\u6784\u5C55\u5F00\uFF0C\u4E3B\u8981\u5206\u56DB\u5927\u6B65\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822211659796.png" alt="image-20220822211659796" loading="lazy"></p><p><strong>\u5EFA\u7ACB\u77E5\u8BC6\u4F53\u7CFB</strong>\uFF1A \u4ECE JVM \u7684\u5185\u5B58\u7ED3\u6784\u5230\u5783\u573E\u6536\u96C6\u7684\u7B97\u6CD5\u548C\u6536\u96C6\u5668\uFF0C\u5B66\u4E60 GC \u7684\u57FA\u7840\u77E5\u8BC6\uFF0C\u638C\u63E1\u4E00\u4E9B\u5E38\u7528\u7684 GC \u95EE\u9898\u5206\u6790\u5DE5\u5177\u3002</p><p><strong>\u786E\u5B9A\u8BC4\u4EF7\u6307\u6807</strong>\uFF1A \u4E86\u89E3\u57FA\u672C GC \u7684\u8BC4\u4EF7\u65B9\u6CD5\uFF0C\u6478\u6E05\u5982\u4F55\u8BBE\u5B9A\u72EC\u7ACB\u7CFB\u7EDF\u7684\u6307\u6807\uFF0C\u4EE5\u53CA\u5728\u4E1A\u52A1\u573A\u666F\u4E2D\u5224\u65AD GC \u662F\u5426\u5B58\u5728\u95EE\u9898\u7684\u624B\u6BB5\u3002</p><p><strong>\u573A\u666F\u8C03\u4F18\u5B9E\u8DF5</strong>\uFF1A \u8FD0\u7528\u638C\u63E1\u7684\u77E5\u8BC6\u548C\u7CFB\u7EDF\u8BC4\u4EF7\u6307\u6807\uFF0C\u5206\u6790\u4E0E\u89E3\u51B3\u4E5D\u79CD CMS \u4E2D\u5E38\u89C1 GC \u95EE\u9898\u573A\u666F\u3002</p><p><strong>\u603B\u7ED3\u4F18\u5316\u7ECF\u9A8C</strong>\uFF1A \u5BF9\u6574\u4F53\u8FC7\u7A0B\u505A\u603B\u7ED3\u5E76\u63D0\u51FA\u7B14\u8005\u7684\u51E0\u70B9\u5EFA\u8BAE\uFF0C\u540C\u65F6\u5C06\u603B\u7ED3\u5230\u7684\u7ECF\u9A8C\u5B8C\u5584\u5230\u77E5\u8BC6\u4F53\u7CFB\u4E4B\u4E2D\u3002</p><h2 id="_2-gc-\u57FA\u7840" tabindex="-1"><a class="header-anchor" href="#_2-gc-\u57FA\u7840" aria-hidden="true">#</a> 2. GC \u57FA\u7840</h2><p>\u5728\u6B63\u5F0F\u5F00\u59CB\u524D\uFF0C\u5148\u505A\u4E9B\u7B80\u8981\u94FA\u57AB\uFF0C\u4ECB\u7ECD\u4E0B JVM \u5185\u5B58\u5212\u5206\u3001\u6536\u96C6\u7B97\u6CD5\u3001\u6536\u96C6\u5668\u7B49\u5E38\u7528\u6982\u5FF5\u4ECB\u7ECD\uFF0C\u57FA\u7840\u6BD4\u8F83\u597D\u7684\u540C\u5B66\u53EF\u4EE5\u76F4\u63A5\u8DF3\u8FC7\u8FD9\u90E8\u5206\u3002</p><h3 id="_2-1-\u57FA\u7840\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_2-1-\u57FA\u7840\u6982\u5FF5" aria-hidden="true">#</a> 2.1 \u57FA\u7840\u6982\u5FF5</h3>',17),r=p("<li><strong>GC</strong>\uFF1A GC \u672C\u8EAB\u6709\u4E09\u79CD\u8BED\u4E49\uFF0C\u4E0B\u6587\u9700\u8981\u6839\u636E\u5177\u4F53\u573A\u666F\u5E26\u5165\u4E0D\u540C\u7684\u8BED\u4E49\uFF1A <ul><li><strong>Garbage Collection</strong>\uFF1A\u5783\u573E\u6536\u96C6\u6280\u672F\uFF0C\u540D\u8BCD\u3002</li><li><strong>Garbage Collector</strong>\uFF1A\u5783\u573E\u6536\u96C6\u5668\uFF0C\u540D\u8BCD\u3002</li><li><strong>Garbage Collecting</strong>\uFF1A\u5783\u573E\u6536\u96C6\u52A8\u4F5C\uFF0C\u52A8\u8BCD\u3002</li></ul></li><li><strong>Mutator</strong>\uFF1A \u751F\u4EA7\u5783\u573E\u7684\u89D2\u8272\uFF0C\u4E5F\u5C31\u662F\u6211\u4EEC\u7684\u5E94\u7528\u7A0B\u5E8F\uFF0C\u5783\u573E\u5236\u9020\u8005\uFF0C\u901A\u8FC7 Allocator \u8FDB\u884C allocate \u548C free\u3002</li><li><strong>TLAB</strong>\uFF1A Thread Local Allocation Buffer \u7684\u7B80\u5199\uFF0C\u57FA\u4E8E CAS \u7684\u72EC\u4EAB\u7EBF\u7A0B\uFF08Mutator Threads\uFF09\u53EF\u4EE5\u4F18\u5148\u5C06\u5BF9\u8C61\u5206\u914D\u5728 Eden \u4E2D\u7684\u4E00\u5757\u5185\u5B58\uFF0C\u56E0\u4E3A\u662F Java \u7EBF\u7A0B\u72EC\u4EAB\u7684\u5185\u5B58\u533A\u6CA1\u6709\u9501\u7ADE\u4E89\uFF0C\u6240\u4EE5\u5206\u914D\u901F\u5EA6\u66F4\u5FEB\uFF0C\u6BCF\u4E2A TLAB \u90FD\u662F\u4E00\u4E2A\u7EBF\u7A0B\u72EC\u4EAB\u7684\u3002</li>",3),k=n("strong",null,"Card Table",-1),d=s("\uFF1A \u4E2D\u6587\u7FFB\u8BD1\u4E3A\u5361\u8868\uFF0C\u4E3B\u8981\u662F\u7528\u6765\u6807\u8BB0\u5361\u9875\u7684\u72B6\u6001\uFF0C\u6BCF\u4E2A\u5361\u8868\u9879\u5BF9\u5E94\u4E00\u4E2A\u5361\u9875\u3002\u5F53\u5361\u9875\u4E2D\u4E00\u4E2A\u5BF9\u8C61\u5F15\u7528\u6709\u5199\u64CD\u4F5C\u65F6\uFF0C\u5199\u5C4F\u969C\u5C06\u4F1A\u6807\u8BB0\u5BF9\u8C61\u6240\u5728\u7684\u5361\u8868\u72B6\u6001\u6539\u4E3A dirty\uFF0C\u5361\u8868\u7684\u672C\u8D28\u662F\u7528\u6765\u89E3\u51B3\u8DE8\u4EE3\u5F15\u7528\u7684\u95EE\u9898\u3002\u5177\u4F53\u600E\u4E48\u89E3\u51B3\u7684\u53EF\u4EE5\u53C2\u8003 StackOverflow \u4E0A\u7684\u8FD9\u4E2A\u95EE\u9898 "),m={href:"https://stackoverflow.com/questions/19154607/how-actually-card-table-and-writer-barrier-works",target:"_blank",rel:"noopener noreferrer"},v=s("how-actually-card-table-and-writer-barrier-works (opens new window)"),b=s("\uFF0C\u6216\u8005\u7814\u8BFB\u4E00\u4E0B cardTableRS.app \u4E2D\u7684\u6E90\u7801\u3002"),g=p('<h3 id="_2-2-jvm-\u5185\u5B58\u5212\u5206" tabindex="-1"><a class="header-anchor" href="#_2-2-jvm-\u5185\u5B58\u5212\u5206" aria-hidden="true">#</a> 2.2 JVM \u5185\u5B58\u5212\u5206</h3><p>\u4ECE JCP\uFF08Java Community Process\uFF09\u7684\u5B98\u7F51\u4E2D\u53EF\u4EE5\u770B\u5230\uFF0C\u76EE\u524D Java \u7248\u672C\u6700\u65B0\u5DF2\u7ECF\u5230\u4E86 Java 16\uFF0C\u672A\u6765\u7684 Java 17 \u4EE5\u53CA\u73B0\u5728\u7684 Java 11 \u548C Java 8 \u662F LTS \u7248\u672C\uFF0CJVM \u89C4\u8303\u4E5F\u5728\u968F\u7740\u8FED\u4EE3\u5728\u53D8\u66F4\uFF0C\u7531\u4E8E\u672C\u6587\u4E3B\u8981\u8BA8\u8BBA CMS\uFF0C\u6B64\u5904\u8FD8\u662F\u653E Java 8 \u7684\u5185\u5B58\u7ED3\u6784\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822212105570.png" alt="image-20220822212105570" loading="lazy"></p><p>GC \u4E3B\u8981\u5DE5\u4F5C\u5728 Heap \u533A\u548C MetaSpace \u533A\uFF08\u4E0A\u56FE\u84DD\u8272\u90E8\u5206\uFF09\uFF0C\u5728 Direct Memory \u4E2D\uFF0C\u5982\u679C\u4F7F\u7528\u7684\u662F DirectByteBuffer\uFF0C\u90A3\u4E48\u5728\u5206\u914D\u5185\u5B58\u4E0D\u591F\u65F6\u5219\u662F GC \u901A\u8FC7 Cleaner#clean \u95F4\u63A5\u7BA1\u7406\u3002</p><p>\u4EFB\u4F55\u81EA\u52A8\u5185\u5B58\u7BA1\u7406\u7CFB\u7EDF\u90FD\u4F1A\u9762\u4E34\u7684\u6B65\u9AA4\uFF1A\u4E3A\u65B0\u5BF9\u8C61\u5206\u914D\u7A7A\u95F4\uFF0C\u7136\u540E\u6536\u96C6\u5783\u573E\u5BF9\u8C61\u7A7A\u95F4\uFF0C\u4E0B\u9762\u6211\u4EEC\u5C31\u5C55\u5F00\u4ECB\u7ECD\u4E00\u4E0B\u8FD9\u4E9B\u57FA\u7840\u77E5\u8BC6\u3002</p><h3 id="_2-3-\u5206\u914D\u5BF9\u8C61" tabindex="-1"><a class="header-anchor" href="#_2-3-\u5206\u914D\u5BF9\u8C61" aria-hidden="true">#</a> 2.3 \u5206\u914D\u5BF9\u8C61</h3><p>Java \u4E2D\u5BF9\u8C61\u5730\u5740\u64CD\u4F5C\u4E3B\u8981\u4F7F\u7528 Unsafe \u8C03\u7528\u4E86 C \u7684 allocate \u548C free \u4E24\u4E2A\u65B9\u6CD5\uFF0C\u5206\u914D\u65B9\u6CD5\u6709\u4E24\u79CD\uFF1A</p><ul><li><strong>\u7A7A\u95F2\u94FE\u8868</strong>\uFF08free list\uFF09\uFF1A \u901A\u8FC7\u989D\u5916\u7684\u5B58\u50A8\u8BB0\u5F55\u7A7A\u95F2\u7684\u5730\u5740\uFF0C\u5C06\u968F\u673A IO \u53D8\u4E3A\u987A\u5E8F IO\uFF0C\u4F46\u5E26\u6765\u4E86\u989D\u5916\u7684\u7A7A\u95F4\u6D88\u8017\u3002</li><li><strong>\u78B0\u649E\u6307\u9488</strong>\uFF08bump pointer\uFF09\uFF1A \u901A\u8FC7\u4E00\u4E2A\u6307\u9488\u4F5C\u4E3A\u5206\u754C\u70B9\uFF0C\u9700\u8981\u5206\u914D\u5185\u5B58\u65F6\uFF0C\u4EC5\u9700\u628A\u6307\u9488\u5F80\u7A7A\u95F2\u7684\u4E00\u7AEF\u79FB\u52A8\u4E0E\u5BF9\u8C61\u5927\u5C0F\u76F8\u7B49\u7684\u8DDD\u79BB\uFF0C\u5206\u914D\u6548\u7387\u8F83\u9AD8\uFF0C\u4F46\u4F7F\u7528\u573A\u666F\u6709\u9650\u3002</li></ul><h3 id="_2-4-\u6536\u96C6\u5BF9\u8C61" tabindex="-1"><a class="header-anchor" href="#_2-4-\u6536\u96C6\u5BF9\u8C61" aria-hidden="true">#</a> 2.4 \u6536\u96C6\u5BF9\u8C61</h3><h4 id="_2-4-1-\u8BC6\u522B\u5783\u573E" tabindex="-1"><a class="header-anchor" href="#_2-4-1-\u8BC6\u522B\u5783\u573E" aria-hidden="true">#</a> 2.4.1 \u8BC6\u522B\u5783\u573E</h4><p><strong>\u5F15\u7528\u8BA1\u6570\u6CD5</strong>\uFF08Reference Counting\uFF09\uFF1A \u5BF9\u6BCF\u4E2A\u5BF9\u8C61\u7684\u5F15\u7528\u8FDB\u884C\u8BA1\u6570\uFF0C\u6BCF\u5F53\u6709\u4E00\u4E2A\u5730\u65B9\u5F15\u7528\u5B83\u65F6\u8BA1\u6570\u5668 +1\u3001\u5F15\u7528\u5931\u6548\u5219 -1\uFF0C\u5F15\u7528\u7684\u8BA1\u6570\u653E\u5230\u5BF9\u8C61\u5934\u4E2D\uFF0C\u5927\u4E8E 0 \u7684\u5BF9\u8C61\u88AB\u8BA4\u4E3A\u662F\u5B58\u6D3B\u5BF9\u8C61\u3002\u867D\u7136\u5FAA\u73AF\u5F15\u7528\u7684\u95EE\u9898\u53EF\u901A\u8FC7 Recycler \u7B97\u6CD5\u89E3\u51B3\uFF0C\u4F46\u662F\u5728\u591A\u7EBF\u7A0B\u73AF\u5883\u4E0B\uFF0C\u5F15\u7528\u8BA1\u6570\u53D8\u66F4\u4E5F\u8981\u8FDB\u884C\u6602\u8D35\u7684\u540C\u6B65\u64CD\u4F5C\uFF0C\u6027\u80FD\u8F83\u4F4E\uFF0C\u65E9\u671F\u7684\u7F16\u7A0B\u8BED\u8A00\u4F1A\u91C7\u7528\u6B64\u7B97\u6CD5\u3002</p><p><strong>\u53EF\u8FBE\u6027\u5206\u6790</strong>\uFF0C\u53C8\u79F0\u5F15\u7528\u94FE\u6CD5\uFF08Tracing GC\uFF09\uFF1A \u4ECE GC Root \u5F00\u59CB\u8FDB\u884C\u5BF9\u8C61\u641C\u7D22\uFF0C\u53EF\u4EE5\u88AB\u641C\u7D22\u5230\u7684\u5BF9\u8C61\u5373\u4E3A\u53EF\u8FBE\u5BF9\u8C61\uFF0C\u6B64\u65F6\u8FD8\u4E0D\u8DB3\u4EE5\u5224\u65AD\u5BF9\u8C61\u662F\u5426\u5B58\u6D3B/\u6B7B\u4EA1\uFF0C\u9700\u8981\u7ECF\u8FC7\u591A\u6B21\u6807\u8BB0\u624D\u80FD\u66F4\u52A0\u51C6\u786E\u5730\u786E\u5B9A\uFF0C\u6574\u4E2A\u8FDE\u901A\u56FE\u4E4B\u5916\u7684\u5BF9\u8C61\u4FBF\u53EF\u4EE5\u4F5C\u4E3A\u5783\u573E\u88AB\u56DE\u6536\u6389\u3002\u76EE\u524D Java \u4E2D\u4E3B\u6D41\u7684\u865A\u62DF\u673A\u5747\u91C7\u7528\u6B64\u7B97\u6CD5\u3002</p><blockquote><p>\u5907\u6CE8\uFF1A\u5F15\u7528\u8BA1\u6570\u6CD5\u662F\u53EF\u4EE5\u5904\u7406\u5FAA\u73AF\u5F15\u7528\u95EE\u9898\u7684\uFF0C\u4E0B\u6B21\u9762\u8BD5\u65F6\u4E0D\u8981\u518D\u8FD9\u4E48\u8BF4\u5566~ ~</p></blockquote><h4 id="_2-4-2-\u6536\u96C6\u7B97\u6CD5" tabindex="-1"><a class="header-anchor" href="#_2-4-2-\u6536\u96C6\u7B97\u6CD5" aria-hidden="true">#</a> 2.4.2 \u6536\u96C6\u7B97\u6CD5</h4><p>\u81EA\u4ECE\u6709\u81EA\u52A8\u5185\u5B58\u7BA1\u7406\u51FA\u73B0\u4E4B\u65F6\u5C31\u6709\u7684\u4E00\u4E9B\u6536\u96C6\u7B97\u6CD5\uFF0C\u4E0D\u540C\u7684\u6536\u96C6\u5668\u4E5F\u662F\u5728\u4E0D\u540C\u573A\u666F\u4E0B\u8FDB\u884C\u7EC4\u5408\u3002</p><p><strong>Mark-Sweep</strong>\uFF08\u6807\u8BB0-\u6E05\u9664\uFF09\uFF1A \u56DE\u6536\u8FC7\u7A0B\u4E3B\u8981\u5206\u4E3A\u4E24\u4E2A\u9636\u6BB5\uFF0C\u7B2C\u4E00\u9636\u6BB5\u4E3A\u8FFD\u8E2A\uFF08Tracing\uFF09\u9636\u6BB5\uFF0C\u5373\u4ECE GC Root \u5F00\u59CB\u904D\u5386\u5BF9\u8C61\u56FE\uFF0C\u5E76\u6807\u8BB0\uFF08Mark\uFF09\u6240\u9047\u5230\u7684\u6BCF\u4E2A\u5BF9\u8C61\uFF0C\u7B2C\u4E8C\u9636\u6BB5\u4E3A\u6E05\u9664\uFF08Sweep\uFF09\u9636\u6BB5\uFF0C\u5373\u56DE\u6536\u5668\u68C0\u67E5\u5806\u4E2D\u6BCF\u4E00\u4E2A\u5BF9\u8C61\uFF0C\u5E76\u5C06\u6240\u6709\u672A\u88AB\u6807\u8BB0\u7684\u5BF9\u8C61\u8FDB\u884C\u56DE\u6536\uFF0C\u6574\u4E2A\u8FC7\u7A0B\u4E0D\u4F1A\u53D1\u751F\u5BF9\u8C61\u79FB\u52A8\u3002\u6574\u4E2A\u7B97\u6CD5\u5728\u4E0D\u540C\u7684\u5B9E\u73B0\u4E2D\u4F1A\u4F7F\u7528\u4E09\u8272\u62BD\u8C61\uFF08Tricolour Abstraction\uFF09\u3001\u4F4D\u56FE\u6807\u8BB0\uFF08BitMap\uFF09\u7B49\u6280\u672F\u6765\u63D0\u9AD8\u7B97\u6CD5\u7684\u6548\u7387\uFF0C\u5B58\u6D3B\u5BF9\u8C61\u8F83\u591A\u65F6\u8F83\u9AD8\u6548\u3002</p><p><strong>Mark-Compact</strong> \uFF08\u6807\u8BB0-\u6574\u7406\uFF09\uFF1A \u8FD9\u4E2A\u7B97\u6CD5\u7684\u4E3B\u8981\u76EE\u7684\u5C31\u662F\u89E3\u51B3\u5728\u975E\u79FB\u52A8\u5F0F\u56DE\u6536\u5668\u4E2D\u90FD\u4F1A\u5B58\u5728\u7684\u788E\u7247\u5316\u95EE\u9898\uFF0C\u4E5F\u5206\u4E3A\u4E24\u4E2A\u9636\u6BB5\uFF0C\u7B2C\u4E00\u9636\u6BB5\u4E0E Mark-Sweep \u7C7B\u4F3C\uFF0C\u7B2C\u4E8C\u9636\u6BB5\u5219\u4F1A\u5BF9\u5B58\u6D3B\u5BF9\u8C61\u6309\u7167\u6574\u7406\u987A\u5E8F\uFF08Compaction Order\uFF09\u8FDB\u884C\u6574\u7406\u3002\u4E3B\u8981\u5B9E\u73B0\u6709\u53CC\u6307\u9488\uFF08Two-Finger\uFF09\u56DE\u6536\u7B97\u6CD5\u3001\u6ED1\u52A8\u56DE\u6536\uFF08Lisp2\uFF09\u7B97\u6CD5\u548C\u5F15\u7EBF\u6574\u7406\uFF08Threaded Compaction\uFF09\u7B97\u6CD5\u7B49\u3002</p><p><strong>Copying</strong>\uFF08\u590D\u5236\uFF09\uFF1A \u5C06\u7A7A\u95F4\u5206\u4E3A\u4E24\u4E2A\u5927\u5C0F\u76F8\u540C\u7684 From \u548C To \u4E24\u4E2A\u534A\u533A\uFF0C\u540C\u4E00\u65F6\u95F4\u53EA\u4F1A\u4F7F\u7528\u5176\u4E2D\u4E00\u4E2A\uFF0C\u6BCF\u6B21\u8FDB\u884C\u56DE\u6536\u65F6\u5C06\u4E00\u4E2A\u534A\u533A\u7684\u5B58\u6D3B\u5BF9\u8C61\u901A\u8FC7\u590D\u5236\u7684\u65B9\u5F0F\u8F6C\u79FB\u5230\u53E6\u4E00\u4E2A\u534A\u533A\u3002\u6709\u9012\u5F52\uFF08Robert R. Fenichel \u548C Jerome C. Yochelson\u63D0\u51FA\uFF09\u548C\u8FED\u4EE3\uFF08Cheney \u63D0\u51FA\uFF09\u7B97\u6CD5\uFF0C\u4EE5\u53CA\u89E3\u51B3\u4E86\u524D\u4E24\u8005\u9012\u5F52\u6808\u3001\u7F13\u5B58\u884C\u7B49\u95EE\u9898\u7684\u8FD1\u4F3C\u4F18\u5148\u641C\u7D22\u7B97\u6CD5\u3002\u590D\u5236\u7B97\u6CD5\u53EF\u4EE5\u901A\u8FC7\u78B0\u649E\u6307\u9488\u7684\u65B9\u5F0F\u8FDB\u884C\u5FEB\u901F\u5730\u5206\u914D\u5185\u5B58\uFF0C\u4F46\u662F\u4E5F\u5B58\u5728\u7740\u7A7A\u95F4\u5229\u7528\u7387\u4E0D\u9AD8\u7684\u7F3A\u70B9\uFF0C\u53E6\u5916\u5C31\u662F\u5B58\u6D3B\u5BF9\u8C61\u6BD4\u8F83\u5927\u65F6\u590D\u5236\u7684\u6210\u672C\u6BD4\u8F83\u9AD8\u3002</p><p>\u4E09\u79CD\u7B97\u6CD5\u5728\u662F\u5426\u79FB\u52A8\u5BF9\u8C61\u3001\u7A7A\u95F4\u548C\u65F6\u95F4\u65B9\u9762\u7684\u4E00\u4E9B\u5BF9\u6BD4\uFF0C\u5047\u8BBE\u5B58\u6D3B\u5BF9\u8C61\u6570\u91CF\u4E3A <em>L</em>\u3001\u5806\u7A7A\u95F4\u5927\u5C0F\u4E3A <em>H</em>\uFF0C\u5219\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822212542576.png" alt="image-20220822212542576" loading="lazy"></p><p>\u628A mark\u3001sweep\u3001compaction\u3001copying \u8FD9\u51E0\u79CD\u52A8\u4F5C\u7684\u8017\u65F6\u653E\u5728\u4E00\u8D77\u770B\uFF0C\u5927\u81F4\u6709\u8FD9\u6837\u7684\u5173\u7CFB\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822212623171.png" alt="image-20220822212623171" loading="lazy"></p><p>\u867D\u7136 compaction \u4E0E copying \u90FD\u6D89\u53CA\u79FB\u52A8\u5BF9\u8C61\uFF0C\u4F46\u53D6\u51B3\u4E8E\u5177\u4F53\u7B97\u6CD5\uFF0Ccompaction \u53EF\u80FD\u8981\u5148\u8BA1\u7B97\u4E00\u6B21\u5BF9\u8C61\u7684\u76EE\u6807\u5730\u5740\uFF0C\u7136\u540E\u4FEE\u6B63\u6307\u9488\uFF0C\u6700\u540E\u518D\u79FB\u52A8\u5BF9\u8C61\u3002copying \u5219\u53EF\u4EE5\u628A\u8FD9\u51E0\u4EF6\u4E8B\u60C5\u5408\u4E3A\u4E00\u4F53\u6765\u505A\uFF0C\u6240\u4EE5\u53EF\u4EE5\u5FEB\u4E00\u4E9B\u3002\u53E6\u5916\uFF0C\u8FD8\u9700\u8981\u7559\u610F GC \u5E26\u6765\u7684\u5F00\u9500\u4E0D\u80FD\u53EA\u770B Collector \u7684\u8017\u65F6\uFF0C\u8FD8\u5F97\u770B Allocator \u3002\u5982\u679C\u80FD\u4FDD\u8BC1\u5185\u5B58\u6CA1\u788E\u7247\uFF0C\u5206\u914D\u5C31\u53EF\u4EE5\u7528 pointer bumping \u65B9\u5F0F\uFF0C\u53EA\u9700\u8981\u632A\u4E00\u4E2A\u6307\u9488\u5C31\u5B8C\u6210\u4E86\u5206\u914D\uFF0C\u975E\u5E38\u5FEB\u3002\u800C\u5982\u679C\u5185\u5B58\u6709\u788E\u7247\u5C31\u5F97\u7528 freelist \u4E4B\u7C7B\u7684\u65B9\u5F0F\u7BA1\u7406\uFF0C\u5206\u914D\u901F\u5EA6\u901A\u5E38\u4F1A\u6162\u4E00\u4E9B\u3002</p><h3 id="_2-5-\u6536\u96C6\u5668" tabindex="-1"><a class="header-anchor" href="#_2-5-\u6536\u96C6\u5668" aria-hidden="true">#</a> 2.5 \u6536\u96C6\u5668</h3>',24),_=s("\u76EE\u524D\u5728 Hotspot VM \u4E2D\u4E3B\u8981\u6709\u5206\u4EE3\u6536\u96C6\u548C\u5206\u533A\u6536\u96C6\u4E24\u5927\u7C7B\uFF0C\u5177\u4F53\u53EF\u4EE5\u770B\u4E0B\u9762\u7684\u8FD9\u4E2A\u56FE\uFF0C\u4E0D\u8FC7\u672A\u6765\u4F1A\u9010\u6E10\u5411\u5206\u533A\u6536\u96C6\u53D1\u5C55\u3002\u5728\u7F8E\u56E2\u5185\u90E8\uFF0C\u6709\u90E8\u5206\u4E1A\u52A1\u5C1D\u8BD5\u7528\u4E86 ZGC\uFF08\u611F\u5174\u8DA3\u7684\u540C\u5B66\u53EF\u4EE5\u5B66\u4E60\u4E0B\u8FD9\u7BC7\u6587\u7AE0 "),h={href:"https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html",target:"_blank",rel:"noopener noreferrer"},f=s("\u65B0\u4E00\u4EE3\u5783\u573E\u56DE\u6536\u5668ZGC\u7684\u63A2\u7D22\u4E0E\u5B9E\u8DF5"),C=s("\uFF09\uFF0C\u5176\u4F59\u57FA\u672C\u90FD\u505C\u7559\u5728 CMS \u548C G1 \u4E0A\u3002\u53E6\u5916\u5728 JDK11 \u540E\u63D0\u4F9B\u4E86\u4E00\u4E2A\u4E0D\u6267\u884C\u4EFB\u4F55\u5783\u573E\u56DE\u6536\u52A8\u4F5C\u7684\u56DE\u6536\u5668 Epsilon\uFF08A No-Op Garbage Collector\uFF09\u7528\u4F5C\u6027\u80FD\u5206\u6790\u3002\u53E6\u5916\u4E00\u4E2A\u5C31\u662F Azul \u7684 Zing JVM\uFF0C\u5176 C4\uFF08Concurrent Continuously Compacting Collector\uFF09\u6536\u96C6\u5668\u4E5F\u5728\u4E1A\u5185\u6709\u4E00\u5B9A\u7684\u5F71\u54CD\u529B\u3002"),y=n("p",null,[n("img",{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822212830964.png",alt:"image-20220822212830964",loading:"lazy"})],-1),M=n("h4",{id:"_2-5-1-\u5206\u4EE3\u6536\u96C6\u5668",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-5-1-\u5206\u4EE3\u6536\u96C6\u5668","aria-hidden":"true"},"#"),s(" 2.5.1 \u5206\u4EE3\u6536\u96C6\u5668")],-1),w=n("li",null,[n("strong",null,"ParNew"),s("\uFF1A \u4E00\u6B3E\u591A\u7EBF\u7A0B\u7684\u6536\u96C6\u5668\uFF0C\u91C7\u7528\u590D\u5236\u7B97\u6CD5\uFF0C\u4E3B\u8981\u5DE5\u4F5C\u5728 Young \u533A\uFF0C\u53EF\u4EE5\u901A\u8FC7 "),n("code",null,"-XX:ParallelGCThreads"),s(" \u53C2\u6570\u6765\u63A7\u5236\u6536\u96C6\u7684\u7EBF\u7A0B\u6570\uFF0C\u6574\u4E2A\u8FC7\u7A0B\u90FD\u662F STW \u7684\uFF0C\u5E38\u4E0E CMS \u7EC4\u5408\u4F7F\u7528\u3002")],-1),G=n("strong",null,"CMS",-1),S=s("\uFF1A \u4EE5\u83B7\u53D6\u6700\u77ED\u56DE\u6536\u505C\u987F\u65F6\u95F4\u4E3A\u76EE\u6807\uFF0C\u91C7\u7528\u201C\u6807\u8BB0-\u6E05\u9664\u201D\u7B97\u6CD5\uFF0C\u5206 4 \u5927\u6B65\u8FDB\u884C\u5783\u573E\u6536\u96C6\uFF0C\u5176\u4E2D\u521D\u59CB\u6807\u8BB0\u548C\u91CD\u65B0\u6807\u8BB0\u4F1A STW \uFF0C\u591A\u6570\u5E94\u7528\u4E8E\u4E92\u8054\u7F51\u7AD9\u6216\u8005 B/S \u7CFB\u7EDF\u7684\u670D\u52A1\u5668\u7AEF\u4E0A\uFF0CJDK9 \u88AB\u6807\u8BB0\u5F03\u7528\uFF0CJDK14 \u88AB\u5220\u9664\uFF0C\u8BE6\u60C5\u53EF\u89C1 "),q={href:"https://openjdk.java.net/jeps/363",target:"_blank",rel:"noopener noreferrer"},z=s("JEP 363 (opens new window)"),T=s("\u3002"),x=p('<h4 id="_2-5-2-\u5206\u533A\u6536\u96C6\u5668" tabindex="-1"><a class="header-anchor" href="#_2-5-2-\u5206\u533A\u6536\u96C6\u5668" aria-hidden="true">#</a> 2.5.2 \u5206\u533A\u6536\u96C6\u5668</h4><ul><li><strong>G1</strong>\uFF1A \u4E00\u79CD\u670D\u52A1\u5668\u7AEF\u7684\u5783\u573E\u6536\u96C6\u5668\uFF0C\u5E94\u7528\u5728\u591A\u5904\u7406\u5668\u548C\u5927\u5BB9\u91CF\u5185\u5B58\u73AF\u5883\u4E2D\uFF0C\u5728\u5B9E\u73B0\u9AD8\u541E\u5410\u91CF\u7684\u540C\u65F6\uFF0C\u5C3D\u53EF\u80FD\u5730\u6EE1\u8DB3\u5783\u573E\u6536\u96C6\u6682\u505C\u65F6\u95F4\u7684\u8981\u6C42\u3002</li><li><strong>ZGC</strong>\uFF1A JDK11 \u4E2D\u63A8\u51FA\u7684\u4E00\u6B3E\u4F4E\u5EF6\u8FDF\u5783\u573E\u56DE\u6536\u5668\uFF0C\u9002\u7528\u4E8E\u5927\u5185\u5B58\u4F4E\u5EF6\u8FDF\u670D\u52A1\u7684\u5185\u5B58\u7BA1\u7406\u548C\u56DE\u6536\uFF0CSPECjbb 2015 \u57FA\u51C6\u6D4B\u8BD5\uFF0C\u5728 128G \u7684\u5927\u5806\u4E0B\uFF0C\u6700\u5927\u505C\u987F\u65F6\u95F4\u624D 1.68 ms\uFF0C\u505C\u987F\u65F6\u95F4\u8FDC\u80DC\u4E8E G1 \u548C CMS\u3002</li><li><strong>Shenandoah</strong>\uFF1A \u7531 Red Hat \u7684\u4E00\u4E2A\u56E2\u961F\u8D1F\u8D23\u5F00\u53D1\uFF0C\u4E0E G1 \u7C7B\u4F3C\uFF0C\u57FA\u4E8E Region \u8BBE\u8BA1\u7684\u5783\u573E\u6536\u96C6\u5668\uFF0C\u4F46\u4E0D\u9700\u8981 Remember Set \u6216\u8005 Card Table \u6765\u8BB0\u5F55\u8DE8 Region \u5F15\u7528\uFF0C\u505C\u987F\u65F6\u95F4\u548C\u5806\u7684\u5927\u5C0F\u6CA1\u6709\u4EFB\u4F55\u5173\u7CFB\u3002\u505C\u987F\u65F6\u95F4\u4E0E ZGC \u63A5\u8FD1\uFF0C\u4E0B\u56FE\u4E3A\u4E0E CMS \u548C G1 \u7B49\u6536\u96C6\u5668\u7684 benchmark\u3002</li></ul><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822213120689.png" alt="image-20220822213120689" loading="lazy"></p><h4 id="_2-5-3-\u5E38\u7528\u6536\u96C6\u5668" tabindex="-1"><a class="header-anchor" href="#_2-5-3-\u5E38\u7528\u6536\u96C6\u5668" aria-hidden="true">#</a> 2.5.3 \u5E38\u7528\u6536\u96C6\u5668</h4><p>\u76EE\u524D\u4F7F\u7528\u6700\u591A\u7684\u662F CMS \u548C G1 \u6536\u96C6\u5668\uFF0C\u4E8C\u8005\u90FD\u6709\u5206\u4EE3\u7684\u6982\u5FF5\uFF0C\u4E3B\u8981\u5185\u5B58\u7ED3\u6784\u5982\u4E0B\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822213231215.png" alt="image-20220822213231215" loading="lazy"></p><h4 id="_2-5-4-\u5176\u4ED6\u6536\u96C6\u5668" tabindex="-1"><a class="header-anchor" href="#_2-5-4-\u5176\u4ED6\u6536\u96C6\u5668" aria-hidden="true">#</a> 2.5.4 \u5176\u4ED6\u6536\u96C6\u5668</h4><p>\u4EE5\u4E0A\u4EC5\u5217\u51FA\u5E38\u89C1\u6536\u96C6\u5668\uFF0C\u9664\u6B64\u4E4B\u5916\u8FD8\u6709\u5F88\u591A\uFF0C\u5982 Metronome\u3001Stopless\u3001Staccato\u3001Chicken\u3001Clover \u7B49\u5B9E\u65F6\u56DE\u6536\u5668\uFF0CSapphire\u3001Compressor\u3001Pauseless \u7B49\u5E76\u53D1\u590D\u5236/\u6574\u7406\u56DE\u6536\u5668\uFF0CDoligez-Leroy-Conthier \u7B49\u6807\u8BB0\u6574\u7406\u56DE\u6536\u5668\uFF0C\u7531\u4E8E\u7BC7\u5E45\u539F\u56E0\uFF0C\u4E0D\u5728\u6B64\u4E00\u4E00\u4ECB\u7ECD\u3002</p><h3 id="_2-6-\u5E38\u7528\u5DE5\u5177" tabindex="-1"><a class="header-anchor" href="#_2-6-\u5E38\u7528\u5DE5\u5177" aria-hidden="true">#</a> 2.6 \u5E38\u7528\u5DE5\u5177</h3><p>\u5DE5\u6B32\u5584\u5176\u4E8B\uFF0C\u5FC5\u5148\u5229\u5176\u5668\uFF0C\u6B64\u5904\u5217\u51FA\u4E00\u4E9B\u7B14\u8005\u5E38\u7528\u7684\u5DE5\u5177\uFF0C\u5177\u4F53\u60C5\u51B5\u5927\u5BB6\u53EF\u4EE5\u81EA\u7531\u9009\u62E9\uFF0C\u672C\u6587\u7684\u95EE\u9898\u90FD\u662F\u4F7F\u7528\u8FD9\u4E9B\u5DE5\u5177\u6765\u5B9A\u4F4D\u548C\u5206\u6790\u7684\u3002</p><h4 id="_2-6-1-\u547D\u4EE4\u884C\u7EC8\u7AEF" tabindex="-1"><a class="header-anchor" href="#_2-6-1-\u547D\u4EE4\u884C\u7EC8\u7AEF" aria-hidden="true">#</a> 2.6.1 \u547D\u4EE4\u884C\u7EC8\u7AEF</h4><ul><li>\u6807\u51C6\u7EC8\u7AEF\u7C7B\uFF1Ajps\u3001jinfo\u3001jstat\u3001jstack\u3001jmap</li><li>\u529F\u80FD\u6574\u5408\u7C7B\uFF1Ajcmd\u3001vjtools\u3001arthas\u3001greys</li></ul><h4 id="_2-6-2-\u53EF\u89C6\u5316\u754C\u9762" tabindex="-1"><a class="header-anchor" href="#_2-6-2-\u53EF\u89C6\u5316\u754C\u9762" aria-hidden="true">#</a> 2.6.2 \u53EF\u89C6\u5316\u754C\u9762</h4>',13),O=n("li",null,"\u7B80\u6613\uFF1AJConsole\u3001JVisualvm\u3001HA\u3001GCHisto\u3001GCViewer",-1),I=n("li",null,"\u8FDB\u9636\uFF1AMAT\u3001JProfiler",-1),R=s("\u547D\u4EE4\u884C\u63A8\u8350 "),J={href:"https://pdai.tech/md/java/jvm/java-jvm-agent-arthas.html",target:"_blank",rel:"noopener noreferrer"},F=s("arthas"),N=s(" \uFF0C\u53EF\u89C6\u5316\u754C\u9762\u63A8\u8350 JProfiler\uFF0C\u6B64\u5916\u8FD8\u6709\u4E00\u4E9B\u5728\u7EBF\u7684\u5E73\u53F0 gceasy\u3001heaphero\u3001fastthread \uFF0C\u7F8E\u56E2\u5185\u90E8\u7684 Scalpel\uFF08\u4E00\u6B3E\u81EA\u7814\u7684 JVM \u95EE\u9898\u8BCA\u65AD\u5DE5\u5177\uFF0C\u6682\u65F6\u672A\u5F00\u6E90\uFF09\u4E5F\u6BD4\u8F83\u597D\u7528\u3002"),X=p(`<h2 id="_3-gc-\u95EE\u9898\u5224\u65AD" tabindex="-1"><a class="header-anchor" href="#_3-gc-\u95EE\u9898\u5224\u65AD" aria-hidden="true">#</a> 3. GC \u95EE\u9898\u5224\u65AD</h2><p>\u5728\u505A GC \u95EE\u9898\u6392\u67E5\u548C\u4F18\u5316\u4E4B\u524D\uFF0C\u6211\u4EEC\u9700\u8981\u5148\u6765\u660E\u786E\u4E0B\u5230\u5E95\u662F\u4E0D\u662F GC \u76F4\u63A5\u5BFC\u81F4\u7684\u95EE\u9898\uFF0C\u6216\u8005\u5E94\u7528\u4EE3\u7801\u5BFC\u81F4\u7684 GC \u5F02\u5E38\uFF0C\u6700\u7EC8\u51FA\u73B0\u95EE\u9898\u3002</p><h3 id="_3-1-\u5224\u65AD-gc-\u6709\u6CA1\u6709\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_3-1-\u5224\u65AD-gc-\u6709\u6CA1\u6709\u95EE\u9898" aria-hidden="true">#</a> 3.1 \u5224\u65AD GC \u6709\u6CA1\u6709\u95EE\u9898\uFF1F</h3><h4 id="_3-1-1-\u8BBE\u5B9A\u8BC4\u4EF7\u6807\u51C6" tabindex="-1"><a class="header-anchor" href="#_3-1-1-\u8BBE\u5B9A\u8BC4\u4EF7\u6807\u51C6" aria-hidden="true">#</a> 3.1.1 \u8BBE\u5B9A\u8BC4\u4EF7\u6807\u51C6</h4><p>\u8BC4\u5224 GC \u7684\u4E24\u4E2A\u6838\u5FC3\u6307\u6807\uFF1A</p><ul><li><strong>\u5EF6\u8FDF\uFF08Latency\uFF09</strong>\uFF1A \u4E5F\u53EF\u4EE5\u7406\u89E3\u4E3A\u6700\u5927\u505C\u987F\u65F6\u95F4\uFF0C\u5373\u5783\u573E\u6536\u96C6\u8FC7\u7A0B\u4E2D\u4E00\u6B21 STW \u7684\u6700\u957F\u65F6\u95F4\uFF0C\u8D8A\u77ED\u8D8A\u597D\uFF0C\u4E00\u5B9A\u7A0B\u5EA6\u4E0A\u53EF\u4EE5\u63A5\u53D7\u9891\u6B21\u7684\u589E\u5927\uFF0CGC \u6280\u672F\u7684\u4E3B\u8981\u53D1\u5C55\u65B9\u5411\u3002</li><li><strong>\u541E\u5410\u91CF\uFF08Throughput\uFF09</strong>\uFF1A \u5E94\u7528\u7CFB\u7EDF\u7684\u751F\u547D\u5468\u671F\u5185\uFF0C\u7531\u4E8E GC \u7EBF\u7A0B\u4F1A\u5360\u7528 Mutator \u5F53\u524D\u53EF\u7528\u7684 CPU \u65F6\u949F\u5468\u671F\uFF0C\u541E\u5410\u91CF\u5373\u4E3A Mutator \u6709\u6548\u82B1\u8D39\u7684\u65F6\u95F4\u5360\u7CFB\u7EDF\u603B\u8FD0\u884C\u65F6\u95F4\u7684\u767E\u5206\u6BD4\uFF0C\u4F8B\u5982\u7CFB\u7EDF\u8FD0\u884C\u4E86 100 min\uFF0CGC \u8017\u65F6 1 min\uFF0C\u5219\u7CFB\u7EDF\u541E\u5410\u91CF\u4E3A 99%\uFF0C\u541E\u5410\u91CF\u4F18\u5148\u7684\u6536\u96C6\u5668\u53EF\u4EE5\u63A5\u53D7\u8F83\u957F\u7684\u505C\u987F\u3002</li></ul><p>\u76EE\u524D\u5404\u5927\u4E92\u8054\u7F51\u516C\u53F8\u7684\u7CFB\u7EDF\u57FA\u672C\u90FD\u66F4\u8FFD\u6C42\u4F4E\u5EF6\u65F6\uFF0C\u907F\u514D\u4E00\u6B21 GC \u505C\u987F\u7684\u65F6\u95F4\u8FC7\u957F\u5BF9\u7528\u6237\u4F53\u9A8C\u9020\u6210\u635F\u5931\uFF0C\u8861\u91CF\u6307\u6807\u9700\u8981\u7ED3\u5408\u4E00\u4E0B\u5E94\u7528\u670D\u52A1\u7684 SLA\uFF0C\u4E3B\u8981\u5982\u4E0B\u4E24\u70B9\u6765\u5224\u65AD\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822213934694.png" alt="image-20220822213934694" loading="lazy"></p><p>\u7B80\u800C\u8A00\u4E4B\uFF0C\u5373\u4E3A\u4E00\u6B21\u505C\u987F\u7684\u65F6\u95F4\u4E0D\u8D85\u8FC7\u5E94\u7528\u670D\u52A1\u7684 TP9999\uFF0CGC \u7684\u541E\u5410\u91CF\u4E0D\u5C0F\u4E8E 99.99%\u3002\u4E3E\u4E2A\u4F8B\u5B50\uFF0C\u5047\u8BBE\u67D0\u4E2A\u670D\u52A1 A \u7684 TP9999 \u4E3A 80 ms\uFF0C\u5E73\u5747 GC \u505C\u987F\u4E3A 30 ms\uFF0C\u90A3\u4E48\u8BE5\u670D\u52A1\u7684\u6700\u5927\u505C\u987F\u65F6\u95F4\u6700\u597D\u4E0D\u8981\u8D85\u8FC7 80 ms\uFF0CGC \u9891\u6B21\u63A7\u5236\u5728 5 min \u4EE5\u4E0A\u4E00\u6B21\u3002\u5982\u679C\u6EE1\u8DB3\u4E0D\u4E86\uFF0C\u90A3\u5C31\u9700\u8981\u8C03\u4F18\u6216\u8005\u901A\u8FC7\u66F4\u591A\u8D44\u6E90\u6765\u8FDB\u884C\u5E76\u8054\u5197\u4F59\u3002\uFF08\u5927\u5BB6\u53EF\u4EE5\u5148\u505C\u4E0B\u6765\uFF0C\u770B\u770B\u76D1\u63A7\u5E73\u53F0\u4E0A\u9762\u7684 gc.meantime \u5206\u949F\u7EA7\u522B\u6307\u6807\uFF0C\u5982\u679C\u8D85\u8FC7\u4E86 6 ms \u90A3\u5355\u673A GC \u541E\u5410\u91CF\u5C31\u8FBE\u4E0D\u5230 4 \u4E2A 9 \u4E86\u3002\uFF09</p><blockquote><p>\u5907\u6CE8\uFF1A\u9664\u4E86\u8FD9\u4E24\u4E2A\u6307\u6807\u4E4B\u5916\u8FD8\u6709 Footprint\uFF08\u8D44\u6E90\u91CF\u5927\u5C0F\u6D4B\u91CF\uFF09\u3001\u53CD\u5E94\u901F\u5EA6\u7B49\u6307\u6807\uFF0C\u4E92\u8054\u7F51\u8FD9\u79CD\u5B9E\u65F6\u7CFB\u7EDF\u8FFD\u6C42\u4F4E\u5EF6\u8FDF\uFF0C\u800C\u5F88\u591A\u5D4C\u5165\u5F0F\u7CFB\u7EDF\u5219\u8FFD\u6C42 Footprint\u3002</p></blockquote><h4 id="_3-1-2-\u8BFB\u61C2-gc-cause" tabindex="-1"><a class="header-anchor" href="#_3-1-2-\u8BFB\u61C2-gc-cause" aria-hidden="true">#</a> 3.1.2 \u8BFB\u61C2 GC Cause</h4><p>\u62FF\u5230 GC \u65E5\u5FD7\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u7B80\u5355\u5206\u6790 GC \u60C5\u51B5\u4E86\uFF0C\u901A\u8FC7\u4E00\u4E9B\u5DE5\u5177\uFF0C\u6211\u4EEC\u53EF\u4EE5\u6BD4\u8F83\u76F4\u89C2\u5730\u770B\u5230 Cause \u7684\u5206\u5E03\u60C5\u51B5\uFF0C\u5982\u4E0B\u56FE\u5C31\u662F\u4F7F\u7528 gceasy \u7ED8\u5236\u7684\u56FE\u8868\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822214214978.png" alt="image-20220822214214978" loading="lazy"></p><p>\u5982\u4E0A\u56FE\u6240\u793A\uFF0C\u6211\u4EEC\u5F88\u6E05\u6670\u7684\u5C31\u80FD\u77E5\u9053\u662F\u4EC0\u4E48\u539F\u56E0\u5F15\u8D77\u7684 GC\uFF0C\u4EE5\u53CA\u6BCF\u6B21\u7684\u65F6\u95F4\u82B1\u8D39\u60C5\u51B5\uFF0C\u4F46\u662F\u8981\u5206\u6790 GC \u7684\u95EE\u9898\uFF0C\u5148\u8981\u8BFB\u61C2 GC Cause\uFF0C\u5373 JVM \u4EC0\u4E48\u6837\u7684\u6761\u4EF6\u4E0B\u9009\u62E9\u8FDB\u884C GC \u64CD\u4F5C\uFF0C\u5177\u4F53 Cause \u7684\u5206\u7C7B\u53EF\u4EE5\u770B\u4E00\u4E0B Hotspot \u6E90\u7801\uFF1A<code>src/share/vm/gc/shared/gcCause.hpp \u548C src/share/vm/gc/shared/gcCause.cpp</code> \u4E2D\u3002</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token class-name">GCCause</span><span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>GCCause<span class="token double-colon punctuation">::</span>Cause cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> _java_lang_system_gc<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;System.gc()&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _full_gc_alot<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;FullGCAlot&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _scavenge_alot<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;ScavengeAlot&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _allocation_profiler<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Allocation Profiler&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _jvmti_force_gc<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;JvmtiEnv ForceGarbageCollection&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _gc_locker<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;GCLocker Initiated GC&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _heap_inspection<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Heap Inspection Initiated GC&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _heap_dump<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Heap Dump Initiated GC&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _wb_young_gc<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;WhiteBox Initiated Young GC&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _wb_conc_mark<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;WhiteBox Initiated Concurrent Mark&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _wb_full_gc<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;WhiteBox Initiated Full GC&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _no_gc<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;No GC&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _allocation_failure<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Allocation Failure&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _tenured_generation_full<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Tenured Generation Full&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _metadata_GC_threshold<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Metadata GC Threshold&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _metadata_GC_clear_soft_refs<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Metadata GC Clear Soft References&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _cms_generation_full<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;CMS Generation Full&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _cms_initial_mark<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;CMS Initial Mark&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _cms_final_remark<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;CMS Final Remark&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _cms_concurrent_mark<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;CMS Concurrent Mark&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _old_generation_expanded_on_last_scavenge<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Old Generation Expanded On Last Scavenge&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _old_generation_too_full_to_scavenge<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Old Generation Too Full To Scavenge&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _adaptive_size_policy<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Ergonomics&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _g1_inc_collection_pause<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;G1 Evacuation Pause&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _g1_humongous_allocation<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;G1 Humongous Allocation&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _dcmd_gc_run<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;Diagnostic Command&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> _last_gc_cause<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;ILLEGAL VALUE - last gc cause - ILLEGAL VALUE&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token string">&quot;unknown GCCause&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u91CD\u70B9\u9700\u8981\u5173\u6CE8\u7684\u51E0\u4E2AGC Cause\uFF1A</p><ul><li><code>System.gc()</code>\uFF1A \u624B\u52A8\u89E6\u53D1GC\u64CD\u4F5C\u3002</li><li><code>CMS</code>\uFF1A CMS GC \u5728\u6267\u884C\u8FC7\u7A0B\u4E2D\u7684\u4E00\u4E9B\u52A8\u4F5C\uFF0C\u91CD\u70B9\u5173\u6CE8 CMS Initial Mark \u548C CMS Final Remark \u4E24\u4E2A STW \u9636\u6BB5\u3002</li><li><code>Promotion Failure</code>\uFF1A Old \u533A\u6CA1\u6709\u8DB3\u591F\u7684\u7A7A\u95F4\u5206\u914D\u7ED9 Young \u533A\u664B\u5347\u7684\u5BF9\u8C61\uFF08\u5373\u4F7F\u603B\u53EF\u7528\u5185\u5B58\u8DB3\u591F\u5927\uFF09\u3002</li><li><code>Concurrent Mode Failure</code>\uFF1A CMS GC \u8FD0\u884C\u671F\u95F4\uFF0COld \u533A\u9884\u7559\u7684\u7A7A\u95F4\u4E0D\u8DB3\u4EE5\u5206\u914D\u7ED9\u65B0\u7684\u5BF9\u8C61\uFF0C\u6B64\u65F6\u6536\u96C6\u5668\u4F1A\u53D1\u751F\u9000\u5316\uFF0C\u4E25\u91CD\u5F71\u54CD GC \u6027\u80FD\uFF0C\u4E0B\u9762\u7684\u4E00\u4E2A\u6848\u4F8B\u5373\u4E3A\u8FD9\u79CD\u573A\u666F\u3002</li><li><code>GCLocker Initiated GC</code>\uFF1A \u5982\u679C\u7EBF\u7A0B\u6267\u884C\u5728 JNI \u4E34\u754C\u533A\u65F6\uFF0C\u521A\u597D\u9700\u8981\u8FDB\u884C GC\uFF0C\u6B64\u65F6 GC Locker \u5C06\u4F1A\u963B\u6B62 GC \u7684\u53D1\u751F\uFF0C\u540C\u65F6\u963B\u6B62\u5176\u4ED6\u7EBF\u7A0B\u8FDB\u5165 JNI \u4E34\u754C\u533A\uFF0C\u76F4\u5230\u6700\u540E\u4E00\u4E2A\u7EBF\u7A0B\u9000\u51FA\u4E34\u754C\u533A\u65F6\u89E6\u53D1\u4E00\u6B21 GC\u3002</li></ul><p>\u4EC0\u4E48\u65F6\u673A\u4F7F\u7528\u8FD9\u4E9B Cause \u89E6\u53D1\u56DE\u6536\uFF0C\u5927\u5BB6\u53EF\u4EE5\u770B\u4E00\u4E0B CMS \u7684\u4EE3\u7801\uFF0C\u8FD9\u91CC\u5C31\u4E0D\u8BA8\u8BBA\u4E86\uFF0C\u5177\u4F53\u5728 <code>/src/hotspot/share/gc/cms/concurrentMarkSweepGeneration.cpp</code> \u4E2D\u3002</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">CMSCollector</span><span class="token double-colon punctuation">::</span><span class="token function">shouldConcurrentCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">LogTarget</span><span class="token punctuation">(</span>Trace<span class="token punctuation">,</span> gc<span class="token punctuation">)</span> log<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_full_gc_requested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because of explicit  gc request (or GCLocker)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FreelistLocker <span class="token function">x</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ------------------------------------------------------------------</span>
  <span class="token comment">// Print out lots of information which affects the initiation of</span>
  <span class="token comment">// a collection.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">is_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector shouldConcurrentCollect: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    LogStream <span class="token function">out</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;time_until_cms_gen_full %3.7f&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">time_until_cms_gen_full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;free=&quot;</span> SIZE_FORMAT<span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;contiguous_available=&quot;</span> SIZE_FORMAT<span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">contiguous_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;promotion_rate=%g&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promotion_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;cms_allocation_rate=%g&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_allocation_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;occupancy=%3.7f&quot;</span><span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;initiatingOccupancy=%3.7f&quot;</span><span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">initiating_occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;cms_time_since_begin=%3.7f&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;cms_time_since_end=%3.7f&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;metadata initialized %d&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">should_concurrent_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ------------------------------------------------------------------</span>

  <span class="token comment">// If the estimated time to complete a cms collection (cms_duration())</span>
  <span class="token comment">// is less than the estimated time remaining until the cms generation</span>
  <span class="token comment">// is full, start a collection.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>UseCMSInitiatingOccupancyOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">time_until_cms_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_cmsGen<span class="token operator">-&gt;</span><span class="token function">occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> _bootstrap_occupancy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot; CMSCollector: collect for bootstrapping statistics: occupancy = %f, boot occupancy = %f&quot;</span><span class="token punctuation">,</span>
                  _cmsGen<span class="token operator">-&gt;</span><span class="token function">occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _bootstrap_occupancy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_cmsGen<span class="token operator">-&gt;</span><span class="token function">should_concurrent_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMS old gen initiated&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  CMSHeap<span class="token operator">*</span> heap <span class="token operator">=</span> <span class="token class-name">CMSHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span><span class="token function">incremental_collection_will_fail</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* consult_young */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because incremental collection will fail &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">should_concurrent_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect for metadata allocation &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// CMSTriggerInterval starts a CMS cycle if enough time has passed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CMSTriggerInterval <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CMSTriggerInterval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Trigger always</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check the CMS time since begin (we do not check the stats validity</span>
    <span class="token comment">// as we want to be able to trigger the first CMS cycle as well)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>CMSTriggerInterval <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> MILLIUNITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because of trigger interval (time since last begin %3.7f secs)&quot;</span><span class="token punctuation">,</span>
                  <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because of trigger interval (first collection)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-\u5224\u65AD\u662F\u4E0D\u662F-gc-\u5F15\u53D1\u7684\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_3-2-\u5224\u65AD\u662F\u4E0D\u662F-gc-\u5F15\u53D1\u7684\u95EE\u9898" aria-hidden="true">#</a> 3.2 \u5224\u65AD\u662F\u4E0D\u662F GC \u5F15\u53D1\u7684\u95EE\u9898\uFF1F</h3><p>\u5230\u5E95\u662F\u7ED3\u679C\uFF08\u73B0\u8C61\uFF09\u8FD8\u662F\u539F\u56E0\uFF0C\u5728\u4E00\u6B21 GC \u95EE\u9898\u5904\u7406\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u5982\u4F55\u5224\u65AD\u662F GC \u5BFC\u81F4\u7684\u6545\u969C\uFF0C\u8FD8\u662F\u7CFB\u7EDF\u672C\u8EAB\u5F15\u53D1 GC \u95EE\u9898\u3002\u8FD9\u91CC\u7EE7\u7EED\u62FF\u5728\u672C\u6587\u5F00\u5934\u63D0\u5230\u7684\u4E00\u4E2A Case\uFF1A\u201CGC \u8017\u65F6\u589E\u5927\u3001\u7EBF\u7A0B Block \u589E\u591A\u3001\u6162\u67E5\u8BE2\u589E\u591A\u3001CPU \u8D1F\u8F7D\u9AD8\u7B49\u56DB\u4E2A\u8868\u8C61\uFF0C\u5982\u4F55\u5224\u65AD\u54EA\u4E2A\u662F\u6839\u56E0\uFF1F\u201D\uFF0C\u7B14\u8005\u8FD9\u91CC\u6839\u636E\u81EA\u5DF1\u7684\u7ECF\u9A8C\u5927\u81F4\u6574\u7406\u4E86\u56DB\u79CD\u5224\u65AD\u65B9\u6CD5\u4F9B\u53C2\u8003\uFF1A</p><ul><li><strong>\u65F6\u5E8F\u5206\u6790</strong>\uFF1A \u5148\u53D1\u751F\u7684\u4E8B\u4EF6\u662F\u6839\u56E0\u7684\u6982\u7387\u66F4\u5927\uFF0C\u901A\u8FC7\u76D1\u63A7\u624B\u6BB5\u5206\u6790\u5404\u4E2A\u6307\u6807\u7684\u5F02\u5E38\u65F6\u95F4\u70B9\uFF0C\u8FD8\u539F\u4E8B\u4EF6\u65F6\u95F4\u7EBF\uFF0C\u5982\u5148\u89C2\u5BDF\u5230 CPU \u8D1F\u8F7D\u9AD8\uFF08\u8981\u6709\u8DB3\u591F\u7684\u65F6\u95F4 Gap\uFF09\uFF0C\u90A3\u4E48\u6574\u4E2A\u95EE\u9898\u5F71\u54CD\u94FE\u5C31\u53EF\u80FD\u662F\uFF1ACPU \u8D1F\u8F7D\u9AD8 -&gt; \u6162\u67E5\u8BE2\u589E\u591A -&gt; GC \u8017\u65F6\u589E\u5927 -&gt; \u7EBF\u7A0BBlock\u589E\u591A -&gt; RT \u4E0A\u6DA8\u3002</li><li><strong>\u6982\u7387\u5206\u6790</strong>\uFF1A \u4F7F\u7528\u7EDF\u8BA1\u6982\u7387\u5B66\uFF0C\u7ED3\u5408\u5386\u53F2\u95EE\u9898\u7684\u7ECF\u9A8C\u8FDB\u884C\u63A8\u65AD\uFF0C\u7531\u8FD1\u5230\u8FDC\u6309\u7C7B\u578B\u5206\u6790\uFF0C\u5982\u8FC7\u5F80\u6162\u67E5\u7684\u95EE\u9898\u6BD4\u8F83\u591A\uFF0C\u90A3\u4E48\u6574\u4E2A\u95EE\u9898\u5F71\u54CD\u94FE\u5C31\u53EF\u80FD\u662F\uFF1A\u6162\u67E5\u8BE2\u589E\u591A -&gt; GC \u8017\u65F6\u589E\u5927 -&gt; CPU \u8D1F\u8F7D\u9AD8 -&gt; \u7EBF\u7A0B Block \u589E\u591A -&gt; RT\u4E0A\u6DA8\u3002</li><li><strong>\u5B9E\u9A8C\u5206\u6790</strong>\uFF1A \u901A\u8FC7\u6545\u969C\u6F14\u7EC3\u7B49\u65B9\u5F0F\u5BF9\u95EE\u9898\u73B0\u573A\u8FDB\u884C\u6A21\u62DF\uFF0C\u89E6\u53D1\u5176\u4E2D\u90E8\u5206\u6761\u4EF6\uFF08\u4E00\u4E2A\u6216\u591A\u4E2A\uFF09\uFF0C\u89C2\u5BDF\u662F\u5426\u4F1A\u53D1\u751F\u95EE\u9898\uFF0C\u5982\u53EA\u89E6\u53D1\u7EBF\u7A0B Block \u5C31\u4F1A\u53D1\u751F\u95EE\u9898\uFF0C\u90A3\u4E48\u6574\u4E2A\u95EE\u9898\u5F71\u54CD\u94FE\u5C31\u53EF\u80FD\u662F\uFF1A\u7EBF\u7A0BBlock\u589E\u591A -&gt; CPU \u8D1F\u8F7D\u9AD8 -&gt; \u6162\u67E5\u8BE2\u589E\u591A -&gt; GC \u8017\u65F6\u589E\u5927 -&gt; RT \u4E0A\u6DA8\u3002</li><li><strong>\u53CD\u8BC1\u5206\u6790</strong>\uFF1A \u5BF9\u5176\u4E2D\u67D0\u4E00\u8868\u8C61\u8FDB\u884C\u53CD\u8BC1\u5206\u6790\uFF0C\u5373\u5224\u65AD\u8868\u8C61\u7684\u53D1\u4E0D\u53D1\u751F\u8DDF\u7ED3\u679C\u662F\u5426\u6709\u76F8\u5173\u6027\uFF0C\u4F8B\u5982\u6211\u4EEC\u4ECE\u6574\u4E2A\u96C6\u7FA4\u7684\u89D2\u5EA6\u89C2\u5BDF\u5230\u67D0\u4E9B\u8282\u70B9\u6162\u67E5\u548C CPU \u90FD\u6B63\u5E38\uFF0C\u4F46\u4E5F\u51FA\u4E86\u95EE\u9898\uFF0C\u90A3\u4E48\u6574\u4E2A\u95EE\u9898\u5F71\u54CD\u94FE\u5C31\u53EF\u80FD\u662F\uFF1AGC \u8017\u65F6\u589E\u5927 -&gt; \u7EBF\u7A0B Block \u589E\u591A -&gt; RT \u4E0A\u6DA8\u3002</li></ul><p>\u4E0D\u540C\u7684\u6839\u56E0\uFF0C\u540E\u7EED\u7684\u5206\u6790\u65B9\u6CD5\u662F\u5B8C\u5168\u4E0D\u540C\u7684\u3002\u5982\u679C\u662F CPU \u8D1F\u8F7D\u9AD8\u90A3\u53EF\u80FD\u9700\u8981\u7528\u706B\u7130\u56FE\u770B\u4E0B\u70ED\u70B9\u3001\u5982\u679C\u662F\u6162\u67E5\u8BE2\u589E\u591A\u90A3\u53EF\u80FD\u9700\u8981\u770B\u4E0B DB \u60C5\u51B5\u3001\u5982\u679C\u662F\u7EBF\u7A0B Block \u5F15\u8D77\u90A3\u53EF\u80FD\u9700\u8981\u770B\u4E0B\u9501\u7ADE\u4E89\u7684\u60C5\u51B5\uFF0C\u6700\u540E\u5982\u679C\u5404\u4E2A\u8868\u8C61\u8BC1\u660E\u90FD\u6CA1\u6709\u95EE\u9898\uFF0C\u90A3\u53EF\u80FD GC \u786E\u5B9E\u5B58\u5728\u95EE\u9898\uFF0C\u53EF\u4EE5\u7EE7\u7EED\u5206\u6790 GC \u95EE\u9898\u4E86\u3002</p><h3 id="_3-3-\u95EE\u9898\u5206\u7C7B\u5BFC\u8BFB" tabindex="-1"><a class="header-anchor" href="#_3-3-\u95EE\u9898\u5206\u7C7B\u5BFC\u8BFB" aria-hidden="true">#</a> 3.3 \u95EE\u9898\u5206\u7C7B\u5BFC\u8BFB</h3><h4 id="_3-3-1-mutator-\u7C7B\u578B" tabindex="-1"><a class="header-anchor" href="#_3-3-1-mutator-\u7C7B\u578B" aria-hidden="true">#</a> 3.3.1 Mutator \u7C7B\u578B</h4><p>Mutator \u7684\u7C7B\u578B\u6839\u636E\u5BF9\u8C61\u5B58\u6D3B\u65F6\u95F4\u6BD4\u4F8B\u56FE\u6765\u770B\u4E3B\u8981\u5206\u4E3A\u4E24\u79CD\uFF0C\u5728\u5F31\u5206\u4EE3\u5047\u8BF4\u4E2D\u4E5F\u63D0\u5230\u7C7B\u4F3C\u7684\u8BF4\u6CD5\uFF0C\u5982\u4E0B\u56FE\u6240\u793A \u201CSurvival Time\u201D \u8868\u793A\u5BF9\u8C61\u5B58\u6D3B\u65F6\u95F4\uFF0C\u201CRate\u201D \u8868\u793A\u5BF9\u8C61\u5206\u914D\u6BD4\u4F8B\uFF1A</p><ul><li><strong>IO \u4EA4\u4E92\u578B</strong>\uFF1A \u4E92\u8054\u7F51\u4E0A\u76EE\u524D\u5927\u90E8\u5206\u7684\u670D\u52A1\u90FD\u5C5E\u4E8E\u8BE5\u7C7B\u578B\uFF0C\u4F8B\u5982\u5206\u5E03\u5F0F RPC\u3001MQ\u3001HTTP \u7F51\u5173\u670D\u52A1\u7B49\uFF0C\u5BF9\u5185\u5B58\u8981\u6C42\u5E76\u4E0D\u5927\uFF0C\u5927\u90E8\u5206\u5BF9\u8C61\u5728 TP9999 \u7684\u65F6\u95F4\u5185\u90FD\u4F1A\u6B7B\u4EA1\uFF0C Young \u533A\u8D8A\u5927\u8D8A\u597D\u3002</li><li><strong>MEM \u8BA1\u7B97\u578B</strong>\uFF1A \u4E3B\u8981\u662F\u5206\u5E03\u5F0F\u6570\u636E\u8BA1\u7B97 Hadoop\uFF0C\u5206\u5E03\u5F0F\u5B58\u50A8 HBase\u3001Cassandra\uFF0C\u81EA\u5EFA\u7684\u5206\u5E03\u5F0F\u7F13\u5B58\u7B49\uFF0C\u5BF9\u5185\u5B58\u8981\u6C42\u9AD8\uFF0C\u5BF9\u8C61\u5B58\u6D3B\u65F6\u95F4\u957F\uFF0COld \u533A\u8D8A\u5927\u8D8A\u597D\u3002</li></ul><p>\u5F53\u7136\uFF0C\u9664\u4E86\u4E8C\u8005\u4E4B\u5916\u8FD8\u6709\u4ECB\u4E8E\u4E24\u8005\u4E4B\u95F4\u7684\u573A\u666F\uFF0C\u672C\u7BC7\u6587\u7AE0\u4E3B\u8981\u8BA8\u8BBA\u7B2C\u4E00\u79CD\u60C5\u51B5\u3002\u5BF9\u8C61 Survival Time \u5206\u5E03\u56FE\uFF0C\u5BF9\u6211\u4EEC\u8BBE\u7F6E GC \u53C2\u6570\u6709\u7740\u975E\u5E38\u91CD\u8981\u7684\u6307\u5BFC\u610F\u4E49\uFF0C\u5982\u4E0B\u56FE\u5C31\u53EF\u4EE5\u7B80\u5355\u63A8\u7B97\u5206\u4EE3\u7684\u8FB9\u754C\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822215245529.png" alt="image-20220822215245529" loading="lazy"></p><h4 id="_3-3-2-gc-\u95EE\u9898\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-3-2-gc-\u95EE\u9898\u5206\u7C7B" aria-hidden="true">#</a> 3.3.2 GC \u95EE\u9898\u5206\u7C7B</h4><p>\u7B14\u8005\u9009\u53D6\u4E86\u4E5D\u79CD\u4E0D\u540C\u7C7B\u578B\u7684 GC \u95EE\u9898\uFF0C\u8986\u76D6\u4E86\u5927\u90E8\u5206\u573A\u666F\uFF0C\u5982\u679C\u6709\u66F4\u597D\u7684\u573A\u666F\uFF0C\u6B22\u8FCE\u5728\u8BC4\u8BBA\u533A\u7ED9\u51FA\u3002</p><ul><li><strong>Unexpected GC</strong>\uFF1A \u610F\u5916\u53D1\u751F\u7684 GC\uFF0C\u5B9E\u9645\u4E0A\u4E0D\u9700\u8981\u53D1\u751F\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u4E00\u4E9B\u624B\u6BB5\u53BB\u907F\u514D\u3002 <ul><li><code>Space Shock</code>\uFF1A \u7A7A\u95F4\u9707\u8361\u95EE\u9898\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u4E00\uFF1A\u52A8\u6001\u6269\u5BB9\u5F15\u8D77\u7684\u7A7A\u95F4\u9707\u8361\u201D\u3002</li><li><code>Explicit GC</code>\uFF1A \u663E\u793A\u6267\u884C GC \u95EE\u9898\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u4E8C\uFF1A\u663E\u5F0F GC \u7684\u53BB\u4E0E\u7559\u201D\u3002</li></ul></li><li><strong>Partial GC</strong>\uFF1A \u90E8\u5206\u6536\u96C6\u64CD\u4F5C\u7684 GC\uFF0C\u53EA\u5BF9\u67D0\u4E9B\u5206\u4EE3/\u5206\u533A\u8FDB\u884C\u56DE\u6536\u3002 <ul><li>Young GC\uFF1A \u5206\u4EE3\u6536\u96C6\u91CC\u9762\u7684 Young \u533A\u6536\u96C6\u52A8\u4F5C\uFF0C\u4E5F\u53EF\u4EE5\u53EB\u505A Minor GC\u3002 <ul><li><code>ParNew</code>\uFF1A Young GC \u9891\u7E41\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u56DB\uFF1A\u8FC7\u65E9\u664B\u5347\u201D\u3002</li></ul></li><li>Old GC\uFF1A \u5206\u4EE3\u6536\u96C6\u91CC\u9762\u7684 Old \u533A\u6536\u96C6\u52A8\u4F5C\uFF0C\u4E5F\u53EF\u4EE5\u53EB\u505A Major GC\uFF0C\u6709\u4E9B\u4E5F\u4F1A\u53EB\u505A Full GC\uFF0C\u4F46\u5176\u5B9E\u8FD9\u79CD\u53EB\u6CD5\u662F\u4E0D\u89C4\u8303\u7684\uFF0C\u5728 CMS \u53D1\u751F Foreground GC \u65F6\u624D\u662F Full GC\uFF0CCMSScavengeBeforeRemark \u53C2\u6570\u4E5F\u53EA\u662F\u5728 Remark \u524D\u89E6\u53D1\u4E00\u6B21Young GC\u3002 <ul><li>CMS\uFF1A Old GC \u9891\u7E41\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u4E94\uFF1ACMS Old GC \u9891\u7E41\u201D\u3002</li><li>CMS\uFF1A Old GC \u4E0D\u9891\u7E41\u4F46\u5355\u6B21\u8017\u65F6\u5927\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u516D\uFF1A\u5355\u6B21 CMS Old GC \u8017\u65F6\u957F\u201D\u3002</li></ul></li></ul></li><li><strong>Full GC</strong>\uFF1A \u5168\u91CF\u6536\u96C6\u7684 GC\uFF0C\u5BF9\u6574\u4E2A\u5806\u8FDB\u884C\u56DE\u6536\uFF0CSTW \u65F6\u95F4\u4F1A\u6BD4\u8F83\u957F\uFF0C\u4E00\u65E6\u53D1\u751F\uFF0C\u5F71\u54CD\u8F83\u5927\uFF0C\u4E5F\u53EF\u4EE5\u53EB\u505A Major GC\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u4E03\uFF1A\u5185\u5B58\u788E\u7247&amp;\u6536\u96C6\u5668\u9000\u5316\u201D\u3002</li><li><strong>MetaSpace</strong>\uFF1A \u5143\u7A7A\u95F4\u56DE\u6536\u5F15\u53D1\u95EE\u9898\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u4E09\uFF1AMetaSpace \u533A OOM\u201D\u3002</li><li><strong>Direct Memory</strong>\uFF1A \u76F4\u63A5\u5185\u5B58\uFF08\u4E5F\u53EF\u4EE5\u79F0\u4F5C\u4E3A\u5806\u5916\u5185\u5B58\uFF09\u56DE\u6536\u5F15\u53D1\u95EE\u9898\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u516B\uFF1A\u5806\u5916\u5185\u5B58 OOM\u201D\u3002</li><li><strong>JNI</strong>\uFF1A \u672C\u5730 Native \u65B9\u6CD5\u5F15\u53D1\u95EE\u9898\uFF0C\u53C2\u89C1\u201C\u573A\u666F\u4E5D\uFF1AJNI \u5F15\u53D1\u7684 GC \u95EE\u9898\u201D\u3002</li></ul><h4 id="_3-3-3-\u6392\u67E5\u96BE\u5EA6" tabindex="-1"><a class="header-anchor" href="#_3-3-3-\u6392\u67E5\u96BE\u5EA6" aria-hidden="true">#</a> 3.3.3 \u6392\u67E5\u96BE\u5EA6</h4><p>\u4E00\u4E2A\u95EE\u9898\u7684<strong>\u89E3\u51B3\u96BE\u5EA6\u8DDF\u5B83\u7684\u5E38\u89C1\u7A0B\u5EA6\u6210\u53CD\u6BD4</strong>\uFF0C\u5927\u90E8\u5206\u6211\u4EEC\u90FD\u53EF\u4EE5\u901A\u8FC7\u5404\u79CD\u641C\u7D22\u5F15\u64CE\u627E\u5230\u7C7B\u4F3C\u7684\u95EE\u9898\uFF0C\u7136\u540E\u7528\u540C\u6837\u7684\u624B\u6BB5\u5C1D\u8BD5\u53BB\u89E3\u51B3\u3002\u5F53\u4E00\u4E2A\u95EE\u9898\u5728\u5404\u79CD\u7F51\u7AD9\u4E0A\u90FD\u627E\u4E0D\u5230\u76F8\u4F3C\u7684\u95EE\u9898\u65F6\uFF0C\u90A3\u4E48\u53EF\u80FD\u4F1A\u6709\u4E24\u79CD\u60C5\u51B5\uFF0C\u4E00\u79CD\u8FD9\u4E0D\u662F\u4E00\u4E2A\u95EE\u9898\uFF0C\u53E6\u4E00\u79CD\u5C31\u662F\u9047\u5230\u4E00\u4E2A\u9690\u85CF\u6BD4\u8F83\u6DF1\u7684\u95EE\u9898\uFF0C\u9047\u5230\u8FD9\u79CD\u95EE\u9898\u53EF\u80FD\u5C31\u8981\u6DF1\u5165\u5230\u6E90\u7801\u7EA7\u522B\u53BB\u8C03\u8BD5\u4E86\u3002\u4EE5\u4E0B GC \u95EE\u9898\u573A\u666F\uFF0C\u6392\u67E5\u96BE\u5EA6\u4ECE\u4E0A\u5230\u4E0B\u4F9D\u6B21\u9012\u589E\u3002</p><h2 id="_4-\u5E38\u89C1\u573A\u666F\u5206\u6790\u4E0E\u89E3\u51B3" tabindex="-1"><a class="header-anchor" href="#_4-\u5E38\u89C1\u573A\u666F\u5206\u6790\u4E0E\u89E3\u51B3" aria-hidden="true">#</a> 4. \u5E38\u89C1\u573A\u666F\u5206\u6790\u4E0E\u89E3\u51B3</h2><h3 id="_4-1-\u573A\u666F\u4E00-\u52A8\u6001\u6269\u5BB9\u5F15\u8D77\u7684\u7A7A\u95F4\u9707\u8361" tabindex="-1"><a class="header-anchor" href="#_4-1-\u573A\u666F\u4E00-\u52A8\u6001\u6269\u5BB9\u5F15\u8D77\u7684\u7A7A\u95F4\u9707\u8361" aria-hidden="true">#</a> 4.1 \u573A\u666F\u4E00\uFF1A\u52A8\u6001\u6269\u5BB9\u5F15\u8D77\u7684\u7A7A\u95F4\u9707\u8361</h3><h4 id="_4-1-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-1-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.1.1 \u73B0\u8C61</h4><p>\u670D\u52A1\u521A\u521A\u542F\u52A8\u65F6 GC \u6B21\u6570\u8F83\u591A\uFF0C\u6700\u5927\u7A7A\u95F4\u5269\u4F59\u5F88\u591A\u4F46\u662F\u4F9D\u7136\u53D1\u751F GC\uFF0C\u8FD9\u79CD\u60C5\u51B5\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u89C2\u5BDF GC \u65E5\u5FD7\u6216\u8005\u901A\u8FC7\u76D1\u63A7\u5DE5\u5177\u6765\u89C2\u5BDF\u5806\u7684\u7A7A\u95F4\u53D8\u5316\u60C5\u51B5\u5373\u53EF\u3002GC Cause \u4E00\u822C\u4E3A Allocation Failure\uFF0C\u4E14\u5728 GC \u65E5\u5FD7\u4E2D\u4F1A\u89C2\u5BDF\u5230\u7ECF\u5386\u4E00\u6B21 GC \uFF0C\u5806\u5185\u5404\u4E2A\u7A7A\u95F4\u7684\u5927\u5C0F\u4F1A\u88AB\u8C03\u6574\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822220321447.png" alt="image-20220822220321447" loading="lazy"></p><h4 id="_4-1-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-1-2-\u539F\u56E0" aria-hidden="true">#</a> 4.1.2 \u539F\u56E0</h4><p>\u5728 JVM \u7684\u53C2\u6570\u4E2D <code>-Xms</code> \u548C <code>-Xmx</code> \u8BBE\u7F6E\u7684\u4E0D\u4E00\u81F4\uFF0C\u5728\u521D\u59CB\u5316\u65F6\u53EA\u4F1A\u521D\u59CB <code>-Xms</code> \u5927\u5C0F\u7684\u7A7A\u95F4\u5B58\u50A8\u4FE1\u606F\uFF0C\u6BCF\u5F53\u7A7A\u95F4\u4E0D\u591F\u7528\u65F6\u518D\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7533\u8BF7\uFF0C\u8FD9\u6837\u7684\u8BDD\u5FC5\u7136\u8981\u8FDB\u884C\u4E00\u6B21 GC\u3002\u5177\u4F53\u662F\u901A\u8FC7 <code>ConcurrentMarkSweepGeneration::compute_new_size()</code> \u65B9\u6CD5\u8BA1\u7B97\u65B0\u7684\u7A7A\u95F4\u5927\u5C0F\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">ConcurrentMarkSweepGeneration</span><span class="token double-colon punctuation">::</span><span class="token function">compute_new_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert_locked_or_safepoint</span><span class="token punctuation">(</span>Heap_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If incremental collection failed, we just want to expand</span>
  <span class="token comment">// to the limit.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">incremental_collection_failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clear_incremental_collection_failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">grow_to_reserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The heap has been compacted but not reset yet.</span>
  <span class="token comment">// Any metric such as free() or used() will be incorrect.</span>

  <span class="token class-name">CardGeneration</span><span class="token double-colon punctuation">::</span><span class="token function">compute_new_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Reset again after a possible resizing</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">did_compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cmsSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">reset_after_compaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53E6\u5916\uFF0C\u5982\u679C\u7A7A\u95F4\u5269\u4F59\u5F88\u591A\u65F6\u4E5F\u4F1A\u8FDB\u884C\u7F29\u5BB9\u64CD\u4F5C\uFF0CJVM \u901A\u8FC7 <code>-XX:MinHeapFreeRatio</code> \u548C <code>-XX:MaxHeapFreeRatio</code> \u6765\u63A7\u5236\u6269\u5BB9\u548C\u7F29\u5BB9\u7684\u6BD4\u4F8B\uFF0C\u8C03\u8282\u8FD9\u4E24\u4E2A\u503C\u4E5F\u53EF\u4EE5\u63A7\u5236\u4F38\u7F29\u7684\u65F6\u673A\uFF0C\u4F8B\u5982\u6269\u5BB9\u4FBF\u662F\u4F7F\u7528 <code>GenCollectedHeap::expand_heap_and_allocate()</code> \u6765\u5B8C\u6210\u7684\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>HeapWord<span class="token operator">*</span> <span class="token class-name">GenCollectedHeap</span><span class="token double-colon punctuation">::</span><span class="token function">expand_heap_and_allocate</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">bool</span>   is_tlab<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HeapWord<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_old_gen<span class="token operator">-&gt;</span><span class="token function">should_allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> is_tlab<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> _old_gen<span class="token operator">-&gt;</span><span class="token function">expand_and_allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> is_tlab<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_young_gen<span class="token operator">-&gt;</span><span class="token function">should_allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> is_tlab<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> _young_gen<span class="token operator">-&gt;</span><span class="token function">expand_and_allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> is_tlab<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token function">is_in_reserved</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;result not in heap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6574\u4E2A\u4F38\u7F29\u7684\u6A21\u578B\u7406\u89E3\u53EF\u4EE5\u770B\u8FD9\u4E2A\u56FE\uFF0C\u5F53 committed \u7684\u7A7A\u95F4\u5927\u5C0F\u8D85\u8FC7\u4E86\u4F4E\u6C34\u4F4D/\u9AD8\u6C34\u4F4D\u7684\u5927\u5C0F\uFF0Ccapacity \u4E5F\u4F1A\u968F\u4E4B\u8C03\u6574\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822220458535.png" alt="image-20220822220458535" loading="lazy"></p><h4 id="_4-1-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-1-3-\u7B56\u7565" aria-hidden="true">#</a> 4.1.3 \u7B56\u7565</h4><p><strong>\u5B9A\u4F4D</strong>\uFF1A\u89C2\u5BDF CMS GC \u89E6\u53D1\u65F6\u95F4\u70B9 <code>Old/MetaSpace</code>\u533A\u7684 committed \u5360\u6BD4\u662F\u4E0D\u662F\u4E00\u4E2A\u56FA\u5B9A\u7684\u503C\uFF0C\u6216\u8005\u50CF\u4E0A\u6587\u63D0\u5230\u7684\u89C2\u5BDF\u603B\u7684\u5185\u5B58\u4F7F\u7528\u7387\u4E5F\u53EF\u4EE5\u3002</p><p><strong>\u89E3\u51B3</strong>\uFF1A\u5C3D\u91CF\u5C06<strong>\u6210\u5BF9\u51FA\u73B0\u7684\u7A7A\u95F4\u5927\u5C0F\u914D\u7F6E\u53C2\u6570\u8BBE\u7F6E\u6210\u56FA\u5B9A</strong>\u7684\uFF0C\u5982 <code>-Xms</code> \u548C <code>-Xmx</code>\uFF0C<code>-XX:MaxNewSize</code> \u548C <code>-XX:NewSize</code>\uFF0C<code>-XX:MetaSpaceSize</code> \u548C <code>-XX:MaxMetaSpaceSize</code> \u7B49\u3002</p><h4 id="_4-1-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-1-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.1.4 \u5C0F\u7ED3</h4><p>\u4E00\u822C\u6765\u8BF4\uFF0C\u6211\u4EEC\u9700\u8981\u4FDD\u8BC1 Java \u865A\u62DF\u673A\u7684\u5806\u662F\u7A33\u5B9A\u7684\uFF0C\u786E\u4FDD <code>-Xms</code> \u548C <code>-Xmx</code> \u8BBE\u7F6E\u7684\u662F\u4E00\u4E2A\u503C\uFF08\u5373\u521D\u59CB\u503C\u548C\u6700\u5927\u503C\u4E00\u81F4\uFF09\uFF0C\u83B7\u5F97\u4E00\u4E2A\u7A33\u5B9A\u7684\u5806\uFF0C\u540C\u7406\u5728 MetaSpace \u533A\u4E5F\u6709\u7C7B\u4F3C\u7684\u95EE\u9898\u3002\u4E0D\u8FC7\u5728\u4E0D\u8FFD\u6C42\u505C\u987F\u65F6\u95F4\u7684\u60C5\u51B5\u4E0B\u9707\u8361\u7684\u7A7A\u95F4\u4E5F\u662F\u6709\u5229\u7684\uFF0C\u53EF\u4EE5\u52A8\u6001\u5730\u4F38\u7F29\u4EE5\u8282\u7701\u7A7A\u95F4\uFF0C\u4F8B\u5982\u4F5C\u4E3A\u5BCC\u5BA2\u6237\u7AEF\u7684 Java \u5E94\u7528\u3002</p><p>\u8FD9\u4E2A\u95EE\u9898\u867D\u7136\u521D\u7EA7\uFF0C\u4F46\u662F\u53D1\u751F\u7684\u6982\u7387\u8FD8\u771F\u4E0D\u5C0F\uFF0C\u5C24\u5176\u662F\u5728\u4E00\u4E9B\u89C4\u8303\u4E0D\u592A\u5065\u5168\u7684\u60C5\u51B5\u4E0B\u3002</p><h3 id="_4-2-\u573A\u666F\u4E8C-\u663E\u5F0F-gc-\u7684\u53BB\u4E0E\u7559" tabindex="-1"><a class="header-anchor" href="#_4-2-\u573A\u666F\u4E8C-\u663E\u5F0F-gc-\u7684\u53BB\u4E0E\u7559" aria-hidden="true">#</a> 4.2 \u573A\u666F\u4E8C\uFF1A\u663E\u5F0F GC \u7684\u53BB\u4E0E\u7559</h3><h4 id="_4-2-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-2-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.2.1 \u73B0\u8C61</h4><p>\u9664\u4E86\u6269\u5BB9\u7F29\u5BB9\u4F1A\u89E6\u53D1 CMS GC \u4E4B\u5916\uFF0C\u8FD8\u6709 Old \u533A\u8FBE\u5230\u56DE\u6536\u9608\u503C\u3001MetaSpace \u7A7A\u95F4\u4E0D\u8DB3\u3001Young \u533A\u664B\u5347\u5931\u8D25\u3001\u5927\u5BF9\u8C61\u62C5\u4FDD\u5931\u8D25\u7B49\u51E0\u79CD\u89E6\u53D1\u6761\u4EF6\uFF0C\u5982\u679C\u8FD9\u4E9B\u60C5\u51B5\u90FD\u6CA1\u6709\u53D1\u751F\u5374\u89E6\u53D1\u4E86 GC \uFF1F\u8FD9\u79CD\u60C5\u51B5\u6709\u53EF\u80FD\u662F\u4EE3\u7801\u4E2D\u624B\u52A8\u8C03\u7528\u4E86 System.gc \u65B9\u6CD5\uFF0C\u6B64\u65F6\u53EF\u4EE5\u627E\u5230 GC \u65E5\u5FD7\u4E2D\u7684 GC Cause \u786E\u8BA4\u4E0B\u3002\u90A3\u4E48\u8FD9\u79CD GC \u5230\u5E95\u6709\u6CA1\u6709\u95EE\u9898\uFF0C\u7FFB\u770B\u7F51\u4E0A\u7684\u4E00\u4E9B\u8D44\u6599\uFF0C\u6709\u4EBA\u8BF4\u53EF\u4EE5\u6DFB\u52A0 <code>-XX:+DisableExplicitGC</code> \u53C2\u6570\u6765\u907F\u514D\u8FD9\u79CD GC\uFF0C\u4E5F\u6709\u4EBA\u8BF4\u4E0D\u80FD\u52A0\u8FD9\u4E2A\u53C2\u6570\uFF0C\u52A0\u4E86\u5C31\u4F1A\u5F71\u54CD Native Memory \u7684\u56DE\u6536\u3002\u5148\u8BF4\u7ED3\u8BBA\uFF0C\u7B14\u8005\u8FD9\u91CC\u5EFA\u8BAE\u4FDD\u7559 System.gc\uFF0C\u90A3\u4E3A\u4EC0\u4E48\u8981\u4FDD\u7559\uFF1F\u6211\u4EEC\u4E00\u8D77\u6765\u5206\u6790\u4E0B\u3002</p><h4 id="_4-2-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-2-2-\u539F\u56E0" aria-hidden="true">#</a> 4.2.2 \u539F\u56E0</h4><p>\u627E\u5230 System.gc \u5728 Hotspot \u4E2D\u7684\u6E90\u7801\uFF0C\u53EF\u4EE5\u53D1\u73B0\u589E\u52A0 <code>-XX:+DisableExplicitGC</code> \u53C2\u6570\u540E\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u53D8\u6210\u4E86\u4E00\u4E2A\u7A7A\u65B9\u6CD5\uFF0C\u5982\u679C\u6CA1\u6709\u52A0\u7684\u8BDD\u4FBF\u4F1A\u8C03\u7528 <code>Universe::heap()::collect</code> \u65B9\u6CD5\uFF0C\u7EE7\u7EED\u8DDF\u8FDB\u5230\u8FD9\u4E2A\u65B9\u6CD5\u4E2D\uFF0C\u53D1\u73B0 System.gc \u4F1A\u5F15\u53D1\u4E00\u6B21 STW \u7684 Full GC\uFF0C\u5BF9\u6574\u4E2A\u5806\u505A\u6536\u96C6\u3002</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">JVM_ENTRY_NO_ENV</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token function">JVM_GC</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">JVMWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;JVM_GC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DisableExplicitGC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Universe</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">collect</span><span class="token punctuation">(</span>GCCause<span class="token double-colon punctuation">::</span>_java_lang_system_gc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
JVM_END
<span class="token keyword">void</span> <span class="token class-name">GenCollectedHeap</span><span class="token double-colon punctuation">::</span><span class="token function">collect</span><span class="token punctuation">(</span>GCCause<span class="token double-colon punctuation">::</span>Cause cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">==</span> GCCause<span class="token double-colon punctuation">::</span>_wb_young_gc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Young collection for the WhiteBox API.</span>
    <span class="token function">collect</span><span class="token punctuation">(</span>cause<span class="token punctuation">,</span> YoungGen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">==</span> GCCause<span class="token double-colon punctuation">::</span>_scavenge_alot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Young collection only.</span>
    <span class="token function">collect</span><span class="token punctuation">(</span>cause<span class="token punctuation">,</span> YoungGen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Stop-the-world full collection.</span>
    <span class="token function">collect</span><span class="token punctuation">(</span>cause<span class="token punctuation">,</span> OldGen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">// Stop-the-world full collection.</span>
    <span class="token function">collect</span><span class="token punctuation">(</span>cause<span class="token punctuation">,</span> OldGen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4FDD\u7559 System.gc</strong></p><p>\u6B64\u5904\u8865\u5145\u4E00\u4E2A\u77E5\u8BC6\u70B9\uFF0C<strong>CMS GC \u5171\u5206\u4E3A Background \u548C Foreground \u4E24\u79CD\u6A21\u5F0F</strong>\uFF0C\u524D\u8005\u5C31\u662F\u6211\u4EEC\u5E38\u89C4\u7406\u89E3\u4E2D\u7684\u5E76\u53D1\u6536\u96C6\uFF0C\u53EF\u4EE5\u4E0D\u5F71\u54CD\u6B63\u5E38\u7684\u4E1A\u52A1\u7EBF\u7A0B\u8FD0\u884C\uFF0C\u4F46 Foreground Collector \u5374\u6709\u5F88\u5927\u7684\u5DEE\u5F02\uFF0C\u4ED6\u4F1A\u8FDB\u884C\u4E00\u6B21\u538B\u7F29\u5F0F GC\u3002\u6B64\u538B\u7F29\u5F0F GC \u4F7F\u7528\u7684\u662F\u8DDF Serial Old GC \u4E00\u6837\u7684 Lisp2 \u7B97\u6CD5\uFF0C\u5176\u4F7F\u7528 Mark-Compact \u6765\u505A Full GC\uFF0C\u4E00\u822C\u79F0\u4E4B\u4E3A MSC\uFF08Mark-Sweep-Compact\uFF09\uFF0C\u5B83\u6536\u96C6\u7684\u8303\u56F4\u662F Java \u5806\u7684 Young \u533A\u548C Old \u533A\u4EE5\u53CA MetaSpace\u3002\u7531\u4E0A\u9762\u7684\u7B97\u6CD5\u7AE0\u8282\u4E2D\u6211\u4EEC\u77E5\u9053 compact \u7684\u4EE3\u4EF7\u662F\u5DE8\u5927\u7684\uFF0C\u90A3\u4E48\u4F7F\u7528 Foreground Collector \u65F6\u5C06\u4F1A\u5E26\u6765\u975E\u5E38\u957F\u7684 STW\u3002\u5982\u679C\u5728\u5E94\u7528\u7A0B\u5E8F\u4E2D System.gc \u88AB\u9891\u7E41\u8C03\u7528\uFF0C\u90A3\u5C31\u975E\u5E38\u5371\u9669\u4E86\u3002</p><p><strong>\u53BB\u6389 System.gc</strong></p><p>\u5982\u679C\u7981\u7528\u6389\u7684\u8BDD\u5C31\u4F1A\u5E26\u6765\u53E6\u5916\u4E00\u4E2A\u5185\u5B58\u6CC4\u6F0F\u95EE\u9898\uFF0C\u6B64\u65F6\u5C31\u9700\u8981\u8BF4\u4E00\u4E0B DirectByteBuffer\uFF0C\u5B83\u6709\u7740\u96F6\u62F7\u8D1D\u7B49\u7279\u70B9\uFF0C\u88AB Netty \u7B49\u5404\u79CD NIO \u6846\u67B6\u4F7F\u7528\uFF0C\u4F1A\u4F7F\u7528\u5230\u5806\u5916\u5185\u5B58\u3002\u5806\u5185\u5B58\u7531 JVM \u81EA\u5DF1\u7BA1\u7406\uFF0C\u5806\u5916\u5185\u5B58\u5FC5\u987B\u8981\u624B\u52A8\u91CA\u653E\uFF0CDirectByteBuffer \u6CA1\u6709 Finalizer\uFF0C\u5B83\u7684 Native Memory \u7684\u6E05\u7406\u5DE5\u4F5C\u662F\u901A\u8FC7 <code>sun.misc.Cleaner</code> \u81EA\u52A8\u5B8C\u6210\u7684\uFF0C\u662F\u4E00\u79CD\u57FA\u4E8E PhantomReference \u7684\u6E05\u7406\u5DE5\u5177\uFF0C\u6BD4\u666E\u901A\u7684 Finalizer \u8F7B\u91CF\u4E9B\u3002</p><p>\u4E3A DirectByteBuffer \u5206\u914D\u7A7A\u95F4\u8FC7\u7A0B\u4E2D\u4F1A\u663E\u5F0F\u8C03\u7528 System.gc \uFF0C\u5E0C\u671B\u901A\u8FC7 Full GC \u6765\u5F3A\u8FEB\u5DF2\u7ECF\u65E0\u7528\u7684 DirectByteBuffer \u5BF9\u8C61\u91CA\u653E\u6389\u5B83\u4EEC\u5173\u8054\u7684 Native Memory\uFF0C\u4E0B\u9762\u4E3A\u4EE3\u7801\u5B9E\u73B0\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// These methods should be called whenever direct memory is allocated or</span>
<span class="token comment">// freed.  They allow the user to control the amount of direct memory</span>
<span class="token comment">// which a process may access.  All sizes are specified in bytes.</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">reserveMemory</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">synchronized</span> <span class="token punctuation">(</span>Bits<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memoryLimitSet <span class="token operator">&amp;&amp;</span> VM<span class="token punctuation">.</span><span class="token function">isBooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            maxMemory <span class="token operator">=</span> VM<span class="token punctuation">.</span><span class="token function">maxDirectMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            memoryLimitSet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> maxMemory <span class="token operator">-</span> reservedMemory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            reservedMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>InterruptedException x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Restore interrupt status</span>
        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span>Bits<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reservedMemory <span class="token operator">+</span> size <span class="token operator">&gt;</span> maxMemory<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token function">OutOfMemoryError</span><span class="token punctuation">(</span><span class="token string">&quot;Direct buffer memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reservedMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HotSpot VM \u53EA\u4F1A\u5728 Old GC \u7684\u65F6\u5019\u624D\u4F1A\u5BF9 Old \u4E2D\u7684\u5BF9\u8C61\u505A Reference Processing\uFF0C\u800C\u5728 Young GC \u65F6\u53EA\u4F1A\u5BF9 Young \u91CC\u7684\u5BF9\u8C61\u505A Reference Processing\u3002Young \u4E2D\u7684 DirectByteBuffer \u5BF9\u8C61\u4F1A\u5728 Young GC \u65F6\u88AB\u5904\u7406\uFF0C\u4E5F\u5C31\u662F\u8BF4\uFF0C\u505A CMS GC \u7684\u8BDD\u4F1A\u5BF9 Old \u505A Reference Processing\uFF0C\u8FDB\u800C\u80FD\u89E6\u53D1 Cleaner \u5BF9\u5DF2\u6B7B\u7684 DirectByteBuffer \u5BF9\u8C61\u505A\u6E05\u7406\u5DE5\u4F5C\u3002\u4F46\u5982\u679C\u5F88\u957F\u4E00\u6BB5\u65F6\u95F4\u91CC\u6CA1\u505A\u8FC7 GC \u6216\u8005\u53EA\u505A\u4E86 Young GC \u7684\u8BDD\u5219\u4E0D\u4F1A\u5728 Old \u89E6\u53D1 Cleaner \u7684\u5DE5\u4F5C\uFF0C\u90A3\u4E48\u5C31\u53EF\u80FD\u8BA9\u672C\u6765\u5DF2\u7ECF\u6B7B\u4EA1\uFF0C\u4F46\u5DF2\u7ECF\u664B\u5347\u5230 Old \u7684 DirectByteBuffer \u5173\u8054\u7684 Native Memory \u5F97\u4E0D\u5230\u53CA\u65F6\u91CA\u653E\u3002\u8FD9\u51E0\u4E2A\u5B9E\u73B0\u7279\u5F81\u4F7F\u5F97\u4F9D\u8D56\u4E8E System.gc \u89E6\u53D1 GC \u6765\u4FDD\u8BC1 DirectByteMemory \u7684\u6E05\u7406\u5DE5\u4F5C\u80FD\u53CA\u65F6\u5B8C\u6210\u3002\u5982\u679C\u6253\u5F00\u4E86 -XX:+DisableExplicitGC\uFF0C\u6E05\u7406\u5DE5\u4F5C\u5C31\u53EF\u80FD\u5F97\u4E0D\u5230\u53CA\u65F6\u5B8C\u6210\uFF0C\u4E8E\u662F\u5C31\u6709\u53D1\u751F Direct Memory \u7684 OOM\u3002</p><h4 id="_4-2-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-2-3-\u7B56\u7565" aria-hidden="true">#</a> 4.2.3 \u7B56\u7565</h4><p>\u901A\u8FC7\u4E0A\u9762\u7684\u5206\u6790\u770B\u5230\uFF0C\u65E0\u8BBA\u662F\u4FDD\u7559\u8FD8\u662F\u53BB\u6389\u90FD\u4F1A\u6709\u4E00\u5B9A\u7684\u98CE\u9669\u70B9\uFF0C\u4E0D\u8FC7\u76EE\u524D\u4E92\u8054\u7F51\u4E2D\u7684 RPC \u901A\u4FE1\u4F1A\u5927\u91CF\u4F7F\u7528 NIO\uFF0C\u6240\u4EE5\u7B14\u8005\u5728\u8FD9\u91CC\u5EFA\u8BAE\u4FDD\u7559\u3002\u6B64\u5916 JVM \u8FD8\u63D0\u4F9B\u4E86 -XX:+ExplicitGCInvokesConcurrent \u548C -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses \u53C2\u6570\u6765\u5C06 System.gc \u7684\u89E6\u53D1\u7C7B\u578B\u4ECE Foreground \u6539\u4E3A Background\uFF0C\u540C\u65F6 Background \u4E5F\u4F1A\u505A Reference Processing\uFF0C\u8FD9\u6837\u7684\u8BDD\u5C31\u80FD\u5927\u5E45\u964D\u4F4E\u4E86 STW \u5F00\u9500\uFF0C\u540C\u65F6\u4E5F\u4E0D\u4F1A\u53D1\u751F NIO Direct Memory OOM\u3002</p><h4 id="_4-2-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-2-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.2.4 \u5C0F\u7ED3</h4><p>\u4E0D\u6B62 CMS\uFF0C\u5728 G1 \u6216 ZGC\u4E2D\u5F00\u542F <code>ExplicitGCInvokesConcurrent</code> \u6A21\u5F0F\uFF0C\u90FD\u4F1A\u91C7\u7528\u9AD8\u6027\u80FD\u7684\u5E76\u53D1\u6536\u96C6\u65B9\u5F0F\u8FDB\u884C\u6536\u96C6\uFF0C\u4E0D\u8FC7\u8FD8\u662F\u5EFA\u8BAE\u5728\u4EE3\u7801\u89C4\u8303\u65B9\u9762\u4E5F\u8981\u505A\u597D\u7EA6\u675F\uFF0C\u89C4\u8303\u597D System.gc \u7684\u4F7F\u7528\u3002</p><blockquote><p>P.S. HotSpot \u5BF9 System.gc \u6709\u7279\u522B\u5904\u7406\uFF0C\u6700\u4E3B\u8981\u7684\u5730\u65B9\u4F53\u73B0\u5728\u4E00\u6B21 System.gc \u662F\u5426\u4E0E\u666E\u901A GC \u4E00\u6837\u4F1A\u89E6\u53D1 GC \u7684\u7EDF\u8BA1/\u9608\u503C\u6570\u636E\u7684\u66F4\u65B0\uFF0CHotSpot \u91CC\u7684\u8BB8\u591A GC \u7B97\u6CD5\u90FD\u5E26\u6709\u81EA\u9002\u5E94\u7684\u529F\u80FD\uFF0C\u4F1A\u6839\u636E\u5148\u524D\u6536\u96C6\u7684\u6548\u7387\u6765\u51B3\u5B9A\u63A5\u4E0B\u6765\u7684 GC \u4E2D\u4F7F\u7528\u7684\u53C2\u6570\uFF0C\u4F46 System.gc \u9ED8\u8BA4\u4E0D\u66F4\u65B0\u8FD9\u4E9B\u7EDF\u8BA1\u6570\u636E\uFF0C\u907F\u514D\u7528\u6237\u5F3A\u884C GC \u5BF9\u8FD9\u4E9B\u81EA\u9002\u5E94\u529F\u80FD\u7684\u5E72\u6270\uFF08\u53EF\u4EE5\u53C2\u8003 <code>-XX:+UseAdaptiveSizePolicyWithSystemGC</code> \u53C2\u6570\uFF0C\u9ED8\u8BA4\u662F false\uFF09\u3002</p></blockquote><h3 id="_4-3-\u573A\u666F\u4E09-metaspace-\u533A-oom" tabindex="-1"><a class="header-anchor" href="#_4-3-\u573A\u666F\u4E09-metaspace-\u533A-oom" aria-hidden="true">#</a> 4.3 \u573A\u666F\u4E09\uFF1AMetaSpace \u533A OOM</h3><h4 id="_4-3-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-3-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.3.1 \u73B0\u8C61</h4><p>JVM \u5728\u542F\u52A8\u540E\u6216\u8005\u67D0\u4E2A\u65F6\u95F4\u70B9\u5F00\u59CB\uFF0C<strong>MetaSpace \u7684\u5DF2\u4F7F\u7528\u5927\u5C0F\u5728\u6301\u7EED\u589E\u957F\uFF0C\u540C\u65F6\u6BCF\u6B21 GC \u4E5F\u65E0\u6CD5\u91CA\u653E\uFF0C\u8C03\u5927 MetaSpace \u7A7A\u95F4\u4E5F\u65E0\u6CD5\u5F7B\u5E95\u89E3\u51B3</strong>\u3002</p><h4 id="_4-3-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-3-2-\u539F\u56E0" aria-hidden="true">#</a> 4.3.2 \u539F\u56E0</h4><p>\u5728\u8BA8\u8BBA\u4E3A\u4EC0\u4E48\u4F1A OOM \u4E4B\u524D\uFF0C\u6211\u4EEC\u5148\u6765\u770B\u4E00\u4E0B\u8FD9\u4E2A\u533A\u91CC\u9762\u4F1A\u5B58\u4EC0\u4E48\u6570\u636E\uFF0CJava7 \u4E4B\u524D\u5B57\u7B26\u4E32\u5E38\u91CF\u6C60\u88AB\u653E\u5230\u4E86 Perm \u533A\uFF0C\u6240\u6709\u88AB intern \u7684 String \u90FD\u4F1A\u88AB\u5B58\u5728\u8FD9\u91CC\uFF0C\u7531\u4E8E String.intern \u662F\u4E0D\u53D7\u63A7\u7684\uFF0C\u6240\u4EE5 <code>-XX:MaxPermSize</code> \u7684\u503C\u4E5F\u4E0D\u592A\u597D\u8BBE\u7F6E\uFF0C\u7ECF\u5E38\u4F1A\u51FA\u73B0 <code>java.lang.OutOfMemoryError: PermGen space</code> \u5F02\u5E38\uFF0C\u6240\u4EE5\u5728 Java7 \u4E4B\u540E\u5E38\u91CF\u6C60\u7B49\u5B57\u9762\u91CF\uFF08Literal\uFF09\u3001\u7C7B\u9759\u6001\u53D8\u91CF\uFF08Class Static\uFF09\u3001\u7B26\u53F7\u5F15\u7528\uFF08Symbols Reference\uFF09\u7B49\u51E0\u9879\u88AB\u79FB\u5230 Heap \u4E2D\u3002\u800C Java8 \u4E4B\u540E PermGen \u4E5F\u88AB\u79FB\u9664\uFF0C\u53D6\u800C\u4EE3\u4E4B\u7684\u662F MetaSpace\u3002</p><p>\u5728\u6700\u5E95\u5C42\uFF0CJVM \u901A\u8FC7 mmap \u63A5\u53E3\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7533\u8BF7\u5185\u5B58\u6620\u5C04\uFF0C\u6BCF\u6B21\u7533\u8BF7 2MB \u7A7A\u95F4\uFF0C\u8FD9\u91CC\u662F\u865A\u62DF\u5185\u5B58\u6620\u5C04\uFF0C\u4E0D\u662F\u771F\u7684\u5C31\u6D88\u8017\u4E86\u4E3B\u5B58\u7684 2MB\uFF0C\u53EA\u6709\u4E4B\u540E\u5728\u4F7F\u7528\u7684\u65F6\u5019\u624D\u4F1A\u771F\u7684\u6D88\u8017\u5185\u5B58\u3002\u7533\u8BF7\u7684\u8FD9\u4E9B\u5185\u5B58\u653E\u5230\u4E00\u4E2A\u94FE\u8868\u4E2D VirtualSpaceList\uFF0C\u4F5C\u4E3A\u5176\u4E2D\u7684\u4E00\u4E2A Node\u3002</p><p>\u5728\u4E0A\u5C42\uFF0CMetaSpace \u4E3B\u8981\u7531 Klass Metaspace \u548C NoKlass Metaspace \u4E24\u5927\u90E8\u5206\u7EC4\u6210\u3002</p><ul><li><code>Klass MetaSpace</code>\uFF1A \u5C31\u662F\u7528\u6765\u5B58 Klass \u7684\uFF0C\u5C31\u662F Class \u6587\u4EF6\u5728 JVM \u91CC\u7684\u8FD0\u884C\u65F6\u6570\u636E\u7ED3\u6784\uFF0C\u8FD9\u90E8\u5206\u9ED8\u8BA4\u653E\u5728 Compressed Class Pointer Space \u4E2D\uFF0C\u662F\u4E00\u5757\u8FDE\u7EED\u7684\u5185\u5B58\u533A\u57DF\uFF0C\u7D27\u63A5\u7740 Heap\u3002Compressed Class Pointer Space \u4E0D\u662F\u5FC5\u987B\u6709\u7684\uFF0C\u5982\u679C\u8BBE\u7F6E\u4E86 -XX:-UseCompressedClassPointers\uFF0C\u6216\u8005 -Xmx \u8BBE\u7F6E\u5927\u4E8E 32 G\uFF0C\u5C31\u4E0D\u4F1A\u6709\u8FD9\u5757\u5185\u5B58\uFF0C\u8FD9\u79CD\u60C5\u51B5\u4E0B Klass \u90FD\u4F1A\u5B58\u5728 NoKlass Metaspace \u91CC\u3002</li><li><code>NoKlass MetaSpace</code>\uFF1A \u4E13\u95E8\u6765\u5B58 Klass \u76F8\u5173\u7684\u5176\u4ED6\u7684\u5185\u5BB9\uFF0C\u6BD4\u5982 Method\uFF0CConstantPool \u7B49\uFF0C\u53EF\u4EE5\u7531\u591A\u5757\u4E0D\u8FDE\u7EED\u7684\u5185\u5B58\u7EC4\u6210\u3002\u867D\u7136\u53EB\u505A NoKlass Metaspace\uFF0C\u4F46\u662F\u4E5F\u5176\u5B9E\u53EF\u4EE5\u5B58 Klass \u7684\u5185\u5BB9\uFF0C\u4E0A\u9762\u5DF2\u7ECF\u63D0\u5230\u4E86\u5BF9\u5E94\u573A\u666F\u3002 \u5177\u4F53\u7684\u5B9A\u4E49\u90FD\u53EF\u4EE5\u5728\u6E90\u7801 <code>shared/vm/memory/metaspace.hpp</code> \u4E2D\u627E\u5230\uFF1A</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Metaspace</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">AllStatic</span></span> <span class="token punctuation">{</span>

  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">MetaspaceShared</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">enum</span> <span class="token class-name">MetadataType</span> <span class="token punctuation">{</span>
    ClassType<span class="token punctuation">,</span>
    NonClassType<span class="token punctuation">,</span>
    MetadataTypeCount
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">enum</span> <span class="token class-name">MetaspaceType</span> <span class="token punctuation">{</span>
    ZeroMetaspaceType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    StandardMetaspaceType <span class="token operator">=</span> ZeroMetaspaceType<span class="token punctuation">,</span>
    BootMetaspaceType <span class="token operator">=</span> StandardMetaspaceType <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    AnonymousMetaspaceType <span class="token operator">=</span> BootMetaspaceType <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    ReflectionMetaspaceType <span class="token operator">=</span> AnonymousMetaspaceType <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    MetaspaceTypeCount
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>

  <span class="token comment">// Align up the word size to the allocation word size</span>
  <span class="token keyword">static</span> size_t <span class="token function">align_word_size_up</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Aligned size of the metaspace.</span>
  <span class="token keyword">static</span> size_t _compressed_class_space_size<span class="token punctuation">;</span>

  <span class="token keyword">static</span> size_t <span class="token function">compressed_class_space_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _compressed_class_space_size<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set_compressed_class_space_size</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _compressed_class_space_size <span class="token operator">=</span> size<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> size_t _first_chunk_word_size<span class="token punctuation">;</span>
  <span class="token keyword">static</span> size_t _first_class_chunk_word_size<span class="token punctuation">;</span>

  <span class="token keyword">static</span> size_t _commit_alignment<span class="token punctuation">;</span>
  <span class="token keyword">static</span> size_t _reserve_alignment<span class="token punctuation">;</span>
  <span class="token function">DEBUG_ONLY</span><span class="token punctuation">(</span><span class="token keyword">static</span> <span class="token keyword">bool</span>   _frozen<span class="token punctuation">;</span><span class="token punctuation">)</span>

  <span class="token comment">// Virtual Space lists for both classes and other metadata</span>
  <span class="token keyword">static</span> metaspace<span class="token double-colon punctuation">::</span>VirtualSpaceList<span class="token operator">*</span> _space_list<span class="token punctuation">;</span>
  <span class="token keyword">static</span> metaspace<span class="token double-colon punctuation">::</span>VirtualSpaceList<span class="token operator">*</span> _class_space_list<span class="token punctuation">;</span>

  <span class="token keyword">static</span> metaspace<span class="token double-colon punctuation">::</span>ChunkManager<span class="token operator">*</span> _chunk_manager_metadata<span class="token punctuation">;</span>
  <span class="token keyword">static</span> metaspace<span class="token double-colon punctuation">::</span>ChunkManager<span class="token operator">*</span> _chunk_manager_class<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">const</span> MetaspaceTracer<span class="token operator">*</span> _tracer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MetaSpace \u7684\u5BF9\u8C61\u4E3A\u4EC0\u4E48\u65E0\u6CD5\u91CA\u653E\uFF0C\u6211\u4EEC\u770B\u4E0B\u9762\u4E24\u70B9\uFF1A</p><ul><li><strong>MetaSpace \u5185\u5B58\u7BA1\u7406</strong>\uFF1A \u7C7B\u548C\u5176\u5143\u6570\u636E\u7684\u751F\u547D\u5468\u671F\u4E0E\u5176\u5BF9\u5E94\u7684\u7C7B\u52A0\u8F7D\u5668\u76F8\u540C\uFF0C\u53EA\u8981\u7C7B\u7684\u7C7B\u52A0\u8F7D\u5668\u662F\u5B58\u6D3B\u7684\uFF0C\u5728 Metaspace \u4E2D\u7684\u7C7B\u5143\u6570\u636E\u4E5F\u662F\u5B58\u6D3B\u7684\uFF0C\u4E0D\u80FD\u88AB\u56DE\u6536\u3002\u6BCF\u4E2A\u52A0\u8F7D\u5668\u6709\u5355\u72EC\u7684\u5B58\u50A8\u7A7A\u95F4\uFF0C\u901A\u8FC7 ClassLoaderMetaspace \u6765\u8FDB\u884C\u7BA1\u7406 SpaceManager* \u7684\u6307\u9488\uFF0C\u76F8\u4E92\u9694\u79BB\u7684\u3002</li><li><strong>MetaSpace \u5F39\u6027\u4F38\u7F29</strong>\uFF1A \u7531\u4E8E MetaSpace \u7A7A\u95F4\u548C Heap \u5E76\u4E0D\u5728\u4E00\u8D77\uFF0C\u6240\u4EE5\u8FD9\u5757\u7684\u7A7A\u95F4\u53EF\u4EE5\u4E0D\u7528\u8BBE\u7F6E\u6216\u8005\u5355\u72EC\u8BBE\u7F6E\uFF0C\u4E00\u822C\u60C5\u51B5\u4E0B\u907F\u514D MetaSpace \u8017\u5C3D VM \u5185\u5B58\u90FD\u4F1A\u8BBE\u7F6E\u4E00\u4E2A MaxMetaSpaceSize\uFF0C\u5728\u8FD0\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u5982\u679C\u5B9E\u9645\u5927\u5C0F\u5C0F\u4E8E\u8FD9\u4E2A\u503C\uFF0CJVM \u5C31\u4F1A\u901A\u8FC7 <code>-XX:MinMetaspaceFreeRatio</code> \u548C <code>-XX:MaxMetaspaceFreeRatio</code> \u4E24\u4E2A\u53C2\u6570\u52A8\u6001\u63A7\u5236\u6574\u4E2A MetaSpace \u7684\u5927\u5C0F\uFF0C\u5177\u4F53\u4F7F\u7528\u53EF\u4EE5\u770B <code>MetaSpaceGC::compute_new_size()</code> \u65B9\u6CD5\uFF08\u4E0B\u65B9\u4EE3\u7801\uFF09\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u4F1A\u5728 CMSCollector \u548C G1CollectorHeap \u7B49\u51E0\u4E2A\u6536\u96C6\u5668\u6267\u884C GC \u65F6\u8C03\u7528\u3002\u8FD9\u4E2A\u91CC\u9762\u4F1A\u6839\u636E <code>used_after_gc</code>\uFF0C<code>MinMetaspaceFreeRatio</code> \u548C <code>MaxMetaspaceFreeRatio</code> \u8FD9\u4E09\u4E2A\u503C\u8BA1\u7B97\u51FA\u6765\u4E00\u4E2A\u65B0\u7684 <code>_capacity_until_GC</code> \u503C\uFF08\u6C34\u4F4D\u7EBF\uFF09\u3002\u7136\u540E\u6839\u636E\u5B9E\u9645\u7684 _capacity_until_GC \u503C\u4F7F\u7528 <code>MetaspaceGC::inc_capacity_until_GC()</code> \u548C <code>MetaspaceGC::dec_capacity_until_GC()</code> \u8FDB\u884C expand \u6216 shrink\uFF0C\u8FD9\u4E2A\u8FC7\u7A0B\u4E5F\u53EF\u4EE5\u53C2\u7167\u573A\u666F\u4E00\u4E2D\u7684\u4F38\u7F29\u6A21\u578B\u8FDB\u884C\u7406\u89E3\u3002</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">compute_new_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_shrink_factor <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;invalid shrink factor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  uint current_shrink_factor <span class="token operator">=</span> _shrink_factor<span class="token punctuation">;</span>
  _shrink_factor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t used_after_gc <span class="token operator">=</span> <span class="token class-name">MetaspaceUtils</span><span class="token double-colon punctuation">::</span><span class="token function">committed_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t capacity_until_GC <span class="token operator">=</span> <span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">capacity_until_GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">double</span> minimum_free_percentage <span class="token operator">=</span> MinMetaspaceFreeRatio <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">double</span> maximum_used_percentage <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> minimum_free_percentage<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">double</span> min_tmp <span class="token operator">=</span> used_after_gc <span class="token operator">/</span> maximum_used_percentage<span class="token punctuation">;</span>
  size_t minimum_desired_capacity <span class="token operator">=</span>
    <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token function">MIN2</span><span class="token punctuation">(</span>min_tmp<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">(</span>max_uintx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Don&#39;t shrink less than the initial generation size</span>
  minimum_desired_capacity <span class="token operator">=</span> <span class="token function">MAX2</span><span class="token punctuation">(</span>minimum_desired_capacity<span class="token punctuation">,</span>
                                  MetaspaceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;MetaspaceGC::compute_new_size: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;    minimum_free_percentage: %6.2f  maximum_used_percentage: %6.2f&quot;</span><span class="token punctuation">,</span>
                           minimum_free_percentage<span class="token punctuation">,</span> maximum_used_percentage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;     used_after_gc       : %6.1fKB&quot;</span><span class="token punctuation">,</span> used_after_gc <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">)</span><span class="token punctuation">;</span>


  size_t shrink_bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity_until_GC <span class="token operator">&lt;</span> minimum_desired_capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If we have less capacity below the metaspace HWM, then</span>
    <span class="token comment">// increment the HWM.</span>
    size_t expand_bytes <span class="token operator">=</span> minimum_desired_capacity <span class="token operator">-</span> capacity_until_GC<span class="token punctuation">;</span>
    expand_bytes <span class="token operator">=</span> <span class="token function">align_up</span><span class="token punctuation">(</span>expand_bytes<span class="token punctuation">,</span> <span class="token class-name">Metaspace</span><span class="token double-colon punctuation">::</span><span class="token function">commit_alignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Don&#39;t expand unless it&#39;s significant</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expand_bytes <span class="token operator">&gt;=</span> MinMetaspaceExpansion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      size_t new_capacity_until_GC <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">bool</span> succeeded <span class="token operator">=</span> <span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">inc_capacity_until_GC</span><span class="token punctuation">(</span>expand_bytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_capacity_until_GC<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>succeeded<span class="token punctuation">,</span> <span class="token string">&quot;Should always succesfully increment HWM when at safepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">Metaspace</span><span class="token double-colon punctuation">::</span><span class="token function">tracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">report_gc_threshold</span><span class="token punctuation">(</span>capacity_until_GC<span class="token punctuation">,</span>
                                               new_capacity_until_GC<span class="token punctuation">,</span>
                                               MetaspaceGCThresholdUpdater<span class="token double-colon punctuation">::</span>ComputeNewSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;    expanding:  minimum_desired_capacity: %6.1fKB  expand_bytes: %6.1fKB  MinMetaspaceExpansion: %6.1fKB  new metaspace HWM:  %6.1fKB&quot;</span><span class="token punctuation">,</span>
                               minimum_desired_capacity <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">,</span>
                               expand_bytes <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">,</span>
                               MinMetaspaceExpansion <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">,</span>
                               new_capacity_until_GC <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// No expansion, now see if we want to shrink</span>
  <span class="token comment">// We would never want to shrink more than this</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>capacity_until_GC <span class="token operator">&gt;=</span> minimum_desired_capacity<span class="token punctuation">,</span>
         SIZE_FORMAT <span class="token string">&quot; &gt;= &quot;</span> SIZE_FORMAT<span class="token punctuation">,</span>
         capacity_until_GC<span class="token punctuation">,</span> minimum_desired_capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t max_shrink_bytes <span class="token operator">=</span> capacity_until_GC <span class="token operator">-</span> minimum_desired_capacity<span class="token punctuation">;</span>

  <span class="token comment">// Should shrinking be considered?</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>MaxMetaspaceFreeRatio <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">double</span> maximum_free_percentage <span class="token operator">=</span> MaxMetaspaceFreeRatio <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">double</span> minimum_used_percentage <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> maximum_free_percentage<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">double</span> max_tmp <span class="token operator">=</span> used_after_gc <span class="token operator">/</span> minimum_used_percentage<span class="token punctuation">;</span>
    size_t maximum_desired_capacity <span class="token operator">=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token function">MIN2</span><span class="token punctuation">(</span>max_tmp<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">(</span>max_uintx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    maximum_desired_capacity <span class="token operator">=</span> <span class="token function">MAX2</span><span class="token punctuation">(</span>maximum_desired_capacity<span class="token punctuation">,</span>
                                    MetaspaceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;    maximum_free_percentage: %6.2f  minimum_used_percentage: %6.2f&quot;</span><span class="token punctuation">,</span>
                             maximum_free_percentage<span class="token punctuation">,</span> minimum_used_percentage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;    minimum_desired_capacity: %6.1fKB  maximum_desired_capacity: %6.1fKB&quot;</span><span class="token punctuation">,</span>
                             minimum_desired_capacity <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">,</span> maximum_desired_capacity <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>minimum_desired_capacity <span class="token operator">&lt;=</span> maximum_desired_capacity<span class="token punctuation">,</span>
           <span class="token string">&quot;sanity check&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity_until_GC <span class="token operator">&gt;</span> maximum_desired_capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Capacity too large, compute shrinking size</span>
      shrink_bytes <span class="token operator">=</span> capacity_until_GC <span class="token operator">-</span> maximum_desired_capacity<span class="token punctuation">;</span>
      shrink_bytes <span class="token operator">=</span> shrink_bytes <span class="token operator">/</span> <span class="token number">100</span> <span class="token operator">*</span> current_shrink_factor<span class="token punctuation">;</span>

      shrink_bytes <span class="token operator">=</span> <span class="token function">align_down</span><span class="token punctuation">(</span>shrink_bytes<span class="token punctuation">,</span> <span class="token class-name">Metaspace</span><span class="token double-colon punctuation">::</span><span class="token function">commit_alignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">assert</span><span class="token punctuation">(</span>shrink_bytes <span class="token operator">&lt;=</span> max_shrink_bytes<span class="token punctuation">,</span>
             <span class="token string">&quot;invalid shrink size &quot;</span> SIZE_FORMAT <span class="token string">&quot; not &lt;= &quot;</span> SIZE_FORMAT<span class="token punctuation">,</span>
             shrink_bytes<span class="token punctuation">,</span> max_shrink_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current_shrink_factor <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _shrink_factor <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        _shrink_factor <span class="token operator">=</span> <span class="token function">MIN2</span><span class="token punctuation">(</span>current_shrink_factor <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;    shrinking:  initThreshold: %.1fK  maximum_desired_capacity: %.1fK&quot;</span><span class="token punctuation">,</span>
                               MetaspaceSize <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">,</span> maximum_desired_capacity <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> metaspace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;    shrink_bytes: %.1fK  current_shrink_factor: %d  new shrink factor: %d  MinMetaspaceExpansion: %.1fK&quot;</span><span class="token punctuation">,</span>
                               shrink_bytes <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">,</span> current_shrink_factor<span class="token punctuation">,</span> _shrink_factor<span class="token punctuation">,</span> MinMetaspaceExpansion <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> K<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Don&#39;t shrink unless it&#39;s significant</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shrink_bytes <span class="token operator">&gt;=</span> MinMetaspaceExpansion <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>capacity_until_GC <span class="token operator">-</span> shrink_bytes<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> MetaspaceSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t new_capacity_until_GC <span class="token operator">=</span> <span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">dec_capacity_until_GC</span><span class="token punctuation">(</span>shrink_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Metaspace</span><span class="token double-colon punctuation">::</span><span class="token function">tracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">report_gc_threshold</span><span class="token punctuation">(</span>capacity_until_GC<span class="token punctuation">,</span>
                                             new_capacity_until_GC<span class="token punctuation">,</span>
                                             MetaspaceGCThresholdUpdater<span class="token double-colon punctuation">::</span>ComputeNewSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7531\u573A\u666F\u4E00\u53EF\u77E5\uFF0C\u4E3A\u4E86\u907F\u514D\u5F39\u6027\u4F38\u7F29\u5E26\u6765\u7684\u989D\u5916 GC \u6D88\u8017\uFF0C\u6211\u4EEC\u4F1A\u5C06 <code>-XX:MetaSpaceSize</code> \u548C <code>-XX:MaxMetaSpaceSize</code> \u4E24\u4E2A\u503C\u8BBE\u7F6E\u4E3A\u56FA\u5B9A\u7684\uFF0C\u4F46\u662F\u8FD9\u6837\u4E5F\u4F1A\u5BFC\u81F4\u5728\u7A7A\u95F4\u4E0D\u591F\u7684\u65F6\u5019\u65E0\u6CD5\u6269\u5BB9\uFF0C\u7136\u540E\u9891\u7E41\u5730\u89E6\u53D1 GC\uFF0C\u6700\u7EC8 OOM\u3002\u6240\u4EE5\u5173\u952E\u539F\u56E0\u5C31\u662F ClassLoader \u4E0D\u505C\u5730\u5728\u5185\u5B58\u4E2D load \u4E86\u65B0\u7684 Class \uFF0C\u4E00\u822C\u8FD9\u79CD\u95EE\u9898\u90FD\u53D1\u751F\u5728\u52A8\u6001\u7C7B\u52A0\u8F7D\u7B49\u60C5\u51B5\u4E0A\u3002</p><h4 id="_4-3-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-3-3-\u7B56\u7565" aria-hidden="true">#</a> 4.3.3 \u7B56\u7565</h4><p>\u4E86\u89E3\u5927\u6982\u4EC0\u4E48\u539F\u56E0\u540E\uFF0C\u5982\u4F55\u5B9A\u4F4D\u548C\u89E3\u51B3\u5C31\u5F88\u7B80\u5355\u4E86\uFF0C\u53EF\u4EE5 dump \u5FEB\u7167\u4E4B\u540E\u901A\u8FC7 JProfiler \u6216 MAT \u89C2\u5BDF Classes \u7684 Histogram\uFF08\u76F4\u65B9\u56FE\uFF09 \u5373\u53EF\uFF0C\u6216\u8005\u76F4\u63A5\u901A\u8FC7\u547D\u4EE4\u5373\u53EF\u5B9A\u4F4D\uFF0C jcmd \u6253\u51E0\u6B21 Histogram \u7684\u56FE\uFF0C\u770B\u4E00\u4E0B\u5177\u4F53\u662F\u54EA\u4E2A\u5305\u4E0B\u7684 Class \u589E\u52A0\u8F83\u591A\u5C31\u53EF\u4EE5\u5B9A\u4F4D\u4E86\u3002\u4E0D\u8FC7\u6709\u65F6\u5019\u4E5F\u8981\u7ED3\u5408InstBytes\u3001KlassBytes\u3001Bytecodes\u3001MethodAll \u7B49\u51E0\u9879\u6307\u6807\u7EFC\u5408\u6765\u770B\u4E0B\u3002\u5982\u4E0B\u56FE\u4FBF\u662F\u7B14\u8005\u4F7F\u7528 jcmd \u6392\u67E5\u5230\u4E00\u4E2A Orika \u7684\u95EE\u9898\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>jcmd <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span> GC.class_stats<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">&#39;{print$13}&#39;</span><span class="token operator">|</span><span class="token function">sed</span>  <span class="token string">&#39;s/\\(.*\\)\\.\\(.*\\)/\\1/g&#39;</span><span class="token operator">|</span><span class="token function">sort</span> <span class="token operator">|</span><span class="token function">uniq</span> -c<span class="token operator">|</span><span class="token function">sort</span> -nrk1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822221545629.png" alt="image-20220822221545629" loading="lazy"></p><p>\u5982\u679C\u65E0\u6CD5\u4ECE\u6574\u4F53\u7684\u89D2\u5EA6\u5B9A\u4F4D\uFF0C\u53EF\u4EE5\u6DFB\u52A0 <code>-XX:+TraceClassLoading</code> \u548C <code>-XX:+TraceClassUnLoading</code> \u53C2\u6570\u89C2\u5BDF\u8BE6\u7EC6\u7684\u7C7B\u52A0\u8F7D\u548C\u5378\u8F7D\u4FE1\u606F\u3002</p><h4 id="_4-3-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-3-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.3.4 \u5C0F\u7ED3</h4><p>\u539F\u7406\u7406\u89E3\u6BD4\u8F83\u590D\u6742\uFF0C\u4F46\u5B9A\u4F4D\u548C\u89E3\u51B3\u95EE\u9898\u4F1A\u6BD4\u8F83\u7B80\u5355\uFF0C\u7ECF\u5E38\u4F1A\u51FA\u95EE\u9898\u7684\u51E0\u4E2A\u70B9\u6709 Orika \u7684 classMap\u3001JSON \u7684 ASMSerializer\u3001Groovy \u52A8\u6001\u52A0\u8F7D\u7C7B\u7B49\uFF0C\u57FA\u672C\u90FD\u96C6\u4E2D\u5728\u53CD\u5C04\u3001Javasisit \u5B57\u8282\u7801\u589E\u5F3A\u3001CGLIB \u52A8\u6001\u4EE3\u7406\u3001OSGi \u81EA\u5B9A\u4E49\u7C7B\u52A0\u8F7D\u5668\u7B49\u7684\u6280\u672F\u70B9\u4E0A\u3002\u53E6\u5916\u5C31\u662F\u53CA\u65F6\u7ED9 MetaSpace \u533A\u7684\u4F7F\u7528\u7387\u52A0\u4E00\u4E2A\u76D1\u63A7\uFF0C\u5982\u679C\u6307\u6807\u6709\u6CE2\u52A8\u63D0\u524D\u53D1\u73B0\u5E76\u89E3\u51B3\u95EE\u9898\u3002</p><h3 id="_4-4-\u573A\u666F\u56DB-\u8FC7\u65E9\u664B\u5347" tabindex="-1"><a class="header-anchor" href="#_4-4-\u573A\u666F\u56DB-\u8FC7\u65E9\u664B\u5347" aria-hidden="true">#</a> 4.4 \u573A\u666F\u56DB\uFF1A\u8FC7\u65E9\u664B\u5347</h3><h4 id="_4-4-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-4-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.4.1 \u73B0\u8C61</h4><p>\u8FD9\u79CD\u573A\u666F\u4E3B\u8981\u53D1\u751F\u5728\u5206\u4EE3\u7684\u6536\u96C6\u5668\u4E0A\u9762\uFF0C\u4E13\u4E1A\u7684\u672F\u8BED\u79F0\u4E3A\u201CPremature Promotion\u201D\u300290% \u7684\u5BF9\u8C61\u671D\u751F\u5915\u6B7B\uFF0C\u53EA\u6709\u5728 Young \u533A\u7ECF\u5386\u8FC7\u51E0\u6B21 GC \u7684\u6D17\u793C\u540E\u624D\u4F1A\u664B\u5347\u5230 Old \u533A\uFF0C\u6BCF\u7ECF\u5386\u4E00\u6B21 GC \u5BF9\u8C61\u7684 GC Age \u5C31\u4F1A\u589E\u957F 1\uFF0C\u6700\u5927\u901A\u8FC7 <code>-XX:MaxTenuringThreshold</code> \u6765\u63A7\u5236\u3002</p><p>\u8FC7\u65E9\u664B\u5347\u4E00\u822C\u4E0D\u4F1A\u76F4\u63A5\u5F71\u54CD GC\uFF0C\u603B\u4F1A\u4F34\u968F\u7740\u6D6E\u52A8\u5783\u573E\u3001\u5927\u5BF9\u8C61\u62C5\u4FDD\u5931\u8D25\u7B49\u95EE\u9898\uFF0C\u4F46\u8FD9\u4E9B\u95EE\u9898\u4E0D\u662F\u7ACB\u523B\u53D1\u751F\u7684\uFF0C\u6211\u4EEC\u53EF\u4EE5\u89C2\u5BDF\u4EE5\u4E0B\u51E0\u79CD\u73B0\u8C61\u6765\u5224\u65AD\u662F\u5426\u53D1\u751F\u4E86\u8FC7\u65E9\u664B\u5347\u3002</p><p>\u5206\u914D\u901F\u7387\u63A5\u8FD1\u4E8E\u664B\u5347\u901F\u7387\uFF0C\u5BF9\u8C61\u664B\u5347\u5E74\u9F84\u8F83\u5C0F\u3002</p><p>GC \u65E5\u5FD7\u4E2D\u51FA\u73B0<code>\u201CDesired survivor size 107347968 bytes, new threshold 1(max 6)\u201D</code>\u7B49\u4FE1\u606F\uFF0C\u8BF4\u660E\u6B64\u65F6\u7ECF\u5386\u8FC7\u4E00\u6B21 GC \u5C31\u4F1A\u653E\u5230 Old \u533A\u3002</p><p><strong>Full GC \u6BD4\u8F83\u9891\u7E41</strong>\uFF0C\u4E14\u7ECF\u5386\u8FC7\u4E00\u6B21 GC \u4E4B\u540E Old \u533A\u7684\u53D8\u5316\u6BD4\u4F8B\u975E\u5E38\u5927\u3002</p><p>\u6BD4\u5982\u8BF4 Old \u533A\u89E6\u53D1\u7684\u56DE\u6536\u9608\u503C\u662F 80%\uFF0C\u7ECF\u5386\u8FC7\u4E00\u6B21 GC \u4E4B\u540E\u4E0B\u964D\u5230\u4E86 10%\uFF0C\u8FD9\u5C31\u8BF4\u660E Old \u533A\u7684 70% \u7684\u5BF9\u8C61\u5B58\u6D3B\u65F6\u95F4\u5176\u5B9E\u5F88\u77ED\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\uFF0COld \u533A\u5927\u5C0F\u6BCF\u6B21 GC \u540E\u4ECE 2.1G \u56DE\u6536\u5230 300M\uFF0C\u4E5F\u5C31\u662F\u8BF4\u56DE\u6536\u6389\u4E86 1.8G \u7684\u5783\u573E\uFF0C<strong>\u53EA\u6709 300M \u7684\u6D3B\u8DC3\u5BF9\u8C61</strong>\u3002\u6574\u4E2A Heap \u76EE\u524D\u662F 4G\uFF0C\u6D3B\u8DC3\u5BF9\u8C61\u53EA\u5360\u4E86\u4E0D\u5230\u5341\u5206\u4E4B\u4E00\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822221838560.png" alt="image-20220822221838560" loading="lazy"></p><p>\u8FC7\u65E9\u664B\u5347\u7684\u5371\u5BB3\uFF1A</p><ul><li>Young GC \u9891\u7E41\uFF0C\u603B\u7684\u541E\u5410\u91CF\u4E0B\u964D\u3002</li><li>Full GC \u9891\u7E41\uFF0C\u53EF\u80FD\u4F1A\u6709\u8F83\u5927\u505C\u987F\u3002</li></ul><h4 id="_4-4-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-4-2-\u539F\u56E0" aria-hidden="true">#</a> 4.4.2 \u539F\u56E0</h4><p>\u4E3B\u8981\u7684\u539F\u56E0\u6709\u4EE5\u4E0B\u4E24\u70B9\uFF1A</p><ul><li><strong>Young/Eden \u533A\u8FC7\u5C0F</strong>\uFF1A \u8FC7\u5C0F\u7684\u76F4\u63A5\u540E\u679C\u5C31\u662F Eden \u88AB\u88C5\u6EE1\u7684\u65F6\u95F4\u53D8\u77ED\uFF0C\u672C\u5E94\u8BE5\u56DE\u6536\u7684\u5BF9\u8C61\u53C2\u4E0E\u4E86 GC \u5E76\u664B\u5347\uFF0CYoung GC \u91C7\u7528\u7684\u662F\u590D\u5236\u7B97\u6CD5\uFF0C\u7531\u57FA\u7840\u7BC7\u6211\u4EEC\u77E5\u9053 copying \u8017\u65F6\u8FDC\u5927\u4E8E mark\uFF0C\u4E5F\u5C31\u662F Young GC \u8017\u65F6\u672C\u8D28\u4E0A\u5C31\u662F copy \u7684\u65F6\u95F4\uFF08CMS \u626B\u63CF Card Table \u6216 G1 \u626B\u63CF Remember Set \u51FA\u95EE\u9898\u7684\u60C5\u51B5\u53E6\u8BF4\uFF09\uFF0C\u6CA1\u6765\u53CA\u56DE\u6536\u7684\u5BF9\u8C61\u589E\u5927\u4E86\u56DE\u6536\u7684\u4EE3\u4EF7\uFF0C\u6240\u4EE5 Young GC \u65F6\u95F4\u589E\u52A0\uFF0C\u540C\u65F6\u53C8\u65E0\u6CD5\u5FEB\u901F\u91CA\u653E\u7A7A\u95F4\uFF0CYoung GC \u6B21\u6570\u4E5F\u8DDF\u7740\u589E\u52A0\u3002</li><li><strong>\u5206\u914D\u901F\u7387\u8FC7\u5927</strong>\uFF1A \u53EF\u4EE5\u89C2\u5BDF\u51FA\u95EE\u9898\u524D\u540E Mutator \u7684\u5206\u914D\u901F\u7387\uFF0C\u5982\u679C\u6709\u660E\u663E\u6CE2\u52A8\u53EF\u4EE5\u5C1D\u8BD5\u89C2\u5BDF\u7F51\u5361\u6D41\u91CF\u3001\u5B58\u50A8\u7C7B\u4E2D\u95F4\u4EF6\u6162\u67E5\u8BE2\u65E5\u5FD7\u7B49\u4FE1\u606F\uFF0C\u770B\u662F\u5426\u6709\u5927\u91CF\u6570\u636E\u88AB\u52A0\u8F7D\u5230\u5185\u5B58\u4E2D\u3002</li></ul><p>\u540C\u65F6\u65E0\u6CD5 GC \u6389\u5BF9\u8C61\u8FD8\u4F1A\u5E26\u6765\u53E6\u5916\u4E00\u4E2A\u95EE\u9898\uFF0C\u5F15\u53D1\u52A8\u6001\u5E74\u9F84\u8BA1\u7B97\uFF1AJVM \u901A\u8FC7 <code>-XX:MaxTenuringThreshold</code> \u53C2\u6570\u6765\u63A7\u5236\u664B\u5347\u5E74\u9F84\uFF0C\u6BCF\u7ECF\u8FC7\u4E00\u6B21 GC\uFF0C\u5E74\u9F84\u5C31\u4F1A\u52A0\u4E00\uFF0C\u8FBE\u5230\u6700\u5927\u5E74\u9F84\u5C31\u53EF\u4EE5\u8FDB\u5165 Old \u533A\uFF0C\u6700\u5927\u503C\u4E3A 15\uFF08\u56E0\u4E3A JVM \u4E2D\u4F7F\u7528 4 \u4E2A\u6BD4\u7279\u6765\u8868\u793A\u5BF9\u8C61\u7684\u5E74\u9F84\uFF09\u3002\u8BBE\u5B9A\u56FA\u5B9A\u7684 MaxTenuringThreshold \u503C\u4F5C\u4E3A\u664B\u5347\u6761\u4EF6\uFF1A</p><ul><li><code>MaxTenuringThreshold</code> \u5982\u679C\u8BBE\u7F6E\u5F97\u8FC7\u5927\uFF0C\u539F\u672C\u5E94\u8BE5\u664B\u5347\u7684\u5BF9\u8C61\u4E00\u76F4\u505C\u7559\u5728 Survivor \u533A\uFF0C\u76F4\u5230 Survivor \u533A\u6EA2\u51FA\uFF0C\u4E00\u65E6\u6EA2\u51FA\u53D1\u751F\uFF0CEden + Survivor \u4E2D\u5BF9\u8C61\u5C06\u4E0D\u518D\u4F9D\u636E\u5E74\u9F84\u5168\u90E8\u63D0\u5347\u5230 Old \u533A\uFF0C\u8FD9\u6837\u5BF9\u8C61\u8001\u5316\u7684\u673A\u5236\u5C31\u5931\u6548\u4E86\u3002</li><li><code>MaxTenuringThreshold</code> \u5982\u679C\u8BBE\u7F6E\u5F97\u8FC7\u5C0F\uFF0C\u8FC7\u65E9\u664B\u5347\u5373\u5BF9\u8C61\u4E0D\u80FD\u5728 Young \u533A\u5145\u5206\u88AB\u56DE\u6536\uFF0C\u5927\u91CF\u77ED\u671F\u5BF9\u8C61\u88AB\u664B\u5347\u5230 Old \u533A\uFF0COld \u533A\u7A7A\u95F4\u8FC5\u901F\u589E\u957F\uFF0C\u5F15\u8D77\u9891\u7E41\u7684 Major GC\uFF0C\u5206\u4EE3\u56DE\u6536\u5931\u53BB\u4E86\u610F\u4E49\uFF0C\u4E25\u91CD\u5F71\u54CD GC \u6027\u80FD\u3002</li></ul><p>\u76F8\u540C\u5E94\u7528\u5728\u4E0D\u540C\u65F6\u95F4\u7684\u8868\u73B0\u4E0D\u540C\uFF0C\u7279\u6B8A\u4EFB\u52A1\u7684\u6267\u884C\u6216\u8005\u6D41\u91CF\u6210\u5206\u7684\u53D8\u5316\uFF0C\u90FD\u4F1A\u5BFC\u81F4\u5BF9\u8C61\u7684\u751F\u547D\u5468\u671F\u5206\u5E03\u53D1\u751F\u6CE2\u52A8\uFF0C\u90A3\u4E48\u56FA\u5B9A\u7684\u9608\u503C\u8BBE\u5B9A\uFF0C\u56E0\u4E3A\u65E0\u6CD5\u52A8\u6001\u9002\u5E94\u53D8\u5316\uFF0C\u4F1A\u9020\u6210\u548C\u4E0A\u9762\u95EE\u9898\uFF0C\u6240\u4EE5 Hotspot \u4F1A\u4F7F\u7528\u52A8\u6001\u8BA1\u7B97\u7684\u65B9\u5F0F\u6765\u8C03\u6574\u664B\u5347\u7684\u9608\u503C\u3002</p><p>\u5177\u4F53\u52A8\u6001\u8BA1\u7B97\u53EF\u4EE5\u770B\u4E00\u4E0B Hotspot \u6E90\u7801\uFF0C\u5177\u4F53\u5728 <code>/src/hotspot/share/gc/shared/ageTable.cpp</code> \u7684 <code>compute_tenuring_threshold</code>\u65B9\u6CD5\u4E2D\uFF1A</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>uint ageTable<span class="token double-colon punctuation">::</span><span class="token function">compute_tenuring_threshold</span><span class="token punctuation">(</span>size_t survivor_capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//TargetSurvivorRatio\u9ED8\u8BA450\uFF0C\u610F\u601D\u662F\uFF1A\u5728\u56DE\u6536\u4E4B\u540E\u5E0C\u671Bsurvivor\u533A\u7684\u5360\u7528\u7387\u8FBE\u5230\u8FD9\u4E2A\u6BD4\u4F8B</span>
  size_t desired_survivor_size <span class="token operator">=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> survivor_capacity<span class="token punctuation">)</span><span class="token operator">*</span>TargetSurvivorRatio<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  uint age <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>sizes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;no objects with age zero should be recorded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>age <span class="token operator">&lt;</span> table_size<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//table_size=16</span>
    total <span class="token operator">+=</span> sizes<span class="token punctuation">[</span>age<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5982\u679C\u52A0\u4E0A\u8FD9\u4E2A\u5E74\u9F84\u7684\u6240\u6709\u5BF9\u8C61\u7684\u5927\u5C0F\u4E4B\u540E\uFF0C\u5360\u7528\u91CF&gt;\u671F\u671B\u7684\u5927\u5C0F\uFF0C\u5C31\u8BBE\u7F6Eage\u4E3A\u65B0\u7684\u664B\u5347\u9608\u503C</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>total <span class="token operator">&gt;</span> desired_survivor_size<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    age<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  uint result <span class="token operator">=</span> age <span class="token operator">&lt;</span> MaxTenuringThreshold <span class="token operator">?</span> age <span class="token operator">:</span> MaxTenuringThreshold<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintTenuringDistribution <span class="token operator">||</span> UsePerfData<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//\u6253\u5370\u671F\u671B\u7684survivor\u7684\u5927\u5C0F\u4EE5\u53CA\u65B0\u8BA1\u7B97\u51FA\u6765\u7684\u9608\u503C\uFF0C\u548C\u8BBE\u7F6E\u7684\u6700\u5927\u9608\u503C</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintTenuringDistribution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      gclog_or_tty<span class="token operator">-&gt;</span><span class="token function">cr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      gclog_or_tty<span class="token operator">-&gt;</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;Desired survivor size &quot;</span> SIZE_FORMAT <span class="token string">&quot; bytes, new threshold %u (max %u)&quot;</span><span class="token punctuation">,</span>
        desired_survivor_size<span class="token operator">*</span>oopSize<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> MaxTenuringThreshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    age <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>age <span class="token operator">&lt;</span> table_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      total <span class="token operator">+=</span> sizes<span class="token punctuation">[</span>age<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sizes<span class="token punctuation">[</span>age<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintTenuringDistribution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          gclog_or_tty<span class="token operator">-&gt;</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;- age %3u: &quot;</span> <span class="token function">SIZE_FORMAT_W</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">&quot; bytes, &quot;</span> <span class="token function">SIZE_FORMAT_W</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">&quot; total&quot;</span><span class="token punctuation">,</span>
                                        age<span class="token punctuation">,</span>    sizes<span class="token punctuation">[</span>age<span class="token punctuation">]</span><span class="token operator">*</span>oopSize<span class="token punctuation">,</span>          total<span class="token operator">*</span>oopSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>UsePerfData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _perf_sizes<span class="token punctuation">[</span>age<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">set_value</span><span class="token punctuation">(</span>sizes<span class="token punctuation">[</span>age<span class="token punctuation">]</span><span class="token operator">*</span>oopSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      age<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>UsePerfData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      SharedHeap<span class="token operator">*</span> sh <span class="token operator">=</span> <span class="token class-name">SharedHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      CollectorPolicy<span class="token operator">*</span> policy <span class="token operator">=</span> sh<span class="token operator">-&gt;</span><span class="token function">collector_policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      GCPolicyCounters<span class="token operator">*</span> gc_counters <span class="token operator">=</span> policy<span class="token operator">-&gt;</span><span class="token function">counters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      gc_counters<span class="token operator">-&gt;</span><span class="token function">tenuring_threshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_value</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gc_counters<span class="token operator">-&gt;</span><span class="token function">desired_survivor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_value</span><span class="token punctuation">(</span>
        desired_survivor_size<span class="token operator">*</span>oopSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230 Hotspot \u904D\u5386\u6240\u6709\u5BF9\u8C61\u65F6\uFF0C\u4ECE\u6240\u6709\u5E74\u9F84\u4E3A 0 \u7684\u5BF9\u8C61\u5360\u7528\u7684\u7A7A\u95F4\u5F00\u59CB\u7D2F\u52A0\uFF0C\u5982\u679C\u52A0\u4E0A\u5E74\u9F84\u7B49\u4E8E n \u7684\u6240\u6709\u5BF9\u8C61\u7684\u7A7A\u95F4\u4E4B\u540E\uFF0C\u4F7F\u7528 Survivor \u533A\u7684\u6761\u4EF6\u503C\uFF08TargetSurvivorRatio / 100\uFF0CTargetSurvivorRatio \u9ED8\u8BA4\u503C\u4E3A 50\uFF09\u8FDB\u884C\u5224\u65AD\uFF0C\u82E5\u5927\u4E8E\u8FD9\u4E2A\u503C\u5219\u7ED3\u675F\u5FAA\u73AF\uFF0C\u5C06 n \u548C MaxTenuringThreshold \u6BD4\u8F83\uFF0C\u82E5 n \u5C0F\uFF0C\u5219\u9608\u503C\u4E3A n\uFF0C\u82E5 n \u5927\uFF0C\u5219\u53EA\u80FD\u53BB\u8BBE\u7F6E\u6700\u5927\u9608\u503C\u4E3A MaxTenuringThreshold\u3002<strong>\u52A8\u6001\u5E74\u9F84\u89E6\u53D1\u540E\u5BFC\u81F4\u66F4\u591A\u7684\u5BF9\u8C61\u8FDB\u5165\u4E86 Old \u533A\uFF0C\u9020\u6210\u8D44\u6E90\u6D6A\u8D39</strong>\u3002</p><h4 id="_4-4-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-4-3-\u7B56\u7565" aria-hidden="true">#</a> 4.4.3 \u7B56\u7565</h4><p>\u77E5\u9053\u95EE\u9898\u539F\u56E0\u540E\u6211\u4EEC\u5C31\u6709\u89E3\u51B3\u7684\u65B9\u5411\uFF0C\u5982\u679C\u662F <strong>Young/Eden \u533A\u8FC7\u5C0F</strong>\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5728\u603B\u7684 Heap \u5185\u5B58\u4E0D\u53D8\u7684\u60C5\u51B5\u4E0B\u9002\u5F53\u589E\u5927 Young \u533A\uFF0C\u5177\u4F53\u600E\u4E48\u589E\u52A0\uFF1F\u4E00\u822C\u60C5\u51B5\u4E0B Old \u7684\u5927\u5C0F\u5E94\u5F53\u4E3A\u6D3B\u8DC3\u5BF9\u8C61\u7684 2~3 \u500D\u5DE6\u53F3\uFF0C\u8003\u8651\u5230\u6D6E\u52A8\u5783\u573E\u95EE\u9898\u6700\u597D\u5728 3 \u500D\u5DE6\u53F3\uFF0C\u5269\u4E0B\u7684\u90FD\u53EF\u4EE5\u5206\u7ED9 Young \u533A\u3002</p><p>\u62FF\u7B14\u8005\u7684\u4E00\u6B21\u5178\u578B\u8FC7\u65E9\u664B\u5347\u4F18\u5316\u6765\u770B\uFF0C\u539F\u914D\u7F6E\u4E3A Young 1.2G + Old 2.8G\uFF0C\u901A\u8FC7\u89C2\u5BDF CMS GC \u7684\u60C5\u51B5\u627E\u5230\u5B58\u6D3B\u5BF9\u8C61\u5927\u6982\u4E3A 300~400M\uFF0C\u4E8E\u662F\u8C03\u6574 Old 1.5G \u5DE6\u53F3\uFF0C\u5269\u4E0B 2.5G \u5206\u7ED9 Young \u533A\u3002\u4EC5\u4EC5\u8C03\u4E86\u4E00\u4E2A Young \u533A\u5927\u5C0F\u53C2\u6570\uFF08-Xmn\uFF09\uFF0C\u6574\u4E2A JVM \u4E00\u5206\u949F Young GC \u4ECE 26 \u6B21\u964D\u4F4E\u5230\u4E86 11 \u6B21\uFF0C\u5355\u6B21\u65F6\u95F4\u4E5F\u6CA1\u6709\u589E\u52A0\uFF0C\u603B\u7684 GC \u65F6\u95F4\u4ECE 1100ms \u964D\u4F4E\u5230\u4E86 500ms\uFF0CCMS GC \u6B21\u6570\u4E5F\u4ECE 40 \u5206\u949F\u5DE6\u53F3\u4E00\u6B21\u964D\u4F4E\u5230\u4E86 7 \u5C0F\u65F6 30 \u5206\u949F\u4E00\u6B21\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822222109592.png" alt="image-20220822222109592" loading="lazy"></p><p>\u5982\u679C\u662F\u5206\u914D\u901F\u7387\u8FC7\u5927\uFF1A</p><ul><li><strong>\u5076\u53D1\u8F83\u5927</strong>\uFF1A\u901A\u8FC7\u5185\u5B58\u5206\u6790\u5DE5\u5177\u627E\u5230\u95EE\u9898\u4EE3\u7801\uFF0C\u4ECE\u4E1A\u52A1\u903B\u8F91\u4E0A\u505A\u4E00\u4E9B\u4F18\u5316\u3002</li><li><strong>\u4E00\u76F4\u8F83\u5927</strong>\uFF1A\u5F53\u524D\u7684 Collector \u5DF2\u7ECF\u4E0D\u6EE1\u8DB3 Mutator \u7684\u671F\u671B\u4E86\uFF0C\u8FD9\u79CD\u60C5\u51B5\u8981\u4E48\u6269\u5BB9 Mutator \u7684 VM\uFF0C\u8981\u4E48\u8C03\u6574 GC \u6536\u96C6\u5668\u7C7B\u578B\u6216\u52A0\u5927\u7A7A\u95F4\u3002</li></ul><h4 id="_4-4-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-4-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.4.4 \u5C0F\u7ED3</h4><p>\u8FC7\u65E9\u664B\u5347\u95EE\u9898\u4E00\u822C\u4E0D\u4F1A\u7279\u522B\u660E\u663E\uFF0C\u4F46\u65E5\u79EF\u6708\u7D2F\u4E4B\u540E\u53EF\u80FD\u4F1A\u7206\u53D1\u4E00\u6CE2\u6536\u96C6\u5668\u9000\u5316\u4E4B\u7C7B\u7684\u95EE\u9898\uFF0C\u6240\u4EE5\u6211\u4EEC\u8FD8\u662F\u8981\u63D0\u524D\u907F\u514D\u6389\u7684\uFF0C\u53EF\u4EE5\u770B\u770B\u81EA\u5DF1\u7CFB\u7EDF\u91CC\u9762\u662F\u5426\u6709\u8FD9\u4E9B\u73B0\u8C61\uFF0C\u5982\u679C\u6BD4\u8F83\u5339\u914D\u7684\u8BDD\uFF0C\u53EF\u4EE5\u5C1D\u8BD5\u4F18\u5316\u4E00\u4E0B\u3002\u4E00\u884C\u4EE3\u7801\u4F18\u5316\u7684 ROI \u8FD8\u662F\u5F88\u9AD8\u7684\u3002</p><p>\u5982\u679C\u5728\u89C2\u5BDF Old \u533A\u524D\u540E\u6BD4\u4F8B\u53D8\u5316\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u53D1\u73B0\u53EF\u4EE5\u56DE\u6536\u7684\u6BD4\u4F8B\u975E\u5E38\u5C0F\uFF0C\u5982\u4ECE 80% \u53EA\u56DE\u6536\u5230\u4E86 60%\uFF0C\u8BF4\u660E\u6211\u4EEC\u5927\u90E8\u5206\u5BF9\u8C61\u90FD\u662F\u5B58\u6D3B\u7684\uFF0COld \u533A\u7684\u7A7A\u95F4\u53EF\u4EE5\u9002\u5F53\u8C03\u5927\u4E9B\u3002</p><h4 id="_4-4-5-\u52A0\u9910" tabindex="-1"><a class="header-anchor" href="#_4-4-5-\u52A0\u9910" aria-hidden="true">#</a> 4.4.5 \u52A0\u9910</h4><p>\u5173\u4E8E\u5728\u8C03\u6574 Young \u4E0E Old \u7684\u6BD4\u4F8B\u65F6\uFF0C\u5982\u4F55\u9009\u53D6\u5177\u4F53\u7684 NewRatio \u503C\uFF0C\u8FD9\u91CC\u5C06\u95EE\u9898\u62BD\u8C61\u6210\u4E3A\u4E00\u4E2A\u84C4\u6C34\u6C60\u6A21\u578B\uFF0C\u627E\u5230\u4EE5\u4E0B\u5173\u952E\u8861\u91CF\u6307\u6807\uFF0C\u5927\u5BB6\u53EF\u4EE5\u6839\u636E\u81EA\u5DF1\u573A\u666F\u8FDB\u884C\u63A8\u7B97\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822222446050.png" alt="image-20220822222446050" loading="lazy"></p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822222456547.png" alt="image-20220822222456547" loading="lazy"></p><ul><li><p><code>NewRatio</code> \u7684\u503C r \u4E0E va\u3001vp\u3001vyc\u3001voc\u3001rs \u7B49\u503C\u5B58\u5728\u4E00\u5B9A\u51FD\u6570\u76F8\u5173\u6027\uFF08rs \u8D8A\u5C0F r \u8D8A\u5927\u3001r \u8D8A\u5C0F vp \u8D8A\u5C0F\uFF0C\u2026\uFF0C\u4E4B\u524D\u5C1D\u8BD5\u4F7F\u7528 NN \u6765\u8F85\u52A9\u5EFA\u6A21\uFF0C\u4F46\u76EE\u524D\u8FD8\u6CA1\u6709\u5B8C\u5168\u7B97\u51FA\u5177\u4F53\u7684\u516C\u5F0F\uFF0C\u6709\u60F3\u6CD5\u7684\u540C\u5B66\u53EF\u4EE5\u5728\u8BC4\u8BBA\u533A\u7ED9\u51FA\u4F60\u7684\u7B54\u6848\uFF09\u3002</p></li><li><p>\u603B\u505C\u987F\u65F6\u95F4 T \u4E3A Young GC \u603B\u65F6\u95F4 Tyc \u548C Old GC \u603B\u65F6\u95F4 Toc \u4E4B\u548C\uFF0C\u5176\u4E2D Tyc \u4E0E vyc \u548C vp \u76F8\u5173\uFF0CToc \u4E0E voc\u76F8\u5173\u3002</p></li><li><p>\u5FFD\u7565\u6389 GC \u65F6\u95F4\u540E\uFF0C\u4E24\u6B21 Young GC \u7684\u65F6\u95F4\u95F4\u9694\u8981\u5927\u4E8E TP9999 \u65F6\u95F4\uFF0C\u8FD9\u6837\u5C3D\u91CF\u8BA9\u5BF9\u8C61\u5728 Eden \u533A\u5C31\u88AB\u56DE\u6536\uFF0C\u53EF\u4EE5\u51CF\u5C11\u5F88\u591A\u505C\u987F\u3002</p></li></ul><h3 id="_4-5-\u573A\u666F\u4E94-cms-old-gc-\u9891\u7E41" tabindex="-1"><a class="header-anchor" href="#_4-5-\u573A\u666F\u4E94-cms-old-gc-\u9891\u7E41" aria-hidden="true">#</a> 4.5 \u573A\u666F\u4E94\uFF1ACMS Old GC \u9891\u7E41</h3><h4 id="_4-5-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-5-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.5.1 \u73B0\u8C61</h4><p>Old \u533A\u9891\u7E41\u7684\u505A CMS GC\uFF0C\u4F46\u662F\u6BCF\u6B21\u8017\u65F6\u4E0D\u662F\u7279\u522B\u957F\uFF0C\u6574\u4F53\u6700\u5927 STW \u4E5F\u5728\u53EF\u63A5\u53D7\u8303\u56F4\u5185\uFF0C\u4F46\u7531\u4E8E GC \u592A\u9891\u7E41\u5BFC\u81F4\u541E\u5410\u4E0B\u964D\u6BD4\u8F83\u591A\u3002</p><h4 id="_4-5-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-5-2-\u539F\u56E0" aria-hidden="true">#</a> 4.5.2 \u539F\u56E0</h4><p>\u8FD9\u79CD\u60C5\u51B5\u6BD4\u8F83\u5E38\u89C1\uFF0C\u57FA\u672C\u90FD\u662F\u4E00\u6B21 Young GC \u5B8C\u6210\u540E\uFF0C\u8D1F\u8D23\u5904\u7406 CMS GC \u7684\u4E00\u4E2A\u540E\u53F0\u7EBF\u7A0B concurrentMarkSweepThread \u4F1A\u4E0D\u65AD\u5730\u8F6E\u8BE2\uFF0C\u4F7F\u7528 shouldConcurrentCollect() \u65B9\u6CD5\u505A\u4E00\u6B21\u68C0\u6D4B\uFF0C\u5224\u65AD\u662F\u5426\u8FBE\u5230\u4E86\u56DE\u6536\u6761\u4EF6\u3002\u5982\u679C\u8FBE\u5230\u6761\u4EF6\uFF0C\u4F7F\u7528 collect_in_background() \u542F\u52A8\u4E00\u6B21 Background \u6A21\u5F0F GC\u3002\u8F6E\u8BE2\u7684\u5224\u65AD\u662F\u4F7F\u7528 sleepBeforeNextCycle() \u65B9\u6CD5\uFF0C\u95F4\u9694\u5468\u671F\u4E3A -XX:CMSWaitDuration \u51B3\u5B9A\uFF0C\u9ED8\u8BA4\u4E3A2s\u3002</p><p>\u5177\u4F53\u4EE3\u7801\u5728\uFF1A src/hotspot/share/gc/cms/concurrentMarkSweepThread.cpp\u3002</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">ConcurrentMarkSweepThread</span><span class="token double-colon punctuation">::</span><span class="token function">run_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token function">cmst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;just checking&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>BindCMSThreadToCPU <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>os<span class="token double-colon punctuation">::</span><span class="token function">bind_to_processor</span><span class="token punctuation">(</span>CPUForCMSThread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log_warning</span><span class="token punctuation">(</span>gc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&#39;t bind CMS thread to processor &quot;</span> UINTX_FORMAT<span class="token punctuation">,</span> CPUForCMSThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">should_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sleepBeforeNextCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    GCIdMark gc_id_mark<span class="token punctuation">;</span>
    GCCause<span class="token double-colon punctuation">::</span>Cause cause <span class="token operator">=</span> _collector<span class="token operator">-&gt;</span>_full_gc_requested <span class="token operator">?</span>
      _collector<span class="token operator">-&gt;</span>_full_gc_cause <span class="token operator">:</span> GCCause<span class="token double-colon punctuation">::</span>_cms_concurrent_mark<span class="token punctuation">;</span>
    _collector<span class="token operator">-&gt;</span><span class="token function">collect_in_background</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">verify_ok_to_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token class-name">ConcurrentMarkSweepThread</span><span class="token double-colon punctuation">::</span><span class="token function">sleepBeforeNextCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">should_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>CMSWaitDuration <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Wait until the next synchronous GC, a concurrent full gc</span>
      <span class="token comment">// request or a timeout, whichever is earlier.</span>
      <span class="token function">wait_on_cms_lock_for_scavenge</span><span class="token punctuation">(</span>CMSWaitDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Wait until any cms_lock event or check interval not to call shouldConcurrentCollect permanently</span>
      <span class="token function">wait_on_cms_lock</span><span class="token punctuation">(</span>CMSCheckInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Check if we should start a CMS collection cycle</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_collector<span class="token operator">-&gt;</span><span class="token function">shouldConcurrentCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// .. collection criterion not yet met, let&#39;s go back</span>
    <span class="token comment">// and wait some more</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5224\u65AD\u662F\u5426\u8FDB\u884C\u56DE\u6536\u7684\u4EE3\u7801\u5728\uFF1A/src/hotspot/share/gc/cms/concurrentMarkSweepGeneration.cpp\u3002</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">CMSCollector</span><span class="token double-colon punctuation">::</span><span class="token function">shouldConcurrentCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">LogTarget</span><span class="token punctuation">(</span>Trace<span class="token punctuation">,</span> gc<span class="token punctuation">)</span> log<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_full_gc_requested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because of explicit  gc request (or GCLocker)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FreelistLocker <span class="token function">x</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ------------------------------------------------------------------</span>
  <span class="token comment">// Print out lots of information which affects the initiation of</span>
  <span class="token comment">// a collection.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">is_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector shouldConcurrentCollect: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    LogStream <span class="token function">out</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;time_until_cms_gen_full %3.7f&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">time_until_cms_gen_full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;free=&quot;</span> SIZE_FORMAT<span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;contiguous_available=&quot;</span> SIZE_FORMAT<span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">contiguous_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;promotion_rate=%g&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promotion_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;cms_allocation_rate=%g&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_allocation_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;occupancy=%3.7f&quot;</span><span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;initiatingOccupancy=%3.7f&quot;</span><span class="token punctuation">,</span> _cmsGen<span class="token operator">-&gt;</span><span class="token function">initiating_occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;cms_time_since_begin=%3.7f&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;cms_time_since_end=%3.7f&quot;</span><span class="token punctuation">,</span> <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;metadata initialized %d&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">should_concurrent_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ------------------------------------------------------------------</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>UseCMSInitiatingOccupancyOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">time_until_cms_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_cmsGen<span class="token operator">-&gt;</span><span class="token function">occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> _bootstrap_occupancy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot; CMSCollector: collect for bootstrapping statistics: occupancy = %f, boot occupancy = %f&quot;</span><span class="token punctuation">,</span>
                  _cmsGen<span class="token operator">-&gt;</span><span class="token function">occupancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _bootstrap_occupancy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_cmsGen<span class="token operator">-&gt;</span><span class="token function">should_concurrent_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMS old gen initiated&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We start a collection if we believe an incremental collection may fail;</span>
  <span class="token comment">// this is not likely to be productive in practice because it&#39;s probably too</span>
  <span class="token comment">// late anyway.</span>
  CMSHeap<span class="token operator">*</span> heap <span class="token operator">=</span> <span class="token class-name">CMSHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span><span class="token function">incremental_collection_will_fail</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* consult_young */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because incremental collection will fail &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MetaspaceGC</span><span class="token double-colon punctuation">::</span><span class="token function">should_concurrent_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect for metadata allocation &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// CMSTriggerInterval starts a CMS cycle if enough time has passed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>CMSTriggerInterval <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CMSTriggerInterval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Trigger always</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check the CMS time since begin (we do not check the stats validity</span>
    <span class="token comment">// as we want to be able to trigger the first CMS cycle as well)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>CMSTriggerInterval <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> MILLIUNITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because of trigger interval (time since last begin %3.7f secs)&quot;</span><span class="token punctuation">,</span>
                  <span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cms_time_since_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;CMSCollector: collect because of trigger interval (first collection)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5206\u6790\u5176\u4E2D\u903B\u8F91\u5224\u65AD\u662F\u5426\u89E6\u53D1 GC\uFF0C\u5206\u4E3A\u4EE5\u4E0B\u51E0\u79CD\u60C5\u51B5\uFF1A</p><ul><li><strong>\u89E6\u53D1 CMS GC</strong>\uFF1A \u901A\u8FC7\u8C03\u7528 <code>_collector-&gt;collect_in_background()</code> \u8FDB\u884C\u89E6\u53D1 Background GC \u3002 <ul><li>CMS \u9ED8\u8BA4\u91C7\u7528 JVM \u8FD0\u884C\u65F6\u7684\u7EDF\u8BA1\u6570\u636E\u5224\u65AD\u662F\u5426\u9700\u8981\u89E6\u53D1 CMS GC\uFF0C\u5982\u679C\u9700\u8981\u6839\u636E <code>-XX:CMSInitiatingOccupancyFraction</code> \u7684\u503C\u8FDB\u884C\u5224\u65AD\uFF0C\u9700\u8981\u8BBE\u7F6E\u53C2\u6570 -XX:+UseCMSInitiatingOccupancyOnly\u3002</li><li>\u5982\u679C\u5F00\u542F\u4E86 <code>-XX:UseCMSInitiatingOccupancyOnly</code> \u53C2\u6570\uFF0C\u5224\u65AD\u5F53\u524D Old \u533A\u4F7F\u7528\u7387\u662F\u5426\u5927\u4E8E\u9608\u503C\uFF0C\u5219\u89E6\u53D1 CMS GC\uFF0C\u8BE5\u9608\u503C\u53EF\u4EE5\u901A\u8FC7\u53C2\u6570 <code>-XX:CMSInitiatingOccupancyFraction</code> \u8FDB\u884C\u8BBE\u7F6E\uFF0C\u5982\u679C\u6CA1\u6709\u8BBE\u7F6E\uFF0C\u9ED8\u8BA4\u4E3A 92%\u3002</li><li>\u5982\u679C\u4E4B\u524D\u7684 Young GC \u5931\u8D25\u8FC7\uFF0C\u6216\u8005\u4E0B\u6B21 Young \u533A\u6267\u884C Young GC \u53EF\u80FD\u5931\u8D25\uFF0C\u8FD9\u4E24\u79CD\u60C5\u51B5\u4E0B\u90FD\u9700\u8981\u89E6\u53D1 CMS GC\u3002</li><li>CMS \u9ED8\u8BA4\u4E0D\u4F1A\u5BF9 MetaSpace \u6216 Perm \u8FDB\u884C\u5783\u573E\u6536\u96C6\uFF0C\u5982\u679C\u5E0C\u671B\u5BF9\u8FD9\u4E9B\u533A\u57DF\u8FDB\u884C\u5783\u573E\u6536\u96C6\uFF0C\u9700\u8981\u8BBE\u7F6E\u53C2\u6570 <code>-XX:+CMSClassUnloadingEnabled</code>\u3002</li></ul></li><li><strong>\u89E6\u53D1 Full GC</strong>\uFF1A \u76F4\u63A5\u8FDB\u884C Full GC\uFF0C\u8FD9\u79CD\u60C5\u51B5\u5230\u573A\u666F\u4E03\u4E2D\u5C55\u5F00\u8BF4\u660E\u3002 <ul><li>\u5982\u679C _full_gc_requested \u4E3A\u771F\uFF0C\u8BF4\u660E\u6709\u660E\u786E\u7684\u9700\u6C42\u8981\u8FDB\u884C GC\uFF0C\u6BD4\u5982\u8C03\u7528 System.gc\u3002</li><li>\u5728 Eden \u533A\u4E3A\u5BF9\u8C61\u6216 TLAB \u5206\u914D\u5185\u5B58\u5931\u8D25\uFF0C\u5BFC\u81F4\u4E00\u6B21 Young GC\uFF0C\u5728 GenCollectorPolicy \u7C7B\u7684 satisfy_failed_allocation() \u65B9\u6CD5\u4E2D\u8FDB\u884C\u5224\u65AD\u3002</li></ul></li></ul><p>\u5927\u5BB6\u53EF\u4EE5\u770B\u4E00\u4E0B\u6E90\u7801\u4E2D\u7684\u65E5\u5FD7\u6253\u5370\uFF0C\u901A\u8FC7\u65E5\u5FD7\u6211\u4EEC\u5C31\u53EF\u4EE5\u6BD4\u8F83\u6E05\u695A\u5730\u77E5\u9053\u5177\u4F53\u7684\u539F\u56E0\uFF0C\u7136\u540E\u5C31\u53EF\u4EE5\u7740\u624B\u5206\u6790\u4E86\u3002</p><h4 id="_4-5-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-5-3-\u7B56\u7565" aria-hidden="true">#</a> 4.5.3 \u7B56\u7565</h4><p>\u6211\u4EEC\u8FD9\u91CC\u8FD8\u662F\u62FF\u6700\u5E38\u89C1\u7684\u8FBE\u5230\u56DE\u6536\u6BD4\u4F8B\u8FD9\u4E2A\u573A\u666F\u6765\u8BF4\uFF0C\u4E0E\u8FC7\u65E9\u664B\u5347\u4E0D\u540C\u7684\u662F\u8FD9\u4E9B\u5BF9\u8C61\u786E\u5B9E\u5B58\u6D3B\u4E86\u4E00\u6BB5\u65F6\u95F4\uFF0CSurvival Time \u8D85\u8FC7\u4E86 TP9999 \u65F6\u95F4\uFF0C\u4F46\u662F\u53C8\u8FBE\u4E0D\u5230\u957F\u671F\u5B58\u6D3B\uFF0C\u5982\u5404\u79CD\u6570\u636E\u5E93\u3001\u7F51\u7EDC\u94FE\u63A5\uFF0C\u5E26\u6709\u5931\u6548\u65F6\u95F4\u7684\u7F13\u5B58\u7B49\u3002</p><p>\u5904\u7406\u8FD9\u79CD\u5E38\u89C4\u5185\u5B58\u6CC4\u6F0F\u95EE\u9898\u57FA\u672C\u662F\u4E00\u4E2A\u601D\u8DEF\uFF0C\u4E3B\u8981\u6B65\u9AA4\u5982\u4E0B\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822222848408.png" alt="image-20220822222848408" loading="lazy"></p><p>Dump Diff \u548C Leak Suspects \u6BD4\u8F83\u76F4\u89C2\u5C31\u4E0D\u4ECB\u7ECD\u4E86\uFF0C\u8FD9\u91CC\u8BF4\u4E0B\u5176\u5B83\u51E0\u4E2A\u5173\u952E\u70B9\uFF1A</p><ul><li><strong>\u5185\u5B58 Dump</strong>\uFF1A \u4F7F\u7528 jmap\u3001arthas \u7B49 dump \u5806\u8FDB\u884C\u5FEB\u7167\u65F6\u8BB0\u5F97\u6458\u6389\u6D41\u91CF\uFF0C\u540C\u65F6\u5206\u522B\u5728 CMS GC \u7684\u53D1\u751F\u524D\u540E\u5206\u522B dump \u4E00\u6B21\u3002</li><li><strong>\u5206\u6790 Top Component</strong>\uFF1A \u8981\u8BB0\u5F97\u6309\u7167\u5BF9\u8C61\u3001\u7C7B\u3001\u7C7B\u52A0\u8F7D\u5668\u3001\u5305\u7B49\u591A\u4E2A\u7EF4\u5EA6\u89C2\u5BDF Histogram\uFF0C\u540C\u65F6\u4F7F\u7528 outgoing \u548C incoming \u5206\u6790\u5173\u8054\u7684\u5BF9\u8C61\uFF0C\u53E6\u5916\u5C31\u662F Soft Reference \u548C Weak Reference\u3001Finalizer \u7B49\u4E5F\u8981\u770B\u4E00\u4E0B\u3002</li><li><strong>\u5206\u6790 Unreachable</strong>\uFF1A \u91CD\u70B9\u770B\u4E00\u4E0B\u8FD9\u4E2A\uFF0C\u5173\u6CE8\u4E0B Shallow \u548C Retained \u7684\u5927\u5C0F\u3002\u5982\u4E0B\u56FE\u6240\u793A\uFF0C\u7B14\u8005\u4E4B\u524D\u4E00\u6B21 GC \u4F18\u5316\uFF0C\u5C31\u6839\u636E Unreachable Objects \u53D1\u73B0\u4E86 Hystrix \u7684\u6ED1\u52A8\u7A97\u53E3\u95EE\u9898\u3002</li></ul><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822222908910.png" alt="image-20220822222908910" loading="lazy"></p><h4 id="_4-5-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-5-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.5.4 \u5C0F\u7ED3</h4><p>\u7ECF\u8FC7\u6574\u4E2A\u6D41\u7A0B\u4E0B\u6765\u57FA\u672C\u5C31\u80FD\u5B9A\u4F4D\u95EE\u9898\u4E86\uFF0C\u4E0D\u8FC7\u5728\u4F18\u5316\u7684\u8FC7\u7A0B\u4E2D\u8BB0\u5F97\u4F7F\u7528<strong>\u63A7\u5236\u53D8\u91CF</strong>\u7684\u65B9\u6CD5\u6765\u4F18\u5316\uFF0C\u9632\u6B62\u4E00\u4E9B\u4F1A\u52A0\u5267\u95EE\u9898\u7684\u6539\u52A8\u88AB\u63A9\u76D6\u3002</p><h3 id="_4-6-\u573A\u666F\u516D-\u5355\u6B21-cms-old-gc-\u8017\u65F6\u957F" tabindex="-1"><a class="header-anchor" href="#_4-6-\u573A\u666F\u516D-\u5355\u6B21-cms-old-gc-\u8017\u65F6\u957F" aria-hidden="true">#</a> 4.6 \u573A\u666F\u516D\uFF1A\u5355\u6B21 CMS Old GC \u8017\u65F6\u957F*</h3><h4 id="_4-6-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-6-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.6.1 \u73B0\u8C61</h4><p>CMS GC \u5355\u6B21 STW \u6700\u5927\u8D85\u8FC7 1000ms\uFF0C\u4E0D\u4F1A\u9891\u7E41\u53D1\u751F\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\u6700\u957F\u8FBE\u5230\u4E86 8000ms\u3002\u67D0\u4E9B\u573A\u666F\u4E0B\u4F1A\u5F15\u8D77\u201C\u96EA\u5D29\u6548\u5E94\u201D\uFF0C\u8FD9\u79CD\u573A\u666F\u975E\u5E38\u5371\u9669\uFF0C\u6211\u4EEC\u5E94\u8BE5\u5C3D\u91CF\u907F\u514D\u51FA\u73B0\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822222954466.png" alt="image-20220822222954466" loading="lazy"></p><h4 id="_4-6-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-6-2-\u539F\u56E0" aria-hidden="true">#</a> 4.6.2 \u539F\u56E0</h4><p>CMS \u5728\u56DE\u6536\u7684\u8FC7\u7A0B\u4E2D\uFF0CSTW \u7684\u9636\u6BB5\u4E3B\u8981\u662F Init Mark \u548C Final Remark \u8FD9\u4E24\u4E2A\u9636\u6BB5\uFF0C\u4E5F\u662F\u5BFC\u81F4 CMS Old GC \u6700\u591A\u7684\u539F\u56E0\uFF0C\u53E6\u5916\u6709\u4E9B\u60C5\u51B5\u5C31\u662F\u5728 STW \u524D\u7B49\u5F85 Mutator \u7684\u7EBF\u7A0B\u5230\u8FBE SafePoint \u4E5F\u4F1A\u5BFC\u81F4\u65F6\u95F4\u8FC7\u957F\uFF0C\u4F46\u8FD9\u79CD\u60C5\u51B5\u8F83\u5C11\uFF0C\u6211\u4EEC\u5728\u6B64\u5904\u4E3B\u8981\u8BA8\u8BBA\u524D\u8005\u3002\u53D1\u751F\u6536\u96C6\u5668\u9000\u5316\u6216\u8005\u788E\u7247\u538B\u7F29\u7684\u573A\u666F\u8BF7\u770B\u573A\u666F\u4E03\u3002</p><p>\u60F3\u8981\u77E5\u9053\u8FD9\u4E24\u4E2A\u9636\u6BB5\u4E3A\u4EC0\u4E48\u4F1A\u8017\u65F6\uFF0C\u6211\u4EEC\u9700\u8981\u5148\u770B\u4E00\u4E0B\u8FD9\u4E24\u4E2A\u9636\u6BB5\u90FD\u4F1A\u5E72\u4EC0\u4E48\u3002</p><p>\u6838\u5FC3\u4EE3\u7801\u90FD\u5728 /src/hotspot/share/gc/cms/concurrentMarkSweepGeneration.cpp \u4E2D\uFF0C\u5185\u90E8\u6709\u4E2A\u7EBF\u7A0B ConcurrentMarkSweepThread \u8F6E\u8BE2\u6765\u6821\u9A8C\uFF0COld \u533A\u7684\u5783\u573E\u56DE\u6536\u76F8\u5173\u7EC6\u8282\u88AB\u5B8C\u5168\u5C01\u88C5\u5728 CMSCollector \u4E2D\uFF0C\u8C03\u7528\u5165\u53E3\u5C31\u662F ConcurrentMarkSweepThread \u8C03\u7528\u7684 <code>CMSCollector::collect_in_background</code> \u548C ConcurrentMarkSweepGeneration \u8C03\u7528\u7684 <code>CMSCollector::collect</code> \u65B9\u6CD5\uFF0C\u6B64\u5904\u6211\u4EEC\u8BA8\u8BBA\u5927\u591A\u6570\u573A\u666F\u7684 collect_in_background\u3002\u6574\u4E2A\u8FC7\u7A0B\u4E2D\u4F1A STW \u7684\u4E3B\u8981\u662F initial Mark \u548C Final Remark\uFF0C\u6838\u5FC3\u4EE3\u7801\u5728 VM_CMS_Initial_Mark / VM_CMS_Final_Remark \u4E2D\uFF0C\u6267\u884C\u65F6\u9700\u8981\u5C06\u6267\u884C\u6743\u4EA4\u7531 VMThread \u6765\u6267\u884C\u3002</p><ul><li>CMS Init Mark\u6267\u884C\u6B65\u9AA4\uFF0C\u5B9E\u73B0\u5728 CMSCollector::checkpointRootsInitialWork() \u548C CMSParInitialMarkTask::work \u4E2D\uFF0C\u6574\u4F53\u6B65\u9AA4\u548C\u4EE3\u7801\u5982\u4E0B\uFF1A</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">CMSCollector</span><span class="token double-colon punctuation">::</span><span class="token function">checkpointRootsInitialWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token class-name">SafepointSynchronize</span><span class="token double-colon punctuation">::</span><span class="token function">is_at_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;world should be stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_collectorState <span class="token operator">==</span> InitialMarking<span class="token punctuation">,</span> <span class="token string">&quot;just checking&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Already have locks.</span>
  <span class="token function">assert_lock_strong</span><span class="token punctuation">(</span><span class="token function">bitMapLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_markBitMap<span class="token punctuation">.</span><span class="token function">isAllClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;was reset at end of previous cycle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Setup the verification and class unloading state for this</span>
  <span class="token comment">// CMS collection cycle.</span>
  <span class="token function">setup_cms_unloading_and_verification_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Trace<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">ts</span><span class="token punctuation">(</span><span class="token string">&quot;checkpointRootsInitialWork&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Reset all the PLAB chunk arrays if necessary.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_survivor_plab_array <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>CMSPLABRecordAlways<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reset_survivor_plab_arrays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ResourceMark rm<span class="token punctuation">;</span>
  HandleMark  hm<span class="token punctuation">;</span>

  MarkRefsIntoClosure <span class="token function">notOlder</span><span class="token punctuation">(</span>_span<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_markBitMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  CMSHeap<span class="token operator">*</span> heap <span class="token operator">=</span> <span class="token class-name">CMSHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">verify_work_stacks_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">verify_overflow_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  heap<span class="token operator">-&gt;</span><span class="token function">ensure_parsability</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// fill TLABs, but no need to retire them</span>
  <span class="token comment">// Update the saved marks which may affect the root scans.</span>
  heap<span class="token operator">-&gt;</span><span class="token function">save_marks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// weak reference processing has not started yet.</span>
  <span class="token function">ref_processor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_enqueuing_is_done</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Need to remember all newly created CLDs,</span>
  <span class="token comment">// so that we can guarantee that the remark finds them.</span>
  <span class="token class-name">ClassLoaderDataGraph</span><span class="token double-colon punctuation">::</span><span class="token function">remember_new_clds</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Whenever a CLD is found, it will be claimed before proceeding to mark</span>
  <span class="token comment">// the klasses. The claimed marks need to be cleared before marking starts.</span>
  <span class="token class-name">ClassLoaderDataGraph</span><span class="token double-colon punctuation">::</span><span class="token function">clear_claimed_marks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">print_eden_and_survivor_chunk_arrays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CMSParallelInitialMarkEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The parallel version.</span>
      WorkGang<span class="token operator">*</span> workers <span class="token operator">=</span> heap<span class="token operator">-&gt;</span><span class="token function">workers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>workers <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Need parallel worker threads.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      uint n_workers <span class="token operator">=</span> workers<span class="token operator">-&gt;</span><span class="token function">active_workers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      StrongRootsScope <span class="token function">srs</span><span class="token punctuation">(</span>n_workers<span class="token punctuation">)</span><span class="token punctuation">;</span>

      CMSParInitialMarkTask <span class="token function">tsk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>srs<span class="token punctuation">,</span> n_workers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">initialize_sequential_subtasks_for_young_gen_rescan</span><span class="token punctuation">(</span>n_workers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If the total workers is greater than 1, then multiple workers</span>
      <span class="token comment">// may be used at some time and the initialization has been set</span>
      <span class="token comment">// such that the single threaded path cannot be used.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workers<span class="token operator">-&gt;</span><span class="token function">total_workers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        workers<span class="token operator">-&gt;</span><span class="token function">run_task</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        tsk<span class="token punctuation">.</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// The serial version.</span>
      CLDToOopClosure <span class="token function">cld_closure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>notOlder<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      heap<span class="token operator">-&gt;</span><span class="token function">rem_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">prepare_for_younger_refs_iterate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Not parallel.</span>

      StrongRootsScope <span class="token function">srs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      heap<span class="token operator">-&gt;</span><span class="token function">cms_process_roots</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srs<span class="token punctuation">,</span>
                             <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// young gen as roots</span>
                             <span class="token class-name">GenCollectedHeap</span><span class="token double-colon punctuation">::</span><span class="token function">ScanningOption</span><span class="token punctuation">(</span><span class="token function">roots_scanning_options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token function">should_unload_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token operator">&amp;</span>notOlder<span class="token punctuation">,</span>
                             <span class="token operator">&amp;</span>cld_closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Clear mod-union table; it will be dirtied in the prologue of</span>
  <span class="token comment">// CMS generation per each young generation collection.</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_modUnionTable<span class="token punctuation">.</span><span class="token function">isAllClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token string">&quot;Was cleared in most recent final checkpoint phase&quot;</span>
       <span class="token string">&quot; or no bits are set in the gc_prologue before the start of the next &quot;</span>
       <span class="token string">&quot;subsequent marking phase.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>_ct<span class="token operator">-&gt;</span><span class="token function">cld_rem_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">mod_union_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Save the end of the used_region of the constituent generations</span>
  <span class="token comment">// to be used to limit the extent of sweep in each generation.</span>
  <span class="token function">save_sweep_limits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">verify_overflow_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token class-name">CMSParInitialMarkTask</span><span class="token double-colon punctuation">::</span><span class="token function">work</span><span class="token punctuation">(</span>uint worker_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  elapsedTimer _timer<span class="token punctuation">;</span>
  ResourceMark rm<span class="token punctuation">;</span>
  HandleMark   hm<span class="token punctuation">;</span>

  <span class="token comment">// ---------- scan from roots --------------</span>
  _timer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  CMSHeap<span class="token operator">*</span> heap <span class="token operator">=</span> <span class="token class-name">CMSHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ParMarkRefsIntoClosure <span class="token function">par_mri_cl</span><span class="token punctuation">(</span>_collector<span class="token operator">-&gt;</span>_span<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>_collector<span class="token operator">-&gt;</span>_markBitMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ---------- young gen roots --------------</span>
  <span class="token punctuation">{</span>
    <span class="token function">work_on_young_gen_roots</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>par_mri_cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _timer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Finished young gen initial mark scan work in %dth thread: %3.3f sec&quot;</span><span class="token punctuation">,</span> worker_id<span class="token punctuation">,</span> _timer<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ---------- remaining roots --------------</span>
  _timer<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _timer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  CLDToOopClosure <span class="token function">cld_closure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>par_mri_cl<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  heap<span class="token operator">-&gt;</span><span class="token function">cms_process_roots</span><span class="token punctuation">(</span>_strong_roots_scope<span class="token punctuation">,</span>
                          <span class="token boolean">false</span><span class="token punctuation">,</span>     <span class="token comment">// yg was scanned above</span>
                          <span class="token class-name">GenCollectedHeap</span><span class="token double-colon punctuation">::</span><span class="token function">ScanningOption</span><span class="token punctuation">(</span>_collector<span class="token operator">-&gt;</span><span class="token class-name">CMSCollector</span><span class="token double-colon punctuation">::</span><span class="token function">roots_scanning_options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          _collector<span class="token operator">-&gt;</span><span class="token function">should_unload_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>par_mri_cl<span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>cld_closure<span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>_par_state_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>_collector<span class="token operator">-&gt;</span><span class="token function">should_unload_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">||</span> <span class="token punctuation">(</span>_collector<span class="token operator">-&gt;</span><span class="token class-name">CMSCollector</span><span class="token double-colon punctuation">::</span><span class="token function">roots_scanning_options</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> GenCollectedHeap<span class="token double-colon punctuation">::</span>SO_AllCodeCache<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">&quot;if we didn&#39;t scan the code cache, we have to be ready to drop nmethods with expired weak oops&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _timer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Finished remaining root initial mark scan work in %dth thread: %3.3f sec&quot;</span><span class="token punctuation">,</span> worker_id<span class="token punctuation">,</span> _timer<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223037609.png" alt="image-20220822223037609" loading="lazy"></p><p>\u6574\u4E2A\u8FC7\u7A0B\u6BD4\u8F83\u7B80\u5355\uFF0C\u4ECE GC Root \u51FA\u53D1\u6807\u8BB0 Old \u4E2D\u7684\u5BF9\u8C61\uFF0C\u5904\u7406\u5B8C\u6210\u540E\u501F\u52A9 BitMap \u5904\u7406\u4E0B Young \u533A\u5BF9 Old \u533A\u7684\u5F15\u7528\uFF0C\u6574\u4E2A\u8FC7\u7A0B\u57FA\u672C\u90FD\u6BD4\u8F83\u5FEB\uFF0C\u5F88\u5C11\u4F1A\u6709\u8F83\u5927\u7684\u505C\u987F\u3002</p><ul><li>CMS Final Remark \u6267\u884C\u6B65\u9AA4\uFF0C\u5B9E\u73B0\u5728 <code>CMSCollector::checkpointRootsFinalWork()</code> \u4E2D\uFF0C\u6574\u4F53\u4EE3\u7801\u548C\u6B65\u9AA4\u5982\u4E0B\uFF1A</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">CMSCollector</span><span class="token double-colon punctuation">::</span><span class="token function">checkpointRootsFinalWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Trace<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">tm</span><span class="token punctuation">(</span><span class="token string">&quot;checkpointRootsFinalWork&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">haveFreelistLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;must have free list locks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_lock_strong</span><span class="token punctuation">(</span><span class="token function">bitMapLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ResourceMark rm<span class="token punctuation">;</span>
  HandleMark   hm<span class="token punctuation">;</span>

  CMSHeap<span class="token operator">*</span> heap <span class="token operator">=</span> <span class="token class-name">CMSHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_unload_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CodeCache</span><span class="token double-colon punctuation">::</span><span class="token function">gc_prologue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">haveFreelistLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;must have free list locks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert_lock_strong</span><span class="token punctuation">(</span><span class="token function">bitMapLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  heap<span class="token operator">-&gt;</span><span class="token function">ensure_parsability</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// fill TLAB&#39;s, but no need to retire them</span>
  <span class="token comment">// Update the saved marks which may affect the root scans.</span>
  heap<span class="token operator">-&gt;</span><span class="token function">save_marks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">print_eden_and_survivor_chunk_arrays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CMSParallelRemarkEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Debug<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">&quot;Rescan (parallel)&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">do_remark_parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Debug<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">&quot;Rescan (non-parallel)&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">do_remark_non_parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">verify_work_stacks_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">verify_overflow_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Trace<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">ts</span><span class="token punctuation">(</span><span class="token string">&quot;refProcessingWork&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">refProcessingWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">verify_work_stacks_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">verify_overflow_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_unload_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CodeCache</span><span class="token double-colon punctuation">::</span><span class="token function">gc_epilogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">JvmtiExport</span><span class="token double-colon punctuation">::</span><span class="token function">gc_epilogue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_markStack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;No grey objects&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t ser_ovflw <span class="token operator">=</span> _ser_pmc_remark_ovflw <span class="token operator">+</span> _ser_pmc_preclean_ovflw <span class="token operator">+</span>
                     _ser_kac_ovflw        <span class="token operator">+</span> _ser_kac_preclean_ovflw<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ser_ovflw <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Marking stack overflow (benign) (pmc_pc=&quot;</span> SIZE_FORMAT <span class="token string">&quot;, pmc_rm=&quot;</span> SIZE_FORMAT <span class="token string">&quot;, kac=&quot;</span> SIZE_FORMAT <span class="token string">&quot;, kac_preclean=&quot;</span> SIZE_FORMAT <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span>
                         _ser_pmc_preclean_ovflw<span class="token punctuation">,</span> _ser_pmc_remark_ovflw<span class="token punctuation">,</span> _ser_kac_ovflw<span class="token punctuation">,</span> _ser_kac_preclean_ovflw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _markStack<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _ser_pmc_remark_ovflw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    _ser_pmc_preclean_ovflw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    _ser_kac_preclean_ovflw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    _ser_kac_ovflw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_par_pmc_remark_ovflw <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> _par_kac_ovflw <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Work queue overflow (benign) (pmc_rm=&quot;</span> SIZE_FORMAT <span class="token string">&quot;, kac=&quot;</span> SIZE_FORMAT <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span>
                          _par_pmc_remark_ovflw<span class="token punctuation">,</span> _par_kac_ovflw<span class="token punctuation">)</span><span class="token punctuation">;</span>
     _par_pmc_remark_ovflw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    _par_kac_ovflw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>_markStack<span class="token punctuation">.</span>_hit_limit <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot; (benign) Hit max stack size limit (&quot;</span> SIZE_FORMAT <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span>
                          _markStack<span class="token punctuation">.</span>_hit_limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>_markStack<span class="token punctuation">.</span>_failed_double <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">log_trace</span><span class="token punctuation">(</span>gc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot; (benign) Failed stack doubling (&quot;</span> SIZE_FORMAT <span class="token string">&quot;), current capacity &quot;</span> SIZE_FORMAT<span class="token punctuation">,</span>
                          _markStack<span class="token punctuation">.</span>_failed_double<span class="token punctuation">,</span> _markStack<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  _markStack<span class="token punctuation">.</span>_hit_limit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  _markStack<span class="token punctuation">.</span>_failed_double <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VerifyAfterGC <span class="token operator">||</span> VerifyDuringGC<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token class-name">CMSHeap</span><span class="token double-colon punctuation">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">total_collections</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> VerifyGCStartAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">verify_after_remark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _gc_tracer_cm<span class="token operator">-&gt;</span><span class="token function">report_object_count_after_gc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_is_alive_closure<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Change under the freelistLocks.</span>
  _collectorState <span class="token operator">=</span> Sweeping<span class="token punctuation">;</span>
  <span class="token comment">// Call isAllClear() under bitMapLock</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_modUnionTable<span class="token punctuation">.</span><span class="token function">isAllClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Should be clear by end of the final marking&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>_ct<span class="token operator">-&gt;</span><span class="token function">cld_rem_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">mod_union_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Should be clear by end of the final marking&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223157312.png" alt="image-20220822223157312" loading="lazy"></p><p>Final Remark \u662F\u6700\u7EC8\u7684\u7B2C\u4E8C\u6B21\u6807\u8BB0\uFF0C\u8FD9\u79CD\u60C5\u51B5\u53EA\u6709\u5728 Background GC \u6267\u884C\u4E86 InitialMarking \u6B65\u9AA4\u7684\u60C5\u5F62\u4E0B\u624D\u4F1A\u6267\u884C\uFF0C\u5982\u679C\u662F Foreground GC \u6267\u884C\u7684 InitialMarking \u6B65\u9AA4\u5219\u4E0D\u9700\u8981\u518D\u6B21\u6267\u884C FinalRemark\u3002Final Remark \u7684\u5F00\u59CB\u9636\u6BB5\u4E0E Init Mark \u5904\u7406\u7684\u6D41\u7A0B\u76F8\u540C\uFF0C\u4F46\u662F\u540E\u7EED\u591A\u4E86 Card Table \u904D\u5386\u3001Reference \u5B9E\u4F8B\u7684\u6E05\u7406\u5E76\u5C06\u5176\u52A0\u5165\u5230 Reference \u7EF4\u62A4\u7684 pend_list \u4E2D\uFF0C\u5982\u679C\u8981\u6536\u96C6\u5143\u6570\u636E\u4FE1\u606F\uFF0C\u8FD8\u8981\u6E05\u7406 SystemDictionary\u3001CodeCache\u3001SymbolTable\u3001StringTable \u7B49\u7EC4\u4EF6\u4E2D\u4E0D\u518D\u4F7F\u7528\u7684\u8D44\u6E90\u3002</p><h4 id="_4-6-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-6-3-\u7B56\u7565" aria-hidden="true">#</a> 4.6.3 \u7B56\u7565</h4><p>\u77E5\u9053\u4E86\u4E24\u4E2A STW \u8FC7\u7A0B\u6267\u884C\u6D41\u7A0B\uFF0C\u6211\u4EEC\u5206\u6790\u89E3\u51B3\u5C31\u6BD4\u8F83\u7B80\u5355\u4E86\uFF0C\u7531\u4E8E\u5927\u90E8\u5206\u95EE\u9898\u90FD\u51FA\u5728 Final Remark \u8FC7\u7A0B\uFF0C\u8FD9\u91CC\u6211\u4EEC\u4E5F\u62FF\u8FD9\u4E2A\u573A\u666F\u6765\u4E3E\u4F8B\uFF0C\u4E3B\u8981\u6B65\u9AA4\uFF1A</p><p>+\u3010<strong>\u65B9\u5411</strong>\u3011 \u89C2\u5BDF\u8BE6\u7EC6 GC \u65E5\u5FD7\uFF0C\u627E\u5230\u51FA\u95EE\u9898\u65F6 Final Remark \u65E5\u5FD7\uFF0C\u5206\u6790\u4E0B Reference \u5904\u7406\u548C\u5143\u6570\u636E\u5904\u7406 real \u8017\u65F6\u662F\u5426\u6B63\u5E38\uFF0C\u8BE6\u7EC6\u4FE1\u606F\u9700\u8981\u901A\u8FC7 -XX:+PrintReferenceGC \u53C2\u6570\u5F00\u542F\u3002\u57FA\u672C\u5728\u65E5\u5FD7\u91CC\u9762\u5C31\u80FD\u5B9A\u4F4D\u5230\u5927\u6982\u662F\u54EA\u4E2A\u65B9\u5411\u51FA\u4E86\u95EE\u9898\uFF0C\u8017\u65F6\u8D85\u8FC7 10% \u7684\u5C31\u9700\u8981\u5173\u6CE8\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">2019</span>-02-27T19:55:37.920+0800: <span class="token number">516952.915</span>: <span class="token punctuation">[</span>GC <span class="token punctuation">(</span>CMS Final Remark<span class="token punctuation">)</span> <span class="token number">516952.915</span>: <span class="token punctuation">[</span>ParNew516952.939: <span class="token punctuation">[</span>SoftReference, <span class="token number">0</span> refs, <span class="token number">0.0003857</span> secs<span class="token punctuation">]</span><span class="token number">516952.939</span>: <span class="token punctuation">[</span>WeakReference, <span class="token number">1362</span> refs, <span class="token number">0.0002415</span> secs<span class="token punctuation">]</span><span class="token number">516952.940</span>: <span class="token punctuation">[</span>FinalReference, <span class="token number">146</span> refs, <span class="token number">0.0001233</span> secs<span class="token punctuation">]</span><span class="token number">516952.940</span>: <span class="token punctuation">[</span>PhantomReference, <span class="token number">0</span> refs, <span class="token number">57</span> refs, <span class="token number">0.0002369</span> secs<span class="token punctuation">]</span><span class="token number">516952.940</span>: <span class="token punctuation">[</span>JNI Weak Reference, <span class="token number">0.0000662</span> secs<span class="token punctuation">]</span>
<span class="token punctuation">[</span>class unloading, <span class="token number">0.1770490</span> secs<span class="token punctuation">]</span><span class="token number">516953.329</span>: <span class="token punctuation">[</span>scrub symbol table, <span class="token number">0.0442567</span> secs<span class="token punctuation">]</span><span class="token number">516953.373</span>: <span class="token punctuation">[</span>scrub string table, <span class="token number">0.0036072</span> secs<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span> CMS-remark: 1638504K<span class="token punctuation">(</span>2048000K<span class="token punctuation">)</span><span class="token punctuation">]</span> 1667558K<span class="token punctuation">(</span>4352000K<span class="token punctuation">)</span>, <span class="token number">0.5269311</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times: <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token number">1.20</span> <span class="token assign-left variable">sys</span><span class="token operator">=</span><span class="token number">0.03</span>, <span class="token assign-left variable">real</span><span class="token operator">=</span><span class="token number">0.53</span> secs<span class="token punctuation">]</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>+\u3010<strong>\u6839\u56E0</strong>\u3011 \u6709\u4E86\u5177\u4F53\u7684\u65B9\u5411\u6211\u4EEC\u5C31\u53EF\u4EE5\u8FDB\u884C\u6DF1\u5165\u7684\u5206\u6790\uFF0C\u4E00\u822C\u6765\u8BF4\u6700\u5BB9\u6613\u51FA\u95EE\u9898\u7684\u5730\u65B9\u5C31\u662F Reference \u4E2D\u7684 FinalReference \u548C\u5143\u6570\u636E\u4FE1\u606F\u5904\u7406\u4E2D\u7684 scrub symbol table \u4E24\u4E2A\u9636\u6BB5\uFF0C\u60F3\u8981\u627E\u5230\u5177\u4F53\u95EE\u9898\u4EE3\u7801\u5C31\u9700\u8981\u5185\u5B58\u5206\u6790\u5DE5\u5177 MAT \u6216 JProfiler \u4E86\uFF0C\u6CE8\u610F\u8981 dump \u5373\u5C06\u5F00\u59CB CMS GC \u7684\u5806\u3002\u5728\u7528 MAT \u7B49\u5DE5\u5177\u524D\u4E5F\u53EF\u4EE5\u5148\u7528\u547D\u4EE4\u884C\u770B\u4E0B\u5BF9\u8C61 Histogram\uFF0C\u6709\u53EF\u80FD\u76F4\u63A5\u5C31\u80FD\u5B9A\u4F4D\u95EE\u9898\u3002</p><ul><li>\u5BF9 FinalReference \u7684\u5206\u6790\u4E3B\u8981\u89C2\u5BDF <code>java.lang.ref.Finalizer</code> \u5BF9\u8C61\u7684 dominator tree\uFF0C\u627E\u5230\u6CC4\u6F0F\u7684\u6765\u6E90\u3002\u7ECF\u5E38\u4F1A\u51FA\u73B0\u95EE\u9898\u7684\u51E0\u4E2A\u70B9\u6709 Socket \u7684 SocksSocketImpl \u3001Jersey \u7684 ClientRuntime\u3001MySQL \u7684 ConnectionImpl \u7B49\u7B49\u3002</li><li>scrub symbol table \u8868\u793A\u6E05\u7406\u5143\u6570\u636E\u7B26\u53F7\u5F15\u7528\u8017\u65F6\uFF0C\u7B26\u53F7\u5F15\u7528\u662F Java \u4EE3\u7801\u88AB\u7F16\u8BD1\u6210\u5B57\u8282\u7801\u65F6\uFF0C\u65B9\u6CD5\u5728 JVM \u4E2D\u7684\u8868\u73B0\u5F62\u5F0F\uFF0C\u751F\u547D\u5468\u671F\u4E00\u822C\u4E0E Class \u4E00\u81F4\uFF0C\u5F53 <code>_should_unload_classes</code> \u88AB\u8BBE\u7F6E\u4E3A true \u65F6\u5728 <code>CMSCollector::refProcessingWork()</code> \u4E2D\u4E0E Class Unload\u3001String Table \u4E00\u8D77\u88AB\u5904\u7406\u3002</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_unload_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
      <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Debug<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">&quot;Class Unloading&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Unload classes and purge the SystemDictionary.</span>
      <span class="token keyword">bool</span> purged_class <span class="token operator">=</span> <span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">do_unloading</span><span class="token punctuation">(</span>_gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Unload nmethods.</span>
      <span class="token class-name">CodeCache</span><span class="token double-colon punctuation">::</span><span class="token function">do_unloading</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_is_alive_closure<span class="token punctuation">,</span> purged_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Prune dead klasses from subklass/sibling/implementor lists.</span>
      <span class="token class-name">Klass</span><span class="token double-colon punctuation">::</span><span class="token function">clean_weak_klass_links</span><span class="token punctuation">(</span>purged_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">{</span>
      <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Debug<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">&quot;Scrub Symbol Table&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Clean up unreferenced symbols in symbol table.</span>
      <span class="token class-name">SymbolTable</span><span class="token double-colon punctuation">::</span><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">{</span>
      <span class="token function">GCTraceTime</span><span class="token punctuation">(</span>Debug<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> phases<span class="token punctuation">)</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">&quot;Scrub String Table&quot;</span><span class="token punctuation">,</span> _gc_timer_cm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Delete entries for dead interned strings.</span>
      <span class="token class-name">StringTable</span><span class="token double-colon punctuation">::</span><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_is_alive_closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>+\u3010<strong>\u7B56\u7565</strong>\u3011 \u77E5\u9053 GC \u8017\u65F6\u7684\u6839\u56E0\u5C31\u6BD4\u8F83\u597D\u5904\u7406\u4E86\uFF0C\u8FD9\u79CD\u95EE\u9898\u4E0D\u4F1A\u5927\u9762\u79EF\u540C\u65F6\u7206\u53D1\uFF0C\u4E0D\u8FC7\u6709\u5F88\u591A\u65F6\u5019\u5355\u53F0 STW \u7684\u65F6\u95F4\u4F1A\u6BD4\u8F83\u957F\uFF0C\u5982\u679C\u4E1A\u52A1\u5F71\u54CD\u6BD4\u8F83\u5927\uFF0C\u53CA\u65F6\u6458\u6389\u6D41\u91CF\uFF0C\u5177\u4F53\u540E\u7EED\u4F18\u5316\u7B56\u7565\u5982\u4E0B\uFF1A</p><ul><li>FinalReference\uFF1A\u627E\u5230\u5185\u5B58\u6765\u6E90\u540E\u901A\u8FC7\u4F18\u5316\u4EE3\u7801\u7684\u65B9\u5F0F\u6765\u89E3\u51B3\uFF0C\u5982\u679C\u77ED\u65F6\u95F4\u65E0\u6CD5\u5B9A\u4F4D\u53EF\u4EE5\u589E\u52A0 -XX:+ParallelRefProcEnabled \u5BF9 Reference \u8FDB\u884C\u5E76\u884C\u5904\u7406\u3002</li><li>symbol table\uFF1A\u89C2\u5BDF MetaSpace \u533A\u7684\u5386\u53F2\u4F7F\u7528\u5CF0\u503C\uFF0C\u4EE5\u53CA\u6BCF\u6B21 GC \u524D\u540E\u7684\u56DE\u6536\u60C5\u51B5\uFF0C\u4E00\u822C\u6CA1\u6709\u4F7F\u7528\u52A8\u6001\u7C7B\u52A0\u8F7D\u6216\u8005 DSL \u5904\u7406\u7B49\uFF0CMetaSpace \u7684\u4F7F\u7528\u7387\u4E0A\u4E0D\u4F1A\u6709\u4EC0\u4E48\u53D8\u5316\uFF0C\u8FD9\u79CD\u60C5\u51B5\u53EF\u4EE5\u901A\u8FC7 <code>-XX:-CMSClassUnloadingEnabled</code> \u6765\u907F\u514D MetaSpace \u7684\u5904\u7406\uFF0CJDK8 \u4F1A\u9ED8\u8BA4\u5F00\u542F CMSClassUnloadingEnabled\uFF0C\u8FD9\u4F1A\u4F7F\u5F97 CMS \u5728 CMS-Remark \u9636\u6BB5\u5C1D\u8BD5\u8FDB\u884C\u7C7B\u7684\u5378\u8F7D\u3002</li></ul><h4 id="_4-6-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-6-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.6.4 \u5C0F\u7ED3</h4><p>\u6B63\u5E38\u60C5\u51B5\u8FDB\u884C\u7684 Background CMS GC\uFF0C\u51FA\u73B0\u95EE\u9898\u57FA\u672C\u90FD\u96C6\u4E2D\u5728 Reference \u548C Class \u7B49\u5143\u6570\u636E\u5904\u7406\u4E0A\uFF0C\u5728 Reference \u7C7B\u7684\u95EE\u9898\u5904\u7406\u65B9\u9762\uFF0C\u4E0D\u7BA1\u662F FinalReference\uFF0C\u8FD8\u662F SoftReference\u3001WeakReference \u6838\u5FC3\u7684\u624B\u6BB5\u5C31\u662F\u627E\u51C6\u65F6\u673A dump \u5FEB\u7167\uFF0C\u7136\u540E\u7528\u5185\u5B58\u5206\u6790\u5DE5\u5177\u6765\u5206\u6790\u3002Class \u5904\u7406\u65B9\u9762\u76EE\u524D\u9664\u4E86\u5173\u95ED\u7C7B\u5378\u8F7D\u5F00\u5173\uFF0C\u6CA1\u6709\u592A\u597D\u7684\u65B9\u6CD5\u3002</p><p>\u5728 G1 \u4E2D\u540C\u6837\u6709 Reference \u7684\u95EE\u9898\uFF0C\u53EF\u4EE5\u89C2\u5BDF\u65E5\u5FD7\u4E2D\u7684 Ref Proc\uFF0C\u5904\u7406\u65B9\u6CD5\u4E0E CMS \u7C7B\u4F3C\u3002</p><h3 id="_4-7-\u573A\u666F\u4E03-\u5185\u5B58\u788E\u7247-\u6536\u96C6\u5668\u9000\u5316" tabindex="-1"><a class="header-anchor" href="#_4-7-\u573A\u666F\u4E03-\u5185\u5B58\u788E\u7247-\u6536\u96C6\u5668\u9000\u5316" aria-hidden="true">#</a> 4.7 \u573A\u666F\u4E03\uFF1A\u5185\u5B58\u788E\u7247&amp;\u6536\u96C6\u5668\u9000\u5316</h3><h4 id="_4-7-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-7-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.7.1 \u73B0\u8C61</h4><p>\u5E76\u53D1\u7684 CMS GC \u7B97\u6CD5\uFF0C\u9000\u5316\u4E3A Foreground \u5355\u7EBF\u7A0B\u4E32\u884C GC \u6A21\u5F0F\uFF0CSTW \u65F6\u95F4\u8D85\u957F\uFF0C\u6709\u65F6\u4F1A\u957F\u8FBE\u5341\u51E0\u79D2\u3002\u5176\u4E2D CMS \u6536\u96C6\u5668\u9000\u5316\u540E\u5355\u7EBF\u7A0B\u4E32\u884C GC \u7B97\u6CD5\u6709\u4E24\u79CD\uFF1A</p><ul><li>\u5E26\u538B\u7F29\u52A8\u4F5C\u7684\u7B97\u6CD5\uFF0C\u79F0\u4E3A MSC\uFF0C\u4E0A\u9762\u6211\u4EEC\u4ECB\u7ECD\u8FC7\uFF0C\u4F7F\u7528\u6807\u8BB0-\u6E05\u7406-\u538B\u7F29\uFF0C\u5355\u7EBF\u7A0B\u5168\u6682\u505C\u7684\u65B9\u5F0F\uFF0C\u5BF9\u6574\u4E2A\u5806\u8FDB\u884C\u5783\u573E\u6536\u96C6\uFF0C\u4E5F\u5C31\u662F\u771F\u6B63\u610F\u4E49\u4E0A\u7684 Full GC\uFF0C\u6682\u505C\u65F6\u95F4\u8981\u957F\u4E8E\u666E\u901A CMS\u3002</li><li>\u4E0D\u5E26\u538B\u7F29\u52A8\u4F5C\u7684\u7B97\u6CD5\uFF0C\u6536\u96C6 Old \u533A\uFF0C\u548C\u666E\u901A\u7684 CMS \u7B97\u6CD5\u6BD4\u8F83\u76F8\u4F3C\uFF0C\u6682\u505C\u65F6\u95F4\u76F8\u5BF9 MSC \u7B97\u6CD5\u77ED\u4E00\u4E9B\u3002</li></ul><h4 id="_4-7-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-7-2-\u539F\u56E0" aria-hidden="true">#</a> 4.7.2 \u539F\u56E0</h4><p>CMS \u53D1\u751F\u6536\u96C6\u5668\u9000\u5316\u4E3B\u8981\u6709\u4EE5\u4E0B\u51E0\u79CD\u60C5\u51B5\uFF1A</p><p><strong>\u664B\u5347\u5931\u8D25\uFF08Promotion Failed\uFF09</strong></p><p>\u987E\u540D\u601D\u4E49\uFF0C\u664B\u5347\u5931\u8D25\u5C31\u662F\u6307\u5728\u8FDB\u884C Young GC \u65F6\uFF0CSurvivor \u653E\u4E0D\u4E0B\uFF0C\u5BF9\u8C61\u53EA\u80FD\u653E\u5165 Old\uFF0C\u4F46\u6B64\u65F6 Old \u4E5F\u653E\u4E0D\u4E0B\u3002\u76F4\u89C9\u4E0A\u4E4D\u4E00\u770B\u8FD9\u79CD\u60C5\u51B5\u53EF\u80FD\u4F1A\u7ECF\u5E38\u53D1\u751F\uFF0C\u4F46\u5176\u5B9E\u56E0\u4E3A\u6709 concurrentMarkSweepThread \u548C\u62C5\u4FDD\u673A\u5236\u7684\u5B58\u5728\uFF0C\u53D1\u751F\u7684\u6761\u4EF6\u662F\u5F88\u82DB\u523B\u7684\uFF0C\u9664\u975E\u662F\u77ED\u65F6\u95F4\u5C06 Old \u533A\u7684\u5269\u4F59\u7A7A\u95F4\u8FC5\u901F\u586B\u6EE1\uFF0C\u4F8B\u5982\u4E0A\u6587\u4E2D\u8BF4\u7684\u52A8\u6001\u5E74\u9F84\u5224\u65AD\u5BFC\u81F4\u7684\u8FC7\u65E9\u664B\u5347\uFF08\u89C1\u4E0B\u6587\u7684\u589E\u91CF\u6536\u96C6\u62C5\u4FDD\u5931\u8D25\uFF09\u3002\u53E6\u5916\u8FD8\u6709\u4E00\u79CD\u60C5\u51B5\u5C31\u662F\u5185\u5B58\u788E\u7247\u5BFC\u81F4\u7684 Promotion Failed\uFF0CYoung GC \u4EE5\u4E3A Old \u6709\u8DB3\u591F\u7684\u7A7A\u95F4\uFF0C\u7ED3\u679C\u5230\u5206\u914D\u65F6\uFF0C\u664B\u7EA7\u7684\u5927\u5BF9\u8C61\u627E\u4E0D\u5230\u8FDE\u7EED\u7684\u7A7A\u95F4\u5B58\u653E\u3002</p><p>\u4F7F\u7528 CMS \u4F5C\u4E3A GC \u6536\u96C6\u5668\u65F6\uFF0C\u8FD0\u884C\u8FC7\u4E00\u6BB5\u65F6\u95F4\u7684 Old \u533A\u5982\u4E0B\u56FE\u6240\u793A\uFF0C\u6E05\u9664\u7B97\u6CD5\u5BFC\u81F4\u5185\u5B58\u51FA\u73B0\u591A\u6BB5\u7684\u4E0D\u8FDE\u7EED\uFF0C\u51FA\u73B0\u5927\u91CF\u7684\u5185\u5B58\u788E\u7247\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223306675.png" alt="image-20220822223306675" loading="lazy"></p><p>\u788E\u7247\u5E26\u6765\u4E86\u4E24\u4E2A\u95EE\u9898\uFF1A</p><ul><li><strong>\u7A7A\u95F4\u5206\u914D\u6548\u7387\u8F83\u4F4E</strong>\uFF1A\u4E0A\u6587\u5DF2\u7ECF\u63D0\u5230\u8FC7\uFF0C\u5982\u679C\u662F\u8FDE\u7EED\u7684\u7A7A\u95F4 JVM \u53EF\u4EE5\u901A\u8FC7\u4F7F\u7528 pointer bumping \u7684\u65B9\u5F0F\u6765\u5206\u914D\uFF0C\u800C\u5BF9\u4E8E\u8FD9\u79CD\u6709\u5927\u91CF\u788E\u7247\u7684\u7A7A\u95F2\u94FE\u8868\u5219\u9700\u8981\u9010\u4E2A\u8BBF\u95EE freelist \u4E2D\u7684\u9879\u6765\u8BBF\u95EE\uFF0C\u67E5\u627E\u53EF\u4EE5\u5B58\u653E\u65B0\u5EFA\u5BF9\u8C61\u7684\u5730\u5740\u3002</li><li><strong>\u7A7A\u95F4\u5229\u7528\u6548\u7387\u53D8\u4F4E</strong>\uFF1AYoung \u533A\u664B\u5347\u7684\u5BF9\u8C61\u5927\u5C0F\u5927\u4E8E\u4E86\u8FDE\u7EED\u7A7A\u95F4\u7684\u5927\u5C0F\uFF0C\u90A3\u4E48\u5C06\u4F1A\u89E6\u53D1 Promotion Failed \uFF0C\u5373\u4F7F\u6574\u4E2A Old \u533A\u7684\u5BB9\u91CF\u662F\u8DB3\u591F\u7684\uFF0C\u4F46\u7531\u4E8E\u5176\u4E0D\u8FDE\u7EED\uFF0C\u4E5F\u65E0\u6CD5\u5B58\u653E\u65B0\u5BF9\u8C61\uFF0C\u4E5F\u5C31\u662F\u672C\u6587\u6240\u8BF4\u7684\u95EE\u9898\u3002 \u589E\u91CF\u6536\u96C6\u62C5\u4FDD\u5931\u8D25</li></ul><p>\u5206\u914D\u5185\u5B58\u5931\u8D25\u540E\uFF0C\u4F1A\u5224\u65AD\u7EDF\u8BA1\u5F97\u5230\u7684 Young GC \u664B\u5347\u5230 Old \u7684\u5E73\u5747\u5927\u5C0F\uFF0C\u4EE5\u53CA\u5F53\u524D Young \u533A\u5DF2\u4F7F\u7528\u7684\u5927\u5C0F\u4E5F\u5C31\u662F\u6700\u5927\u53EF\u80FD\u664B\u5347\u7684\u5BF9\u8C61\u5927\u5C0F\uFF0C\u662F\u5426\u5927\u4E8E Old \u533A\u7684\u5269\u4F59\u7A7A\u95F4\u3002\u53EA\u8981 CMS \u7684\u5269\u4F59\u7A7A\u95F4\u6BD4\u524D\u4E24\u8005\u7684\u4EFB\u610F\u4E00\u8005\u5927\uFF0CCMS \u5C31\u8BA4\u4E3A\u664B\u5347\u8FD8\u662F\u5B89\u5168\u7684\uFF0C\u53CD\u4E4B\uFF0C\u5219\u4EE3\u8868\u4E0D\u5B89\u5168\uFF0C\u4E0D\u8FDB\u884CYoung GC\uFF0C\u76F4\u63A5\u89E6\u53D1Full GC\u3002</p><p><strong>\u663E\u5F0F GC</strong></p><p>\u8FD9\u79CD\u60C5\u51B5\u53C2\u89C1\u573A\u666F\u4E8C\u3002</p><p><strong>\u5E76\u53D1\u6A21\u5F0F\u5931\u8D25\uFF08Concurrent Mode Failure\uFF09</strong></p><p>\u6700\u540E\u4E00\u79CD\u60C5\u51B5\uFF0C\u4E5F\u662F\u53D1\u751F\u6982\u7387\u8F83\u9AD8\u7684\u4E00\u79CD\uFF0C\u5728 GC \u65E5\u5FD7\u4E2D\u7ECF\u5E38\u80FD\u770B\u5230 Concurrent Mode Failure \u5173\u952E\u5B57\u3002\u8FD9\u79CD\u662F\u7531\u4E8E\u5E76\u53D1 Background CMS GC \u6B63\u5728\u6267\u884C\uFF0C\u540C\u65F6\u53C8\u6709 Young GC \u664B\u5347\u7684\u5BF9\u8C61\u8981\u653E\u5165\u5230\u4E86 Old \u533A\u4E2D\uFF0C\u800C\u6B64\u65F6 Old \u533A\u7A7A\u95F4\u4E0D\u8DB3\u9020\u6210\u7684\u3002</p><p>\u4E3A\u4EC0\u4E48 CMS GC \u6B63\u5728\u6267\u884C\u8FD8\u4F1A\u5BFC\u81F4\u6536\u96C6\u5668\u9000\u5316\u5462\uFF1F\u4E3B\u8981\u662F\u7531\u4E8E CMS \u65E0\u6CD5\u5904\u7406\u6D6E\u52A8\u5783\u573E\uFF08Floating Garbage\uFF09\u5F15\u8D77\u7684\u3002CMS \u7684\u5E76\u53D1\u6E05\u7406\u9636\u6BB5\uFF0CMutator \u8FD8\u5728\u8FD0\u884C\uFF0C\u56E0\u6B64\u4E0D\u65AD\u6709\u65B0\u7684\u5783\u573E\u4EA7\u751F\uFF0C\u800C\u8FD9\u4E9B\u5783\u573E\u4E0D\u5728\u8FD9\u6B21\u6E05\u7406\u6807\u8BB0\u7684\u8303\u7574\u91CC\uFF0C\u65E0\u6CD5\u5728\u672C\u6B21 GC \u88AB\u6E05\u9664\u6389\uFF0C\u8FD9\u4E9B\u5C31\u662F\u6D6E\u52A8\u5783\u573E\uFF0C\u9664\u6B64\u4E4B\u5916\u5728 Remark \u4E4B\u524D\u90A3\u4E9B\u65AD\u5F00\u5F15\u7528\u8131\u79BB\u4E86\u8BFB\u5199\u5C4F\u969C\u63A7\u5236\u7684\u5BF9\u8C61\u4E5F\u7B97\u6D6E\u52A8\u5783\u573E\u3002\u6240\u4EE5 Old \u533A\u56DE\u6536\u7684\u9608\u503C\u4E0D\u80FD\u592A\u9AD8\uFF0C\u5426\u5219\u9884\u7559\u7684\u5185\u5B58\u7A7A\u95F4\u5F88\u53EF\u80FD\u4E0D\u591F\uFF0C\u4ECE\u800C\u5BFC\u81F4 Concurrent Mode Failure \u53D1\u751F\u3002</p><h4 id="_4-7-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-7-3-\u7B56\u7565" aria-hidden="true">#</a> 4.7.3 \u7B56\u7565</h4><p>\u5206\u6790\u5230\u5177\u4F53\u539F\u56E0\u540E\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u9488\u5BF9\u6027\u89E3\u51B3\u4E86\uFF0C\u5177\u4F53\u601D\u8DEF\u8FD8\u662F\u4ECE\u6839\u56E0\u51FA\u53D1\uFF0C\u5177\u4F53\u89E3\u51B3\u7B56\u7565\uFF1A</p><ul><li><strong>\u5185\u5B58\u788E\u7247</strong>\uFF1A \u901A\u8FC7\u914D\u7F6E -XX:UseCMSCompactAtFullCollection=true \u6765\u63A7\u5236 Full GC\u7684\u8FC7\u7A0B\u4E2D\u662F\u5426\u8FDB\u884C\u7A7A\u95F4\u7684\u6574\u7406\uFF08\u9ED8\u8BA4\u5F00\u542F\uFF0C\u6CE8\u610F\u662FFull GC\uFF0C\u4E0D\u662F\u666E\u901ACMS GC\uFF09\uFF0C\u4EE5\u53CA -XX: CMSFullGCsBeforeCompaction=n \u6765\u63A7\u5236\u591A\u5C11\u6B21 Full GC \u540E\u8FDB\u884C\u4E00\u6B21\u538B\u7F29\u3002</li><li><strong>\u589E\u91CF\u6536\u96C6</strong>\uFF1A \u964D\u4F4E\u89E6\u53D1 CMS GC \u7684\u9608\u503C\uFF0C\u5373\u53C2\u6570 -XX:CMSInitiatingOccupancyFraction \u7684\u503C\uFF0C\u8BA9 CMS GC \u5C3D\u65E9\u6267\u884C\uFF0C\u4EE5\u4FDD\u8BC1\u6709\u8DB3\u591F\u7684\u8FDE\u7EED\u7A7A\u95F4\uFF0C\u4E5F\u51CF\u5C11 Old \u533A\u7A7A\u95F4\u7684\u4F7F\u7528\u5927\u5C0F\uFF0C\u53E6\u5916\u9700\u8981\u4F7F\u7528 -XX:+UseCMSInitiatingOccupancyOnly \u6765\u914D\u5408\u4F7F\u7528\uFF0C\u4E0D\u7136 JVM \u4EC5\u5728\u7B2C\u4E00\u6B21\u4F7F\u7528\u8BBE\u5B9A\u503C\uFF0C\u540E\u7EED\u5219\u81EA\u52A8\u8C03\u6574\u3002</li><li><strong>\u6D6E\u52A8\u5783\u573E</strong>\uFF1A \u89C6\u60C5\u51B5\u63A7\u5236\u6BCF\u6B21\u664B\u5347\u5BF9\u8C61\u7684\u5927\u5C0F\uFF0C\u6216\u8005\u7F29\u77ED\u6BCF\u6B21 CMS GC \u7684\u65F6\u95F4\uFF0C\u5FC5\u8981\u65F6\u53EF\u8C03\u8282 NewRatio \u7684\u503C\u3002\u53E6\u5916\u5C31\u662F\u4F7F\u7528 -XX:+CMSScavengeBeforeRemark \u5728\u8FC7\u7A0B\u4E2D\u63D0\u524D\u89E6\u53D1\u4E00\u6B21 Young GC\uFF0C\u9632\u6B62\u540E\u7EED\u664B\u5347\u8FC7\u591A\u5BF9\u8C61\u3002</li></ul><h4 id="_4-7-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-7-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.7.4 \u5C0F\u7ED3</h4><p>\u6B63\u5E38\u60C5\u51B5\u4E0B\u89E6\u53D1\u5E76\u53D1\u6A21\u5F0F\u7684 CMS GC\uFF0C\u505C\u987F\u975E\u5E38\u77ED\uFF0C\u5BF9\u4E1A\u52A1\u5F71\u54CD\u5F88\u5C0F\uFF0C\u4F46 CMS GC \u9000\u5316\u540E\uFF0C\u5F71\u54CD\u4F1A\u975E\u5E38\u5927\uFF0C\u5EFA\u8BAE\u53D1\u73B0\u4E00\u6B21\u540E\u5C31\u5F7B\u5E95\u6839\u6CBB\u3002\u53EA\u8981\u80FD\u5B9A\u4F4D\u5230\u5185\u5B58\u788E\u7247\u3001\u6D6E\u52A8\u5783\u573E\u3001\u589E\u91CF\u6536\u96C6\u76F8\u5173\u7B49\u5177\u4F53\u4EA7\u751F\u539F\u56E0\uFF0C\u8FD8\u662F\u6BD4\u8F83\u597D\u89E3\u51B3\u7684\uFF0C\u5173\u4E8E\u5185\u5B58\u788E\u7247\u8FD9\u5757\uFF0C\u5982\u679C -XX:CMSFullGCsBeforeCompaction \u7684\u503C\u4E0D\u597D\u9009\u53D6\u7684\u8BDD\uFF0C\u53EF\u4EE5\u4F7F\u7528 -XX:PrintFLSStatistics \u6765\u89C2\u5BDF\u5185\u5B58\u788E\u7247\u7387\u60C5\u51B5\uFF0C\u7136\u540E\u518D\u8BBE\u7F6E\u5177\u4F53\u7684\u503C\u3002</p><p>\u6700\u540E\u5C31\u662F\u5728\u7F16\u7801\u7684\u65F6\u5019\u4E5F\u8981\u907F\u514D\u9700\u8981\u8FDE\u7EED\u5730\u5740\u7A7A\u95F4\u7684\u5927\u5BF9\u8C61\u7684\u4EA7\u751F\uFF0C\u5982\u8FC7\u957F\u7684\u5B57\u7B26\u4E32\uFF0C\u7528\u4E8E\u5B58\u653E\u9644\u4EF6\u3001\u5E8F\u5217\u5316\u6216\u53CD\u5E8F\u5217\u5316\u7684 byte \u6570\u7EC4\u7B49\uFF0C\u8FD8\u6709\u5C31\u662F\u8FC7\u65E9\u664B\u5347\u95EE\u9898\u5C3D\u91CF\u5728\u7206\u53D1\u95EE\u9898\u524D\u5C31\u907F\u514D\u6389\u3002</p><h3 id="_4-8-\u573A\u666F\u516B-\u5806\u5916\u5185\u5B58-oom" tabindex="-1"><a class="header-anchor" href="#_4-8-\u573A\u666F\u516B-\u5806\u5916\u5185\u5B58-oom" aria-hidden="true">#</a> 4.8 \u573A\u666F\u516B\uFF1A\u5806\u5916\u5185\u5B58 OOM</h3><h4 id="_4-8-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-8-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.8.1 \u73B0\u8C61</h4><p>\u5185\u5B58\u4F7F\u7528\u7387\u4E0D\u65AD\u4E0A\u5347\uFF0C\u751A\u81F3\u5F00\u59CB\u4F7F\u7528 SWAP \u5185\u5B58\uFF0C\u540C\u65F6\u53EF\u80FD\u51FA\u73B0 GC \u65F6\u95F4\u98D9\u5347\uFF0C\u7EBF\u7A0B\u88AB Block \u7B49\u73B0\u8C61\uFF0C\u901A\u8FC7 top \u547D\u4EE4\u53D1\u73B0 Java \u8FDB\u7A0B\u7684 RES \u751A\u81F3\u8D85\u8FC7\u4E86 -Xmx \u7684\u5927\u5C0F\u3002\u51FA\u73B0\u8FD9\u4E9B\u73B0\u8C61\u65F6\uFF0C\u57FA\u672C\u53EF\u4EE5\u786E\u5B9A\u662F\u51FA\u73B0\u4E86\u5806\u5916\u5185\u5B58\u6CC4\u6F0F\u3002</p><h4 id="_4-8-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-8-2-\u539F\u56E0" aria-hidden="true">#</a> 4.8.2 \u539F\u56E0</h4><p>JVM \u7684\u5806\u5916\u5185\u5B58\u6CC4\u6F0F\uFF0C\u4E3B\u8981\u6709\u4E24\u79CD\u7684\u539F\u56E0\uFF1A</p><ul><li>\u901A\u8FC7 <code>UnSafe#allocateMemory\uFF0CByteBuffer#allocateDirect</code> \u4E3B\u52A8\u7533\u8BF7\u4E86\u5806\u5916\u5185\u5B58\u800C\u6CA1\u6709\u91CA\u653E\uFF0C\u5E38\u89C1\u4E8E NIO\u3001Netty \u7B49\u76F8\u5173\u7EC4\u4EF6\u3002</li><li>\u4EE3\u7801\u4E2D\u6709\u901A\u8FC7 JNI \u8C03\u7528 Native Code \u7533\u8BF7\u7684\u5185\u5B58\u6CA1\u6709\u91CA\u653E\u3002</li></ul><h4 id="_4-8-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-8-3-\u7B56\u7565" aria-hidden="true">#</a> 4.8.3 \u7B56\u7565</h4><p>\u54EA\u79CD\u539F\u56E0\u9020\u6210\u7684\u5806\u5916\u5185\u5B58\u6CC4\u6F0F\uFF1F</p>`,205),P=s("\u9996\u5148\uFF0C\u6211\u4EEC\u9700\u8981\u786E\u5B9A\u662F\u54EA\u79CD\u539F\u56E0\u5BFC\u81F4\u7684\u5806\u5916\u5185\u5B58\u6CC4\u6F0F\u3002\u8FD9\u91CC\u53EF\u4EE5\u4F7F\u7528 "),L={href:"https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/tooldescr007.html",target:"_blank",rel:"noopener noreferrer"},j=s("NMT (opens new window)"),B=s("\uFF08NativeMemoryTracking\uFF09 \u8FDB\u884C\u5206\u6790\u3002\u5728\u9879\u76EE\u4E2D\u6DFB\u52A0 -XX:NativeMemoryTracking=detail JVM\u53C2\u6570\u540E\u91CD\u542F\u9879\u76EE\uFF08\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u6253\u5F00 NMT \u4F1A\u5E26\u6765 5%~10% \u7684\u6027\u80FD\u635F\u8017\uFF09\u3002\u4F7F\u7528\u547D\u4EE4 jcmd pid VM.native_memory detail \u67E5\u770B\u5185\u5B58\u5206\u5E03\u3002\u91CD\u70B9\u89C2\u5BDF total \u4E2D\u7684 committed\uFF0C\u56E0\u4E3A jcmd \u547D\u4EE4\u663E\u793A\u7684\u5185\u5B58\u5305\u542B\u5806\u5185\u5185\u5B58\u3001Code \u533A\u57DF\u3001\u901A\u8FC7 Unsafe.allocateMemory \u548C DirectByteBuffer \u7533\u8BF7\u7684\u5185\u5B58\uFF0C\u4F46\u662F\u4E0D\u5305\u542B\u5176\u4ED6 Native Code\uFF08C \u4EE3\u7801\uFF09\u7533\u8BF7\u7684\u5806\u5916\u5185\u5B58\u3002"),A=p("<p>\u5982\u679C total \u4E2D\u7684 committed \u548C top \u4E2D\u7684 RES \u76F8\u5DEE\u4E0D\u5927\uFF0C\u5219\u5E94\u4E3A\u4E3B\u52A8\u7533\u8BF7\u7684\u5806\u5916\u5185\u5B58\u672A\u91CA\u653E\u9020\u6210\u7684\uFF0C\u5982\u679C\u76F8\u5DEE\u8F83\u5927\uFF0C\u5219\u57FA\u672C\u53EF\u4EE5\u786E\u5B9A\u662F JNI \u8C03\u7528\u9020\u6210\u7684\u3002</p><ul><li><strong>\u539F\u56E0\u4E00\uFF1A\u4E3B\u52A8\u7533\u8BF7\u672A\u91CA\u653E</strong></li></ul><p>JVM \u4F7F\u7528 <code>-XX:MaxDirectMemorySize=size</code> \u53C2\u6570\u6765\u63A7\u5236\u53EF\u7533\u8BF7\u7684\u5806\u5916\u5185\u5B58\u7684\u6700\u5927\u503C\u3002\u5728 Java8 \u4E2D\uFF0C\u5982\u679C\u672A\u914D\u7F6E\u8BE5\u53C2\u6570\uFF0C\u9ED8\u8BA4\u548C -Xmx \u76F8\u7B49\u3002</p><p>NIO \u548C Netty \u90FD\u4F1A\u53D6 -XX:MaxDirectMemorySize \u914D\u7F6E\u7684\u503C\uFF0C\u6765\u9650\u5236\u7533\u8BF7\u7684\u5806\u5916\u5185\u5B58\u7684\u5927\u5C0F\u3002NIO \u548C Netty \u4E2D\u8FD8\u6709\u4E00\u4E2A\u8BA1\u6570\u5668\u5B57\u6BB5\uFF0C\u7528\u6765\u8BA1\u7B97\u5F53\u524D\u5DF2\u7533\u8BF7\u7684\u5806\u5916\u5185\u5B58\u5927\u5C0F\uFF0CNIO \u4E2D\u662F java.nio.Bits#totalCapacity\u3001Netty \u4E2D io.netty.util.internal.PlatformDependent#DIRECT_MEMORY_COUNTER\u3002</p><p>\u5F53\u7533\u8BF7\u5806\u5916\u5185\u5B58\u65F6\uFF0CNIO \u548C Netty \u4F1A\u6BD4\u8F83\u8BA1\u6570\u5668\u5B57\u6BB5\u548C\u6700\u5927\u503C\u7684\u5927\u5C0F\uFF0C\u5982\u679C\u8BA1\u6570\u5668\u7684\u503C\u8D85\u8FC7\u4E86\u6700\u5927\u503C\u7684\u9650\u5236\uFF0C\u4F1A\u629B\u51FA OOM \u7684\u5F02\u5E38\u3002</p><p>NIO \u4E2D\u662F\uFF1AOutOfMemoryError: Direct buffer memory\u3002</p><p>Netty \u4E2D\u662F\uFF1AOutOfDirectMemoryError: failed to allocate capacity byte(s) of direct memory (used: usedMemory , max: DIRECT_MEMORY_LIMIT )\u3002</p><p>\u6211\u4EEC\u53EF\u4EE5\u68C0\u67E5\u4EE3\u7801\u4E2D\u662F\u5982\u4F55\u4F7F\u7528\u5806\u5916\u5185\u5B58\u7684\uFF0CNIO \u6216\u8005\u662F Netty\uFF0C\u901A\u8FC7\u53CD\u5C04\uFF0C\u83B7\u53D6\u5230\u5BF9\u5E94\u7EC4\u4EF6\u4E2D\u7684\u8BA1\u6570\u5668\u5B57\u6BB5\uFF0C\u5E76\u5728\u9879\u76EE\u4E2D\u5BF9\u8BE5\u5B57\u6BB5\u7684\u6570\u503C\u8FDB\u884C\u6253\u70B9\uFF0C\u5373\u53EF\u51C6\u786E\u5730\u76D1\u63A7\u5230\u8FD9\u90E8\u5206\u5806\u5916\u5185\u5B58\u7684\u4F7F\u7528\u60C5\u51B5\u3002</p><p>\u6B64\u65F6\uFF0C\u53EF\u4EE5\u901A\u8FC7 Debug \u7684\u65B9\u5F0F\u786E\u5B9A\u4F7F\u7528\u5806\u5916\u5185\u5B58\u7684\u5730\u65B9\u662F\u5426\u6B63\u786E\u6267\u884C\u4E86\u91CA\u653E\u5185\u5B58\u7684\u4EE3\u7801\u3002\u53E6\u5916\uFF0C\u9700\u8981\u68C0\u67E5 JVM \u7684\u53C2\u6570\u662F\u5426\u6709 -XX:+DisableExplicitGC \u9009\u9879\uFF0C\u5982\u679C\u6709\u5C31\u53BB\u6389\uFF0C\u56E0\u4E3A\u8BE5\u53C2\u6570\u4F1A\u4F7F System.gc \u5931\u6548\u3002\uFF08\u573A\u666F\u4E8C\uFF1A\u663E\u5F0F GC \u7684\u53BB\u4E0E\u7559\uFF09</p><ul><li><strong>\u539F\u56E0\u4E8C\uFF1A\u901A\u8FC7 JNI \u8C03\u7528\u7684 Native Code \u7533\u8BF7\u7684\u5185\u5B58\u672A\u91CA\u653E</strong></li></ul><p>\u8FD9\u79CD\u60C5\u51B5\u6392\u67E5\u8D77\u6765\u6BD4\u8F83\u56F0\u96BE\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7 Google perftools + Btrace \u7B49\u5DE5\u5177\uFF0C\u5E2E\u52A9\u6211\u4EEC\u5206\u6790\u51FA\u95EE\u9898\u7684\u4EE3\u7801\u5728\u54EA\u91CC\u3002</p>",11),E=s("gperftools \u662F Google \u5F00\u53D1\u7684\u4E00\u6B3E\u975E\u5E38\u5B9E\u7528\u7684\u5DE5\u5177\u96C6\uFF0C\u5B83\u7684\u539F\u7406\u662F\u5728 Java \u5E94\u7528\u7A0B\u5E8F\u8FD0\u884C\u65F6\uFF0C\u5F53\u8C03\u7528 malloc \u65F6\u6362\u7528\u5B83\u7684 "),D={href:"http://libtcmalloc.so",target:"_blank",rel:"noopener noreferrer"},H=s("libtcmalloc.so"),V=s("\uFF0C\u8FD9\u6837\u5C31\u80FD\u5BF9\u5185\u5B58\u5206\u914D\u60C5\u51B5\u505A\u4E00\u4E9B\u7EDF\u8BA1\u3002\u6211\u4EEC\u4F7F\u7528 gperftools \u6765\u8FFD\u8E2A\u5206\u914D\u5185\u5B58\u7684\u547D\u4EE4\u3002\u5982\u4E0B\u56FE\u6240\u793A\uFF0C\u901A\u8FC7 gperftools \u53D1\u73B0 Java_java_util_zip_Inflater_init \u6BD4\u8F83\u53EF\u7591\u3002"),K=p(`<p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223406141.png" alt="image-20220822223406141" loading="lazy"></p><p>\u63A5\u4E0B\u6765\u53EF\u4EE5\u4F7F\u7528 Btrace\uFF0C\u5C1D\u8BD5\u5B9A\u4F4D\u5177\u4F53\u7684\u8C03\u7528\u6808\u3002Btrace \u662F Sun \u63A8\u51FA\u7684\u4E00\u6B3E Java \u8FFD\u8E2A\u3001\u76D1\u63A7\u5DE5\u5177\uFF0C\u53EF\u4EE5\u5728\u4E0D\u505C\u673A\u7684\u60C5\u51B5\u4E0B\u5BF9\u7EBF\u4E0A\u7684 Java \u7A0B\u5E8F\u8FDB\u884C\u76D1\u63A7\u3002\u5982\u4E0B\u56FE\u6240\u793A\uFF0C\u901A\u8FC7 Btrace \u5B9A\u4F4D\u51FA\u9879\u76EE\u4E2D\u7684 ZipHelper \u5728\u9891\u7E41\u8C03\u7528 GZIPInputStream \uFF0C\u5728\u5806\u5916\u5185\u5B58\u5206\u914D\u5BF9\u8C61\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223422117.png" alt="image-20220822223422117" loading="lazy"></p><p>\u6700\u7EC8\u5B9A\u4F4D\u5230\u662F\uFF0C\u9879\u76EE\u4E2D\u5BF9 GIPInputStream \u7684\u4F7F\u7528\u9519\u8BEF\uFF0C\u6CA1\u6709\u6B63\u786E\u7684 close()\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223438677.png" alt="image-20220822223438677" loading="lazy"></p><p>\u9664\u4E86\u9879\u76EE\u672C\u8EAB\u7684\u539F\u56E0\uFF0C\u8FD8\u53EF\u80FD\u6709\u5916\u90E8\u4F9D\u8D56\u5BFC\u81F4\u7684\u6CC4\u6F0F\uFF0C\u5982 Netty \u548C Spring Boot\uFF0C\u8BE6\u7EC6\u60C5\u51B5\u53EF\u4EE5\u5B66\u4E60\u4E0B\u8FD9\u4E24\u7BC7\u6587\u7AE0\uFF0CSpring Boot\u5F15\u8D77\u7684\u201C\u5806\u5916\u5185\u5B58\u6CC4\u6F0F\u201D\u6392\u67E5\u53CA\u7ECF\u9A8C\u603B\u7ED3\u3001Netty\u5806\u5916\u5185\u5B58\u6CC4\u9732\u6392\u67E5\u76DB\u5BB4\u3002</p><h4 id="_4-8-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-8-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.8.4 \u5C0F\u7ED3</h4><p>\u9996\u5148\u53EF\u4EE5\u4F7F\u7528 NMT + jcmd \u5206\u6790\u6CC4\u6F0F\u7684\u5806\u5916\u5185\u5B58\u662F\u54EA\u91CC\u7533\u8BF7\uFF0C\u786E\u5B9A\u539F\u56E0\u540E\uFF0C\u4F7F\u7528\u4E0D\u540C\u7684\u624B\u6BB5\uFF0C\u8FDB\u884C\u539F\u56E0\u5B9A\u4F4D\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223459444.png" alt="image-20220822223459444" loading="lazy"></p><h3 id="_4-9-\u573A\u666F\u4E5D-jni-\u5F15\u53D1\u7684-gc-\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_4-9-\u573A\u666F\u4E5D-jni-\u5F15\u53D1\u7684-gc-\u95EE\u9898" aria-hidden="true">#</a> 4.9 \u573A\u666F\u4E5D\uFF1AJNI \u5F15\u53D1\u7684 GC \u95EE\u9898</h3><h4 id="_4-9-1-\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#_4-9-1-\u73B0\u8C61" aria-hidden="true">#</a> 4.9.1 \u73B0\u8C61</h4><p>\u5728 GC \u65E5\u5FD7\u4E2D\uFF0C\u51FA\u73B0 GC Cause \u4E3A GCLocker Initiated GC\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">2020</span>-09-23T16:49:09.727+0800: <span class="token number">504426.742</span>: <span class="token punctuation">[</span>GC <span class="token punctuation">(</span>GCLocker Initiated GC<span class="token punctuation">)</span> <span class="token number">504426.742</span>: <span class="token punctuation">[</span>ParNew <span class="token punctuation">(</span>promotion failed<span class="token punctuation">)</span>: 209716K-<span class="token operator">&gt;</span>6042K<span class="token punctuation">(</span>1887488K<span class="token punctuation">)</span>, <span class="token number">0.0843330</span> secs<span class="token punctuation">]</span> 1449487K-<span class="token operator">&gt;</span>1347626K<span class="token punctuation">(</span>3984640K<span class="token punctuation">)</span>, <span class="token number">0.0848963</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times: <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token number">0.19</span> <span class="token assign-left variable">sys</span><span class="token operator">=</span><span class="token number">0.00</span>, <span class="token assign-left variable">real</span><span class="token operator">=</span><span class="token number">0.09</span> secs<span class="token punctuation">]</span>
<span class="token number">2020</span>-09-23T16:49:09.812+0800: <span class="token number">504426.827</span>: <span class="token punctuation">[</span>Full GC <span class="token punctuation">(</span>GCLocker Initiated GC<span class="token punctuation">)</span> <span class="token number">504426.827</span>: <span class="token punctuation">[</span>CMS: 1341583K-<span class="token operator">&gt;</span>419699K<span class="token punctuation">(</span>2097152K<span class="token punctuation">)</span>, <span class="token number">1.8482275</span> secs<span class="token punctuation">]</span> 1347626K-<span class="token operator">&gt;</span>419699K<span class="token punctuation">(</span>3984640K<span class="token punctuation">)</span>, <span class="token punctuation">[</span>Metaspace: 297780K-<span class="token operator">&gt;</span>297780K<span class="token punctuation">(</span>1329152K<span class="token punctuation">)</span><span class="token punctuation">]</span>, <span class="token number">1.8490564</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times: <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token number">1.62</span> <span class="token assign-left variable">sys</span><span class="token operator">=</span><span class="token number">0.20</span>, <span class="token assign-left variable">real</span><span class="token operator">=</span><span class="token number">1.85</span> secs<span class="token punctuation">]</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-9-2-\u539F\u56E0" tabindex="-1"><a class="header-anchor" href="#_4-9-2-\u539F\u56E0" aria-hidden="true">#</a> 4.9.2 \u539F\u56E0</h4><p>JNI\uFF08Java Native Interface\uFF09\u610F\u4E3A Java \u672C\u5730\u8C03\u7528\uFF0C\u5B83\u5141\u8BB8 Java \u4EE3\u7801\u548C\u5176\u4ED6\u8BED\u8A00\u5199\u7684 Native \u4EE3\u7801\u8FDB\u884C\u4EA4\u4E92\u3002</p><p>JNI \u5982\u679C\u9700\u8981\u83B7\u53D6 JVM \u4E2D\u7684 String \u6216\u8005\u6570\u7EC4\uFF0C\u6709\u4E24\u79CD\u65B9\u5F0F\uFF1A</p><ul><li>\u62F7\u8D1D\u4F20\u9012\u3002</li><li>\u5171\u4EAB\u5F15\u7528\uFF08\u6307\u9488\uFF09\uFF0C\u6027\u80FD\u66F4\u9AD8\u3002</li></ul><p>\u7531\u4E8E Native \u4EE3\u7801\u76F4\u63A5\u4F7F\u7528\u4E86 JVM \u5806\u533A\u7684\u6307\u9488\uFF0C\u5982\u679C\u8FD9\u65F6\u53D1\u751F GC\uFF0C\u5C31\u4F1A\u5BFC\u81F4\u6570\u636E\u9519\u8BEF\u3002\u56E0\u6B64\uFF0C\u5728\u53D1\u751F\u6B64\u7C7B JNI \u8C03\u7528\u65F6\uFF0C\u7981\u6B62 GC \u7684\u53D1\u751F\uFF0C\u540C\u65F6\u963B\u6B62\u5176\u4ED6\u7EBF\u7A0B\u8FDB\u5165 JNI \u4E34\u754C\u533A\uFF0C\u76F4\u5230\u6700\u540E\u4E00\u4E2A\u7EBF\u7A0B\u9000\u51FA\u4E34\u754C\u533A\u65F6\u89E6\u53D1\u4E00\u6B21 GC\u3002</p><p>GC Locker \u5B9E\u9A8C\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GCLockerTest</span> <span class="token punctuation">{</span>

  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ITERS <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ARR_SIZE <span class="token operator">=</span>  <span class="token number">10000</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> WINDOW <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> window <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>WINDOW<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">&quot;GCLockerTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>ARR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ITERS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">acquire</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Acquired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> WINDOW<span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// omit</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Releasing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;GCLockerTest.h&quot;</span></span>

<span class="token keyword">static</span> jbyte<span class="token operator">*</span> sink<span class="token punctuation">;</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_GCLockerTest_acquire</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass klass<span class="token punctuation">,</span> jintArray arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
sink <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetPrimitiveArrayCritical</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_GCLockerTest_release</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass klass<span class="token punctuation">,</span> jintArray arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ReleasePrimitiveArrayCritical</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C\u8BE5 JNI \u7A0B\u5E8F\uFF0C\u53EF\u4EE5\u770B\u5230\u53D1\u751F\u7684 GC \u90FD\u662F GCLocker Initiated GC\uFF0C\u5E76\u4E14\u6CE8\u610F\u5728 \u201CAcquired\u201D \u548C \u201CReleased\u201D \u65F6\u4E0D\u53EF\u80FD\u53D1\u751F GC\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223553465.png" alt="image-20220822223553465" loading="lazy"></p><p>GC Locker \u53EF\u80FD\u5BFC\u81F4\u7684\u4E0D\u826F\u540E\u679C\u6709\uFF1A</p><ul><li>\u5982\u679C\u6B64\u65F6\u662F Young \u533A\u4E0D\u591F Allocation Failure \u5BFC\u81F4\u7684 GC\uFF0C\u7531\u4E8E\u65E0\u6CD5\u8FDB\u884C Young GC\uFF0C\u4F1A\u5C06\u5BF9\u8C61\u76F4\u63A5\u5206\u914D\u81F3 Old \u533A\u3002</li><li>\u5982\u679C Old \u533A\u4E5F\u6CA1\u6709\u7A7A\u95F4\u4E86\uFF0C\u5219\u4F1A\u7B49\u5F85\u9501\u91CA\u653E\uFF0C\u5BFC\u81F4\u7EBF\u7A0B\u963B\u585E\u3002</li><li>\u53EF\u80FD\u89E6\u53D1\u989D\u5916\u4E0D\u5FC5\u8981\u7684 Young GC\uFF0CJDK \u6709\u4E00\u4E2A Bug\uFF0C\u6709\u4E00\u5B9A\u7684\u51E0\u7387\uFF0C\u672C\u6765\u53EA\u8BE5\u89E6\u53D1\u4E00\u6B21 GCLocker Initiated GC \u7684 Young GC\uFF0C\u5B9E\u9645\u53D1\u751F\u4E86\u4E00\u6B21 Allocation Failure GC \u53C8\u7D27\u63A5\u7740\u4E00\u6B21 GCLocker Initiated GC\u3002\u662F\u56E0\u4E3A GCLocker Initiated GC \u7684\u5C5E\u6027\u88AB\u8BBE\u4E3A full\uFF0C\u5BFC\u81F4\u4E24\u6B21 GC \u4E0D\u80FD\u6536\u655B\u3002</li></ul><h4 id="_4-9-3-\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_4-9-3-\u7B56\u7565" aria-hidden="true">#</a> 4.9.3 \u7B56\u7565</h4>`,26),W=n("li",null,"\u6DFB\u52A0 -XX+PrintJNIGCStalls \u53C2\u6570\uFF0C\u53EF\u4EE5\u6253\u5370\u51FA\u53D1\u751F JNI \u8C03\u7528\u65F6\u7684\u7EBF\u7A0B\uFF0C\u8FDB\u4E00\u6B65\u5206\u6790\uFF0C\u627E\u5230\u5F15\u53D1\u95EE\u9898\u7684 JNI \u8C03\u7528\u3002",-1),U=n("li",null,"JNI \u8C03\u7528\u9700\u8981\u8C28\u614E\uFF0C\u4E0D\u4E00\u5B9A\u53EF\u4EE5\u63D0\u5347\u6027\u80FD\uFF0C\u53CD\u800C\u53EF\u80FD\u9020\u6210 GC \u95EE\u9898\u3002",-1),Y=s("\u5347\u7EA7 JDK \u7248\u672C\u5230 14\uFF0C\u907F\u514D "),Z={href:"https://bugs.openjdk.java.net/browse/JDK-8048556",target:"_blank",rel:"noopener noreferrer"},Q=s("JDK-8048556 (opens new window)"),$=s(" \u5BFC\u81F4\u7684\u91CD\u590D GC\u3002"),nn=p('<p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223618177.png" alt="image-20220822223618177" loading="lazy"></p><h4 id="_4-9-4-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_4-9-4-\u5C0F\u7ED3" aria-hidden="true">#</a> 4.9.4 \u5C0F\u7ED3</h4><p>JNI \u4EA7\u751F\u7684 GC \u95EE\u9898\u8F83\u96BE\u6392\u67E5\uFF0C\u9700\u8981\u8C28\u614E\u4F7F\u7528\u3002</p><h2 id="_5-\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_5-\u603B\u7ED3" aria-hidden="true">#</a> 5. \u603B\u7ED3</h2><p>\u5728\u8FD9\u91CC\uFF0C\u6211\u4EEC\u628A\u6574\u4E2A\u6587\u7AE0\u5185\u5BB9\u603B\u7ED3\u4E00\u4E0B\uFF0C\u65B9\u4FBF\u5927\u5BB6\u6574\u4F53\u5730\u7406\u89E3\u56DE\u987E\u3002</p><h3 id="_5-1-\u5904\u7406\u6D41\u7A0B-sop" tabindex="-1"><a class="header-anchor" href="#_5-1-\u5904\u7406\u6D41\u7A0B-sop" aria-hidden="true">#</a> 5.1 \u5904\u7406\u6D41\u7A0B\uFF08SOP\uFF09</h3><p>\u4E0B\u56FE\u4E3A\u6574\u4F53 GC \u95EE\u9898\u666E\u9002\u7684\u5904\u7406\u6D41\u7A0B\uFF0C\u91CD\u70B9\u7684\u5730\u65B9\u4E0B\u9762\u4F1A\u5355\u72EC\u6807\u6CE8\uFF0C\u5176\u4ED6\u7684\u57FA\u672C\u90FD\u662F\u6807\u51C6\u5904\u7406\u6D41\u7A0B\uFF0C\u6B64\u5904\u4E0D\u518D\u8D58\u8FF0\uFF0C\u6700\u540E\u5728\u6574\u4E2A\u95EE\u9898\u90FD\u5904\u7406\u5B8C\u4E4B\u540E\u6709\u6761\u4EF6\u7684\u8BDD\u5EFA\u8BAE\u505A\u4E00\u4E0B\u590D\u76D8\u3002</p><ul><li><strong>\u5236\u5B9A\u6807\u51C6</strong>\uFF1A \u8FD9\u5757\u5185\u5BB9\u5176\u5B9E\u975E\u5E38\u91CD\u8981\uFF0C\u4F46\u5927\u90E8\u5206\u7CFB\u7EDF\u90FD\u662F\u7F3A\u5931\u7684\uFF0C\u7B14\u8005\u8FC7\u5F80\u9762\u8BD5\u7684\u540C\u5B66\u4E2D\u53EA\u6709\u4E0D\u5230\u4E00\u6210\u7684\u540C\u5B66\u80FD\u7ED9\u51FA\u81EA\u5DF1\u7684\u7CFB\u7EDF GC \u6807\u51C6\u5230\u5E95\u4EC0\u4E48\u6837\uFF0C\u5176\u4ED6\u7684\u90FD\u662F\u7528\u7684\u7EDF\u4E00\u6307\u6807\u6A21\u677F\uFF0C\u7F3A\u5C11\u9884\u89C1\u6027\uFF0C\u5177\u4F53\u6307\u6807\u5236\u5B9A\u53EF\u4EE5\u53C2\u8003 3.1 \u4E2D\u7684\u5185\u5BB9\uFF0C\u9700\u8981\u7ED3\u5408\u5E94\u7528\u7CFB\u7EDF\u7684 TP9999 \u65F6\u95F4\u548C\u5EF6\u8FDF\u3001\u541E\u5410\u91CF\u7B49\u8BBE\u5B9A\u5177\u4F53\u7684\u6307\u6807\uFF0C\u800C\u4E0D\u662F\u88AB\u95EE\u9898\u9A71\u52A8\u3002</li><li><strong>\u4FDD\u7559\u73B0\u573A</strong>\uFF1A \u76EE\u524D\u7EBF\u4E0A\u670D\u52A1\u57FA\u672C\u90FD\u662F\u5206\u5E03\u5F0F\u670D\u52A1\uFF0C\u67D0\u4E2A\u8282\u70B9\u53D1\u751F\u95EE\u9898\u540E\uFF0C\u5982\u679C\u6761\u4EF6\u5141\u8BB8\u4E00\u5B9A\u4E0D\u8981\u76F4\u63A5\u64CD\u4F5C\u91CD\u542F\u3001\u56DE\u6EDA\u7B49\u52A8\u4F5C\u6062\u590D\uFF0C\u4F18\u5148\u901A\u8FC7\u6458\u6389\u6D41\u91CF\u7684\u65B9\u5F0F\u6765\u6062\u590D\uFF0C\u8FD9\u6837\u6211\u4EEC\u53EF\u4EE5\u5C06\u5806\u3001\u6808\u3001GC \u65E5\u5FD7\u7B49\u5173\u952E\u4FE1\u606F\u4FDD\u7559\u4E0B\u6765\uFF0C\u4E0D\u7136\u9519\u8FC7\u4E86\u5B9A\u4F4D\u6839\u56E0\u7684\u65F6\u673A\uFF0C\u540E\u7EED\u89E3\u51B3\u96BE\u5EA6\u5C06\u5927\u5927\u589E\u52A0\u3002\u5F53\u7136\u9664\u4E86\u8FD9\u4E9B\uFF0C\u5E94\u7528\u65E5\u5FD7\u3001\u4E2D\u95F4\u4EF6\u65E5\u5FD7\u3001\u5185\u6838\u65E5\u5FD7\u3001\u5404\u79CD Metrics \u6307\u6807\u7B49\u5BF9\u95EE\u9898\u5206\u6790\u4E5F\u6709\u5F88\u5927\u5E2E\u52A9\u3002</li><li><strong>\u56E0\u679C\u5206\u6790</strong>\uFF1A \u5224\u65AD GC \u5F02\u5E38\u4E0E\u5176\u4ED6\u7CFB\u7EDF\u6307\u6807\u5F02\u5E38\u7684\u56E0\u679C\u5173\u7CFB\uFF0C\u53EF\u4EE5\u53C2\u8003\u7B14\u8005\u5728 3.2 \u4E2D\u4ECB\u7ECD\u7684\u65F6\u5E8F\u5206\u6790\u3001\u6982\u7387\u5206\u6790\u3001\u5B9E\u9A8C\u5206\u6790\u3001\u53CD\u8BC1\u5206\u6790\u7B49 4 \u79CD\u56E0\u679C\u5206\u6790\u6CD5\uFF0C\u907F\u514D\u5728\u6392\u67E5\u8FC7\u7A0B\u4E2D\u8D70\u5165\u8BEF\u533A\u3002</li><li><strong>\u6839\u56E0\u5206\u6790</strong>\uFF1A \u786E\u5B9E\u662F GC \u7684\u95EE\u9898\u540E\uFF0C\u53EF\u4EE5\u501F\u52A9\u4E0A\u6587\u63D0\u5230\u7684\u5DE5\u5177\u5E76\u901A\u8FC7 5 why \u6839\u56E0\u5206\u6790\u6CD5\u4EE5\u53CA\u8DDF\u7B2C\u4E09\u8282\u4E2D\u7684\u4E5D\u79CD\u5E38\u89C1\u7684\u573A\u666F\u8FDB\u884C\u9010\u4E00\u5339\u914D\uFF0C\u6216\u8005\u76F4\u63A5\u53C2\u8003\u4E0B\u6587\u7684\u6839\u56E0\u9C7C\u9AA8\u56FE\uFF0C\u627E\u51FA\u95EE\u9898\u53D1\u751F\u6839\u56E0\uFF0C\u6700\u540E\u518D\u9009\u62E9\u4F18\u5316\u624B\u6BB5\u3002</li></ul><h3 id="_5-2-\u6839\u56E0\u9C7C\u9AA8\u56FE" tabindex="-1"><a class="header-anchor" href="#_5-2-\u6839\u56E0\u9C7C\u9AA8\u56FE" aria-hidden="true">#</a> 5.2 \u6839\u56E0\u9C7C\u9AA8\u56FE</h3><p>\u9001\u4E0A\u4E00\u5F20\u95EE\u9898\u6839\u56E0\u9C7C\u9AA8\u56FE\uFF0C\u4E00\u822C\u60C5\u51B5\u4E0B\u6211\u4EEC\u5728\u5904\u7406\u4E00\u4E2A GC \u95EE\u9898\u65F6\uFF0C\u53EA\u8981\u80FD\u5B9A\u4F4D\u5230\u95EE\u9898\u7684\u201C\u75C5\u7076\u201D\uFF0C\u6709\u7684\u653E\u77E2\uFF0C\u5176\u5B9E\u5C31\u76F8\u5F53\u4E8E\u89E3\u51B3\u4E86 80%\uFF0C\u5982\u679C\u5728\u67D0\u4E9B\u573A\u666F\u4E0B\u4E0D\u592A\u597D\u5B9A\u4F4D\uFF0C\u5927\u5BB6\u53EF\u4EE5\u501F\u52A9\u8FD9\u79CD\u6839\u56E0\u5206\u6790\u56FE\u901A\u8FC7\u6392\u9664\u6CD5\u53BB\u5B9A\u4F4D\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223704641.png" alt="image-20220822223704641" loading="lazy"></p><h3 id="_5-3-\u8C03\u4F18\u5EFA\u8BAE" tabindex="-1"><a class="header-anchor" href="#_5-3-\u8C03\u4F18\u5EFA\u8BAE" aria-hidden="true">#</a> 5.3 \u8C03\u4F18\u5EFA\u8BAE</h3><ul><li><strong>Trade Off</strong>\uFF1A \u4E0E CAP \u6CE8\u5B9A\u8981\u7F3A\u4E00\u89D2\u4E00\u6837\uFF0CGC \u4F18\u5316\u8981\u5728\u5EF6\u8FDF\uFF08Latency\uFF09\u3001\u541E\u5410\u91CF\uFF08Throughput\uFF09\u3001\u5BB9\u91CF\uFF08Capacity\uFF09\u4E09\u8005\u4E4B\u95F4\u8FDB\u884C\u6743\u8861\u3002</li><li><strong>\u6700\u7EC8\u624B\u6BB5</strong>\uFF1A GC \u53D1\u751F\u95EE\u9898\u4E0D\u662F\u4E00\u5B9A\u8981\u5BF9 JVM \u7684 GC \u53C2\u6570\u8FDB\u884C\u8C03\u4F18\uFF0C\u5927\u90E8\u5206\u60C5\u51B5\u4E0B\u662F\u901A\u8FC7 GC \u7684\u60C5\u51B5\u627E\u51FA\u4E00\u4E9B\u4E1A\u52A1\u95EE\u9898\uFF0C\u5207\u8BB0\u4E0A\u6765\u5C31\u5BF9 GC \u53C2\u6570\u8FDB\u884C\u8C03\u6574\uFF0C\u5F53\u7136\u6709\u660E\u786E\u914D\u7F6E\u9519\u8BEF\u7684\u573A\u666F\u9664\u5916\u3002</li><li><strong>\u63A7\u5236\u53D8\u91CF</strong>\uFF1A \u63A7\u5236\u53D8\u91CF\u6CD5\u662F\u5728\u8499\u7279\u5361\u6D1B\uFF08Monte Carlo\uFF09\u65B9\u6CD5\u4E2D\u7528\u4E8E\u51CF\u5C11\u65B9\u5DEE\u7684\u4E00\u79CD\u6280\u672F\u65B9\u6CD5\uFF0C\u6211\u4EEC\u8C03\u4F18\u7684\u65F6\u5019\u5C3D\u91CF\u4E5F\u8981\u4F7F\u7528\uFF0C\u6BCF\u6B21\u8C03\u4F18\u8FC7\u7A0B\u5C3D\u53EF\u80FD\u53EA\u8C03\u6574\u4E00\u4E2A\u53D8\u91CF\u3002</li><li><strong>\u5584\u7528\u641C\u7D22</strong>\uFF1A \u7406\u8BBA\u4E0A 99.99% \u7684 GC \u95EE\u9898\u57FA\u672C\u90FD\u88AB\u9047\u5230\u4E86\uFF0C\u6211\u4EEC\u8981\u5B66\u4F1A\u4F7F\u7528\u641C\u7D22\u5F15\u64CE\u7684\u9AD8\u7EA7\u6280\u5DE7\uFF0C\u91CD\u70B9\u5173\u6CE8 StackOverFlow\u3001Github \u4E0A\u7684 Issue\u3001\u4EE5\u53CA\u5404\u79CD\u8BBA\u575B\u535A\u5BA2\uFF0C\u5148\u770B\u770B\u5176\u4ED6\u4EBA\u662F\u600E\u4E48\u89E3\u51B3\u7684\uFF0C\u4F1A\u8BA9\u89E3\u51B3\u95EE\u9898\u4E8B\u534A\u529F\u500D\u3002\u80FD\u770B\u5230\u8FD9\u7BC7\u6587\u7AE0\uFF0C\u4F60\u7684\u641C\u7D22\u80FD\u529B\u57FA\u672C\u8FC7\u5173\u4E86~</li><li><strong>\u8C03\u4F18\u91CD\u70B9</strong>\uFF1A \u603B\u4F53\u4E0A\u6765\u8BB2\uFF0C\u6211\u4EEC\u5F00\u53D1\u7684\u8FC7\u7A0B\u4E2D\u9047\u5230\u7684\u95EE\u9898\u7C7B\u578B\u4E5F\u57FA\u672C\u90FD\u7B26\u5408\u6B63\u6001\u5206\u5E03\uFF0C\u592A\u7B80\u5355\u6216\u592A\u590D\u6742\u7684\u57FA\u672C\u9047\u5230\u7684\u6982\u7387\u5F88\u4F4E\uFF0C\u7B14\u8005\u8FD9\u91CC\u5C06\u4E2D\u95F4\u6700\u91CD\u8981\u7684\u4E09\u4E2A\u573A\u666F\u6DFB\u52A0\u4E86\u201C*\u201D\u6807\u8BC6\uFF0C\u5E0C\u671B\u9605\u8BFB\u5B8C\u672C\u6587\u4E4B\u540E\u53EF\u4EE5\u89C2\u5BDF\u4E0B\u81EA\u5DF1\u8D1F\u8D23\u7684\u7CFB\u7EDF\uFF0C\u662F\u5426\u5B58\u5728\u4E0A\u8FF0\u95EE\u9898\u3002</li><li><strong>GC \u53C2\u6570</strong>\uFF1A \u5982\u679C\u5806\u3001\u6808\u786E\u5B9E\u65E0\u6CD5\u7B2C\u4E00\u65F6\u95F4\u4FDD\u7559\uFF0C\u4E00\u5B9A\u8981\u4FDD\u7559 GC \u65E5\u5FD7\uFF0C\u8FD9\u6837\u6211\u4EEC\u6700\u8D77\u7801\u53EF\u4EE5\u770B\u5230 GC Cause\uFF0C\u6709\u4E00\u4E2A\u5927\u6982\u7684\u6392\u67E5\u65B9\u5411\u3002\u5173\u4E8E GC \u65E5\u5FD7\u76F8\u5173\u53C2\u6570\uFF0C\u6700\u57FA\u672C\u7684 -XX:+HeapDumpOnOutOfMemoryError \u7B49\u4E00\u4E9B\u53C2\u6570\u5C31\u4E0D\u518D\u63D0\u4E86\uFF0C\u7B14\u8005\u5EFA\u8BAE\u6DFB\u52A0\u4EE5\u4E0B\u53C2\u6570\uFF0C\u53EF\u4EE5\u63D0\u9AD8\u6211\u4EEC\u5206\u6790\u95EE\u9898\u7684\u6548\u7387\u3002</li></ul><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220822223733549.png" alt="image-20220822223733549" loading="lazy"></p><ul><li><strong>\u5176\u4ED6\u5EFA\u8BAE</strong>\uFF1A \u4E0A\u6587\u573A\u666F\u4E2D\u6CA1\u6709\u63D0\u5230\uFF0C\u4F46\u662F\u5BF9 GC \u6027\u80FD\u4E5F\u6709\u63D0\u5347\u7684\u4E00\u4E9B\u5EFA\u8BAE\u3002 <ul><li><strong>\u4E3B\u52A8\u5F0F GC</strong>\uFF1A \u4E5F\u6709\u53E6\u5F00\u751F\u9762\u7684\u505A\u6CD5\uFF0C\u901A\u8FC7\u76D1\u63A7\u624B\u6BB5\u76D1\u63A7\u89C2\u6D4B Old \u533A\u7684\u4F7F\u7528\u60C5\u51B5\uFF0C\u5373\u5C06\u5230\u8FBE\u9608\u503C\u65F6\u5C06\u5E94\u7528\u670D\u52A1\u6458\u6389\u6D41\u91CF\uFF0C\u624B\u52A8\u89E6\u53D1\u4E00\u6B21 Major GC\uFF0C\u51CF\u5C11 CMS GC \u5E26\u6765\u7684\u505C\u987F\uFF0C\u4F46\u968F\u4E4B\u7CFB\u7EDF\u7684\u5065\u58EE\u6027\u4E5F\u4F1A\u51CF\u5C11\uFF0C\u5982\u975E\u5FC5\u8981\u4E0D\u5EFA\u8BAE\u5F15\u5165\u3002</li><li><strong>\u7981\u7528\u504F\u5411\u9501</strong>\uFF1A \u504F\u5411\u9501\u5728\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u4F7F\u7528\u5230\u8BE5\u9501\u7684\u65F6\u5019\u6548\u7387\u5F88\u9AD8\uFF0C\u4F46\u662F\u5728\u7ADE\u4E89\u6FC0\u70C8\u60C5\u51B5\u4F1A\u5347\u7EA7\u6210\u8F7B\u91CF\u7EA7\u9501\uFF0C\u6B64\u65F6\u5C31\u9700\u8981\u5148\u6D88\u9664\u504F\u5411\u9501\uFF0C\u8FD9\u4E2A\u8FC7\u7A0B\u662F STW \u7684\u3002\u5982\u679C\u6BCF\u4E2A\u540C\u6B65\u8D44\u6E90\u90FD\u8D70\u8FD9\u4E2A\u5347\u7EA7\u8FC7\u7A0B\uFF0C\u5F00\u9500\u4F1A\u975E\u5E38\u5927\uFF0C\u6240\u4EE5\u5728\u5DF2\u77E5\u5E76\u53D1\u6FC0\u70C8\u7684\u524D\u63D0\u4E0B\uFF0C\u4E00\u822C\u4F1A\u7981\u7528\u504F\u5411\u9501 <code>-XX:-UseBiasedLocking</code> \u6765\u63D0\u9AD8\u6027\u80FD\u3002</li><li><strong>\u865A\u62DF\u5185\u5B58</strong>\uFF1A \u542F\u52A8\u521D\u671F\u6709\u4E9B\u64CD\u4F5C\u7CFB\u7EDF\uFF08\u4F8B\u5982 Linux\uFF09\u5E76\u6CA1\u6709\u771F\u6B63\u5206\u914D\u7269\u7406\u5185\u5B58\u7ED9 JVM \uFF0C\u800C\u662F\u5728\u865A\u62DF\u5185\u5B58\u4E2D\u5206\u914D\uFF0C\u4F7F\u7528\u7684\u65F6\u5019\u624D\u4F1A\u5728\u7269\u7406\u5185\u5B58\u4E2D\u5206\u914D\u5185\u5B58\u9875\uFF0C\u8FD9\u6837\u4E5F\u4F1A\u5BFC\u81F4 GC \u65F6\u95F4\u8F83\u957F\u3002\u8FD9\u79CD\u60C5\u51B5\u53EF\u4EE5\u6DFB\u52A0 -XX:+AlwaysPreTouch \u53C2\u6570\uFF0C\u8BA9 VM \u5728 commit \u5185\u5B58\u65F6\u8DD1\u4E2A\u5FAA\u73AF\u6765\u5F3A\u5236\u4FDD\u8BC1\u7533\u8BF7\u7684\u5185\u5B58\u771F\u7684 commit\uFF0C\u907F\u514D\u8FD0\u884C\u65F6\u89E6\u53D1\u7F3A\u9875\u5F02\u5E38\u3002\u5728\u4E00\u4E9B\u5927\u5185\u5B58\u7684\u573A\u666F\u4E0B\uFF0C\u6709\u65F6\u5019\u80FD\u5C06\u524D\u51E0\u6B21\u7684 GC \u65F6\u95F4\u964D\u4E00\u4E2A\u6570\u91CF\u7EA7\uFF0C\u4F46\u662F\u6DFB\u52A0\u8FD9\u4E2A\u53C2\u6570\u540E\uFF0C\u542F\u52A8\u7684\u8FC7\u7A0B\u53EF\u80FD\u4F1A\u53D8\u6162\u3002</li></ul></li></ul><h2 id="_6-\u5199\u5728\u6700\u540E" tabindex="-1"><a class="header-anchor" href="#_6-\u5199\u5728\u6700\u540E" aria-hidden="true">#</a> 6. \u5199\u5728\u6700\u540E</h2><p>\u6700\u540E\uFF0C\u518D\u8BF4\u7B14\u8005\u4E2A\u4EBA\u7684\u4E00\u4E9B\u5C0F\u5EFA\u8BAE\uFF0C\u9047\u5230\u4E00\u4E9B GC \u95EE\u9898\uFF0C\u5982\u679C\u6709\u7CBE\u529B\uFF0C\u4E00\u5B9A\u8981\u63A2\u672C\u7A77\u6E90\uFF0C\u627E\u51FA\u6700\u6DF1\u5C42\u6B21\u7684\u539F\u56E0\u3002\u53E6\u5916\uFF0C\u5728\u8FD9\u4E2A\u4FE1\u606F\u6CDB\u6EE5\u7684\u65F6\u4EE3\uFF0C\u6709\u4E00\u4E9B\u88AB\u201C\u5949\u4E3A\u572D\u81EC\u201D\u7684\u7ECF\u9A8C\u53EF\u80FD\u90FD\u662F\u9519\u8BEF\u7684\uFF0C\u5C3D\u91CF\u517B\u6210\u770B\u6E90\u7801\u7684\u4E60\u60EF\uFF0C\u6709\u4E00\u53E5\u8BDD\u8BF4\u5230\u201C\u6E90\u7801\u9762\u524D\uFF0C\u4E86\u65E0\u79D8\u5BC6\u201D\uFF0C\u4E5F\u5C31\u610F\u5473\u7740\u9047\u5230\u641E\u4E0D\u61C2\u7684\u95EE\u9898\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4ECE\u6E90\u7801\u4E2D\u4E00\u7AA5\u7A76\u7ADF\uFF0C\u67D0\u4E9B\u573A\u666F\u4E0B\u786E\u6709\u5947\u6548\u3002\u4F46\u4E5F\u4E0D\u662F\u53EA\u9760\u8BFB\u6E90\u7801\u6765\u5B66\u4E60\uFF0C\u5982\u679C\u786C\u5543\u6E90\u7801\u4F46\u4E0D\u7406\u4F1A\u5176\u80CC\u540E\u53EF\u80FD\u8574\u542B\u7684\u7406\u8BBA\u57FA\u7840\uFF0C\u90A3\u5F88\u5BB9\u6613\u201C\u6361\u829D\u9EBB\u4E22\u897F\u74DC\u201D\uFF0C\u201C\u53EA\u89C1\u6811\u6728\uFF0C\u4E0D\u89C1\u68EE\u6797\u201D\uFF0C\u8BA9\u201C\u4E86\u65E0\u79D8\u5BC6\u201D\u53D8\u6210\u4E86\u4E00\u53E5\u7A7A\u8BDD\uFF0C\u6211\u4EEC\u8FD8\u662F\u8981\u7ED3\u5408\u4E00\u4E9B\u5B9E\u9645\u7684\u4E1A\u52A1\u573A\u666F\u53BB\u9488\u5BF9\u6027\u5730\u5B66\u4E60\u3002</p><p><strong>\u4F60\u7684\u65F6\u95F4\u5728\u54EA\u91CC\uFF0C\u4F60\u7684\u6210\u5C31\u5C31\u4F1A\u5728\u54EA\u91CC</strong>\u3002\u7B14\u8005\u4E5F\u662F\u5728\u524D\u4E24\u5E74\u624D\u5F00\u59CB\u9010\u6B65\u5730\u5728 GC \u65B9\u5411\u4E0A\u4E0D\u65AD\u6DF1\u5165\uFF0C\u67E5\u95EE\u9898\u3001\u770B\u6E90\u7801\u3001\u505A\u603B\u7ED3\uFF0C\u6BCF\u4E2A Case \u5F62\u6210\u4E00\u4E2A\u5C0F\u7684\u95ED\u73AF\uFF0C\u76EE\u524D\u521D\u6B65\u6478\u5230\u4E86 GC \u95EE\u9898\u5904\u7406\u7684\u4E00\u4E9B\u95E8\u9053\uFF0C\u540C\u65F6\u5C06\u7ECF\u9A8C\u603B\u7ED3\u5E94\u7528\u4E8E\u751F\u4EA7\u73AF\u5883\u5B9E\u8DF5\uFF0C\u6162\u6162\u5730\u5F62\u6210\u4E00\u4E2A\u826F\u6027\u5FAA\u73AF\u3002</p><p>\u672C\u7BC7\u6587\u7AE0\u4E3B\u8981\u662F\u4ECB\u7ECD\u4E86 CMS GC \u7684\u4E00\u4E9B\u5E38\u89C1\u573A\u666F\u5206\u6790\uFF0C\u53E6\u5916\u4E00\u4E9B\uFF0C\u5982 CodeCache \u95EE\u9898\u5BFC\u81F4 JIT \u5931\u6548\u3001SafePoint \u5C31\u7EEA\u65F6\u95F4\u957F\u3001Card Table \u626B\u63CF\u8017\u65F6\u7B49\u95EE\u9898\u4E0D\u592A\u5E38\u89C1\u5C31\u6CA1\u6709\u82B1\u592A\u591A\u7BC7\u5E45\u53BB\u8BB2\u89E3\u3002Java GC \u662F\u5728\u201C\u5206\u4EE3\u201D\u7684\u601D\u60F3\u4E0B\u5185\u5377\u4E86\u5F88\u591A\u5E74\u624D\u7A81\u7834\u5230\u4E86\u201C\u5206\u533A\u201D\uFF0C\u76EE\u524D\u5728\u7F8E\u56E2\u4E5F\u5DF2\u7ECF\u5F00\u59CB\u4F7F\u7528 G1 \u6765\u66FF\u6362\u4F7F\u7528\u4E86\u591A\u5E74\u7684 CMS\uFF0C\u867D\u7136\u5728\u5C0F\u7684\u5806\u65B9\u9762 G1 \u8FD8\u7565\u900A\u8272\u4E8E CMS\uFF0C\u4F46\u8FD9\u662F\u4E00\u4E2A\u8D8B\u52BF\uFF0C\u77ED\u65F6\u95F4\u65E0\u6CD5\u5347\u7EA7\u5230 ZGC\uFF0C\u6240\u4EE5\u672A\u6765\u9047\u5230\u7684 G1 \u7684\u95EE\u9898\u53EF\u80FD\u4F1A\u9010\u6E10\u589E\u591A\u3002\u76EE\u524D\u5DF2\u7ECF\u6536\u96C6\u5230 Remember Set \u7C97\u5316\u3001Humongous \u5206\u914D\u3001Ergonomics \u5F02\u5E38\u3001Mixed GC \u4E2D Evacuation Failure \u7B49\u95EE\u9898\uFF0C\u9664\u6B64\u4E4B\u5916\u4E5F\u4F1A\u7ED9\u51FA CMS \u5347\u7EA7\u5230 G1 \u7684\u4E00\u4E9B\u5EFA\u8BAE\uFF0C\u63A5\u4E0B\u6765\u7B14\u8005\u5C06\u7EE7\u7EED\u5B8C\u6210\u8FD9\u90E8\u5206\u6587\u7AE0\u6574\u7406\uFF0C\u656C\u8BF7\u671F\u5F85\u3002</p><p>\u201C\u9632\u706B\u201D\u6C38\u8FDC\u8981\u80DC\u4E8E\u201C\u6551\u706B\u201D\uFF0C<strong>\u4E0D\u653E\u8FC7\u4EFB\u4F55\u4E00\u4E2A\u5F02\u5E38\u7684\u5C0F\u6307\u6807</strong>\uFF08\u4E00\u822C\u6765\u8BF4\uFF0C\u4EFB\u4F55\u4E0D\u5E73\u6ED1\u7684\u66F2\u7EBF\u90FD\u662F\u503C\u5F97\u6000\u7591\u7684\uFF09 \uFF0C\u5C31\u6709\u53EF\u80FD\u907F\u514D\u4E00\u6B21\u6545\u969C\u7684\u53D1\u751F\u3002\u4F5C\u4E3A Java \u7A0B\u5E8F\u5458\u57FA\u672C\u90FD\u4F1A\u9047\u5230\u4E00\u4E9B GC \u7684\u95EE\u9898\uFF0C\u72EC\u7ACB\u89E3\u51B3 GC \u95EE\u9898\u662F\u6211\u4EEC\u5FC5\u987B\u8FC8\u8FC7\u7684\u4E00\u9053\u574E\u3002\u5F00\u7BC7\u4E2D\u4E5F\u63D0\u5230\u8FC7 GC \u4F5C\u4E3A\u7ECF\u5178\u7684\u6280\u672F\uFF0C\u975E\u5E38\u503C\u5F97\u6211\u4EEC\u5B66\u4E60\uFF0C\u4E00\u4E9B GC \u7684\u5B66\u4E60\u6750\u6599\uFF0C\u5982\u300AThe Garbage Collection Handbook\u300B\u300A\u6DF1\u5165\u7406\u89E3Java\u865A\u62DF\u673A\u300B\u7B49\u4E5F\u662F\u5E38\u8BFB\u5E38\u65B0\uFF0C\u8D76\u7D27\u52A8\u8D77\u6765\uFF0C\u82E6\u7EC3 GC \u57FA\u672C\u529F\u5427\u3002</p><p>\u6700\u540E\u7684\u6700\u540E\uFF0C\u518D\u591A\u5570\u55E6\u4E00\u53E5\uFF0C\u76EE\u524D\u6240\u6709 GC \u8C03\u4F18\u76F8\u5173\u7684\u6587\u7AE0\uFF0C\u7B2C\u4E00\u53E5\u8BB2\u7684\u5C31\u662F\u201C\u4E0D\u8981\u8FC7\u65E9\u4F18\u5316\u201D\uFF0C\u4F7F\u5F97\u5F88\u591A\u540C\u5B66\u5BF9 GC \u4F18\u5316\u671B\u800C\u5374\u6B65\u3002\u5728\u8FD9\u91CC\u7B14\u8005\u63D0\u51FA\u4E0D\u4E00\u6837\u7684\u89C2\u70B9\uFF0C\u71B5\u589E\u5B9A\u5F8B\uFF08\u5728\u4E00\u4E2A\u5B64\u7ACB\u7CFB\u7EDF\u91CC\uFF0C\u5982\u679C\u6CA1\u6709\u5916\u529B\u505A\u529F\uFF0C\u5176\u603B\u6DF7\u4E71\u5EA6\uFF08\u5373\u71B5\uFF09\u4F1A\u4E0D\u65AD\u589E\u5927\uFF09\u5728\u8BA1\u7B97\u673A\u7CFB\u7EDF\u540C\u6837\u9002\u7528\uFF0C\u5982\u679C\u4E0D\u4E3B\u52A8\u505A\u529F\u4F7F\u71B5\u51CF\uFF0C\u7CFB\u7EDF\u7EC8\u7A76\u4F1A\u8131\u79BB\u4F60\u7684\u638C\u63A7\uFF0C\u5728\u6211\u4EEC\u5BF9\u4E1A\u52A1\u7CFB\u7EDF\u548C GC \u539F\u7406\u638C\u63E1\u5F97\u8DB3\u591F\u6DF1\u7684\u65F6\u5019\uFF0C\u53EF\u4EE5\u653E\u5FC3\u5927\u80C6\u5730\u505A\u4F18\u5316\uFF0C\u56E0\u4E3A\u6211\u4EEC\u57FA\u672C\u53EF\u4EE5\u9884\u6D4B\u5230\u6BCF\u4E00\u4E2A\u64CD\u4F5C\u7684\u7ED3\u679C\uFF0C\u653E\u624B\u4E00\u640F\u5427\uFF0C\u5C11\u5E74\uFF01</p><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>',22),sn={href:"https://pdai.tech/md/java/jvm/java-jvm-cms-gc.html",target:"_blank",rel:"noopener noreferrer"},an=n("strong",null,"GC - Java \u5783\u573E\u56DE\u6536\u5668\u4E4BCMS GC\u95EE\u9898\u5206\u6790\u4E0E\u89E3\u51B3",-1);function tn(pn,en){const a=i("ExternalLinkIcon");return o(),c("div",null,[u,n("ul",null,[r,n("li",null,[k,d,n("a",m,[v,t(a)]),b])]),g,n("p",null,[_,n("a",h,[f,t(a)]),C]),y,M,n("ul",null,[w,n("li",null,[G,S,n("a",q,[z,t(a)]),T])]),x,n("ul",null,[O,I,n("li",null,[R,n("a",J,[F,t(a)]),N])]),X,n("p",null,[P,n("a",L,[j,t(a)]),B]),A,n("p",null,[E,n("a",D,[H,t(a)]),V]),K,n("ul",null,[W,U,n("li",null,[Y,n("a",Z,[Q,t(a)]),$])]),nn,n("p",null,[n("a",sn,[an,t(a)])])])}var ln=e(l,[["render",tn],["__file","java-jvm-cms-gc.html.vue"]]);export{ln as default};
