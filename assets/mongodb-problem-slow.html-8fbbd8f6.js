import{_ as n,W as a,X as s,a0 as t}from"./framework-0cf5f349.js";const o={},e=t(`<h1 id="mongodb大数据量查询慢问题" tabindex="-1"><a class="header-anchor" href="#mongodb大数据量查询慢问题" aria-hidden="true">#</a> mongodb大数据量查询慢问题</h1><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. 背景</h2><p>我单个collection 有100多万数据，单单一个count查询就要1分多钟，其他分页查数据也是慢成狗了。甚至有时候服务器直接挂掉</p><p>但是这个数据量在robo 3t 很快，但在我的代码和idea 的datagrid 中就特别慢。</p><p>经过一系列的排查大致可以从几个方面入手</p><h2 id="_2-解决" tabindex="-1"><a class="header-anchor" href="#_2-解决" aria-hidden="true">#</a> 2. 解决</h2><h3 id="_2-1-降低mongodb-版本" tabindex="-1"><a class="header-anchor" href="#_2-1-降低mongodb-版本" aria-hidden="true">#</a> 2.1 降低mongodb 版本</h3><p>原本spring-boot版本为2.5.x 关联的mongo版本为4.x</p><blockquote><p>4.x版本改动比较大，查询的优化可能没做好导致</p></blockquote><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220126164949424.png" alt="image-20220126164949424" tabindex="0" loading="lazy"><figcaption>image-20220126164949424</figcaption></figure><p>降低spring-boot版本为2.2.x 关联的mongo版本为3.x</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220126164746396.png" alt="image-20220126164746396" tabindex="0" loading="lazy"><figcaption>image-20220126164746396</figcaption></figure><p>速度快了好多</p><h3 id="_2-2-mongorepository-替换为mongotemplate-cursor-形式" tabindex="-1"><a class="header-anchor" href="#_2-2-mongorepository-替换为mongotemplate-cursor-形式" aria-hidden="true">#</a> 2.2 MongoRepository 替换为MongoTemplate.cursor 形式</h3><p>使用MongoTemplate.cursor形式会快很多</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>     <span class="token class-name">FindIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> findIterable <span class="token operator">=</span> mongoTemplate<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        findIterable<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>pageable<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> pageable<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MongoCursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> cursor <span class="token operator">=</span> findIterable<span class="token punctuation">.</span><span class="token function">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),p=[e];function c(i,l){return a(),s("div",null,p)}const r=n(o,[["render",c],["__file","mongodb-problem-slow.html.vue"]]);export{r as default};
