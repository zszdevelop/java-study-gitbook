import{_ as a,W as t,X as p,Y as n,Z as o,$ as c,a0 as e,D as i}from"./framework-0cf5f349.js";const u={},l=e(`<h1 id="mall中商品优惠方式-促销-会员价-阶梯价-满减" tabindex="-1"><a class="header-anchor" href="#mall中商品优惠方式-促销-会员价-阶梯价-满减" aria-hidden="true">#</a> mall中商品优惠方式(促销，会员价，阶梯价，满减)</h1><h2 id="_1-简介" tabindex="-1"><a class="header-anchor" href="#_1-简介" aria-hidden="true">#</a> 1. 简介</h2><p>优惠方式包括(促销，会员价，阶梯价，满减)，优惠也是商城营销中重要的手段之一。</p><p>促销，会员价，阶梯价，满减 只能选一种作为促销方式</p><h3 id="_1-1-优惠和优惠券" tabindex="-1"><a class="header-anchor" href="#_1-1-优惠和优惠券" aria-hidden="true">#</a> 1.1 优惠和优惠券</h3><p>优惠是在特定时间商品的属性，用户不需要选择优惠券即可享有优惠。而优惠券必须领取优惠券后使用</p><h2 id="_2-数据库设计" tabindex="-1"><a class="header-anchor" href="#_2-数据库设计" aria-hidden="true">#</a> 2. 数据库设计</h2><h3 id="_2-1-商品阶梯价格表" tabindex="-1"><a class="header-anchor" href="#_2-1-商品阶梯价格表" aria-hidden="true">#</a> 2.1 商品阶梯价格表</h3><p>商品优惠相关表，购买同商品满足一定数量后，可以使用打折价格进行购买。如：买两件商品可以打八折。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>create table pms_product_ladder
<span class="token punctuation">(</span>
   id                   bigint not <span class="token keyword">null</span> auto_increment<span class="token punctuation">,</span>
   product_id           bigint comment <span class="token char">&#39;商品id&#39;</span><span class="token punctuation">,</span>
   count                <span class="token keyword">int</span> comment &#39;满足的商品数量&#39;<span class="token punctuation">,</span>
   discount             <span class="token function">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> comment <span class="token char">&#39;折扣&#39;</span><span class="token punctuation">,</span>
   price                <span class="token function">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> comment <span class="token char">&#39;折后价格&#39;</span><span class="token punctuation">,</span>
   primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-商品满减表" tabindex="-1"><a class="header-anchor" href="#_2-2-商品满减表" aria-hidden="true">#</a> 2.2 商品满减表</h3><p>商品优惠相关表，购买同商品满足一定金额后，可以减免一定金额。如：买满1000减100元。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>create table pms_product_full_reduction
<span class="token punctuation">(</span>
   id                   bigint not <span class="token keyword">null</span> auto_increment<span class="token punctuation">,</span>
   product_id           bigint comment <span class="token char">&#39;商品id&#39;</span><span class="token punctuation">,</span>
   full_price           <span class="token function">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> comment <span class="token char">&#39;商品满足金额&#39;</span><span class="token punctuation">,</span>
   reduce_price         <span class="token function">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> comment <span class="token char">&#39;商品减少金额&#39;</span><span class="token punctuation">,</span>
   primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-商品会员价格表" tabindex="-1"><a class="header-anchor" href="#_2-3-商品会员价格表" aria-hidden="true">#</a> 2.3 商品会员价格表</h3><p>根据不同会员等级，可以以不同的会员价格购买。此处设计有缺陷，可以做成不同会员等级可以减免多少元或者按多少折扣进行购买。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>create table pms_member_price
<span class="token punctuation">(</span>
   id                   bigint not <span class="token keyword">null</span> auto_increment<span class="token punctuation">,</span>
   product_id           bigint comment <span class="token char">&#39;商品id&#39;</span><span class="token punctuation">,</span>
   member_level_id      bigint comment <span class="token char">&#39;会员等级id&#39;</span><span class="token punctuation">,</span>
   member_price         <span class="token function">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> comment <span class="token char">&#39;会员价格&#39;</span><span class="token punctuation">,</span>
   member_level_name    <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> comment <span class="token char">&#39;会员等级名称&#39;</span><span class="token punctuation">,</span>
   primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-代码设计" tabindex="-1"><a class="header-anchor" href="#_3-代码设计" aria-hidden="true">#</a> 3. 代码设计</h2><h3 id="_3-1-新增商品" tabindex="-1"><a class="header-anchor" href="#_3-1-新增商品" aria-hidden="true">#</a> 3.1 新增商品</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">PmsProductParam</span> productParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token comment">//创建商品</span>
    <span class="token class-name">PmsProduct</span> product <span class="token operator">=</span> productParam<span class="token punctuation">;</span>
    product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    productMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据促销类型设置价格：会员价格、阶梯价格、满减价格</span>
    <span class="token class-name">Long</span> productId <span class="token operator">=</span> product<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//会员价格</span>
    <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span>memberPriceDao<span class="token punctuation">,</span> productParam<span class="token punctuation">.</span><span class="token function">getMemberPriceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//阶梯价格</span>
    <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span>productLadderDao<span class="token punctuation">,</span> productParam<span class="token punctuation">.</span><span class="token function">getProductLadderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//满减价格</span>
    <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span>productFullReductionDao<span class="token punctuation">,</span> productParam<span class="token punctuation">.</span><span class="token function">getProductFullReductionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>建立关联关系表（这个方法抽取得还不错）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * 建立和插入关系表操作
     *
     * <span class="token keyword">@param</span> <span class="token parameter">dao</span>       可以操作的dao
     * <span class="token keyword">@param</span> <span class="token parameter">dataList</span>  要插入的数据
     * <span class="token keyword">@param</span> <span class="token parameter">productId</span> 建立关系的id
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> dao<span class="token punctuation">,</span> <span class="token class-name">List</span> dataList<span class="token punctuation">,</span> <span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>dataList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> item <span class="token operator">:</span> dataList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Method</span> setId <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;setId&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                setId<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Method</span> setProductId <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;setProductId&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                setProductId<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Method</span> insertList <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;insertList&quot;</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            insertList<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>dao<span class="token punctuation">,</span> dataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;创建产品出错:{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-更新促销价格" tabindex="-1"><a class="header-anchor" href="#_3-2-更新促销价格" aria-hidden="true">#</a> 3.2 更新促销价格</h3><ul><li>促销更新：直接更新商品信息</li><li>会员价格：先清除历史会员价格</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">PmsProductParam</span> productParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token comment">//更新商品信息</span>
    <span class="token class-name">PmsProduct</span> product <span class="token operator">=</span> productParam<span class="token punctuation">;</span>
    product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    productMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//会员价格</span>
    <span class="token class-name">PmsMemberPriceExample</span> pmsMemberPriceExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PmsMemberPriceExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pmsMemberPriceExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andProductIdEqualTo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberPriceMapper<span class="token punctuation">.</span><span class="token function">deleteByExample</span><span class="token punctuation">(</span>pmsMemberPriceExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span>memberPriceDao<span class="token punctuation">,</span> productParam<span class="token punctuation">.</span><span class="token function">getMemberPriceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//阶梯价格</span>
    <span class="token class-name">PmsProductLadderExample</span> ladderExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PmsProductLadderExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ladderExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andProductIdEqualTo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    productLadderMapper<span class="token punctuation">.</span><span class="token function">deleteByExample</span><span class="token punctuation">(</span>ladderExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span>productLadderDao<span class="token punctuation">,</span> productParam<span class="token punctuation">.</span><span class="token function">getProductLadderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//满减价格</span>
    <span class="token class-name">PmsProductFullReductionExample</span> fullReductionExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PmsProductFullReductionExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fullReductionExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andProductIdEqualTo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    productFullReductionMapper<span class="token punctuation">.</span><span class="token function">deleteByExample</span><span class="token punctuation">(</span>fullReductionExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">relateAndInsertList</span><span class="token punctuation">(</span>productFullReductionDao<span class="token punctuation">,</span> productParam<span class="token punctuation">.</span><span class="token function">getProductFullReductionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-促销实现" tabindex="-1"><a class="header-anchor" href="#_3-3-促销实现" aria-hidden="true">#</a> 3.3 促销实现</h3><p>首先要介绍一下这个，<strong>购物车中促销信息的封装</strong>，继承自购物车item</p><ol><li>我们以spu为单位查询出所有的促销信息</li><li>并计算出每件商品的优惠金额 <ol><li>单品促销的优惠金额：商品原价-促销价</li><li>打折的优惠金额：商品原价-折扣*商品原价</li><li>满减的优惠金额：(商品原价/总价)*满减金额</li></ol></li><li>通过每件商品的优惠金额，计算出优惠总价</li><li>所需要支付的金额：总价-优惠总价</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 购物车中促销信息的封装
 * Created by macro on 2018/8/27.
 */</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartPromotionItem</span> <span class="token keyword">extends</span> <span class="token class-name">OmsCartItem</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;促销活动信息&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> promotionMessage<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;促销活动减去的金额，针对每个商品&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> reduceAmount<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;剩余库存-锁定库存&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> realStock<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;购买商品赠送积分&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> integration<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;购买商品赠送成长值&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> growth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-1-单品促销" tabindex="-1"><a class="header-anchor" href="#_3-3-1-单品促销" aria-hidden="true">#</a> 3.3.1 单品促销</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>promotionType <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//单品促销</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CartPromotionItem</span> cartPromotionItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartPromotionItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPromotionMessage</span><span class="token punctuation">(</span><span class="token string">&quot;单品促销&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//优惠的金额=商品原价-促销价</span>
        <span class="token class-name">PmsSkuStock</span> skuStock <span class="token operator">=</span> <span class="token function">getOriginalPrice</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getProductSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> originalPrice <span class="token operator">=</span> skuStock<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//单品促销使用原价</span>
        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>originalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setReduceAmount</span><span class="token punctuation">(</span>originalPrice<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getPromotionPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setRealStock</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>skuStock<span class="token punctuation">.</span><span class="token function">getLockStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartPromotionItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-打折优惠" tabindex="-1"><a class="header-anchor" href="#_3-3-2-打折优惠" aria-hidden="true">#</a> 3.3.2 打折优惠</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>promotionType <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//打折优惠</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">getCartItemCount</span><span class="token punctuation">(</span>itemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PmsProductLadder</span> ladder <span class="token operator">=</span> <span class="token function">getProductLadder</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> promotionProduct<span class="token punctuation">.</span><span class="token function">getProductLadderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ladder<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CartPromotionItem</span> cartPromotionItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartPromotionItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token function">getLadderPromotionMessage</span><span class="token punctuation">(</span>ladder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPromotionMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//优惠的金额=商品原价-折扣*商品原价</span>
            <span class="token class-name">PmsSkuStock</span> skuStock <span class="token operator">=</span> <span class="token function">getOriginalPrice</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">,</span>item<span class="token punctuation">.</span><span class="token function">getProductSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> originalPrice <span class="token operator">=</span> skuStock<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> reduceAmount <span class="token operator">=</span> originalPrice<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>ladder<span class="token punctuation">.</span><span class="token function">getDiscount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>originalPrice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setReduceAmount</span><span class="token punctuation">(</span>reduceAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setRealStock</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>skuStock<span class="token punctuation">.</span><span class="token function">getLockStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">handleNoReduce</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span>itemList<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-3-满减" tabindex="-1"><a class="header-anchor" href="#_3-3-3-满减" aria-hidden="true">#</a> 3.3.3 满减</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>promotionType <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//满减</span>
    <span class="token class-name">BigDecimal</span> totalAmount<span class="token operator">=</span> <span class="token function">getCartItemAmount</span><span class="token punctuation">(</span>itemList<span class="token punctuation">,</span>promotionProductList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PmsProductFullReduction</span> fullReduction <span class="token operator">=</span> <span class="token function">getProductFullReduction</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getProductFullReductionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fullReduction<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CartPromotionItem</span> cartPromotionItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartPromotionItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token function">getFullReductionPromotionMessage</span><span class="token punctuation">(</span>fullReduction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPromotionMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//优惠的金额=(商品原价/总价)*满减金额</span>
            <span class="token class-name">PmsSkuStock</span> skuStock<span class="token operator">=</span> <span class="token function">getOriginalPrice</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getProductSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> originalPrice <span class="token operator">=</span> skuStock<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> reduceAmount <span class="token operator">=</span> originalPrice<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>fullReduction<span class="token punctuation">.</span><span class="token function">getReducePrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setReduceAmount</span><span class="token punctuation">(</span>reduceAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setRealStock</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>skuStock<span class="token punctuation">.</span><span class="token function">getLockStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItem<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cartPromotionItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">handleNoReduce</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span>itemList<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-计算促销优惠价格-完整流程" tabindex="-1"><a class="header-anchor" href="#_3-4-计算促销优惠价格-完整流程" aria-hidden="true">#</a> 3.4 计算促销优惠价格（完整流程）</h3><h4 id="_3-4-1-根据购物车id-生成确认单时-计算促销信息" tabindex="-1"><a class="header-anchor" href="#_3-4-1-根据购物车id-生成确认单时-计算促销信息" aria-hidden="true">#</a> 3.4.1 根据购物车id 生成确认单时，计算促销信息</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartPromotionItem</span><span class="token punctuation">&gt;</span></span> cartPromotionItemList <span class="token operator">=</span> cartItemService<span class="token punctuation">.</span><span class="token function">listPromotion</span><span class="token punctuation">(</span>currentMember<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cartIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
result<span class="token punctuation">.</span><span class="token function">setCartPromotionItemList</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2-计算购物车中的促销信息" tabindex="-1"><a class="header-anchor" href="#_3-4-2-计算购物车中的促销信息" aria-hidden="true">#</a> 3.4.2 计算购物车中的促销信息</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartPromotionItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">listPromotion</span><span class="token punctuation">(</span><span class="token class-name">Long</span> memberId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> cartIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span></span> cartItemList <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>cartIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            cartItemList <span class="token operator">=</span> cartItemList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span>cartIds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartPromotionItem</span><span class="token punctuation">&gt;</span></span> cartPromotionItemList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>cartItemList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            cartPromotionItemList <span class="token operator">=</span> promotionService<span class="token punctuation">.</span><span class="token function">calcCartPromotion</span><span class="token punctuation">(</span>cartItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cartPromotionItemList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-3-先根据productid对cartitem进行分组-以spu为单位进行计算优惠" tabindex="-1"><a class="header-anchor" href="#_3-4-3-先根据productid对cartitem进行分组-以spu为单位进行计算优惠" aria-hidden="true">#</a> 3.4.3 先根据productId对CartItem进行分组，以spu为单位进行计算优惠</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * 以spu为单位对购物车中商品进行分组
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">groupCartItemBySpu</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span></span> cartItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> productCartMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> cartItem <span class="token operator">:</span> cartItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span></span> productCartItemList <span class="token operator">=</span> productCartMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>productCartItemList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                productCartItemList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                productCartItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                productCartMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productCartItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                productCartItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> productCartMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-4-查询所有商品的优惠相关信息-sql关联表" tabindex="-1"><a class="header-anchor" href="#_3-4-4-查询所有商品的优惠相关信息-sql关联表" aria-hidden="true">#</a> 3.4.4 查询所有商品的优惠相关信息（sql关联表）</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;getPromotionProductList&quot;</span> resultMap<span class="token operator">=</span><span class="token string">&quot;promotionProductMap&quot;</span><span class="token operator">&gt;</span>
    <span class="token constant">SELECT</span>
        p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        p<span class="token punctuation">.</span>\`name\`<span class="token punctuation">,</span>
        p<span class="token punctuation">.</span>promotion_type<span class="token punctuation">,</span>
        p<span class="token punctuation">.</span>gift_growth<span class="token punctuation">,</span>
        p<span class="token punctuation">.</span>gift_point<span class="token punctuation">,</span>
        sku<span class="token punctuation">.</span>id sku_id<span class="token punctuation">,</span>
        sku<span class="token punctuation">.</span>price sku_price<span class="token punctuation">,</span>
        sku<span class="token punctuation">.</span>sku_code sku_sku_code<span class="token punctuation">,</span>
        sku<span class="token punctuation">.</span>promotion_price sku_promotion_price<span class="token punctuation">,</span>
        sku<span class="token punctuation">.</span>stock sku_stock<span class="token punctuation">,</span>
        sku<span class="token punctuation">.</span>lock_stock sku_lock_stock<span class="token punctuation">,</span>
        ladder<span class="token punctuation">.</span>id ladder_id<span class="token punctuation">,</span>
        ladder<span class="token punctuation">.</span>count ladder_count<span class="token punctuation">,</span>
        ladder<span class="token punctuation">.</span>discount ladder_discount<span class="token punctuation">,</span>
        full_re<span class="token punctuation">.</span>id full_id<span class="token punctuation">,</span>
        full_re<span class="token punctuation">.</span>full_price full_full_price<span class="token punctuation">,</span>
        full_re<span class="token punctuation">.</span>reduce_price full_reduce_price
    <span class="token constant">FROM</span>
        pms_product p
        <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> pms_sku_stock sku <span class="token constant">ON</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> sku<span class="token punctuation">.</span>product_id
        <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> pms_product_ladder ladder <span class="token constant">ON</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> ladder<span class="token punctuation">.</span>product_id
        <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> pms_product_full_reduction full_re <span class="token constant">ON</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> full_re<span class="token punctuation">.</span>product_id
    <span class="token constant">WHERE</span>
        p<span class="token punctuation">.</span>id <span class="token constant">IN</span>
    <span class="token operator">&lt;</span>foreach collection<span class="token operator">=</span><span class="token string">&quot;ids&quot;</span> <span class="token keyword">open</span><span class="token operator">=</span><span class="token string">&quot;(&quot;</span> close<span class="token operator">=</span><span class="token string">&quot;)&quot;</span> item<span class="token operator">=</span><span class="token string">&quot;id&quot;</span> separator<span class="token operator">=</span><span class="token string">&quot;,&quot;</span><span class="token operator">&gt;</span>
        #<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>foreach<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-5-计算商品促销优惠价格" tabindex="-1"><a class="header-anchor" href="#_3-4-5-计算商品促销优惠价格" aria-hidden="true">#</a> 3.4.5 计算商品促销优惠价格</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartPromotionItem</span><span class="token punctuation">&gt;</span></span> cartPromotionItemList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> productCartMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> productId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PromotionProduct</span> promotionProduct <span class="token operator">=</span> <span class="token function">getPromotionProductById</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> promotionProductList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsCartItem</span><span class="token punctuation">&gt;</span></span> itemList <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> promotionType <span class="token operator">=</span> promotionProduct<span class="token punctuation">.</span><span class="token function">getPromotionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>promotionType <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//单品促销</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">CartPromotionItem</span> cartPromotionItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartPromotionItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPromotionMessage</span><span class="token punctuation">(</span><span class="token string">&quot;单品促销&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//商品原价-促销价</span>
                    <span class="token class-name">PmsSkuStock</span> skuStock <span class="token operator">=</span> <span class="token function">getOriginalPrice</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getProductSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BigDecimal</span> originalPrice <span class="token operator">=</span> skuStock<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//单品促销使用原价</span>
                    cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>originalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cartPromotionItem<span class="token punctuation">.</span><span class="token function">setReduceAmount</span><span class="token punctuation">(</span>originalPrice<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getPromotionPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cartPromotionItem<span class="token punctuation">.</span><span class="token function">setRealStock</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>skuStock<span class="token punctuation">.</span><span class="token function">getLockStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cartPromotionItem<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cartPromotionItem<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cartPromotionItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>promotionType <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//打折优惠</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">getCartItemCount</span><span class="token punctuation">(</span>itemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PmsProductLadder</span> ladder <span class="token operator">=</span> <span class="token function">getProductLadder</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> promotionProduct<span class="token punctuation">.</span><span class="token function">getProductLadderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>ladder<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">CartPromotionItem</span> cartPromotionItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartPromotionItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token function">getLadderPromotionMessage</span><span class="token punctuation">(</span>ladder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPromotionMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//商品原价-折扣*商品原价</span>
                        <span class="token class-name">PmsSkuStock</span> skuStock <span class="token operator">=</span> <span class="token function">getOriginalPrice</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">,</span>item<span class="token punctuation">.</span><span class="token function">getProductSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BigDecimal</span> originalPrice <span class="token operator">=</span> skuStock<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BigDecimal</span> reduceAmount <span class="token operator">=</span> originalPrice<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>ladder<span class="token punctuation">.</span><span class="token function">getDiscount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>originalPrice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setReduceAmount</span><span class="token punctuation">(</span>reduceAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setRealStock</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>skuStock<span class="token punctuation">.</span><span class="token function">getLockStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token function">handleNoReduce</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span>itemList<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>promotionType <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//满减</span>
                <span class="token class-name">BigDecimal</span> totalAmount<span class="token operator">=</span> <span class="token function">getCartItemAmount</span><span class="token punctuation">(</span>itemList<span class="token punctuation">,</span>promotionProductList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PmsProductFullReduction</span> fullReduction <span class="token operator">=</span> <span class="token function">getProductFullReduction</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getProductFullReductionList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>fullReduction<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsCartItem</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">CartPromotionItem</span> cartPromotionItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartPromotionItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token function">getFullReductionPromotionMessage</span><span class="token punctuation">(</span>fullReduction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setPromotionMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//(商品原价/总价)*满减金额</span>
                        <span class="token class-name">PmsSkuStock</span> skuStock<span class="token operator">=</span> <span class="token function">getOriginalPrice</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getProductSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BigDecimal</span> originalPrice <span class="token operator">=</span> skuStock<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BigDecimal</span> reduceAmount <span class="token operator">=</span> originalPrice<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>fullReduction<span class="token punctuation">.</span><span class="token function">getReducePrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setReduceAmount</span><span class="token punctuation">(</span>reduceAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setRealStock</span><span class="token punctuation">(</span>skuStock<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>skuStock<span class="token punctuation">.</span><span class="token function">getLockStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItem<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>promotionProduct<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cartPromotionItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartPromotionItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token function">handleNoReduce</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span>itemList<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//无优惠</span>
                <span class="token function">handleNoReduce</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span> itemList<span class="token punctuation">,</span>promotionProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cartPromotionItemList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-需支付的总金额" tabindex="-1"><a class="header-anchor" href="#_3-5-需支付的总金额" aria-hidden="true">#</a> 3.5 需支付的总金额</h3><p>此时的计算就是商品的价格-促销价格</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> <span class="token function">calcTotalAmount</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartPromotionItem</span><span class="token punctuation">&gt;</span></span> cartItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BigDecimal</span> total <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartPromotionItem</span> item <span class="token operator">:</span> cartItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigDecimal</span> realPrice <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getReduceAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        total<span class="token operator">=</span>total<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>realPrice<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-界面设计" tabindex="-1"><a class="header-anchor" href="#_4-界面设计" aria-hidden="true">#</a> 4. 界面设计</h2><h3 id="_4-1-管理端" tabindex="-1"><a class="header-anchor" href="#_4-1-管理端" aria-hidden="true">#</a> 4.1 管理端</h3><h4 id="_4-1-1-填写促销" tabindex="-1"><a class="header-anchor" href="#_4-1-1-填写促销" aria-hidden="true">#</a> 4.1.1 填写促销</h4><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220323200719031.png" alt="image-20220323200719031" tabindex="0" loading="lazy"><figcaption>image-20220323200719031</figcaption></figure><h4 id="_4-1-2-特惠促销" tabindex="-1"><a class="header-anchor" href="#_4-1-2-特惠促销" aria-hidden="true">#</a> 4.1.2 特惠促销</h4><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220323200820529.png" alt="image-20220323200820529" tabindex="0" loading="lazy"><figcaption>image-20220323200820529</figcaption></figure><h4 id="_4-1-3-会员价格" tabindex="-1"><a class="header-anchor" href="#_4-1-3-会员价格" aria-hidden="true">#</a> 4.1.3 会员价格</h4><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220323200838867.png" alt="image-20220323200838867" tabindex="0" loading="lazy"><figcaption>image-20220323200838867</figcaption></figure><h2 id="_5-相关问题" tabindex="-1"><a class="header-anchor" href="#_5-相关问题" aria-hidden="true">#</a> 5. 相关问题</h2><h3 id="_5-1-什么时候需要计算促销金额" tabindex="-1"><a class="header-anchor" href="#_5-1-什么时候需要计算促销金额" aria-hidden="true">#</a> 5.1 什么时候需要计算促销金额</h3><ol><li>生成确认单的时候 <ol><li>优惠券是否符合满减需求，就已经使用了促销完成后的金额</li></ol></li><li>下单时</li></ol><h3 id="_5-2-优惠方式表设计" tabindex="-1"><a class="header-anchor" href="#_5-2-优惠方式表设计" aria-hidden="true">#</a> 5.2 优惠方式表设计</h3><ul><li><p>特惠促销：一件商品只有一个优惠价。是一对一的关系，所以设计在商品表中</p></li><li><p>会员价，阶梯价、满减：都是一对多的关系，所以采用外表方式</p></li></ul><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章" aria-hidden="true">#</a> 参考文章</h2>`,62),k={href:"http://www.macrozheng.com/#/database/mall_pms_02",target:"_blank",rel:"noopener noreferrer"};function r(d,m){const s=i("ExternalLinkIcon");return t(),p("div",null,[l,n("p",null,[n("a",k,[o("mall官网"),c(s)])])])}const b=a(u,[["render",r],["__file","mall-product-offer.html.vue"]]);export{b as default};
