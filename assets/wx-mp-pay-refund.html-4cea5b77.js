import{_ as t,W as p,X as e,Y as n,Z as c,$ as o,a0 as s,D as l}from"./framework-0cf5f349.js";const i={},u=s(`<h1 id="微信小程序退款实现" tabindex="-1"><a class="header-anchor" href="#微信小程序退款实现" aria-hidden="true">#</a> 微信小程序退款实现</h1><h2 id="_1-简介" tabindex="-1"><a class="header-anchor" href="#_1-简介" aria-hidden="true">#</a> 1. 简介</h2><p>商城中有交易，就有退货。那么退货完成后，我们如何实现退款呢？</p><h2 id="_2-退货流程" tabindex="-1"><a class="header-anchor" href="#_2-退货流程" aria-hidden="true">#</a> 2. 退货流程</h2><ol><li><p>用户在订单中选择要退货的订单</p></li><li><p>选择要退货的商品，填写退货基本信息（退货商品id，退货数量，价格）</p></li><li><p>后台对退货商品进行审批</p></li><li><p>审批通过，用户将商品进行退货</p><ol><li>设置退款金额（并不一定是订单原价，只要小于支付总价就可以）</li></ol></li><li><p>用户将商品退回后，后台操作完成退货</p><ol><li>此时将触发微信退款</li></ol></li></ol><h2 id="_3-微信退货实现" tabindex="-1"><a class="header-anchor" href="#_3-微信退货实现" aria-hidden="true">#</a> 3. 微信退货实现</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
            <span class="token comment">// 微信退款</span>
            <span class="token class-name">OmsOrderReturnApplyResult</span> item <span class="token operator">=</span> <span class="token function">getItem</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> returnAmount <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getReturnAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> totalFee <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getProductRealPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">WxPayService</span> wxPayService <span class="token operator">=</span> <span class="token class-name">WxPayConfiguration</span><span class="token punctuation">.</span><span class="token function">getPayService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">WxPayRefundRequest</span> refundRequest <span class="token operator">=</span> <span class="token class-name">WxPayRefundRequest</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">outRefundNo</span><span class="token punctuation">(</span>id<span class="token operator">+</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">outTradeNo</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">totalFee</span><span class="token punctuation">(</span>totalFee<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">refundFee</span><span class="token punctuation">(</span>returnAmount<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">WxPayRefundResult</span> refund <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">refund</span><span class="token punctuation">(</span>refundRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;退款结果：&quot;</span><span class="token operator">+</span>refund<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WxPayException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;退款失败，{}&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-相关配置-前置条件" tabindex="-1"><a class="header-anchor" href="#_4-相关配置-前置条件" aria-hidden="true">#</a> 4. 相关配置（前置条件）</h2><h3 id="_4-1-证书文件下载" tabindex="-1"><a class="header-anchor" href="#_4-1-证书文件下载" aria-hidden="true">#</a> 4.1 证书文件下载</h3>`,9),k={href:"https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_3",target:"_blank",rel:"noopener noreferrer"},r=s(`<figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220327221200412.png" alt="image-20220327221200412" tabindex="0" loading="lazy"><figcaption>image-20220327221200412</figcaption></figure><p>未正确配置会出现如下提示</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>【请求地址】：https://api.mch.weixin.qq.com/secapi/pay/refund
【请求数据】：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appid</span><span class="token punctuation">&gt;</span></span>wxcf0e67a387408a94<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appid</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mch_id</span><span class="token punctuation">&gt;</span></span>1623109465<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mch_id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce_str</span><span class="token punctuation">&gt;</span></span>1648388313318<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce_str</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sign</span><span class="token punctuation">&gt;</span></span>E0CCE2B1BC9ECC8C8FC8BC756D817547<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sign</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>out_trade_no</span><span class="token punctuation">&gt;</span></span>2022032701null000002<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>out_trade_no</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>out_refund_no</span><span class="token punctuation">&gt;</span></span>29test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>out_refund_no</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>total_fee</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>total_fee</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>refund_fee</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>refund_fee</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>op_user_id</span><span class="token punctuation">&gt;</span></span>1623109465<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>op_user_id</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span>
【异常信息】：请确保证书文件地址keyPath已配置
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220328202045671.png" alt="image-20220328202045671" tabindex="0" loading="lazy"><figcaption>image-20220328202045671</figcaption></figure>`,4);function d(g,m){const a=l("ExternalLinkIcon");return p(),e("div",null,[u,n("p",null,[n("a",k,[c("微信支付官方文档"),o(a)])]),r])}const f=t(i,[["render",d],["__file","wx-mp-pay-refund.html.vue"]]);export{f as default};
