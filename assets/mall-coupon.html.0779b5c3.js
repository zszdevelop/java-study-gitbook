import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o,c as e,a as n,b as t,e as s,d as c,r as l}from"./app.d4563a68.js";const i={},u=n("h1",{id:"mall\u4E2D\u4F18\u60E0\u5238\u8BBE\u8BA1-\u91CD\u70B9",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#mall\u4E2D\u4F18\u60E0\u5238\u8BBE\u8BA1-\u91CD\u70B9","aria-hidden":"true"},"#"),s(" mall\u4E2D\u4F18\u60E0\u5238\u8BBE\u8BA1\uFF08\u91CD\u70B9\uFF09")],-1),k=s("\u8BE5\u7BC7\u6587\u7AE0\u4E3B\u8981\u53C2\u8003"),r={href:"http://www.macrozheng.com/#/README",target:"_blank",rel:"noopener noreferrer"},d=s("mall\u5B98\u65B9\u6587\u6863"),m=s("\uFF0C\u5E76\u7ED3\u5408\u81EA\u5DF1\u7684\u4F7F\u7528\u611F\u53D7\u505A\u7684\u4E00\u4E9B\u7B14\u8BB0"),v=c(`<h2 id="_1-\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#_1-\u7B80\u4ECB" aria-hidden="true">#</a> 1. \u7B80\u4ECB</h2><p>\u4F18\u60E0\u5238\u662F\u5546\u57CE\u4E2D\u7684\u6838\u5FC3\u91CD\u70B9\uFF0C\u7535\u5546\u901A\u8FC7\u5404\u79CD\u5404\u79CD\u4FC3\u9500\u73A9\u6CD5\uFF0C\u589E\u52A0\u7528\u6237\u8D2D\u4E70\u6B32\u671B\uFF0C\u62C9\u52A8\u6D88\u8D39\u3002\u4F46\u4FC3\u9500\u73A9\u6CD5\u8FD8\u662F\u633A\u590D\u6742\u7684</p><h2 id="_2-\u76F8\u5173\u8868\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_2-\u76F8\u5173\u8868\u7ED3\u6784" aria-hidden="true">#</a> 2. \u76F8\u5173\u8868\u7ED3\u6784</h2><h3 id="_2-1-\u4F18\u60E0\u5238\u8868" tabindex="-1"><a class="header-anchor" href="#_2-1-\u4F18\u60E0\u5238\u8868" aria-hidden="true">#</a> 2.1 \u4F18\u60E0\u5238\u8868</h3><p>\u7528\u4E8E\u5B58\u50A8\u4F18\u60E0\u5238\u4FE1\u606F\uFF0C\u9700\u8981\u6CE8\u610F\u7684\u662F\u4F18\u60E0\u5238\u7684\u4F7F\u7528\u7C7B\u578B\uFF1A0-&gt;\u5168\u573A\u901A\u7528\uFF1B1-&gt;\u6307\u5B9A\u5206\u7C7B\uFF1B2-&gt;\u6307\u5B9A\u5546\u54C1\uFF0C\u4E0D\u540C\u4F7F\u7528\u7C7B\u578B\u7684\u4F18\u60E0\u5238\u4F7F\u7528\u8303\u56F4\u4E0D\u4E00\u6837\u3002</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sms_coupon
<span class="token punctuation">(</span>
   id                   <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
   <span class="token keyword">type</span>                 <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F18\u60E0\u5377\u7C7B\u578B\uFF1B0-&gt;\u5168\u573A\u8D60\u5238\uFF1B1-&gt;\u4F1A\u5458\u8D60\u5238\uFF1B2-&gt;\u8D2D\u7269\u8D60\u5238\uFF1B3-&gt;\u6CE8\u518C\u8D60\u5238&#39;</span><span class="token punctuation">,</span>
   name                 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u540D\u79F0&#39;</span><span class="token punctuation">,</span>
   platform             <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F7F\u7528\u5E73\u53F0\uFF1A0-&gt;\u5168\u90E8\uFF1B1-&gt;\u79FB\u52A8\uFF1B2-&gt;PC&#39;</span><span class="token punctuation">,</span>
   count                <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u6570\u91CF&#39;</span><span class="token punctuation">,</span>
   amount               <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u91D1\u989D&#39;</span><span class="token punctuation">,</span>
   per_limit            <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u6BCF\u4EBA\u9650\u9886\u5F20\u6570&#39;</span><span class="token punctuation">,</span>
   min_point            <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F7F\u7528\u95E8\u69DB\uFF1B0\u8868\u793A\u65E0\u95E8\u69DB&#39;</span><span class="token punctuation">,</span>
   start_time           <span class="token keyword">datetime</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5F00\u59CB\u4F7F\u7528\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
   end_time             <span class="token keyword">datetime</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u7ED3\u675F\u4F7F\u7528\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
   use_type             <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F7F\u7528\u7C7B\u578B\uFF1A0-&gt;\u5168\u573A\u901A\u7528\uFF1B1-&gt;\u6307\u5B9A\u5206\u7C7B\uFF1B2-&gt;\u6307\u5B9A\u5546\u54C1&#39;</span><span class="token punctuation">,</span>
   note                 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5907\u6CE8&#39;</span><span class="token punctuation">,</span>
   publish_count        <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u53D1\u884C\u6570\u91CF&#39;</span><span class="token punctuation">,</span>
   use_count            <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5DF2\u4F7F\u7528\u6570\u91CF&#39;</span><span class="token punctuation">,</span>
   receive_count        <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u9886\u53D6\u6570\u91CF&#39;</span><span class="token punctuation">,</span>
   enable_time          <span class="token keyword">datetime</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u53EF\u4EE5\u9886\u53D6\u7684\u65E5\u671F&#39;</span><span class="token punctuation">,</span>
   code                 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F18\u60E0\u7801&#39;</span><span class="token punctuation">,</span>
   member_level         <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u53EF\u9886\u53D6\u7684\u4F1A\u5458\u7C7B\u578B\uFF1A0-&gt;\u65E0\u9650\u5236&#39;</span><span class="token punctuation">,</span>
   <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-\u4F18\u60E0\u5238\u5386\u53F2\u8BB0\u5F55\u8868" tabindex="-1"><a class="header-anchor" href="#_2-2-\u4F18\u60E0\u5238\u5386\u53F2\u8BB0\u5F55\u8868" aria-hidden="true">#</a> 2.2 \u4F18\u60E0\u5238\u5386\u53F2\u8BB0\u5F55\u8868</h3><p>\u7528\u4E8E\u5B58\u50A8\u4F1A\u5458\u9886\u53D6\u53CA\u4F7F\u7528\u4F18\u60E0\u5238\u7684\u8BB0\u5F55\uFF0C<strong>\u5F53\u4F1A\u5458\u9886\u53D6\u5230\u4F18\u60E0\u5238\u65F6\uFF0C\u4F1A\u4EA7\u751F\u4E00\u6761\u4F18\u60E0\u5238\u7684\u8BB0\u5F55</strong>\uFF0C\u9700\u8981\u6CE8\u610F\u7684\u662F\u5B83\u7684\u4F7F\u7528\u72B6\u6001\uFF1A0-&gt;\u672A\u4F7F\u7528\uFF1B1-&gt;\u5DF2\u4F7F\u7528\uFF1B2-&gt;\u5DF2\u8FC7\u671F\u3002</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sms_coupon_history
<span class="token punctuation">(</span>
   id                   <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
   coupon_id            <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F18\u60E0\u5238id&#39;</span><span class="token punctuation">,</span>
   member_id            <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F1A\u5458id&#39;</span><span class="token punctuation">,</span>
   order_id             <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u8BA2\u5355id&#39;</span><span class="token punctuation">,</span>
   coupon_code          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F18\u60E0\u5238\u7801&#39;</span><span class="token punctuation">,</span>
   member_nickname      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u9886\u53D6\u4EBA\u6635\u79F0&#39;</span><span class="token punctuation">,</span>
   get_type             <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u83B7\u53D6\u7C7B\u578B\uFF1A0-&gt;\u540E\u53F0\u8D60\u9001\uFF1B1-&gt;\u4E3B\u52A8\u83B7\u53D6&#39;</span><span class="token punctuation">,</span>
   create_time          <span class="token keyword">datetime</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
   use_status           <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F7F\u7528\u72B6\u6001\uFF1A0-&gt;\u672A\u4F7F\u7528\uFF1B1-&gt;\u5DF2\u4F7F\u7528\uFF1B2-&gt;\u5DF2\u8FC7\u671F&#39;</span><span class="token punctuation">,</span>
   use_time             <span class="token keyword">datetime</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F7F\u7528\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
   order_sn             <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u8BA2\u5355\u53F7\u7801&#39;</span><span class="token punctuation">,</span>
   <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-\u4F18\u60E0\u5238\u548C\u5546\u54C1\u7684\u5173\u7CFB\u8868" tabindex="-1"><a class="header-anchor" href="#_2-3-\u4F18\u60E0\u5238\u548C\u5546\u54C1\u7684\u5173\u7CFB\u8868" aria-hidden="true">#</a> 2.3 \u4F18\u60E0\u5238\u548C\u5546\u54C1\u7684\u5173\u7CFB\u8868</h3><p>\u7528\u4E8E\u5B58\u50A8\u4F18\u60E0\u5238\u4E0E\u5546\u54C1\u7684\u5173\u7CFB\uFF0C\u5F53\u4F18\u60E0\u5238\u7684\u4F7F\u7528\u7C7B\u578B\u4E3A\u6307\u5B9A\u5546\u54C1\u65F6\uFF0C\u4F18\u60E0\u5238\u4E0E\u5546\u54C1\u9700\u8981\u5EFA\u7ACB\u5173\u7CFB\u3002</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sms_coupon_product_relation
<span class="token punctuation">(</span>
   id                   <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
   coupon_id            <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F18\u60E0\u5238id&#39;</span><span class="token punctuation">,</span>
   product_id           <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5546\u54C1id&#39;</span><span class="token punctuation">,</span>
   product_name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5546\u54C1\u540D\u79F0&#39;</span><span class="token punctuation">,</span>
   product_sn           <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5546\u54C1\u6761\u7801&#39;</span><span class="token punctuation">,</span>
   <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-\u4F18\u60E0\u5238\u548C\u5546\u54C1\u5206\u7C7B\u5173\u7CFB\u8868" tabindex="-1"><a class="header-anchor" href="#_2-4-\u4F18\u60E0\u5238\u548C\u5546\u54C1\u5206\u7C7B\u5173\u7CFB\u8868" aria-hidden="true">#</a> 2.4 \u4F18\u60E0\u5238\u548C\u5546\u54C1\u5206\u7C7B\u5173\u7CFB\u8868</h3><p>\u7528\u4E8E\u5B58\u50A8\u4F18\u60E0\u5238\u4E0E\u5546\u54C1\u5206\u7C7B\u7684\u5173\u7CFB\uFF0C\u5F53\u4F18\u60E0\u5238\u7684\u4F7F\u7528\u7C7B\u578B\u4E3A\u6307\u5B9A\u5206\u7C7B\u65F6\uFF0C\u4F18\u60E0\u5238\u4E0E\u5546\u54C1\u5206\u7C7B\u9700\u8981\u5EFA\u7ACB\u5173\u7CFB\u3002</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sms_coupon_product_category_relation
<span class="token punctuation">(</span>
   id                   <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
   coupon_id            <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u4F18\u60E0\u5238id&#39;</span><span class="token punctuation">,</span>
   product_category_id  <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5546\u54C1\u5206\u7C7Bid&#39;</span><span class="token punctuation">,</span>
   product_category_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u5546\u54C1\u5206\u7C7B\u540D\u79F0&#39;</span><span class="token punctuation">,</span>
   parent_category_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u7236\u5206\u7C7B\u540D\u79F0&#39;</span><span class="token punctuation">,</span>
   <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-\u7BA1\u7406\u7AEF\u5C55\u73B0" tabindex="-1"><a class="header-anchor" href="#_3-\u7BA1\u7406\u7AEF\u5C55\u73B0" aria-hidden="true">#</a> 3. \u7BA1\u7406\u7AEF\u5C55\u73B0</h2><h3 id="_3-1-\u4F18\u60E0\u5238\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#_3-1-\u4F18\u60E0\u5238\u5217\u8868" aria-hidden="true">#</a> 3.1 \u4F18\u60E0\u5238\u5217\u8868</h3><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114448436.png" alt="image-20220313114448436" loading="lazy"></p><h3 id="_3-2-\u7F16\u8F91\u4F18\u60E0\u5238" tabindex="-1"><a class="header-anchor" href="#_3-2-\u7F16\u8F91\u4F18\u60E0\u5238" aria-hidden="true">#</a> 3.2 \u7F16\u8F91\u4F18\u60E0\u5238</h3><h4 id="_3-2-1-\u5168\u573A\u901A\u7528" tabindex="-1"><a class="header-anchor" href="#_3-2-1-\u5168\u573A\u901A\u7528" aria-hidden="true">#</a> 3.2.1 \u5168\u573A\u901A\u7528</h4><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114555987.png" alt="image-20220313114555987" loading="lazy"></p><h4 id="_3-2-2-\u6307\u5B9A\u5546\u54C1" tabindex="-1"><a class="header-anchor" href="#_3-2-2-\u6307\u5B9A\u5546\u54C1" aria-hidden="true">#</a> 3.2.2 \u6307\u5B9A\u5546\u54C1</h4><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114639223.png" alt="image-20220313114639223" loading="lazy"></p><h4 id="_3-2-3-\u6307\u5B9A\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-2-3-\u6307\u5B9A\u5206\u7C7B" aria-hidden="true">#</a> 3.2.3 \u6307\u5B9A\u5206\u7C7B</h4><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114713294.png" alt="image-20220313114713294" loading="lazy"></p><h3 id="_3-3-\u67E5\u770B\u4F18\u60E0\u5238" tabindex="-1"><a class="header-anchor" href="#_3-3-\u67E5\u770B\u4F18\u60E0\u5238" aria-hidden="true">#</a> 3.3 \u67E5\u770B\u4F18\u60E0\u5238</h3><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114754254.png" alt="image-20220313114754254" loading="lazy"></p><h2 id="_4-\u79FB\u52A8\u7AEF\u5C55\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-\u79FB\u52A8\u7AEF\u5C55\u73B0" aria-hidden="true">#</a> 4. \u79FB\u52A8\u7AEF\u5C55\u73B0</h2><h3 id="_4-1-\u6211\u7684\u4F18\u60E0\u5238" tabindex="-1"><a class="header-anchor" href="#_4-1-\u6211\u7684\u4F18\u60E0\u5238" aria-hidden="true">#</a> 4.1 \u6211\u7684\u4F18\u60E0\u5238</h3><h4 id="_4-1-1-\u672A\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#_4-1-1-\u672A\u4F7F\u7528" aria-hidden="true">#</a> 4.1.1 \u672A\u4F7F\u7528</h4><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114856115.png" alt="image-20220313114856115" loading="lazy"></p><h4 id="_4-1-2-\u5DF2\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#_4-1-2-\u5DF2\u4F7F\u7528" aria-hidden="true">#</a> 4.1.2 \u5DF2\u4F7F\u7528</h4><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114918514.png" alt="image-20220313114918514" loading="lazy"></p><h4 id="_4-1-3-\u5DF2\u8FC7\u671F" tabindex="-1"><a class="header-anchor" href="#_4-1-3-\u5DF2\u8FC7\u671F" aria-hidden="true">#</a> 4.1.3 \u5DF2\u8FC7\u671F</h4><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313114942582.png" alt="image-20220313114942582" loading="lazy"></p><h3 id="_4-2-\u4F18\u60E0\u5238\u8BE6\u60C5" tabindex="-1"><a class="header-anchor" href="#_4-2-\u4F18\u60E0\u5238\u8BE6\u60C5" aria-hidden="true">#</a> 4.2 \u4F18\u60E0\u5238\u8BE6\u60C5</h3><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/blogimage-master/image-20220313115009711.png" alt="image-20220313115009711" loading="lazy"></p><h2 id="_5-\u4EE3\u7801\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#_5-\u4EE3\u7801\u903B\u8F91" aria-hidden="true">#</a> 5. \u4EE3\u7801\u903B\u8F91</h2><h3 id="_5-1-\u83B7\u53D6\u5386\u53F2\u4F18\u60E0\u5238\u548C\u4F18\u60E0\u5238\u5217\u8868\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#_5-1-\u83B7\u53D6\u5386\u53F2\u4F18\u60E0\u5238\u548C\u4F18\u60E0\u5238\u5217\u8868\u533A\u522B" aria-hidden="true">#</a> 5.1 \u83B7\u53D6\u5386\u53F2\u4F18\u60E0\u5238\u548C\u4F18\u60E0\u5238\u5217\u8868\u533A\u522B</h3><p>\u83B7\u53D6\u5386\u53F2\u4F18\u60E0\u5238\u662F\u65E0\u8BBA\u662F\u5426\u5931\u6548\uFF0C\u90FD\u67E5\u8BE2</p><h4 id="_5-1-1-\u83B7\u53D6\u4F1A\u5458\u4F18\u60E0\u5238\u5386\u53F2\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#_5-1-1-\u83B7\u53D6\u4F1A\u5458\u4F18\u60E0\u5238\u5386\u53F2\u5217\u8868" aria-hidden="true">#</a> 5.1.1 \u83B7\u53D6\u4F1A\u5458\u4F18\u60E0\u5238\u5386\u53F2\u5217\u8868</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistory</span><span class="token punctuation">&gt;</span></span> <span class="token function">listHistory</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> useStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UmsMember</span> currentMember <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">getCurrentMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SmsCouponHistoryExample</span> couponHistoryExample<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SmsCouponHistoryExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SmsCouponHistoryExample<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> couponHistoryExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria<span class="token punctuation">.</span><span class="token function">andMemberIdEqualTo</span><span class="token punctuation">(</span>currentMember<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>useStatus<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            criteria<span class="token punctuation">.</span><span class="token function">andUseStatusEqualTo</span><span class="token punctuation">(</span>useStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> couponHistoryMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>couponHistoryExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-2-\u83B7\u53D6\u4F1A\u5458\u4F18\u60E0\u5238\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#_5-1-2-\u83B7\u53D6\u4F1A\u5458\u4F18\u60E0\u5238\u5217\u8868" aria-hidden="true">#</a> 5.1.2 \u83B7\u53D6\u4F1A\u5458\u4F18\u60E0\u5238\u5217\u8868</h4><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code> <span class="token keyword">SELECT</span>
          c<span class="token punctuation">.</span><span class="token operator">*</span>
        <span class="token keyword">FROM</span>
            sms_coupon_history ch
                <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> sms_coupon c <span class="token keyword">ON</span> ch<span class="token punctuation">.</span>coupon_id <span class="token operator">=</span> c<span class="token punctuation">.</span>id
        <span class="token keyword">WHERE</span> ch<span class="token punctuation">.</span>member_id <span class="token operator">=</span> <span class="token comment">#{memberId}</span>
        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;useStatus!=null and useStatus!=2&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">AND</span> ch<span class="token punctuation">.</span>use_status <span class="token operator">=</span> <span class="token comment">#{useStatus}</span>
            <span class="token operator">AND</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> c<span class="token punctuation">.</span>start_time
            <span class="token operator">AND</span> c<span class="token punctuation">.</span>end_time <span class="token operator">&gt;</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;useStatus!=null and useStatus==2&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">AND</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> c<span class="token punctuation">.</span>end_time
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-\u4FEE\u6539\u4F18\u60E0\u5238" tabindex="-1"><a class="header-anchor" href="#_5-2-\u4FEE\u6539\u4F18\u60E0\u5238" aria-hidden="true">#</a> 5.2 \u4FEE\u6539\u4F18\u60E0\u5238</h3><p>\u66F4\u65B0\u4F18\u60E0\u5238\uFF0C\u540C\u65F6\u9700\u8981\u5220\u9664\u5173\u8054\u7684\u5546\u54C1\u548C\u5206\u7C7B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">SmsCouponParam</span> couponParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        couponParam<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span>couponMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5220\u9664\u540E\u63D2\u5165\u4F18\u60E0\u5238\u548C\u5546\u54C1\u5173\u7CFB\u8868</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">.</span><span class="token function">getUseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SmsCouponProductRelation</span> productRelation<span class="token operator">:</span>couponParam<span class="token punctuation">.</span><span class="token function">getProductRelationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                productRelation<span class="token punctuation">.</span><span class="token function">setCouponId</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">deleteProductRelation</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            productRelationDao<span class="token punctuation">.</span><span class="token function">insertList</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">.</span><span class="token function">getProductRelationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u5220\u9664\u540E\u63D2\u5165\u4F18\u60E0\u5238\u548C\u5546\u54C1\u5206\u7C7B\u5173\u7CFB\u8868</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">.</span><span class="token function">getUseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SmsCouponProductCategoryRelation</span> couponProductCategoryRelation <span class="token operator">:</span> couponParam<span class="token punctuation">.</span><span class="token function">getProductCategoryRelationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                couponProductCategoryRelation<span class="token punctuation">.</span><span class="token function">setCouponId</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">deleteProductCategoryRelation</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            productCategoryRelationDao<span class="token punctuation">.</span><span class="token function">insertList</span><span class="token punctuation">(</span>couponParam<span class="token punctuation">.</span><span class="token function">getProductCategoryRelationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-\u83B7\u53D6\u5F53\u524D\u5546\u54C1\u76F8\u5173\u4F18\u60E0\u5238" tabindex="-1"><a class="header-anchor" href="#_5-3-\u83B7\u53D6\u5F53\u524D\u5546\u54C1\u76F8\u5173\u4F18\u60E0\u5238" aria-hidden="true">#</a> 5.3 \u83B7\u53D6\u5F53\u524D\u5546\u54C1\u76F8\u5173\u4F18\u60E0\u5238</h3><ol><li>\u4ECE<strong>\u4F18\u60E0\u5238\u548C\u5546\u54C1\u5173\u8054\u8868</strong>\u4E2D\u67E5\u51FA\u4F18\u60E0\u5238id</li><li>\u4ECE<strong>\u4F18\u60E0\u5238\u548C\u5206\u7C7B\u5173\u8054\u8868</strong>\u4E2D\u67E5\u51FA\u4F18\u60E0\u5238id</li><li>\u5C06\u4F18\u60E0\u5238id in \u51FA\u6765</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCoupon</span><span class="token punctuation">&gt;</span></span> <span class="token function">listByProduct</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> allCouponIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u83B7\u53D6\u6307\u5B9A\u5546\u54C1\u4F18\u60E0\u5238</span>
        <span class="token class-name">SmsCouponProductRelationExample</span> cprExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCouponProductRelationExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cprExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andProductIdEqualTo</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponProductRelation</span><span class="token punctuation">&gt;</span></span> cprList <span class="token operator">=</span> couponProductRelationMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>cprExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>cprList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> couponIds <span class="token operator">=</span> cprList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SmsCouponProductRelation</span><span class="token operator">::</span><span class="token function">getCouponId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allCouponIds<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>couponIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u83B7\u53D6\u6307\u5B9A\u5206\u7C7B\u4F18\u60E0\u5238</span>
        <span class="token class-name">PmsProduct</span> product <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SmsCouponProductCategoryRelationExample</span> cpcrExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCouponProductCategoryRelationExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cpcrExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andProductCategoryIdEqualTo</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getProductCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponProductCategoryRelation</span><span class="token punctuation">&gt;</span></span> cpcrList <span class="token operator">=</span> couponProductCategoryRelationMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>cpcrExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>cpcrList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> couponIds <span class="token operator">=</span> cpcrList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SmsCouponProductCategoryRelation</span><span class="token operator">::</span><span class="token function">getCouponId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allCouponIds<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>couponIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>allCouponIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u6240\u6709\u4F18\u60E0\u5238</span>
        <span class="token class-name">SmsCouponExample</span> couponExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCouponExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        couponExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andEndTimeGreaterThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andStartTimeLessThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andUseTypeEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        couponExample<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>couponExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andEndTimeGreaterThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andStartTimeLessThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andUseTypeNotEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andIdIn</span><span class="token punctuation">(</span>allCouponIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>couponExample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-\u751F\u6210\u786E\u8BA4\u5355\u65F6\u7684\u4F18\u60E0\u5238\u5904\u7406\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#_5-4-\u751F\u6210\u786E\u8BA4\u5355\u65F6\u7684\u4F18\u60E0\u5238\u5904\u7406\u903B\u8F91" aria-hidden="true">#</a> 5.4 \u751F\u6210\u786E\u8BA4\u5355\u65F6\u7684\u4F18\u60E0\u5238\u5904\u7406\u903B\u8F91</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u83B7\u53D6\u7528\u6237\u53EF\u7528\u4F18\u60E0\u5238\u5217\u8868</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistoryDetail</span><span class="token punctuation">&gt;</span></span> couponHistoryDetailList <span class="token operator">=</span> memberCouponService<span class="token punctuation">.</span><span class="token function">listCart</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
result<span class="token punctuation">.</span><span class="token function">setCouponHistoryDetailList</span><span class="token punctuation">(</span>couponHistoryDetailList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9488\u5BF9\u9009\u4E2D\u7684\u8D2D\u7269\u8F66\u5546\u54C1\u8BA1\u7B97</p><ol><li>\u83B7\u53D6\u6539\u7528\u6237\u7684\u6240\u6709\u4F18\u60E0\u5238</li><li>\u6839\u636E\u4F18\u60E0\u5238\u4F7F\u7528\u7C7B\u578B\u6765\u5224\u65AD\u4F18\u60E0\u5238\u662F\u5426\u53EF\u7528 <ol><li>\u5168\u573A\u901A\u7528 <ol><li>\u5224\u65AD\u622A\u6B62\u65F6\u95F4\u4F18\u60E0\u8D77\u70B9</li></ol></li><li>\u6307\u5B9A\u5206\u7C7B <ol><li>\u8BA1\u7B97\u6307\u5B9A\u5206\u7C7B\u7684\u603B\u4EF7</li><li>\u5224\u65AD\u622A\u6B62\u65F6\u95F4\u548C\u4F18\u60E0\u8D77\u70B9</li></ol></li><li>\u6307\u5B9A\u5546\u54C1 <ol><li>\u8BA1\u7B97\u6307\u5B9A\u5546\u54C1\u7684\u603B\u4EF7</li><li>\u5224\u65AD\u622A\u6B62\u65F6\u95F4\u548C\u4F18\u60E0\u8D77\u70B9</li></ol></li></ol></li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistoryDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">listCart</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartPromotionItem</span><span class="token punctuation">&gt;</span></span> cartItemList<span class="token punctuation">,</span> <span class="token class-name">Integer</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UmsMember</span> currentMember <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">getCurrentMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u83B7\u53D6\u8BE5\u7528\u6237\u6240\u6709\u4F18\u60E0\u5238</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistoryDetail</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> couponHistoryDao<span class="token punctuation">.</span><span class="token function">getDetailList</span><span class="token punctuation">(</span>currentMember<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u6839\u636E\u4F18\u60E0\u5238\u4F7F\u7528\u7C7B\u578B\u6765\u5224\u65AD\u4F18\u60E0\u5238\u662F\u5426\u53EF\u7528</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistoryDetail</span><span class="token punctuation">&gt;</span></span> enableList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistoryDetail</span><span class="token punctuation">&gt;</span></span> disableList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SmsCouponHistoryDetail</span> couponHistoryDetail <span class="token operator">:</span> allList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> useType <span class="token operator">=</span> couponHistoryDetail<span class="token punctuation">.</span><span class="token function">getCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> minPoint <span class="token operator">=</span> couponHistoryDetail<span class="token punctuation">.</span><span class="token function">getCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> endTime <span class="token operator">=</span> couponHistoryDetail<span class="token punctuation">.</span><span class="token function">getCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>useType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//0-&gt;\u5168\u573A\u901A\u7528</span>
            <span class="token comment">//\u5224\u65AD\u662F\u5426\u6EE1\u8DB3\u4F18\u60E0\u8D77\u70B9</span>
            <span class="token comment">//\u8BA1\u7B97\u8D2D\u7269\u8F66\u5546\u54C1\u7684\u603B\u4EF7</span>
            <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> <span class="token function">calcTotalAmount</span><span class="token punctuation">(</span>cartItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>totalAmount<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>minPoint<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                enableList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                disableList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>useType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//1-&gt;\u6307\u5B9A\u5206\u7C7B</span>
            <span class="token comment">//\u8BA1\u7B97\u6307\u5B9A\u5206\u7C7B\u5546\u54C1\u7684\u603B\u4EF7</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> productCategoryIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SmsCouponProductCategoryRelation</span> categoryRelation <span class="token operator">:</span> couponHistoryDetail<span class="token punctuation">.</span><span class="token function">getCategoryRelationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                productCategoryIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>categoryRelation<span class="token punctuation">.</span><span class="token function">getProductCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> <span class="token function">calcTotalAmountByproductCategoryId</span><span class="token punctuation">(</span>cartItemList<span class="token punctuation">,</span>productCategoryIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>totalAmount<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>totalAmount<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>minPoint<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                enableList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                disableList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>useType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//2-&gt;\u6307\u5B9A\u5546\u54C1</span>
            <span class="token comment">//\u8BA1\u7B97\u6307\u5B9A\u5546\u54C1\u7684\u603B\u4EF7</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> productIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SmsCouponProductRelation</span> productRelation <span class="token operator">:</span> couponHistoryDetail<span class="token punctuation">.</span><span class="token function">getProductRelationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                productIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>productRelation<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> <span class="token function">calcTotalAmountByProductId</span><span class="token punctuation">(</span>cartItemList<span class="token punctuation">,</span>productIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>totalAmount<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>totalAmount<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>minPoint<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                enableList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                disableList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> enableList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> disableList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-\u83B7\u53D6\u4F18\u60E0\u5238\u5386\u53F2\u8BE6\u60C5" tabindex="-1"><a class="header-anchor" href="#_5-5-\u83B7\u53D6\u4F18\u60E0\u5238\u5386\u53F2\u8BE6\u60C5" aria-hidden="true">#</a> 5.5 \u83B7\u53D6\u4F18\u60E0\u5238\u5386\u53F2\u8BE6\u60C5</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>couponHistoryDetailMap<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.macro.mall.portal.domain.SmsCouponHistoryDetail<span class="token punctuation">&quot;</span></span>
           <span class="token attr-name">extends</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.macro.mall.mapper.SmsCouponHistoryMapper.BaseResultMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>coupon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.macro.mall.mapper.SmsCouponMapper.BaseResultMap<span class="token punctuation">&quot;</span></span> <span class="token attr-name">columnPrefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c_<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>productRelationList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">columnPrefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cpr_<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.macro.mall.mapper.SmsCouponProductRelationMapper.BaseResultMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>categoryRelationList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">columnPrefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cpcr_<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.macro.mall.mapper.SmsCouponProductCategoryRelationMapper.BaseResultMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getDetailList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>couponHistoryDetailMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    SELECT
        ch.*,
        c.id c_id,
        c.name c_name,
        c.amount c_amount,
        c.min_point c_min_point,
        c.platform c_platform,
        c.start_time c_start_time,
        c.end_time c_end_time,
        c.note c_note,
        c.use_type c_use_type,
        c.type c_type,
        cpr.id cpr_id,cpr.product_id cpr_product_id,
        cpcr.id cpcr_id,cpcr.product_category_id cpcr_product_category_id
    FROM
        sms_coupon_history ch
        LEFT JOIN sms_coupon c ON ch.coupon_id = c.id
        LEFT JOIN sms_coupon_product_relation cpr ON cpr.coupon_id = c.id
        LEFT JOIN sms_coupon_product_category_relation cpcr ON cpcr.coupon_id = c.id
    WHERE ch.member_id = #{memberId}
    AND ch.use_status = 0
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-6-\u4E0B\u5355\u65F6\u9009\u62E9\u4F18\u60E0\u5238\u540E\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#_5-6-\u4E0B\u5355\u65F6\u9009\u62E9\u4F18\u60E0\u5238\u540E\u903B\u8F91" aria-hidden="true">#</a> 5.6 \u4E0B\u5355\u65F6\u9009\u62E9\u4F18\u60E0\u5238\u540E\u903B\u8F91</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u5224\u65AD\u4F7F\u7528\u4F7F\u7528\u4E86\u4F18\u60E0\u5238</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderParam<span class="token punctuation">.</span><span class="token function">getCouponId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u4E0D\u7528\u4F18\u60E0\u5238</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsOrderItem</span> orderItem <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setCouponAmount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u4F7F\u7528\u4F18\u60E0\u5238</span>
            <span class="token class-name">SmsCouponHistoryDetail</span> couponHistoryDetail <span class="token operator">=</span> <span class="token function">getUseCoupon</span><span class="token punctuation">(</span>cartPromotionItemList<span class="token punctuation">,</span> orderParam<span class="token punctuation">.</span><span class="token function">getCouponId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>couponHistoryDetail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Asserts</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BE5\u4F18\u60E0\u5238\u4E0D\u53EF\u7528&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//\u5BF9\u4E0B\u5355\u5546\u54C1\u7684\u4F18\u60E0\u5238\u8FDB\u884C\u5904\u7406</span>
            <span class="token function">handleCouponAmount</span><span class="token punctuation">(</span>orderItemList<span class="token punctuation">,</span> couponHistoryDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5BF9\u4F18\u60E0\u5238\u4F18\u60E0\u8FDB\u884C\u5904\u7406</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * \u5BF9\u4F18\u60E0\u5238\u4F18\u60E0\u8FDB\u884C\u5904\u7406
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderItemList</span>       order_item\u5217\u8868
     * <span class="token keyword">@param</span> <span class="token parameter">couponHistoryDetail</span> \u53EF\u7528\u4F18\u60E0\u5238\u8BE6\u60C5
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCouponAmount</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsOrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList<span class="token punctuation">,</span> <span class="token class-name">SmsCouponHistoryDetail</span> couponHistoryDetail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SmsCoupon</span> coupon <span class="token operator">=</span> couponHistoryDetail<span class="token punctuation">.</span><span class="token function">getCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getUseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5168\u573A\u901A\u7528</span>
            <span class="token function">calcPerCouponAmount</span><span class="token punctuation">(</span>orderItemList<span class="token punctuation">,</span> coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getUseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u6307\u5B9A\u5206\u7C7B</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsOrderItem</span><span class="token punctuation">&gt;</span></span> couponOrderItemList <span class="token operator">=</span> <span class="token function">getCouponOrderItemByRelation</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">,</span> orderItemList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">calcPerCouponAmount</span><span class="token punctuation">(</span>couponOrderItemList<span class="token punctuation">,</span> coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getUseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u6307\u5B9A\u5546\u54C1</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsOrderItem</span><span class="token punctuation">&gt;</span></span> couponOrderItemList <span class="token operator">=</span> <span class="token function">getCouponOrderItemByRelation</span><span class="token punctuation">(</span>couponHistoryDetail<span class="token punctuation">,</span> orderItemList<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">calcPerCouponAmount</span><span class="token punctuation">(</span>couponOrderItemList<span class="token punctuation">,</span> coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5BF9\u6BCF\u4E2A\u4E0B\u5355\u5546\u54C1\u8FDB\u884C<strong>\u4F18\u60E0\u5238\u91D1\u989D\u5206\u644A\u7684\u8BA1\u7B97</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * \u5BF9\u6BCF\u4E2A\u4E0B\u5355\u5546\u54C1\u8FDB\u884C\u4F18\u60E0\u5238\u91D1\u989D\u5206\u644A\u7684\u8BA1\u7B97
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderItemList</span> \u53EF\u7528\u4F18\u60E0\u5238\u7684\u4E0B\u5355\u5546\u54C1\u5546\u54C1
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">calcPerCouponAmount</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsOrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList<span class="token punctuation">,</span> <span class="token class-name">SmsCoupon</span> coupon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> <span class="token function">calcTotalAmount</span><span class="token punctuation">(</span>orderItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsOrderItem</span> orderItem <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//(\u5546\u54C1\u4EF7\u683C/\u53EF\u7528\u5546\u54C1\u603B\u4EF7)*\u4F18\u60E0\u5238\u9762\u989D</span>
            <span class="token class-name">BigDecimal</span> couponAmount <span class="token operator">=</span> orderItem<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setCouponAmount</span><span class="token punctuation">(</span>couponAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
     * \u8BA1\u7B97\u603B\u91D1\u989D
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> <span class="token function">calcTotalAmount</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OmsOrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OmsOrderItem</span> item <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            totalAmount <span class="token operator">=</span> totalAmount<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> totalAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-\u76F8\u5173\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_6-\u76F8\u5173\u95EE\u9898" aria-hidden="true">#</a> 6. \u76F8\u5173\u95EE\u9898</h2><h3 id="_6-1-\u4EC0\u4E48\u65F6\u5019\u9700\u8981\u83B7\u53D6\u4F18\u60E0\u5238\u76F8\u5173\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_6-1-\u4EC0\u4E48\u65F6\u5019\u9700\u8981\u83B7\u53D6\u4F18\u60E0\u5238\u76F8\u5173\u4FE1\u606F" aria-hidden="true">#</a> 6.1 \u4EC0\u4E48\u65F6\u5019\u9700\u8981\u83B7\u53D6\u4F18\u60E0\u5238\u76F8\u5173\u4FE1\u606F</h3><ol><li>\u5546\u54C1\u8BE6\u60C5\u9875\u4E2D\u7684\u9886\u53D6</li><li>\u8D2D\u7269\u8F66\u4E0B\u5355\u65F6\u9009\u62E9\u4F18\u60E0\u5238 <ol><li>\u8BA1\u7B97\u7ED3\u675F\u65F6\u95F4\u548C\u6700\u4F4E\u4F7F\u7528\u91D1\u989D</li></ol></li></ol><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>`,67),b={href:"http://www.macrozheng.com/#/database/mall_sms_02?id=%E8%90%A5%E9%94%80%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89",target:"_blank",rel:"noopener noreferrer"},g=s("\u8425\u9500\u6A21\u5757\u6570\u636E\u5E93\u8868\u89E3\u6790\uFF08\u4E8C\uFF09");function y(h,f){const a=l("ExternalLinkIcon");return o(),e("div",null,[u,n("blockquote",null,[n("p",null,[k,n("a",r,[d,t(a)]),m])]),v,n("p",null,[n("a",b,[g,t(a)])])])}const C=p(i,[["render",y],["__file","mall-coupon.html.vue"]]);export{C as default};
