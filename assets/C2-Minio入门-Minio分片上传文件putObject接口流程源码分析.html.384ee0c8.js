import { o as openBlock, c as createElementBlock, e as createStaticVNode } from "./app.46f7153a.js";
import { _ as _export_sfc } from "./plugin-vue_export-helper.21dcd24c.js";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h1 id="minio\u5165\u95E8-minio\u5206\u7247\u4E0A\u4F20\u6587\u4EF6putobject\u63A5\u53E3\u6D41\u7A0B\u6E90\u7801\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#minio\u5165\u95E8-minio\u5206\u7247\u4E0A\u4F20\u6587\u4EF6putobject\u63A5\u53E3\u6D41\u7A0B\u6E90\u7801\u5206\u6790" aria-hidden="true">#</a> Minio\u5165\u95E8-Minio\u5206\u7247\u4E0A\u4F20\u6587\u4EF6putObject\u63A5\u53E3\u6D41\u7A0B\u6E90\u7801\u5206\u6790</h1><h2 id="_1-\u524D\u8A00" tabindex="-1"><a class="header-anchor" href="#_1-\u524D\u8A00" aria-hidden="true">#</a> 1. \u524D\u8A00</h2><p>\u4E3A\u4E86\u66F4\u597D\u7684\u7406\u89E3\u548C\u4F18\u5316Minio\u6587\u4EF6\u4E0A\u4F20\uFF0C\u672C\u7BC7\u6587\u6863\u5BF9MInio\u4E2D\u4E0A\u4F20\u6587\u4EF6putObject\u63A5\u53E3\u6E90\u7801\u5206\u6790\u4EE5\u4E0B\u3002</p><p>\u57FA\u4E8EJava \u5BA2\u6237\u7AEF API</p><p>Controller\u5C42\u4E0A\u4F20\u6587\u4EF6\u63A5\u53E3\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ResponseBody</span>\n<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> bucketName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> minioTemplate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MinioTemplate\u63A5\u53E3\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>        minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>\n                <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>uuidFileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>\n                        inputStream<span class="token punctuation">,</span> inputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-\u6E90\u7801\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#_2-\u6E90\u7801\u5206\u6790" aria-hidden="true">#</a> 2. \u6E90\u7801\u5206\u6790</h2><h3 id="_2-1-\u8FDB\u5165controller\u5C42\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_2-1-\u8FDB\u5165controller\u5C42\u63A5\u53E3" aria-hidden="true">#</a> 2.1 \u8FDB\u5165Controller\u5C42\u63A5\u53E3</h3><p>\u9996\u5148\u6211\u5728\u9875\u9762\u4E0A\u4E0A\u4F20\u4E86\u4E00\u4E2A9M\u5DE6\u53F3\u7684\u6587\u4EF6\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724200722531.png" alt="image-20220724200722531"></p><p>\u6587\u4EF6\u4E0A\u4F20\uFF0C\u7ECF\u8FC7Tomcat\u670D\u52A1\u5668\u8FDB\u884C\u5904\u7406\uFF0C\u7136\u540E\u5230\u8FBE\u6211\u4EEC\u7684Controller\u5C42\u4E0A\u4F20\u6587\u4EF6\u63A5\u53E3\uFF0C\u6211\u4EEC\u4F7F\u7528\u7684\u662FMultipartFile \u5BF9\u8C61\u6765\u63A5\u53D7\u6587\u4EF6\uFF0C\u53EF\u4EE5\u770B\u5230\u5F53\u524DMultipartFile \u5BF9\u8C61\u5B58\u653E\u4E86\u6587\u4EF6\u76F8\u5173\u4FE1\u606F\uFF0C\u800C\u6B64\u65F6\u5B9E\u9645\u7684\u6587\u4EF6\u662F\u7531Tomcat\u5B58\u653E\u5728\u786C\u76D8\u4E34\u65F6\u76EE\u5F55\u7684\u3002</p><p>MultipartFile\u5B9E\u9645\u7684\u5BF9\u8C61\u662FStandardMultipartHttpServletRequest\u7684\u5B9E\u4F8B\uFF0C\u4ED6\u5305\u542B\u4E86ApplicationPart\u5BF9\u8C61\uFF0CApplicationPart\u5305\u542B\u4E86\u56FE\u7247\u4E2D\u7684\u6587\u4EF6\u4FE1\u606F\u3002 <img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724200830484.png" alt="image-20220724200830484"></p><p>\u63A5\u6536\u5230\u5BF9\u8C61\u540E\uFF0C\u8C03\u7528\u7684\u5C31\u662FMinioTemplate\uFF0C\u8FD9\u91CC\u4F20\u5165\u4E86\u5404\u79CD\u53C2\u6570\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>minioTemplate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6700\u91CD\u8981\u7684\u662F\u4F20\u5165\u4E86\u4E00\u4E2AInputStream\uFF0C\u8C03\u7528\u7684\u662FMultipartFile \u5BF9\u8C61\u7684getInputStream()\u65B9\u6CD5\u3002</p><p>getInputStream\u83B7\u53D6\u8F93\u5165\u6D41\uFF0C\u662F\u8C03\u7528ApplicationPart\u4E2D\u7684DiskFileItem\u5BF9\u8C61\u7684getInputStream()\u65B9\u6CD5\u3002\u8FD9\u4E2A\u65B9\u6CD5\u4F1A\u5C06\u4E34\u65F6\u6587\u4EF6\uFF0C\u76F4\u63A5\u8F6C\u4E3AFileInputStream\u5E76\u8FD4\u56DE\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isInMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        	<span class="token comment">// \u76F4\u63A5\u5C06\u4E34\u65F6\u6587\u4EF6\u8F6C\u4E3A\u8F93\u5165\u6D41</span>\n            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dfos<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cachedContent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span>cachedContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dfos<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cachedContent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-\u6784\u5EFA\u53C2\u6570\u5BF9\u8C61putobjectargs-\u53C2\u6570\u6821\u9A8C-\u5206\u7247" tabindex="-1"><a class="header-anchor" href="#_2-2-\u6784\u5EFA\u53C2\u6570\u5BF9\u8C61putobjectargs-\u53C2\u6570\u6821\u9A8C-\u5206\u7247" aria-hidden="true">#</a> 2.2 \u6784\u5EFA\u53C2\u6570\u5BF9\u8C61PutObjectArgs\uFF08\u53C2\u6570\u6821\u9A8C\uFF0C\u5206\u7247\uFF09</h3><p>InputStream\u83B7\u53D6\u5230\u4E86\u4EE5\u540E\uFF0C\u63A5\u7740\u5C31\u662F\u8C03\u7528MinioTemplate\u4E2D\u7684putObject\u65B9\u6CD5\u4E86\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>     minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>\n             <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>uuidFileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>\n                     inputStream<span class="token punctuation">,</span> inputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>\n                     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>putObject\u65B9\u6CD5\u5B9E\u9645\u8C03\u7528\u7684\u5C31\u662F MinioClient\u7684putObject\uFF0C\u8C03\u7528\u4E4B\u524D\u4F1A\u521B\u5EFAPutObjectArgs\u53C2\u6570\u5BF9\u8C61\uFF0C\u4F7F\u7528\u7684\u662F\u5EFA\u9020\u8005\u6A21\u5F0F\u3002</p><p>PutObjectArgs\u9996\u5148\u4F1A\u5BF9\u5B58\u50A8\u6876\u540D\u79F0\u8FDB\u884C\u6821\u9A8C\uFF0C\u6240\u4EE5\u521B\u5EFA\u5B58\u50A8\u6876\u540D\u79F0\u65F6\uFF0C\u8981\u683C\u5916\u6CE8\u610F\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">validateBucketName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    	<span class="token comment">// \u975E\u7A7A\u6821\u9A8C</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateNotNull</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;bucket name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 1. \u6821\u9A8C\u957F\u5EA6\uFF0C3-63\u4E4B\u95F4</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span> msg<span class="token punctuation">;</span>\n            <span class="token comment">// 2. \u4E0D\u80FD\u5305\u542B\u201C..\u201D</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                msg <span class="token operator">=</span> <span class="token string">&quot;bucket name cannot contain successive periods. For more information refer http://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html&quot;</span><span class="token punctuation">;</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token comment">// 3. \u6B63\u5219\u6821\u9A8C</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">&quot;^[a-z0-9][a-z0-9\\\\.\\\\-]+[a-z0-9]$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                msg <span class="token operator">=</span> <span class="token string">&quot;bucket name does not follow Amazon S3 standards. For more information refer http://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html&quot;</span><span class="token punctuation">;</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; : bucket name must be at least 3 and no more than 63 characters long&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u5BF9\u5BF9\u8C61\u540D\u79F0\u8FDB\u884C\u6821\u9A8C\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">validateObjectName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    	<span class="token comment">// 1. \u975E\u7A7A\u548CNull\u6821\u9A8C</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateNotEmptyString</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;object name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u6309\u7167\u53CD\u659C\u6760\u5206\u5272\u4E3A\u5B57\u7B26\u4E32\u6570\u7EC4</span>\n        <span class="token keyword">int</span> var3 <span class="token operator">=</span> var2<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n		<span class="token comment">//  2. \u5FAA\u73AF\u5B57\u7B26\u4E32\u6570\u7EC4\uFF0C\u6821\u9A8C\u6BCF\u4E2A\u659C\u6760\u5206\u5272\u7684\u5B57\u6BB5\u4E0D\u80FD\u662F\u201C.\u201D\u6216\u8005\u201C..\u201D</span>\n        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var4 <span class="token operator">&lt;</span> var3<span class="token punctuation">;</span> <span class="token operator">++</span>var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span> token <span class="token operator">=</span> var2<span class="token punctuation">[</span>var4<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> token<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;object name with &#39;.&#39; or &#39;..&#39; path segment is not supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\u5BF9InputStream\u8FDB\u884C\u6784\u5EFA\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">PutObjectArgs<span class="token punctuation">.</span>Builder</span> <span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> stream<span class="token punctuation">,</span> <span class="token keyword">long</span> objectSize<span class="token punctuation">,</span> <span class="token keyword">long</span> partSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>			\n        <span class="token comment">// 1. \u975E\u7A7A</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateNotNull</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token string">&quot;stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 2. \u83B7\u53D6\u5206\u7247\u6570\uFF0C5M\u5206\u5272</span>\n        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> partinfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPartInfo</span><span class="token punctuation">(</span>objectSize<span class="token punctuation">,</span> partSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">long</span> pSize <span class="token operator">=</span> partinfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// \u5206\u7247\u5927\u5C0F 5M=5242880\u5B57\u8282</span>\n        <span class="token keyword">int</span> pCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>partinfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// \u5206\u7247\u6570\uFF0C\u8FD9\u91CC\u4E0A\u4F20\u76849m\u6587\u4EF6\uFF0C\u6240\u4EE5\u6709\u4E24\u7247</span>\n        <span class="token comment">// 3. \u5C06FileInputStream=\u300BBufferedInputStream</span>\n        <span class="token class-name">BufferedInputStream</span> bis <span class="token operator">=</span> stream <span class="token keyword">instanceof</span> <span class="token class-name">BufferedInputStream</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">BufferedInputStream</span><span class="token punctuation">)</span>stream <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 4. \u5C06\u8FD9\u4E9B\u53C2\u6570\u6DFB\u52A0\u5230PutObjectArgs\u5BF9\u8C61\u4E2D</span>\n        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStream</span><span class="token punctuation">(</span>bis<span class="token punctuation">,</span> objectSize<span class="token punctuation">,</span> pSize<span class="token punctuation">,</span> pCount<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u6784\u5EFAInputStream\u65F6\uFF0C\u4F1A\u8FDB\u884C\u5206\u7247\u64CD\u4F5C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4E86\u89E3\u5230\u4E0A\u4F20\u6587\u4EF6\u5927\u5C0F\u7684\u4E00\u4E9B\u9650\u5236\uFF1A</p><ul><li>\u5206\u7247\u5927\u5C0F\u4E0D\u80FD\u5C0F\u4E8E5MB\uFF0C\u5927\u4E8E5GB</li><li>\u5BF9\u8C61\u5927\u5C0F\u4E0D\u80FD\u8D85\u8FC75TiB</li><li>partSize\u4F20\u5165-1\uFF0C\u9ED8\u8BA4\u6309\u71675MB\u8FDB\u884C\u5206\u5272</li><li>\u5206\u7247\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC710000</li></ul><p>\u5206\u7247\u89C4\u5219\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">// \u53C2\u6570\u4E3A \u6587\u4EF6\u5927\u5C0FobjectSize\u3001\u5206\u7247\u5927\u5C0FpartSize\uFF0C\u5206\u7247\u6570\u6211\u4EEC\u4F20\u5165\u7684\u662F-1\uFF0C\u8868\u793A\u4F7F\u7528\u9ED8\u8BA4\u914D\u7F6E</span>\n    <span class="token keyword">protected</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPartInfo</span><span class="token punctuation">(</span><span class="token keyword">long</span> objectSize<span class="token punctuation">,</span> <span class="token keyword">long</span> partSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    	<span class="token comment">// 1. \u6821\u9A8C\u5927\u5C0F\uFF0C\u5982\u679C\u8BBE\u7F6E\u7684\u5206\u7247\u5927\u5C0F \u5C0F\u4E8E5M\u6216\u8005\u5927\u4E8E5GB\uFF0C\u62A5\u9519\u4E0D\u652F\u6301</span>\n    	<span class="token comment">//  \u5BF9\u8C61\u5927\u5C0F\u8D85\u8FC75TiB\uFF0C\u62A5\u9519\u4E0D\u652F\u6301</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateSizes</span><span class="token punctuation">(</span>objectSize<span class="token punctuation">,</span> partSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>objectSize <span class="token operator">&lt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>partSize<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        	<span class="token comment">// 2. \u6CA1\u6709\u8BBE\u7F6E\u5206\u7247\u6570\u636E\u5927\u5C0F\uFF0C\u600E\u6309\u7167\u9ED8\u8BA4\u76845M\u8FDB\u884C\u5206\u5272</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>partSize <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">double</span> dPartSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>objectSize <span class="token operator">/</span> <span class="token number">10000.0D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                dPartSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>dPartSize <span class="token operator">/</span> <span class="token number">5242880.0D</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5242880.0D</span><span class="token punctuation">;</span>\n                partSize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dPartSize<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>partSize <span class="token operator">&gt;</span> objectSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                partSize <span class="token operator">=</span> objectSize<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">long</span> partCount <span class="token operator">=</span> partSize <span class="token operator">&gt;</span> <span class="token number">0L</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>objectSize <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>partSize<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1L</span><span class="token punctuation">;</span>\n            <span class="token comment">// 3. \u5206\u7247\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC710000</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>partCount <span class="token operator">&gt;</span> <span class="token number">10000L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;object size &quot;</span> <span class="token operator">+</span> objectSize <span class="token operator">+</span> <span class="token string">&quot; and part size &quot;</span> <span class="token operator">+</span> partSize <span class="token operator">+</span> <span class="token string">&quot; make more than &quot;</span> <span class="token operator">+</span> <span class="token number">10000</span> <span class="token operator">+</span> <span class="token string">&quot;parts for upload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            	<span class="token comment">// 4. \u8FD4\u56DE\u4E00\u4E2A\u6570\u7EC4\uFF0C\u7B2C\u4E00\u4E2A\u503C\u4E3A\u5206\u7247\u6570\u636E\u5927\u5C0F\uFF0C\u7B2C\u4E8C\u4E2A\u4E3A\u5206\u7247\u6570\u91CF</span>\n                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>partSize<span class="token punctuation">,</span> partCount<span class="token punctuation">}</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u7EC8\u6784\u5EFA\u7684PutObjectArgs\u5BF9\u8C61\u5982\u4E0B\uFF1A</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724201355357.png" alt="image-20220724201355357"></p><p>\u8BE5\u5BF9\u8C61\u5305\u542B\u4E86\u6587\u4EF6\u6D41\u3001\u5BF9\u8C61\u540D\u3001\u5206\u7247\u4FE1\u606F\u7B49\u91CD\u8981\u6570\u636E\u3002</p><h3 id="_2-3-\u8FDB\u5165minioclient-\u4E0A\u4F20\u5206\u7247\u3001\u5408\u5E76" tabindex="-1"><a class="header-anchor" href="#_2-3-\u8FDB\u5165minioclient-\u4E0A\u4F20\u5206\u7247\u3001\u5408\u5E76" aria-hidden="true">#</a> 2.3 \u8FDB\u5165MinioClient\uFF08\u4E0A\u4F20\u5206\u7247\u3001\u5408\u5E76\uFF09</h3><p>\u63A5\u7740\u8FDB\u5165\u5230MinioClient\u7684putObject\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token class-name">ObjectWriteResponse</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">PutObjectArgs</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ErrorResponseException</span><span class="token punctuation">,</span> <span class="token class-name">InsufficientDataException</span><span class="token punctuation">,</span> <span class="token class-name">InternalException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidResponseException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">ServerException</span><span class="token punctuation">,</span> <span class="token class-name">XmlParserException</span> <span class="token punctuation">{</span>\n 	<span class="token comment">// 1. \u68C0\u67E5\u53C2\u6570\u662F\u5426\u4E3ANull</span>\n     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token comment">// 2. \u6821\u9A8C\u662F\u5426\u5F00\u542F\u4E86SSE\u52A0\u5BC6\uFF0C\u5982\u679C\u5F00\u542F\u4E86SSE\uFF0C\u800C\u4E0D\u662FHttps\u8BF7\u6C42\u5219\u62A5\u9519</span>\n     args<span class="token punctuation">.</span><span class="token function">validateSse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token comment">// 3. \u6267\u884C\u4E0A\u4F20\u6587\u4EF6</span>\n     <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">objectSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">partSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">partCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u7740\u8C03\u7528\u91CD\u8F7D\u7684putObject\u65B9\u6CD5\uFF0C\u4F1A\u8FDB\u884C\u5206\u5757\u521B\u5EFA=\u300B\u5206\u5757\u4E0A\u4F20=\u300B\u5408\u5E76\u6587\u4EF6\u6D41\u7A0B\u64CD\u4F5C\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">ObjectWriteResponse</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">PutObjectBaseArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">Object</span> data<span class="token punctuation">,</span> <span class="token keyword">long</span> objectSize<span class="token punctuation">,</span> <span class="token keyword">long</span> partSize<span class="token punctuation">,</span> <span class="token keyword">int</span> partCount<span class="token punctuation">,</span> <span class="token class-name">String</span> contentType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ErrorResponseException</span><span class="token punctuation">,</span> <span class="token class-name">InsufficientDataException</span><span class="token punctuation">,</span> <span class="token class-name">InternalException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidResponseException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">ServerException</span><span class="token punctuation">,</span> <span class="token class-name">XmlParserException</span> <span class="token punctuation">{</span>\n	<span class="token comment">// 1.\u8BBE\u7F6E\u6D88\u606F\u5934</span>\n    <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newMultimap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">extraHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    headers<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">genHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 2. \u8BBE\u7F6E Content-Type</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token class-name">String</span> uploadId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token class-name">Part</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parts <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token comment">// 3. \u521B\u5EFA\u5757\u8BFB\u53D6\u5BF9\u8C61</span>\n    <span class="token class-name">PartReader</span> partReader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newPartReader</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> objectSize<span class="token punctuation">,</span> partSize<span class="token punctuation">,</span> partCount<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>partReader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;data must be RandomAccessFile or InputStream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            	<span class="token comment">// 4. \u5206\u5757\u64CD\u4F5C\uFF0C\u5E76\u8FD4\u56DE\u5757\u5BF9\u8C61</span>\n                <span class="token class-name">PartSource</span> partSource <span class="token operator">=</span> partReader<span class="token punctuation">.</span><span class="token function">getPart</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">.</span><span class="token function">isHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>partSource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                	<span class="token comment">// \u6CA1\u6709\u5206\u7247\u65F6\uFF0C\u8868\u793A\u5206\u7247\u5168\u90E8\u4E0A\u4F20\u6210\u529F\uFF0C\u6267\u884C\u5408\u5E76\u6587\u4EF6\u64CD\u4F5C\u3002</span>\n                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">completeMultipartUpload</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> parts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n				<span class="token comment">// 5. \u5982\u679C\u5BF9\u8C61\u53EA\u6709\u4E00\u5757\uFF0C\u4E5F\u5C31\u662F5MB\u4E4B\u5185\uFF0C\u6267\u884C\u4E0A\u4F20</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>partReader<span class="token punctuation">.</span><span class="token function">partCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partSource<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">extraQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n				\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                	<span class="token comment">// 6. \u6267\u884C\u5206\u5757\u4E0A\u4F20\u8BF7\u6C42\uFF0C\u8FD4\u56DEuploadId</span>\n                    <span class="token class-name">CreateMultipartUploadResponse</span> response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMultipartUpload</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">extraQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    uploadId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uploadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    parts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Part</span><span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n\n                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ssecHeaders <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">sse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span><span class="token function">sse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ServerSideEncryptionCustomerKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    ssecHeaders <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">sse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n				<span class="token comment">// 7. \u6839\u636E\u521B\u5EFA\u7684\u8BF7\u6C42\uFF0C\u6B63\u5F0F\u6267\u884C\u4E0A\u4F20\u5206\u7247\u7684\u64CD\u4F5C</span>\n                <span class="token keyword">int</span> partNumber <span class="token operator">=</span> partSource<span class="token punctuation">.</span><span class="token function">partNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">UploadPartResponse</span> response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadPart</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partSource<span class="token punctuation">,</span> partNumber<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> ssecHeaders <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Multimaps</span><span class="token punctuation">.</span><span class="token function">forMap</span><span class="token punctuation">(</span>ssecHeaders<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">String</span> etag <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">etag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                parts<span class="token punctuation">[</span>partNumber <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Part</span><span class="token punctuation">(</span>partNumber<span class="token punctuation">,</span> etag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> var18<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">abortMultipartUpload</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">throw</span> var18<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var19<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">abortMultipartUpload</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Multimap</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">throw</span> var19<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-\u521B\u5EFA\u5206\u7247" tabindex="-1"><a class="header-anchor" href="#_2-4-\u521B\u5EFA\u5206\u7247" aria-hidden="true">#</a> 2.4 \u521B\u5EFA\u5206\u7247</h3><p>putObject\u65B9\u6CD5\u9996\u5148\u4F1A\u521B\u5EFAPartReader \u5757\u8BFB\u53D6\u5BF9\u8C61\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token class-name">PartReader</span> <span class="token function">newPartReader</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">,</span> <span class="token keyword">long</span> objectSize<span class="token punctuation">,</span> <span class="token keyword">long</span> partSize<span class="token punctuation">,</span> <span class="token keyword">int</span> partCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>		\n 	<span class="token comment">// 1. \u5982\u679C\u662FRandomAccessFile\uFF08RandomAccessFile\u5141\u8BB8\u81EA\u7531\u5B9A\u4E49\u6587\u4EF6\u8BB0\u5F55\u6307\u9488\uFF0C</span>\n 	<span class="token comment">// RandomAccessFile\u53EF\u4EE5\u4E0D\u4ECE\u5F00\u59CB\u7684\u5730\u65B9\u5F00\u59CB\u8F93\u51FA\uFF0C\u56E0\u6B64RandomAccessFile\u53EF\u4EE5\u5411\u5DF2\u5B58\u5728\u7684\u6587\u4EF6\u540E\u8FFD\u52A0\u5185\u5BB9\u3002\uFF09</span>\n 	<span class="token comment">// \u521B\u5EFARandomAccessFile\u7C7B\u578B\u7684PartReader </span>\n     <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PartReader</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RandomAccessFile</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> objectSize<span class="token punctuation">,</span> partSize<span class="token punctuation">,</span> partCount<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n     	<span class="token comment">// 2. \u521B\u5EFA\u4E0D\u540C\u8F93\u5165\u6D41\u7684PartReader \u5BF9\u8C61</span>\n         <span class="token keyword">return</span> data <span class="token keyword">instanceof</span> <span class="token class-name">InputStream</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PartReader</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> objectSize<span class="token punctuation">,</span> partSize<span class="token punctuation">,</span> partCount<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span>\n <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PartReader \u5305\u542B\u4E86\u6587\u4EF6\u6570\u636E\u6D41\u53CA\u5206\u7247\u4FE1\u606F\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724201815010.png" alt="image-20220724201815010"></p><p>\u63A5\u7740\u8FDB\u5165\u4E00\u4E2A\u6B7B\u5FAA\u73AF\uFF0CPartReader \u4F1A\u83B7\u53D6PartSource\u5757\u5BF9\u8C61\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">PartSource</span> <span class="token function">getPart</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> computeSha256<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>partNumber <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>partCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        	<span class="token comment">// 1. \u83B7\u53D6\u5206\u7247\uFF0C\u4ECE\u7B2C\u4E00\u4E2A\u5F00\u59CB\u83B7\u53D6</span>\n            <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>partNumber<span class="token punctuation">;</span>\n            <span class="token class-name">MessageDigest</span> md5 <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MD5 \u52A0\u5BC6\u5BF9\u8C61</span>\n            <span class="token class-name">MessageDigest</span> sha256 <span class="token operator">=</span> computeSha256 <span class="token operator">?</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;SHA-256&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// SHA-256\u52A0\u5BC6\u5BF9\u8C61</span>\n            <span class="token keyword">long</span> partSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>partSize<span class="token punctuation">;</span> <span class="token comment">// \u5206\u7247\u5927\u5C0F 5MB</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>partNumber <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>partCount<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u5224\u65AD\u5F53\u524D\u5206\u7247\u662F\u4E0D\u662F\u6700\u540E\u4E00\u4E2A\u5206\u7247</span>\n                partSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>objectSize <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalDataRead<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n			<span class="token comment">// 2. \u4F7F\u7528\u7B97\u6CD5\u8BFB\u53D6\u5206\u5757\u6570\u636E</span>\n            <span class="token keyword">long</span> bytesRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>partSize<span class="token punctuation">,</span> md5<span class="token punctuation">,</span> sha256<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>totalDataRead <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectSize <span class="token operator">&lt;</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eof<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span>partCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>partNumber<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n			<span class="token comment">// 3. \u52A0\u5BC6</span>\n            <span class="token class-name">String</span> md5Hash <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">String</span> sha256Hash <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>computeSha256<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                sha256Hash <span class="token operator">=</span> <span class="token class-name">BaseEncoding</span><span class="token punctuation">.</span><span class="token function">base16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>sha256<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>US<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n			<span class="token comment">// 4. \u8FD4\u56DEPartSource\u5BF9\u8C61</span>\n            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PartSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>partNumber<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">,</span> bytesRead<span class="token punctuation">,</span> md5Hash<span class="token punctuation">,</span> sha256Hash<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PartSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>partNumber<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffers<span class="token punctuation">,</span> bytesRead<span class="token punctuation">,</span> md5Hash<span class="token punctuation">,</span> sha256Hash<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6BCF\u4E2APartSource\u5BF9\u8C61\uFF0C\u5C31\u5BF9\u5E94\u4E00\u4E2A\u5757\u5BF9\u8C61\uFF0C\u5176\u4E2D\u5305\u542B\u4E86\u5757\u6570\u636E\u548C\u52A0\u5BC6\u8FD4\u56DE\u7684\u7B7E\u540D\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724201918590.png" alt="image-20220724201918590"></p><h3 id="_2-5-\u521B\u5EFA\u5206\u7247\u8BF7\u6C42-\u83B7\u53D6uploadid" tabindex="-1"><a class="header-anchor" href="#_2-5-\u521B\u5EFA\u5206\u7247\u8BF7\u6C42-\u83B7\u53D6uploadid" aria-hidden="true">#</a> 2.5. \u521B\u5EFA\u5206\u7247\u8BF7\u6C42\uFF08\u83B7\u53D6uploadId\uFF09</h3><p>createMultipartUpload\u65B9\u6CD5\u4F1A\u521B\u5EFA\u5206\u5757\u8BF7\u6C42\uFF0C\u6839\u636E\u5BF9\u8C61\u540D\u548C\u5B58\u50A8\u6876\u540D\u53BBMinio\u83B7\u53D6\u4E0A\u4F20\u5F53\u524D\u5BF9\u8C61\u7684uploadId\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">CreateMultipartUploadResponse</span> <span class="token function">createMultipartUpload</span><span class="token punctuation">(</span><span class="token class-name">String</span> bucketName<span class="token punctuation">,</span> <span class="token class-name">String</span> region<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">,</span> <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers<span class="token punctuation">,</span> <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> extraQueryParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InsufficientDataException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">ServerException</span><span class="token punctuation">,</span> <span class="token class-name">XmlParserException</span><span class="token punctuation">,</span> <span class="token class-name">ErrorResponseException</span><span class="token punctuation">,</span> <span class="token class-name">InternalException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidResponseException</span> <span class="token punctuation">{</span>\n    	<span class="token comment">// \u6784\u5EFA\u8BF7\u6C42\u53C2\u6570</span>\n        <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queryParams <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newMultimap</span><span class="token punctuation">(</span>extraQueryParams<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        queryParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;uploads&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headersCopy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newMultimap</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headersCopy<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            headersCopy<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/octet-stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n		<span class="token comment">// \u6267\u884CHTTP\u8BF7\u6C42</span>\n        <span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> objectName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">,</span> region<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">httpHeaders</span><span class="token punctuation">(</span>headersCopy<span class="token punctuation">)</span><span class="token punctuation">,</span> queryParams<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Throwable</span> var9 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">CreateMultipartUploadResponse</span> var11<span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        	<span class="token comment">// \u89E3\u6790\u8FD4\u56DE\u7ED3\u679C</span>\n            <span class="token class-name">InitiateMultipartUploadResult</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InitiateMultipartUploadResult</span><span class="token punctuation">)</span><span class="token class-name">Xml</span><span class="token punctuation">.</span><span class="token function">unmarshal</span><span class="token punctuation">(</span><span class="token class-name">InitiateMultipartUploadResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">charStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            var11 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateMultipartUploadResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> region<span class="token punctuation">,</span> objectName<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uploadId\u5728\u5FAA\u73AF\u4E2D\u4F7F\u7528\u7684\u90FD\u662F\u540C\u4E00\u4E2A\uFF0C\u8BF4\u660E\u5206\u7247\u4E0A\u4F20\u7684\u65F6\u5019\u90FD\u4F1A\u4F7F\u7528\u540C\u4E00\u4E2AuploadId\uFF0C\u6700\u540E\u5408\u5E76\u540C\u4E00\u4E2AuploadId\u7684\u6587\u4EF6\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724202032288.png" alt="image-20220724202032288"></p><h3 id="_2-6-\u4E0A\u4F20\u5206\u7247" tabindex="-1"><a class="header-anchor" href="#_2-6-\u4E0A\u4F20\u5206\u7247" aria-hidden="true">#</a> 2.6 \u4E0A\u4F20\u5206\u7247</h3><p>\u83B7\u53D6\u5230\u4E86uploadId\u4EE5\u540E\uFF0C\u5C31\u4F1A\u6267\u884C\u4E0A\u4F20\u64CD\u4F5C\uFF0C\u8C03\u7528uploadPart\u65B9\u6CD5\uFF0CuploadPart\u6700\u7EC8\u4E5F\u662F\u8C03\u7528execute\uFF0C\u53EF\u4EE5\u770B\u5230\u8BE5\u65B9\u6CD5\uFF0C\u662F\u8C03\u7528\u7684OkHttpClient \u53BB\u6267\u884C\u7684\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Response</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">String</span> bucketName<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">,</span> <span class="token class-name">String</span> region<span class="token punctuation">,</span> <span class="token class-name">Headers</span> headers<span class="token punctuation">,</span> <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queryParamMap<span class="token punctuation">,</span> <span class="token class-name">Object</span> body<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">XmlParserException</span> <span class="token punctuation">{</span>\n    	<span class="token comment">//......</span>\n        <span class="token comment">// \u6784\u5EFAURL \uFF1Ahttp://127.0.0.1:9000/pearl-buckent/files/2021-10-26/d9e9d6fc-73fc-4323-b317-b8b26b6b6fe0_apache-maven-3.6.2-bin.zip?uploadId=70174335-85ec-47c6-acaf-afa12c8add48&amp;partNumber=2</span>\n        <span class="token class-name">HttpUrl</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildUrl</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> objectName<span class="token punctuation">,</span> region<span class="token punctuation">,</span> queryParamMap<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// \u7701\u7565\u6784\u5EFA\u5176\u4ED6\u5BF9\u8C61</span>\n        <span class="token comment">// \u8C03\u7528 httpClient\u6267\u884C\u4E0A\u4F20\u6587\u4EF6</span>\n        <span class="token class-name">Response</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// \u5904\u7406\u54CD\u5E94\uFF0C\u5F02\u5E38\u5904\u7406\u7B49\u3002</span>\n        <span class="token class-name">ResponseBody</span> responseBody<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           \n 					<span class="token comment">// \u7701\u7565\u5927\u91CF\u4EE3\u7801.....</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7-\u5408\u5E76\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_2-7-\u5408\u5E76\u6587\u4EF6" aria-hidden="true">#</a> 2.7 \u5408\u5E76\u6587\u4EF6</h3><p>\u5206\u7247\u7684\u6570\u636E\u90FD\u4E0A\u4F20\u540E\uFF0C\u8FDB\u5165\u5230completeMultipartUpload\u65B9\u6CD5\uFF0C\u5728\u8FD9\u4E2A\u65B9\u6CD5\u6267\u884C\u4E4B\u524D\uFF0C\u5728Minio\u63A7\u5236\u53F0\u662F\u770B\u4E0D\u5230\u4E0A\u4F20\u5BF9\u8C61\u7684\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724202212381.png" alt="image-20220724202212381"></p><p>\u8FD9\u4E2A\u65B9\u6CD5\u4F20\u5165\u4E86\u6587\u4EF6\u5BF9\u8C61\u540D\uFF0CuploadID\u7B49\uFF0C</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724202251788.png" alt="image-20220724202251788"></p><p>\u8BE5\u65B9\u6CD5\u6700\u7EC8\u4E5F\u662F\u6267\u884C\u7684execute\uFF0C\u4F7F\u7528httpclient\u53BB\u8C03\u7528\u7684Minio\u670D\u52A1\u5668\u5408\u5E76\u5206\u7247\uFF0C\u6700\u540E\u5B8C\u6210\u4E86\u5206\u7247\u4E0A\u4F20\u64CD\u4F5C\u3002\u4E4B\u540ETomcat\u56DE\u8C03\uFF0C\u5B8C\u6210\u6E05\u7406\u4E34\u65F6\u6587\u4EF6\u7B49\u64CD\u4F5C\uFF0C\u6700\u540E\u8FD4\u56DE\u4FE1\u606F\u7ED9\u524D\u7AEF\uFF0C\u4E5F\u5BF9\u5E94\u4E86\u6574\u4E2AServlet\u8BF7\u6C42\u54CD\u5E94\u7684\u6574\u4E2A\u6D41\u7A0B\u3002</p><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724202351886.png" alt="image-20220724202351886"></p><h2 id="_3-\u7B80\u5355\u6D41\u7A0B\u56FE" tabindex="-1"><a class="header-anchor" href="#_3-\u7B80\u5355\u6D41\u7A0B\u56FE" aria-hidden="true">#</a> 3. \u7B80\u5355\u6D41\u7A0B\u56FE</h2><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220724202421408.png" alt="image-20220724202421408"></p>', 67);
const _hoisted_68 = [
  _hoisted_1
];
function _sfc_render(_ctx, _cache) {
  return openBlock(), createElementBlock("div", null, _hoisted_68);
}
var C2Minio__Minio______putObject_________html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "C2-Minio\u5165\u95E8-Minio\u5206\u7247\u4E0A\u4F20\u6587\u4EF6putObject\u63A5\u53E3\u6D41\u7A0B\u6E90\u7801\u5206\u6790.html.vue"]]);
export { C2Minio__Minio______putObject_________html as default };
