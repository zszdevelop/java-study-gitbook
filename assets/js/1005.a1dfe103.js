(window.webpackJsonp=window.webpackJsonp||[]).push([[1005],{1381:function(_,v,t){"use strict";t.r(v);var a=t(26),s=Object(a.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h1",{attrs:{id:"计算大数据量-频繁操作数据库优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#计算大数据量-频繁操作数据库优化"}},[_._v("#")]),_._v(" 计算大数据量，频繁操作数据库优化")]),_._v(" "),t("h2",{attrs:{id:"_1-背景介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-背景介绍"}},[_._v("#")]),_._v(" 1. 背景介绍")]),_._v(" "),t("p",[_._v("我们有个业务场景是需要计算几万个用户的特征，这些用户特征分布在10个表中（不单单是获取某个字段，拿到记录后还需要手动计算）。")]),_._v(" "),t("p",[t("strong",[_._v("最初的版本")])]),_._v(" "),t("ol",[t("li",[_._v("循环出这几万个用户信息")]),_._v(" "),t("li",[_._v("根据用户信息到对应的10张表中查询特征值，并计算")]),_._v(" "),t("li",[_._v("将这n个特征值合并")]),_._v(" "),t("li",[_._v("保存到数据库中")])]),_._v(" "),t("p",[_._v("在数据量小的时候，该方案并没有什么问题，几分钟就完事了。但我们线上环境需要计算几万，甚至几十万的时候，时间成倍增长（我们同步3万个用户，花费了15个小时）。")]),_._v(" "),t("h2",{attrs:{id:"_2-优化方案1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-优化方案1"}},[_._v("#")]),_._v(" 2. 优化方案1")]),_._v(" "),t("p",[_._v("尝试使用线程池，将3万个数据划分成每100个用户一组添加到线程池。")]),_._v(" "),t("blockquote",[t("p",[_._v("线程池配置：核心线程20个，最大线程40个")])]),_._v(" "),t("p",[_._v("但效果并不好，我们这里的操作主要是频繁操作数据库，这一部分耗费的时间过长。")]),_._v(" "),t("blockquote",[t("p",[_._v("每个用户查询10张关联表，在保存。")]),_._v(" "),t("p",[_._v("3万个用户，实际查询就需要30万次，保存3万次")])]),_._v(" "),t("h2",{attrs:{id:"_3-优化方案2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-优化方案2"}},[_._v("#")]),_._v(" 3. 优化方案2")]),_._v(" "),t("p",[_._v("关于这种频繁操作数据库，io密集型的操作。我们的优化方式思路：")]),_._v(" "),t("ul",[t("li",[_._v("减少请求数量")]),_._v(" "),t("li",[_._v("减少请求大小")])]),_._v(" "),t("p",[_._v("关于请求数量上，我们查询一个用户的时间和查询100个用户的时间是差不多的，我们把计算放在内存中操作，最后再将这些数据组合就会快很多。")]),_._v(" "),t("p",[_._v("实现思路")]),_._v(" "),t("ol",[t("li",[_._v("将3万个用户，每100个划分为一组，添加进线程池")]),_._v(" "),t("li",[_._v("一次查询出线程中的100个用户的关联数据")]),_._v(" "),t("li",[_._v("分别计算这100个用户特征，然后将特征值放入特征map中（key 为用户id，value对应的特征值）")]),_._v(" "),t("li",[_._v("将特征集的n个map，通过用户id查询组合成新特征集")]),_._v(" "),t("li",[_._v("批量保存100个特征集")])]),_._v(" "),t("p",[_._v("优化后3万个用户同步花费时间为5分钟")])])}),[],!1,null,null,null);v.default=s.exports}}]);