import { r as resolveComponent, o as openBlock, c as createElementBlock, a as createBaseVNode, b as createVNode, e as createStaticVNode, d as createTextVNode } from "./app.7a45cd91.js";
import { _ as _export_sfc } from "./plugin-vue_export-helper.21dcd24c.js";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h1 id="scheduledthreadpoolexecutor\u8BE6\u89E3" tabindex="-1"><a class="header-anchor" href="#scheduledthreadpoolexecutor\u8BE6\u89E3" aria-hidden="true">#</a> ScheduledThreadPoolExecutor\u8BE6\u89E3</h1><h2 id="_0-\u9762\u8BD5\u9898" tabindex="-1"><a class="header-anchor" href="#_0-\u9762\u8BD5\u9898" aria-hidden="true">#</a> 0. \u9762\u8BD5\u9898</h2><ul><li><p>ScheduledThreadPoolExecutor\u8981\u89E3\u51B3\u4EC0\u4E48\u6837\u7684\u95EE\u9898?</p></li><li><p>ScheduledThreadPoolExecutor\u76F8\u6BD4ThreadPoolExecutor\u6709\u54EA\u4E9B\u7279\u6027?</p></li><li><p>ScheduledThreadPoolExecutor\u6709\u4EC0\u4E48\u6837\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u6838\u5FC3\u5185\u90E8\u7C7B\u548C\u62BD\u8C61\u7C7B?</p></li><li><p>ScheduledThreadPoolExecutor\u6709\u54EA\u4E24\u4E2A\u5173\u95ED\u7B56\u7565? \u533A\u522B\u662F\u4EC0\u4E48?</p></li><li><p>ScheduledThreadPoolExecutor\u4E2DscheduleAtFixedRate \u548C scheduleWithFixedDelay\u533A\u522B\u662F\u4EC0\u4E48?</p></li><li><p>\u4E3A\u4EC0\u4E48ThreadPoolExecutor \u7684\u8C03\u6574\u7B56\u7565\u5374\u4E0D\u9002\u7528\u4E8E ScheduledThreadPoolExecutor?</p></li><li><p>Executors \u63D0\u4F9B\u4E86\u51E0\u79CD\u65B9\u6CD5\u6765\u6784\u9020 ScheduledThreadPoolExecutor?</p></li></ul><h2 id="_1-\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#_1-\u7B80\u4ECB" aria-hidden="true">#</a> 1. \u7B80\u4ECB</h2><p>ScheduledThreadPoolExecutor\u7EE7\u627F\u81EA ThreadPoolExecutor\uFF0C\u4E3A\u4EFB\u52A1\u63D0\u4F9B\u5EF6\u8FDF\u6216\u5468\u671F\u6267\u884C\uFF0C\u5C5E\u4E8E\u7EBF\u7A0B\u6C60\u7684\u4E00\u79CD\u3002\u548C ThreadPoolExecutor \u76F8\u6BD4\uFF0C\u5B83\u8FD8\u5177\u6709\u4EE5\u4E0B\u51E0\u79CD\u7279\u6027:</p><ul><li>\u4F7F\u7528\u4E13\u95E8\u7684\u4EFB\u52A1\u7C7B\u578B\u2014ScheduledFutureTask \u6765\u6267\u884C\u5468\u671F\u4EFB\u52A1\uFF0C\u4E5F\u53EF\u4EE5\u63A5\u6536\u4E0D\u9700\u8981\u65F6\u95F4\u8C03\u5EA6\u7684\u4EFB\u52A1(\u8FD9\u4E9B\u4EFB\u52A1\u901A\u8FC7 ExecutorService \u6765\u6267\u884C)\u3002</li><li>\u4F7F\u7528\u4E13\u95E8\u7684\u5B58\u50A8\u961F\u5217\u2014DelayedWorkQueue \u6765\u5B58\u50A8\u4EFB\u52A1\uFF0CDelayedWorkQueue \u662F\u65E0\u754C\u5EF6\u8FDF\u961F\u5217DelayQueue \u7684\u4E00\u79CD\u3002\u76F8\u6BD4ThreadPoolExecutor\u4E5F\u7B80\u5316\u4E86\u6267\u884C\u673A\u5236(delayedExecute\u65B9\u6CD5\uFF0C\u540E\u9762\u5355\u72EC\u5206\u6790)\u3002</li><li>\u652F\u6301\u53EF\u9009\u7684run-after-shutdown\u53C2\u6570\uFF0C\u5728\u6C60\u88AB\u5173\u95ED(shutdown)\u4E4B\u540E\u652F\u6301\u53EF\u9009\u7684\u903B\u8F91\u6765\u51B3\u5B9A\u662F\u5426\u7EE7\u7EED\u8FD0\u884C\u5468\u671F\u6216\u5EF6\u8FDF\u4EFB\u52A1\u3002\u5E76\u4E14\u5F53\u4EFB\u52A1(\u91CD\u65B0)\u63D0\u4EA4\u64CD\u4F5C\u4E0E shutdown \u64CD\u4F5C\u91CD\u53E0\u65F6\uFF0C\u590D\u67E5\u903B\u8F91\u4E5F\u4E0D\u76F8\u540C\u3002</li></ul><h3 id="_1-1-\u5E94\u7528\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#_1-1-\u5E94\u7528\u573A\u666F" aria-hidden="true">#</a> 1.1 \u5E94\u7528\u573A\u666F</h3><p>\u5728\u5F88\u591A\u4E1A\u52A1\u573A\u666F\u4E2D\uFF0C\u6211\u4EEC\u53EF\u80FD\u9700\u8981\u5468\u671F\u6027\u7684\u8FD0\u884C\u67D0\u9879\u4EFB\u52A1\u6765\u83B7\u53D6\u7ED3\u679C\uFF0C\u6BD4\u5982\u5468\u671F\u6570\u636E\u7EDF\u8BA1\uFF0C\u5B9A\u65F6\u53D1\u9001\u6570\u636E\u7B49\u3002\u5728\u5E76\u53D1\u5305\u51FA\u73B0\u4E4B\u524D\uFF0CJava \u65E9\u57281.3\u5C31\u63D0\u4F9B\u4E86 Timer \u7C7B(\u53EA\u9700\u8981\u4E86\u89E3\uFF0C\u76EE\u524D\u5DF2\u6E10\u6E10\u88AB ScheduledThreadPoolExecutor \u4EE3\u66FF)\u6765\u9002\u5E94\u8FD9\u4E9B\u4E1A\u52A1\u573A\u666F\u3002\u968F\u7740\u4E1A\u52A1\u91CF\u7684\u4E0D\u65AD\u589E\u5927\uFF0C\u6211\u4EEC\u53EF\u80FD\u9700\u8981\u591A\u4E2A\u5DE5\u4F5C\u7EBF\u7A0B\u8FD0\u884C\u4EFB\u52A1\u6765\u5C3D\u53EF\u80FD\u7684\u589E\u52A0\u4EA7\u54C1\u6027\u80FD\uFF0C\u6216\u8005\u662F\u9700\u8981\u66F4\u9AD8\u7684\u7075\u6D3B\u6027\u6765\u63A7\u5236\u548C\u76D1\u63A7\u8FD9\u4E9B\u5468\u671F\u4E1A\u52A1\u3002\u8FD9\u4E9B\u90FD\u662F ScheduledThreadPoolExecutor \u8BDE\u751F\u7684\u5FC5\u7136\u6027</p><h2 id="_2-\u6570\u636E\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_2-\u6570\u636E\u7ED3\u6784" aria-hidden="true">#</a> 2. \u6570\u636E\u7ED3\u6784</h2><p><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220528151010977.png" alt="image-20220528151010977"></p><h3 id="_2-1-\u7EE7\u627Fthreadpoolexecutor" tabindex="-1"><a class="header-anchor" href="#_2-1-\u7EE7\u627Fthreadpoolexecutor" aria-hidden="true">#</a> 2.1 \u7EE7\u627FThreadPoolExecutor</h3><p>ScheduledThreadPoolExecutor\u7EE7\u627F\u81EA <code>ThreadPoolExecutor</code>:</p><h3 id="_2-2-\u4E24\u4E2A\u5185\u90E8\u7C7B-scheduledfuturetask-\u548C-delayedworkqueue" tabindex="-1"><a class="header-anchor" href="#_2-2-\u4E24\u4E2A\u5185\u90E8\u7C7B-scheduledfuturetask-\u548C-delayedworkqueue" aria-hidden="true">#</a> 2.2 \u4E24\u4E2A\u5185\u90E8\u7C7B <code>ScheduledFutureTask</code> \u548C <code>DelayedWorkQueue</code></h3><ul><li><code>ScheduledFutureTask</code>: \u7EE7\u627F\u4E86FutureTask\uFF0C\u8BF4\u660E\u662F\u4E00\u4E2A\u5F02\u6B65\u8FD0\u7B97\u4EFB\u52A1\uFF1B\u6700\u4E0A\u5C42\u5206\u522B\u5B9E\u73B0\u4E86Runnable\u3001Future\u3001Delayed\u63A5\u53E3\uFF0C\u8BF4\u660E\u5B83\u662F\u4E00\u4E2A\u53EF\u4EE5\u5EF6\u8FDF\u6267\u884C\u7684\u5F02\u6B65\u8FD0\u7B97\u4EFB\u52A1\u3002</li><li><code>DelayedWorkQueue</code>: \u8FD9\u662F ScheduledThreadPoolExecutor \u4E3A\u5B58\u50A8\u5468\u671F\u6216\u5EF6\u8FDF\u4EFB\u52A1\u4E13\u95E8\u5B9A\u4E49\u7684\u4E00\u4E2A\u5EF6\u8FDF\u961F\u5217\uFF0C\u7EE7\u627F\u4E86 AbstractQueue\uFF0C\u4E3A\u4E86\u5951\u5408 ThreadPoolExecutor \u4E5F\u5B9E\u73B0\u4E86 BlockingQueue \u63A5\u53E3\u3002\u5B83\u5185\u90E8\u53EA\u5141\u8BB8\u5B58\u50A8 RunnableScheduledFuture \u7C7B\u578B\u7684\u4EFB\u52A1\u3002\u4E0E DelayQueue \u7684\u4E0D\u540C\u4E4B\u5904\u5C31\u662F\u5B83\u53EA\u5141\u8BB8\u5B58\u653E RunnableScheduledFuture \u5BF9\u8C61\uFF0C\u5E76\u4E14\u81EA\u5DF1\u5B9E\u73B0\u4E86\u4E8C\u53C9\u5806(DelayQueue \u662F\u5229\u7528\u4E86 PriorityQueue \u7684\u4E8C\u53C9\u5806\u7ED3\u6784)\u3002</li></ul><h2 id="_3-\u6E90\u7801\u89E3\u6790" tabindex="-1"><a class="header-anchor" href="#_3-\u6E90\u7801\u89E3\u6790" aria-hidden="true">#</a> 3. \u6E90\u7801\u89E3\u6790</h2><blockquote><p>\u4EE5\u4E0B\u6E90\u7801\u7684\u89E3\u6790\u662F\u57FA\u4E8E\u4F60\u5DF2\u7ECF\u7406\u89E3\u4E86FutureTask\u3002</p></blockquote><h3 id="_3-1-\u5185\u90E8\u7C7Bscheduledfuturetask" tabindex="-1"><a class="header-anchor" href="#_3-1-\u5185\u90E8\u7C7Bscheduledfuturetask" aria-hidden="true">#</a> 3.1 \u5185\u90E8\u7C7BScheduledFutureTask</h3><h4 id="_3-1-1-\u5C5E\u6027" tabindex="-1"><a class="header-anchor" href="#_3-1-1-\u5C5E\u6027" aria-hidden="true">#</a> 3.1.1 \u5C5E\u6027</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u4E3A\u76F8\u540C\u5EF6\u65F6\u4EFB\u52A1\u63D0\u4F9B\u7684\u987A\u5E8F\u7F16\u53F7</span>\n<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceNumber<span class="token punctuation">;</span>\n\n<span class="token comment">//\u4EFB\u52A1\u53EF\u4EE5\u6267\u884C\u7684\u65F6\u95F4\uFF0C\u7EB3\u79D2\u7EA7</span>\n<span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>\n\n<span class="token comment">//\u91CD\u590D\u4EFB\u52A1\u7684\u6267\u884C\u5468\u671F\u65F6\u95F4\uFF0C\u7EB3\u79D2\u7EA7\u3002</span>\n<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> period<span class="token punctuation">;</span>\n\n<span class="token comment">//\u91CD\u65B0\u5165\u961F\u7684\u4EFB\u52A1</span>\n<span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> outerTask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n\n<span class="token comment">//\u5EF6\u8FDF\u961F\u5217\u7684\u7D22\u5F15\uFF0C\u4EE5\u652F\u6301\u66F4\u5FEB\u7684\u53D6\u6D88\u64CD\u4F5C</span>\n<span class="token keyword">int</span> heapIndex<span class="token punctuation">;</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>sequenceNumber</code>: \u5F53\u4E24\u4E2A\u4EFB\u52A1\u6709\u76F8\u540C\u7684\u5EF6\u8FDF\u65F6\u95F4\u65F6\uFF0C\u6309\u7167 FIFO \u7684\u987A\u5E8F\u5165\u961F\u3002sequenceNumber \u5C31\u662F\u4E3A\u76F8\u540C\u5EF6\u65F6\u4EFB\u52A1\u63D0\u4F9B\u7684\u987A\u5E8F\u7F16\u53F7\u3002</li><li><code>time</code>: \u4EFB\u52A1\u53EF\u4EE5\u6267\u884C\u65F6\u7684\u65F6\u95F4\uFF0C\u7EB3\u79D2\u7EA7\uFF0C\u901A\u8FC7triggerTime\u65B9\u6CD5\u8BA1\u7B97\u5F97\u51FA\u3002</li><li><code>period</code>: \u4EFB\u52A1\u7684\u6267\u884C\u5468\u671F\u65F6\u95F4\uFF0C\u7EB3\u79D2\u7EA7\u3002\u6B63\u6570\u8868\u793A\u56FA\u5B9A\u901F\u7387\u6267\u884C(\u4E3AscheduleAtFixedRate\u63D0\u4F9B\u670D\u52A1)\uFF0C\u8D1F\u6570\u8868\u793A\u56FA\u5B9A\u5EF6\u8FDF\u6267\u884C(\u4E3AscheduleWithFixedDelay\u63D0\u4F9B\u670D\u52A1)\uFF0C0\u8868\u793A\u4E0D\u91CD\u590D\u4EFB\u52A1\u3002</li><li><code>outerTask</code>: \u91CD\u65B0\u5165\u961F\u7684\u4EFB\u52A1\uFF0C\u901A\u8FC7reExecutePeriodic\u65B9\u6CD5\u5165\u961F\u91CD\u65B0\u6392\u5E8F\u3002</li></ul><h4 id="_3-1-2-\u6838\u5FC3\u65B9\u6CD5run" tabindex="-1"><a class="header-anchor" href="#_3-1-2-\u6838\u5FC3\u65B9\u6CD5run" aria-hidden="true">#</a> 3.1.2 \u6838\u5FC3\u65B9\u6CD5run()</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">boolean</span> periodic <span class="token operator">=</span> <span class="token function">isPeriodic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u662F\u5426\u4E3A\u5468\u671F\u4EFB\u52A1</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canRunInCurrentRunState</span><span class="token punctuation">(</span>periodic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//\u5F53\u524D\u72B6\u6001\u662F\u5426\u53EF\u4EE5\u6267\u884C</span>\n        <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>periodic<span class="token punctuation">)</span>\n        <span class="token comment">//\u4E0D\u662F\u5468\u671F\u4EFB\u52A1\uFF0C\u76F4\u63A5\u6267\u884C</span>\n        <span class="token class-name">ScheduledFutureTask</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ScheduledFutureTask</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">runAndReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">setNextRunTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u8BBE\u7F6E\u4E0B\u4E00\u6B21\u8FD0\u884C\u65F6\u95F4</span>\n        <span class="token function">reExecutePeriodic</span><span class="token punctuation">(</span>outerTask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u91CD\u6392\u5E8F\u4E00\u4E2A\u5468\u671F\u4EFB\u52A1</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF4\u660E: ScheduledFutureTask \u7684run\u65B9\u6CD5\u91CD\u5199\u4E86 FutureTask \u7684\u7248\u672C\uFF0C\u4EE5\u4FBF\u6267\u884C\u5468\u671F\u4EFB\u52A1\u65F6\u91CD\u7F6E/\u91CD\u6392\u5E8F\u4EFB\u52A1\u3002\u4EFB\u52A1\u7684\u6267\u884C\u901A\u8FC7\u7236\u7C7B FutureTask \u7684run\u5B9E\u73B0\u3002\u5185\u90E8\u6709\u4E24\u4E2A\u9488\u5BF9\u5468\u671F\u4EFB\u52A1\u7684\u65B9\u6CD5:</p><ul><li>setNextRunTime(): \u7528\u6765\u8BBE\u7F6E\u4E0B\u4E00\u6B21\u8FD0\u884C\u7684\u65F6\u95F4\uFF0C\u6E90\u7801\u5982\u4E0B:</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u8BBE\u7F6E\u4E0B\u4E00\u6B21\u6267\u884C\u4EFB\u52A1\u7684\u65F6\u95F4</span>\n<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setNextRunTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">long</span> p <span class="token operator">=</span> period<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//\u56FA\u5B9A\u901F\u7387\u6267\u884C\uFF0CscheduleAtFixedRate</span>\n        time <span class="token operator">+=</span> p<span class="token punctuation">;</span>\n    <span class="token keyword">else</span>\n        time <span class="token operator">=</span> <span class="token function">triggerTime</span><span class="token punctuation">(</span><span class="token operator">-</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//\u56FA\u5B9A\u5EF6\u8FDF\u6267\u884C\uFF0CscheduleWithFixedDelay</span>\n<span class="token punctuation">}</span>\n<span class="token comment">//\u8BA1\u7B97\u56FA\u5B9A\u5EF6\u8FDF\u4EFB\u52A1\u7684\u6267\u884C\u65F6\u95F4</span>\n<span class="token keyword">long</span> <span class="token function">triggerTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>\n        <span class="token punctuation">(</span><span class="token punctuation">(</span>delay <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> delay <span class="token operator">:</span> <span class="token function">overflowFree</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>reExecutePeriodic(): \u5468\u671F\u4EFB\u52A1\u91CD\u65B0\u5165\u961F\u7B49\u5F85\u4E0B\u4E00\u6B21\u6267\u884C\uFF0C\u6E90\u7801\u5982\u4E0B:</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u91CD\u6392\u5E8F\u4E00\u4E2A\u5468\u671F\u4EFB\u52A1</span>\n<span class="token keyword">void</span> <span class="token function">reExecutePeriodic</span><span class="token punctuation">(</span><span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canRunInCurrentRunState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//\u6C60\u5173\u95ED\u540E\u53EF\u7EE7\u7EED\u6267\u884C</span>\n        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u4EFB\u52A1\u5165\u5217</span>\n        <span class="token comment">//\u91CD\u65B0\u68C0\u67E5run-after-shutdown\u53C2\u6570\uFF0C\u5982\u679C\u4E0D\u80FD\u7EE7\u7EED\u8FD0\u884C\u5C31\u79FB\u9664\u961F\u5217\u4EFB\u52A1\uFF0C\u5E76\u53D6\u6D88\u4EFB\u52A1\u7684\u6267\u884C</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canRunInCurrentRunState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">else</span>\n            <span class="token function">ensurePrestart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u542F\u52A8\u4E00\u4E2A\u65B0\u7684\u7EBF\u7A0B\u7B49\u5F85\u4EFB\u52A1</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>reExecutePeriodic\u4E0EdelayedExecute\u7684\u6267\u884C\u7B56\u7565\u4E00\u81F4\uFF0C\u53EA\u4E0D\u8FC7reExecutePeriodic\u4E0D\u4F1A\u6267\u884C\u62D2\u7EDD\u7B56\u7565\u800C\u662F\u76F4\u63A5\u4E22\u6389\u4EFB\u52A1\u3002</p><h4 id="_3-1-3-cancel\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_3-1-3-cancel\u65B9\u6CD5" aria-hidden="true">#</a> 3.1.3 cancel\u65B9\u6CD5</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">boolean</span> cancelled <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>cancelled <span class="token operator">&amp;&amp;</span> removeOnCancel <span class="token operator">&amp;&amp;</span> heapIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> cancelled<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ScheduledFutureTask.cancel\u672C\u8D28\u4E0A\u7531\u5176\u7236\u7C7B FutureTask.cancel \u5B9E\u73B0\u3002\u53D6\u6D88\u4EFB\u52A1\u6210\u529F\u540E\u4F1A\u6839\u636EremoveOnCancel\u53C2\u6570\u51B3\u5B9A\u662F\u5426\u4ECE\u961F\u5217\u4E2D\u79FB\u9664\u6B64\u4EFB\u52A1\u3002</p><h3 id="_3-2-\u6838\u5FC3\u5C5E\u6027" tabindex="-1"><a class="header-anchor" href="#_3-2-\u6838\u5FC3\u5C5E\u6027" aria-hidden="true">#</a> 3.2 \u6838\u5FC3\u5C5E\u6027</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u5173\u95ED\u540E\u7EE7\u7EED\u6267\u884C\u5DF2\u7ECF\u5B58\u5728\u7684\u5468\u671F\u4EFB\u52A1 </span>\n<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> continueExistingPeriodicTasksAfterShutdown<span class="token punctuation">;</span>\n\n<span class="token comment">//\u5173\u95ED\u540E\u7EE7\u7EED\u6267\u884C\u5DF2\u7ECF\u5B58\u5728\u7684\u5EF6\u65F6\u4EFB\u52A1 </span>\n<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> executeExistingDelayedTasksAfterShutdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n<span class="token comment">//\u53D6\u6D88\u4EFB\u52A1\u540E\u79FB\u9664 </span>\n<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> removeOnCancel <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token comment">//\u4E3A\u76F8\u540C\u5EF6\u65F6\u7684\u4EFB\u52A1\u63D0\u4F9B\u7684\u987A\u5E8F\u7F16\u53F7\uFF0C\u4FDD\u8BC1\u4EFB\u52A1\u4E4B\u95F4\u7684FIFO\u987A\u5E8F</span>\n<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> sequencer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>continueExistingPeriodicTasksAfterShutdown</code>\u548C<code>executeExistingDelayedTasksAfterShutdown</code>\u662F ScheduledThreadPoolExecutor \u5B9A\u4E49\u7684 <code>run-after-shutdown</code> \u53C2\u6570\uFF0C\u7528\u6765\u63A7\u5236\u6C60\u5173\u95ED\u4E4B\u540E\u7684\u4EFB\u52A1\u6267\u884C\u903B\u8F91\u3002</li><li><code>removeOnCancel</code>\u7528\u6765\u63A7\u5236\u4EFB\u52A1\u53D6\u6D88\u540E\u662F\u5426\u4ECE\u961F\u5217\u4E2D\u79FB\u9664\u3002\u5F53\u4E00\u4E2A\u5DF2\u7ECF\u63D0\u4EA4\u7684\u5468\u671F\u6216\u5EF6\u8FDF\u4EFB\u52A1\u5728\u8FD0\u884C\u4E4B\u524D\u88AB\u53D6\u6D88\uFF0C\u90A3\u4E48\u5B83\u4E4B\u540E\u5C06\u4E0D\u4F1A\u8FD0\u884C\u3002\u9ED8\u8BA4\u914D\u7F6E\u4E0B\uFF0C\u8FD9\u79CD\u5DF2\u7ECF\u53D6\u6D88\u7684\u4EFB\u52A1\u5728\u5C4A\u671F\u4E4B\u524D\u4E0D\u4F1A\u88AB\u79FB\u9664\u3002 \u901A\u8FC7\u8FD9\u79CD\u673A\u5236\uFF0C\u53EF\u4EE5\u65B9\u4FBF\u68C0\u67E5\u548C\u76D1\u63A7\u7EBF\u7A0B\u6C60\u72B6\u6001\uFF0C\u4F46\u4E5F\u53EF\u80FD\u5BFC\u81F4\u5DF2\u7ECF\u53D6\u6D88\u7684\u4EFB\u52A1\u65E0\u9650\u6EDE\u7559\u3002\u4E3A\u4E86\u907F\u514D\u8FD9\u79CD\u60C5\u51B5\u7684\u53D1\u751F\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7<code>setRemoveOnCancelPolicy</code>\u65B9\u6CD5\u8BBE\u7F6E\u79FB\u9664\u7B56\u7565\uFF0C\u628A\u53C2\u6570<code>removeOnCancel</code>\u8BBE\u4E3Atrue\u53EF\u4EE5\u5728\u4EFB\u52A1\u53D6\u6D88\u540E\u7ACB\u5373\u4ECE\u961F\u5217\u4E2D\u79FB\u9664\u3002</li><li><code>sequencer</code>\u662F\u4E3A\u76F8\u540C\u5EF6\u65F6\u7684\u4EFB\u52A1\u63D0\u4F9B\u7684\u987A\u5E8F\u7F16\u53F7\uFF0C\u4FDD\u8BC1\u4EFB\u52A1\u4E4B\u95F4\u7684 FIFO \u987A\u5E8F\u3002\u4E0E ScheduledFutureTask \u5185\u90E8\u7684sequenceNumber\u53C2\u6570\u4F5C\u7528\u4E00\u81F4\u3002</li></ul><h3 id="_3-3-\u6784\u9020\u51FD\u6570" tabindex="-1"><a class="header-anchor" href="#_3-3-\u6784\u9020\u51FD\u6570" aria-hidden="true">#</a> 3.3 \u6784\u9020\u51FD\u6570</h3><p>\u9996\u5148\u770B\u4E0B\u6784\u9020\u51FD\u6570\uFF0CScheduledThreadPoolExecutor \u5185\u90E8\u6709\u56DB\u4E2A\u6784\u9020\u51FD\u6570\uFF0C\u8FD9\u91CC\u6211\u4EEC\u53EA\u770B\u8FD9\u4E2A\u6700\u5927\u6784\u9020\u7075\u6D3B\u5EA6\u7684:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>\n                                   <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>\n                                   <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NANOSECONDS<span class="token punctuation">,</span>\n          <span class="token keyword">new</span> <span class="token class-name">DelayedWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6784\u9020\u51FD\u6570\u90FD\u662F\u901A\u8FC7super\u8C03\u7528\u4E86ThreadPoolExecutor\u7684\u6784\u9020\uFF0C\u5E76\u4E14\u4F7F\u7528\u7279\u5B9A\u7B49\u5F85\u961F\u5217DelayedWorkQueue\u3002</p><h3 id="_3-4-\u6838\u5FC3\u65B9\u6CD5-schedule" tabindex="-1"><a class="header-anchor" href="#_3-4-\u6838\u5FC3\u65B9\u6CD5-schedule" aria-hidden="true">#</a> 3.4 \u6838\u5FC3\u65B9\u6CD5:Schedule</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">,</span>\n                                       <span class="token keyword">long</span> delay<span class="token punctuation">,</span>\n                                       <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>callable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> unit <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token function">decorateTask</span><span class="token punctuation">(</span>callable<span class="token punctuation">,</span>\n        <span class="token keyword">new</span> <span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>callable<span class="token punctuation">,</span> <span class="token function">triggerTime</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6784\u9020ScheduledFutureTask\u4EFB\u52A1</span>\n    <span class="token function">delayedExecute</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u4EFB\u52A1\u6267\u884C\u4E3B\u65B9\u6CD5</span>\n    <span class="token keyword">return</span> t<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF4\u660E: schedule\u4E3B\u8981\u7528\u4E8E\u6267\u884C\u4E00\u6B21\u6027(\u5EF6\u8FDF)\u4EFB\u52A1\u3002\u51FD\u6570\u6267\u884C\u903B\u8F91\u5206\u4E24\u6B65:</p><ul><li><code>\u5C01\u88C5 Callable/Runnable</code>: \u9996\u5148\u901A\u8FC7triggerTime\u8BA1\u7B97\u4EFB\u52A1\u7684\u5EF6\u8FDF\u6267\u884C\u65F6\u95F4\uFF0C\u7136\u540E\u901A\u8FC7 ScheduledFutureTask \u7684\u6784\u9020\u51FD\u6570\u628A Runnable/Callable \u4EFB\u52A1\u6784\u9020\u4E3AScheduledThreadPoolExecutor\u53EF\u4EE5\u6267\u884C\u7684\u4EFB\u52A1\u7C7B\u578B\uFF0C\u6700\u540E\u8C03\u7528decorateTask\u65B9\u6CD5\u6267\u884C\u7528\u6237\u81EA\u5B9A\u4E49\u7684\u903B\u8F91\uFF1BdecorateTask\u662F\u4E00\u4E2A\u7528\u6237\u53EF\u81EA\u5B9A\u4E49\u6269\u5C55\u7684\u65B9\u6CD5\uFF0C\u9ED8\u8BA4\u5B9E\u73B0\u4E0B\u76F4\u63A5\u8FD4\u56DE\u5C01\u88C5\u7684RunnableScheduledFuture\u4EFB\u52A1\uFF0C\u6E90\u7801\u5982\u4E0B:</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">decorateTask</span><span class="token punctuation">(</span>\n    <span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span> <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> task<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>\u6267\u884C\u4EFB\u52A1</code>: \u901A\u8FC7delayedExecute\u5B9E\u73B0\u3002\u4E0B\u9762\u6211\u4EEC\u6765\u8BE6\u7EC6\u5206\u6790\u3002</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">delayedExecute</span><span class="token punctuation">(</span><span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token function">reject</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6C60\u5DF2\u5173\u95ED\uFF0C\u6267\u884C\u62D2\u7EDD\u7B56\u7565</span>\n    <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u4EFB\u52A1\u5165\u961F</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token operator">!</span><span class="token function">canRunInCurrentRunState</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">isPeriodic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token comment">//\u5224\u65ADrun-after-shutdown\u53C2\u6570</span>\n            <span class="token function">remove</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//\u79FB\u9664\u4EFB\u52A1</span>\n            task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">else</span>\n            <span class="token function">ensurePrestart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u542F\u52A8\u4E00\u4E2A\u65B0\u7684\u7EBF\u7A0B\u7B49\u5F85\u4EFB\u52A1</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF4\u660E: delayedExecute\u662F\u6267\u884C\u4EFB\u52A1\u7684\u4E3B\u65B9\u6CD5\uFF0C\u65B9\u6CD5\u6267\u884C\u903B\u8F91\u5982\u4E0B:</p><ul><li>\u5982\u679C\u6C60\u5DF2\u5173\u95ED(ctl &gt;= SHUTDOWN)\uFF0C\u6267\u884C\u4EFB\u52A1\u62D2\u7EDD\u7B56\u7565\uFF1B</li><li>\u6C60\u6B63\u5728\u8FD0\u884C\uFF0C\u9996\u5148\u628A\u4EFB\u52A1\u5165\u961F\u6392\u5E8F\uFF1B\u7136\u540E\u91CD\u65B0\u68C0\u67E5\u6C60\u7684\u5173\u95ED\u72B6\u6001\uFF0C\u6267\u884C\u5982\u4E0B\u903B\u8F91:</li></ul><p><code>A</code>: \u5982\u679C\u6C60\u6B63\u5728\u8FD0\u884C\uFF0C\u6216\u8005 run-after-shutdown \u53C2\u6570\u503C\u4E3Atrue\uFF0C\u5219\u8C03\u7528\u7236\u7C7B\u65B9\u6CD5ensurePrestart\u542F\u52A8\u4E00\u4E2A\u65B0\u7684\u7EBF\u7A0B\u7B49\u5F85\u6267\u884C\u4EFB\u52A1\u3002ensurePrestart\u6E90\u7801\u5982\u4E0B:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">ensurePrestart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span>\n        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ensurePrestart\u662F\u7236\u7C7B ThreadPoolExecutor \u7684\u65B9\u6CD5\uFF0C\u7528\u4E8E\u542F\u52A8\u4E00\u4E2A\u65B0\u7684\u5DE5\u4F5C\u7EBF\u7A0B\u7B49\u5F85\u6267\u884C\u4EFB\u52A1\uFF0C\u5373\u4F7FcorePoolSize\u4E3A0\u4E5F\u4F1A\u5B89\u6392\u4E00\u4E2A\u65B0\u7EBF\u7A0B\u3002</p><p><code>B</code>: \u5982\u679C\u6C60\u5DF2\u7ECF\u5173\u95ED\uFF0C\u5E76\u4E14 run-after-shutdown \u53C2\u6570\u503C\u4E3Afalse\uFF0C\u5219\u6267\u884C\u7236\u7C7B(ThreadPoolExecutor)\u65B9\u6CD5remove\u79FB\u9664\u961F\u5217\u4E2D\u7684\u6307\u5B9A\u4EFB\u52A1\uFF0C\u6210\u529F\u79FB\u9664\u540E\u8C03\u7528ScheduledFutureTask.cancel\u53D6\u6D88\u4EFB\u52A1</p><h3 id="_3-5-\u6838\u5FC3\u65B9\u6CD5-scheduleatfixedrate-\u548C-schedulewithfixeddelay" tabindex="-1"><a class="header-anchor" href="#_3-5-\u6838\u5FC3\u65B9\u6CD5-scheduleatfixedrate-\u548C-schedulewithfixeddelay" aria-hidden="true">#</a> 3.5 \u6838\u5FC3\u65B9\u6CD5:scheduleAtFixedRate \u548C scheduleWithFixedDelay</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * \u521B\u5EFA\u4E00\u4E2A\u5468\u671F\u6267\u884C\u7684\u4EFB\u52A1\uFF0C\u7B2C\u4E00\u6B21\u6267\u884C\u5EF6\u671F\u65F6\u95F4\u4E3AinitialDelay\uFF0C\n * \u4E4B\u540E\u6BCF\u9694period\u6267\u884C\u4E00\u6B21\uFF0C\u4E0D\u7B49\u5F85\u7B2C\u4E00\u6B21\u6267\u884C\u5B8C\u6210\u5C31\u5F00\u59CB\u8BA1\u65F6\n */</span>\n<span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>\n                                              <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span>\n                                              <span class="token keyword">long</span> period<span class="token punctuation">,</span>\n                                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> unit <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>period <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">//\u6784\u5EFARunnableScheduledFuture\u4EFB\u52A1\u7C7B\u578B</span>\n    <span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> sft <span class="token operator">=</span>\n        <span class="token keyword">new</span> <span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>command<span class="token punctuation">,</span>\n                                      <span class="token keyword">null</span><span class="token punctuation">,</span>\n                                      <span class="token function">triggerTime</span><span class="token punctuation">(</span>initialDelay<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//\u8BA1\u7B97\u4EFB\u52A1\u7684\u5EF6\u8FDF\u65F6\u95F4</span>\n                                      unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u8BA1\u7B97\u4EFB\u52A1\u7684\u6267\u884C\u5468\u671F</span>\n    <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token function">decorateTask</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> sft<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6267\u884C\u7528\u6237\u81EA\u5B9A\u4E49\u903B\u8F91</span>\n    sft<span class="token punctuation">.</span>outerTask <span class="token operator">=</span> t<span class="token punctuation">;</span><span class="token comment">//\u8D4B\u503C\u7ED9outerTask\uFF0C\u51C6\u5907\u91CD\u65B0\u5165\u961F\u7B49\u5F85\u4E0B\u4E00\u6B21\u6267\u884C</span>\n    <span class="token function">delayedExecute</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6267\u884C\u4EFB\u52A1</span>\n    <span class="token keyword">return</span> t<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token doc-comment comment">/**\n * \u521B\u5EFA\u4E00\u4E2A\u5468\u671F\u6267\u884C\u7684\u4EFB\u52A1\uFF0C\u7B2C\u4E00\u6B21\u6267\u884C\u5EF6\u671F\u65F6\u95F4\u4E3AinitialDelay\uFF0C\n * \u5728\u7B2C\u4E00\u6B21\u6267\u884C\u5B8C\u4E4B\u540E\u5EF6\u8FDFdelay\u540E\u5F00\u59CB\u4E0B\u4E00\u6B21\u6267\u884C\n */</span>\n<span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>\n                                                 <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span>\n                                                 <span class="token keyword">long</span> delay<span class="token punctuation">,</span>\n                                                 <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> unit <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">//\u6784\u5EFARunnableScheduledFuture\u4EFB\u52A1\u7C7B\u578B</span>\n    <span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> sft <span class="token operator">=</span>\n        <span class="token keyword">new</span> <span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>command<span class="token punctuation">,</span>\n                                      <span class="token keyword">null</span><span class="token punctuation">,</span>\n                                      <span class="token function">triggerTime</span><span class="token punctuation">(</span>initialDelay<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//\u8BA1\u7B97\u4EFB\u52A1\u7684\u5EF6\u8FDF\u65F6\u95F4</span>\n                                      unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span><span class="token operator">-</span>delay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u8BA1\u7B97\u4EFB\u52A1\u7684\u6267\u884C\u5468\u671F</span>\n    <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token function">decorateTask</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> sft<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6267\u884C\u7528\u6237\u81EA\u5B9A\u4E49\u903B\u8F91</span>\n    sft<span class="token punctuation">.</span>outerTask <span class="token operator">=</span> t<span class="token punctuation">;</span><span class="token comment">//\u8D4B\u503C\u7ED9outerTask\uFF0C\u51C6\u5907\u91CD\u65B0\u5165\u961F\u7B49\u5F85\u4E0B\u4E00\u6B21\u6267\u884C</span>\n    <span class="token function">delayedExecute</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6267\u884C\u4EFB\u52A1</span>\n    <span class="token keyword">return</span> t<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF4\u660E: scheduleAtFixedRate\u548CscheduleWithFixedDelay\u65B9\u6CD5\u7684\u903B\u8F91\u4E0Eschedule\u7C7B\u4F3C\u3002</p><p><strong>\u6CE8\u610FscheduleAtFixedRate\u548CscheduleWithFixedDelay\u7684\u533A\u522B</strong>: \u4E4D\u4E00\u770B\u4E24\u4E2A\u65B9\u6CD5\u4E00\u6A21\u4E00\u6837\uFF0C\u5176\u5B9E\uFF0C\u5728unit.toNanos\u8FD9\u4E00\u884C\u4EE3\u7801\u4E2D\u8FD8\u662F\u6709\u533A\u522B\u7684\u3002\u6CA1\u9519\uFF0CscheduleAtFixedRate\u4F20\u7684\u662F\u6B63\u503C\uFF0C\u800CscheduleWithFixedDelay\u4F20\u7684\u5219\u662F\u8D1F\u503C\uFF0C\u8FD9\u4E2A\u503C\u5C31\u662F ScheduledFutureTask \u7684period\u5C5E\u6027\u3002</p><h3 id="_3-6-\u6838\u5FC3\u65B9\u6CD5-shutdown" tabindex="-1"><a class="header-anchor" href="#_3-6-\u6838\u5FC3\u65B9\u6CD5-shutdown" aria-hidden="true">#</a> 3.6 \u6838\u5FC3\u65B9\u6CD5:shutdown()</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">//\u53D6\u6D88\u5E76\u6E05\u9664\u7531\u4E8E\u5173\u95ED\u7B56\u7565\u4E0D\u5E94\u8BE5\u8FD0\u884C\u7684\u6240\u6709\u4EFB\u52A1</span>\n<span class="token annotation punctuation">@Override</span> <span class="token keyword">void</span> <span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">//\u83B7\u53D6run-after-shutdown\u53C2\u6570</span>\n    <span class="token keyword">boolean</span> keepDelayed <span class="token operator">=</span>\n        <span class="token function">getExecuteExistingDelayedTasksAfterShutdownPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">boolean</span> keepPeriodic <span class="token operator">=</span>\n        <span class="token function">getContinueExistingPeriodicTasksAfterShutdownPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keepDelayed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>keepPeriodic<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//\u6C60\u5173\u95ED\u540E\u4E0D\u4FDD\u7559\u4EFB\u52A1</span>\n        <span class="token comment">//\u4F9D\u6B21\u53D6\u6D88\u4EFB\u52A1</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> e <span class="token operator">:</span> q<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>\n                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        q<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6E05\u9664\u7B49\u5F85\u961F\u5217</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//\u6C60\u5173\u95ED\u540E\u4FDD\u7559\u4EFB\u52A1</span>\n        <span class="token comment">// Traverse snapshot to avoid iterator exceptions</span>\n        <span class="token comment">//\u904D\u5386\u5FEB\u7167\u4EE5\u907F\u514D\u8FED\u4EE3\u5668\u5F02\u5E38</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> e <span class="token operator">:</span> q<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">RunnableScheduledFuture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span>\n                    <span class="token punctuation">(</span><span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>e<span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isPeriodic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">!</span>keepPeriodic <span class="token operator">:</span> <span class="token operator">!</span>keepDelayed<span class="token punctuation">)</span> <span class="token operator">||</span>\n                    t<span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// also remove if already cancelled</span>\n                    <span class="token comment">//\u5982\u679C\u4EFB\u52A1\u5DF2\u7ECF\u53D6\u6D88\uFF0C\u79FB\u9664\u961F\u5217\u4E2D\u7684\u4EFB\u52A1</span>\n                    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>\n                        t<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u7EC8\u6B62\u7EBF\u7A0B\u6C60</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF4\u660E: \u6C60\u5173\u95ED\u65B9\u6CD5\u8C03\u7528\u4E86\u7236\u7C7BThreadPoolExecutor\u7684shutdown\uFF0C\u5177\u4F53\u5206\u6790\u89C1 ThreadPoolExecutor \u7BC7\u3002\u8FD9\u91CC\u4E3B\u8981\u4ECB\u7ECD\u4EE5\u4E0B\u5728shutdown\u65B9\u6CD5\u4E2D\u8C03\u7528\u7684\u5173\u95ED\u94A9\u5B50onShutdown\u65B9\u6CD5\uFF0C\u5B83\u7684\u4E3B\u8981\u4F5C\u7528\u662F\u5728\u5173\u95ED\u7EBF\u7A0B\u6C60\u540E\u53D6\u6D88\u5E76\u6E05\u9664\u7531\u4E8E\u5173\u95ED\u7B56\u7565\u4E0D\u5E94\u8BE5\u8FD0\u884C\u7684\u6240\u6709\u4EFB\u52A1\uFF0C\u8FD9\u91CC\u4E3B\u8981\u662F\u6839\u636E run-after-shutdown \u53C2\u6570(continueExistingPeriodicTasksAfterShutdown\u548CexecuteExistingDelayedTasksAfterShutdown)\u6765\u51B3\u5B9A\u7EBF\u7A0B\u6C60\u5173\u95ED\u540E\u662F\u5426\u5173\u95ED\u5DF2\u7ECF\u5B58\u5728\u7684\u4EFB\u52A1\u3002</p><h2 id="_4-\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_4-\u95EE\u9898" aria-hidden="true">#</a> 4. \u95EE\u9898</h2><h3 id="_4-1-\u4E3A\u4EC0\u4E48threadpoolexecutor-\u7684\u8C03\u6574\u7B56\u7565\u5374\u4E0D\u9002\u7528\u4E8E-scheduledthreadpoolexecutor" tabindex="-1"><a class="header-anchor" href="#_4-1-\u4E3A\u4EC0\u4E48threadpoolexecutor-\u7684\u8C03\u6574\u7B56\u7565\u5374\u4E0D\u9002\u7528\u4E8E-scheduledthreadpoolexecutor" aria-hidden="true">#</a> 4.1 <strong>\u4E3A\u4EC0\u4E48ThreadPoolExecutor \u7684\u8C03\u6574\u7B56\u7565\u5374\u4E0D\u9002\u7528\u4E8E ScheduledThreadPoolExecutor\uFF1F</strong></h3><p>\u4F8B\u5982: \u7531\u4E8E ScheduledThreadPoolExecutor \u662F\u4E00\u4E2A\u56FA\u5B9A\u6838\u5FC3\u7EBF\u7A0B\u6570\u5927\u5C0F\u7684\u7EBF\u7A0B\u6C60\uFF0C\u5E76\u4E14\u4F7F\u7528\u4E86\u4E00\u4E2A\u65E0\u754C\u961F\u5217\uFF0C\u6240\u4EE5\u8C03\u6574maximumPoolSize\u5BF9\u5176\u6CA1\u6709\u4EFB\u4F55\u5F71\u54CD(\u6240\u4EE5 ScheduledThreadPoolExecutor \u6CA1\u6709\u63D0\u4F9B\u53EF\u4EE5\u8C03\u6574\u6700\u5927\u7EBF\u7A0B\u6570\u7684\u6784\u9020\u51FD\u6570\uFF0C\u9ED8\u8BA4\u6700\u5927\u7EBF\u7A0B\u6570\u56FA\u5B9A\u4E3AInteger.MAX_VALUE)\u3002\u6B64\u5916\uFF0C\u8BBE\u7F6EcorePoolSize\u4E3A0\u6216\u8005\u8BBE\u7F6E\u6838\u5FC3\u7EBF\u7A0B\u7A7A\u95F2\u540E\u6E05\u9664(allowCoreThreadTimeOut)\u540C\u6837\u4E5F\u4E0D\u662F\u4E00\u4E2A\u597D\u7684\u7B56\u7565\uFF0C\u56E0\u4E3A\u4E00\u65E6\u5468\u671F\u4EFB\u52A1\u5230\u8FBE\u67D0\u4E00\u6B21\u8FD0\u884C\u5468\u671F\u65F6\uFF0C\u53EF\u80FD\u5BFC\u81F4\u7EBF\u7A0B\u6C60\u5185\u6CA1\u6709\u7EBF\u7A0B\u53BB\u5904\u7406\u8FD9\u4E9B\u4EFB\u52A1\u3002</p><h3 id="_4-2-executors-\u63D0\u4F9B\u4E86\u54EA\u51E0\u79CD\u65B9\u6CD5\u6765\u6784\u9020-scheduledthreadpoolexecutor" tabindex="-1"><a class="header-anchor" href="#_4-2-executors-\u63D0\u4F9B\u4E86\u54EA\u51E0\u79CD\u65B9\u6CD5\u6765\u6784\u9020-scheduledthreadpoolexecutor" aria-hidden="true">#</a> 4.2 Executors \u63D0\u4F9B\u4E86\u54EA\u51E0\u79CD\u65B9\u6CD5\u6765\u6784\u9020 ScheduledThreadPoolExecutor\uFF1F</h3><ul><li>newScheduledThreadPool: \u53EF\u6307\u5B9A\u6838\u5FC3\u7EBF\u7A0B\u6570\u7684\u7EBF\u7A0B\u6C60\u3002</li><li>newSingleThreadScheduledExecutor: \u53EA\u6709\u4E00\u4E2A\u5DE5\u4F5C\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60\u3002\u5982\u679C\u5185\u90E8\u5DE5\u4F5C\u7EBF\u7A0B\u7531\u4E8E\u6267\u884C\u5468\u671F\u4EFB\u52A1\u5F02\u5E38\u800C\u88AB\u7EC8\u6B62\uFF0C\u5219\u4F1A\u65B0\u5EFA\u4E00\u4E2A\u7EBF\u7A0B\u66FF\u4EE3\u5B83\u7684\u4F4D\u7F6E\u3002</li></ul><p>\u6CE8\u610F: newScheduledThreadPool(1, threadFactory) \u4E0D\u7B49\u4EF7\u4E8EnewSingleThreadScheduledExecutor\u3002newSingleThreadScheduledExecutor\u521B\u5EFA\u7684\u7EBF\u7A0B\u6C60\u4FDD\u8BC1\u5185\u90E8\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u6267\u884C\u4EFB\u52A1\uFF0C\u5E76\u4E14\u7EBF\u7A0B\u6570\u4E0D\u53EF\u6269\u5C55\uFF1B\u800C\u901A\u8FC7newScheduledThreadPool(1, threadFactory)\u521B\u5EFA\u7684\u7EBF\u7A0B\u6C60\u53EF\u4EE5\u901A\u8FC7setCorePoolSize\u65B9\u6CD5\u6765\u4FEE\u6539\u6838\u5FC3\u7EBF\u7A0B\u6570\u3002</p><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>', 65);
const _hoisted_66 = {
  href: "https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ScheduledThreadPoolExecutor.html",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_67 = /* @__PURE__ */ createTextVNode("JUC\u7EBF\u7A0B\u6C60: ScheduledThreadPoolExecutor\u8BE6\u89E3");
function _sfc_render(_ctx, _cache) {
  const _component_ExternalLinkIcon = resolveComponent("ExternalLinkIcon");
  return openBlock(), createElementBlock("div", null, [
    _hoisted_1,
    createBaseVNode("p", null, [
      createBaseVNode("a", _hoisted_66, [
        _hoisted_67,
        createVNode(_component_ExternalLinkIcon)
      ])
    ])
  ]);
}
var ScheduledThreadPoolExecutor___html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "ScheduledThreadPoolExecutor\u8BE6\u89E3.html.vue"]]);
export { ScheduledThreadPoolExecutor___html as default };
