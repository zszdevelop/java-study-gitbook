import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";import{o as p,c,a as n,b as a,e as o,d as t,r as i}from"./app.f1a1a4ee.js";const l={},u=o(`<h1 id="\u591A\u6570\u636E\u6E90\u7684\u652F\u6301" tabindex="-1"><a class="header-anchor" href="#\u591A\u6570\u636E\u6E90\u7684\u652F\u6301" aria-hidden="true">#</a> \u591A\u6570\u636E\u6E90\u7684\u652F\u6301</h1><h2 id="_1-\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#_1-\u7B80\u4ECB" aria-hidden="true">#</a> 1. \u7B80\u4ECB</h2><p>\u5728\u5B9E\u9645\u5F00\u53D1\u4E2D\uFF0C\u7ECF\u5E38\u53EF\u80FD\u9047\u5230\u5728\u4E00\u4E2A\u5E94\u7528\u4E2D\u53EF\u80FD\u9700\u8981\u8BBF\u95EE\u591A\u4E2A\u6570\u636E\u5E93\u7684\u60C5\u51B5\uFF0C\u90A3\u4E48\u6211\u4EEC\u5982\u4F55\u5B9E\u73B0\u8BBF\u95EE\u4E0D\u540C\u63A5\u53E3\u65F6\uFF0C\u6307\u5411\u4E0D\u540C\u7684\u6570\u636E\u5E93\u5462\u3002</p><h2 id="_2-\u5B9E\u73B0\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_2-\u5B9E\u73B0\u601D\u8DEF" aria-hidden="true">#</a> 2. \u5B9E\u73B0\u601D\u8DEF</h2><h3 id="_2-1-\u5982\u4F55\u4FB5\u5165\u6027\u6700\u5C0F\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_2-1-\u5982\u4F55\u4FB5\u5165\u6027\u6700\u5C0F\u5B9E\u73B0" aria-hidden="true">#</a> 2.1 \u5982\u4F55\u4FB5\u5165\u6027\u6700\u5C0F\u5B9E\u73B0\uFF1F</h3><p>\u6211\u4EEC\u9700\u8981\u6839\u636E\u4E0D\u540C\u7684\u63A5\u53E3\u8BBF\u95EE\u4E0D\u540C\u7684\u6570\u636E\u6E90\u3002\u5BF9\u4EE3\u7801\u4FB5\u5165\u6700\u5C0F\u7684\u80AF\u5B9A\u662F\u5B9A\u4E49\u6CE8\u89E3</p><h3 id="_2-2-\u652F\u6301\u4F18\u5148\u7EA7" tabindex="-1"><a class="header-anchor" href="#_2-2-\u652F\u6301\u4F18\u5148\u7EA7" aria-hidden="true">#</a> 2.2 \u652F\u6301\u4F18\u5148\u7EA7</h3><p>\u5E0C\u671B\u80FD\u540C\u65F6\u76F4\u63A5\u7C7B\u548C\u65B9\u6CD5\u4E0A\u4F7F\u7528\u8BE5\u6CE8\u89E3\uFF0C\u5148\u65B9\u6CD5\uFF0C\u540E\u7C7B\uFF0C\u5982\u679C\u65B9\u6CD5\u8986\u76D6\u4E86\u7C7B\u4E0A\u7684\u6570\u636E\u6E90\u7C7B\u578B\uFF0C\u4EE5\u65B9\u6CD5\u7684\u4E3A\u51C6\uFF0C\u5426\u5219\u4EE5\u7C7B\u4E0A\u7684\u4E3A\u51C6\u3002</p><p>\u5B9E\u73B0\u601D\u8DEF\u5148\u67E5\u65B9\u6CD5\uFF0C\u518D\u67E5\u7C7B\u5C31\u53EF\u4EE5\u4E86</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u83B7\u53D6\u9700\u8981\u5207\u6362\u7684\u6570\u636E\u6E90
 */</span>
<span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">MethodSignature</span> signature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> point<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>signature<span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-\u5207\u6362\u6570\u636E\u6E90\u540E-\u8981\u518D\u5207\u56DE\u9ED8\u8BA4\u7684" tabindex="-1"><a class="header-anchor" href="#_2-3-\u5207\u6362\u6570\u636E\u6E90\u540E-\u8981\u518D\u5207\u56DE\u9ED8\u8BA4\u7684" aria-hidden="true">#</a> 2.3 \u5207\u6362\u6570\u636E\u6E90\u540E\uFF0C\u8981\u518D\u5207\u56DE\u9ED8\u8BA4\u7684</h3><p>\u5982\u679C\u5207\u6362\u4E86\u6570\u636E\u6E90\uFF0C\u90A3\u4E48\u4E0B\u4E00\u6B21\u7684\u6570\u636E\u6E90\u5E94\u8BE5\u8FD8\u8981\u662F\u9ED8\u8BA4\u7684</p><ul><li>\u6267\u884C\u524D\u8BBE\u7F6E\u52A8\u6001\u6570\u636E\u6E90</li><li>\u6267\u884C\u540E\u6E05\u9664</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">setDataSourceType</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> point<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">finally</span>
<span class="token punctuation">{</span>
    <span class="token comment">// \u9500\u6BC1\u6570\u636E\u6E90 \u5728\u6267\u884C\u65B9\u6CD5\u4E4B\u540E</span>
    <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">clearDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-\u5982\u4F55\u5207\u6362\u6570\u636E\u6E90" tabindex="-1"><a class="header-anchor" href="#_2-4-\u5982\u4F55\u5207\u6362\u6570\u636E\u6E90" aria-hidden="true">#</a> 2.4 \u5982\u4F55\u5207\u6362\u6570\u636E\u6E90</h3><p>Spring boot\u63D0\u4F9B\u4E86AbstractRoutingDataSource \u6839\u636E\u7528\u6237\u5B9A\u4E49\u7684\u89C4\u5219\u9009\u62E9\u5F53\u524D\u7684\u6570\u636E\u6E90\u3002\u6211\u4EEC\u53EF\u4EE5\u501F\u52A9\u4ED6\u5B9E\u73B0</p><h3 id="_2-5-\u5207\u6362\u540E\u5982\u4F55\u4E0D\u5F71\u54CD\u5176\u4ED6\u7A0B\u5E8F" tabindex="-1"><a class="header-anchor" href="#_2-5-\u5207\u6362\u540E\u5982\u4F55\u4E0D\u5F71\u54CD\u5176\u4ED6\u7A0B\u5E8F" aria-hidden="true">#</a> 2.5 \u5207\u6362\u540E\u5982\u4F55\u4E0D\u5F71\u54CD\u5176\u4ED6\u7A0B\u5E8F</h3><p>\u4F7F\u7528ThreadLocal\u7EF4\u62A4\u53D8\u91CF\uFF0CThreadLocal\u4E3A\u6BCF\u4E2A\u4F7F\u7528\u8BE5\u53D8\u91CF\u7684\u7EBF\u7A0B\u63D0\u4F9B\u72EC\u7ACB\u7684\u53D8\u91CF\u526F\u672C\uFF0C\u6240\u4EE5\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u72EC\u7ACB\u5730\u6539\u53D8\u81EA\u5DF1\u7684\u526F\u672C\uFF0C\u800C\u4E0D\u4F1A\u5F71\u54CD\u5176\u5B83\u7EBF\u7A0B\u6240\u5BF9\u5E94\u7684\u526F\u672C\u3002</p><h2 id="_3-\u591A\u6570\u636E\u6E90\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#_3-\u591A\u6570\u636E\u6E90\u4F7F\u7528" aria-hidden="true">#</a> 3. \u591A\u6570\u636E\u6E90\u4F7F\u7528</h2><ol><li><p>\u5728<code>application-druid.yml</code>\u914D\u7F6E\u4ECE\u5E93\u6570\u636E\u6E90</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code># \u4ECE\u5E93\u6570\u636E\u6E90
slave<span class="token operator">:</span>
  # \u4ECE\u6570\u636E\u6E90\u5F00\u5173<span class="token operator">/</span>\u9ED8\u8BA4\u5173\u95ED
  enabled<span class="token operator">:</span> <span class="token boolean">true</span>
  url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>test<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>zeroDateTimeBehavior<span class="token operator">=</span>convertToNull<span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span>GMT<span class="token operator">%</span><span class="token number">2</span>B8
  username<span class="token operator">:</span> root
  password<span class="token operator">:</span> password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>\u5728<code>DataSourceType</code>\u7C7B\u6DFB\u52A0\u6570\u636E\u6E90\u679A\u4E3E</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u4ECE\u5E93
 */</span>
SLAVE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>\u5728<code>DruidConfig</code>\u914D\u7F6E\u8BFB\u53D6\u6570\u636E\u6E90</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">&quot;spring.datasource.druid.slave&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.druid.slave&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">slaveDataSource</span><span class="token punctuation">(</span><span class="token class-name">DruidProperties</span> druidProperties<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">DruidDataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">DruidDataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> druidProperties<span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>\u5728<code>DruidConfig</code>\u7C7B<code>dataSource</code>\u65B9\u6CD5\u6DFB\u52A0\u6570\u636E\u6E90</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token function">setDataSource</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">,</span> <span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>SLAVE<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;slaveDataSource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>\u5728\u9700\u8981\u4F7F\u7528\u591A\u6570\u636E\u6E90\u65B9\u6CD5\u6216\u7C7B\u4E0A\u6DFB\u52A0<code>@DataSource</code>\u6CE8\u89E3\uFF0C\u5176\u4E2D<code>value</code>\u7528\u6765\u8868\u793A\u6570\u636E\u6E90</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataSource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>SLAVE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectUserList</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectUserList</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@DataSource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>SLAVE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserServiceImpl</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="_4-\u624B\u52A8\u5207\u6362\u6570\u636E\u6E90" tabindex="-1"><a class="header-anchor" href="#_4-\u624B\u52A8\u5207\u6362\u6570\u636E\u6E90" aria-hidden="true">#</a> 4. \u624B\u52A8\u5207\u6362\u6570\u636E\u6E90</h2><p>\u5728\u9700\u8981\u5207\u6362\u6570\u636E\u6E90\u7684\u65B9\u6CD5\u4E2D\u4F7F\u7528<code>DynamicDataSourceContextHolder</code>\u7C7B\u5B9E\u73B0\u624B\u52A8\u5207\u6362\uFF0C\u4F7F\u7528\u65B9\u6CD5\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectUserList</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">setDataSourceType</span><span class="token punctuation">(</span><span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>SLAVE<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectUserList</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">clearDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> userList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-\u5177\u4F53\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_5-\u5177\u4F53\u5B9E\u73B0" aria-hidden="true">#</a> 5. \u5177\u4F53\u5B9E\u73B0</h2><h3 id="_5-1-\u5B9A\u4E49\u6CE8\u89E3-datasource" tabindex="-1"><a class="header-anchor" href="#_5-1-\u5B9A\u4E49\u6CE8\u89E3-datasource" aria-hidden="true">#</a> 5.1 \u5B9A\u4E49\u6CE8\u89E3@DataSource</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u81EA\u5B9A\u4E49\u591A\u6570\u636E\u6E90\u5207\u6362\u6CE8\u89E3
 *
 * \u4F18\u5148\u7EA7\uFF1A\u5148\u65B9\u6CD5\uFF0C\u540E\u7C7B\uFF0C\u5982\u679C\u65B9\u6CD5\u8986\u76D6\u4E86\u7C7B\u4E0A\u7684\u6570\u636E\u6E90\u7C7B\u578B\uFF0C\u4EE5\u65B9\u6CD5\u7684\u4E3A\u51C6\uFF0C\u5426\u5219\u4EE5\u7C7B\u4E0A\u7684\u4E3A\u51C6
 *
 * <span class="token keyword">@author</span> ygn
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DataSource</span>
<span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * \u5207\u6362\u6570\u636E\u6E90\u540D\u79F0
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceType</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>MASTER<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-\u6570\u636E\u6E90\u7C7B\u578B" tabindex="-1"><a class="header-anchor" href="#_5-2-\u6570\u636E\u6E90\u7C7B\u578B" aria-hidden="true">#</a> 5.2 \u6570\u636E\u6E90\u7C7B\u578B</h3><p>\u6839\u636E\u6211\u4EEC\u5B9E\u9645\u9700\u6C42\uFF0C\u5B9A\u4E49\u4E0D\u540C\u6570\u636E\u6E90\u3002\u53EF\u4EE5\u6839\u636E\u591A\u79CD\u60C5\u51B5\u5212\u5206\uFF0C\u5982</p><ul><li><p>\u4E3B\u4ECE\u5212\u5206</p></li><li><p>\u4E1A\u52A1\u5212\u5206</p><p>A\u4E1A\u52A1\u6570\u636E\u5E93,B\u4E1A\u52A1\u6570\u636E\u5E93\u3002</p></li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u6570\u636E\u6E90
 * 
 * <span class="token keyword">@author</span> ygn
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">DataSourceType</span>
<span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * \u4E3B\u5E93
     */</span>
    MASTER<span class="token punctuation">,</span>

    <span class="token doc-comment comment">/**
     * \u4ECE\u5E93
     */</span>
    SLAVE
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-\u6570\u636E\u6E90\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#_5-3-\u6570\u636E\u6E90\u914D\u7F6E" aria-hidden="true">#</a> 5.3 \u6570\u636E\u6E90\u914D\u7F6E</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * druid \u914D\u7F6E\u591A\u6570\u636E\u6E90
 * 
 * <span class="token keyword">@author</span> ygn
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidConfig</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">&quot;spring.datasource.druid.master&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">masterDataSource</span><span class="token punctuation">(</span><span class="token class-name">DruidProperties</span> druidProperties<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">DruidDataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">DruidDataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> druidProperties<span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">&quot;spring.datasource.druid.slave&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.druid.slave&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">slaveDataSource</span><span class="token punctuation">(</span><span class="token class-name">DruidProperties</span> druidProperties<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">DruidDataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">DruidDataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> druidProperties<span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dynamicDataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token keyword">public</span> <span class="token class-name">DynamicDataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> masterDataSource<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>MASTER<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> masterDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setDataSource</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">,</span> <span class="token class-name">DataSourceType</span><span class="token punctuation">.</span>SLAVE<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;slaveDataSource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span>masterDataSource<span class="token punctuation">,</span> targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token doc-comment comment">/**
     * \u8BBE\u7F6E\u6570\u636E\u6E90
     * 
     * <span class="token keyword">@param</span> <span class="token parameter">targetDataSources</span> \u5907\u9009\u6570\u636E\u6E90\u96C6\u5408
     * <span class="token keyword">@param</span> <span class="token parameter">sourceName</span> \u6570\u636E\u6E90\u540D\u79F0
     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span> bean\u540D\u79F0
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> targetDataSources<span class="token punctuation">,</span> <span class="token class-name">String</span> sourceName<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sourceName<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u53BB\u9664\u76D1\u63A7\u9875\u9762\u5E95\u90E8\u7684\u5E7F\u544A
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unchecked&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.druid.statViewServlet.enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">FilterRegistrationBean</span> <span class="token function">removeDruidFilterRegistrationBean</span><span class="token punctuation">(</span><span class="token class-name">DruidStatProperties</span> properties<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// \u83B7\u53D6web\u76D1\u63A7\u9875\u9762\u7684\u53C2\u6570</span>
        <span class="token class-name">DruidStatProperties<span class="token punctuation">.</span>StatViewServlet</span> config <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getStatViewServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u63D0\u53D6common.js\u7684\u914D\u7F6E\u8DEF\u5F84</span>
        <span class="token class-name">String</span> pattern <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getUrlPattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> config<span class="token punctuation">.</span><span class="token function">getUrlPattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;/druid/*&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> commonJsPattern <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\\\*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;js/common.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token string">&quot;support/http/resources/js/common.js&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// \u521B\u5EFAfilter\u8FDB\u884C\u8FC7\u6EE4</span>
        <span class="token class-name">Filter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span>
            <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span>
            <span class="token punctuation">{</span>
                chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u91CD\u7F6E\u7F13\u51B2\u533A\uFF0C\u54CD\u5E94\u5934\u4E0D\u4F1A\u88AB\u91CD\u7F6E</span>
                response<span class="token punctuation">.</span><span class="token function">resetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u83B7\u53D6common.js</span>
                <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">readFromResource</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u6B63\u5219\u66FF\u6362banner, \u9664\u53BB\u5E95\u90E8\u7684\u5E7F\u544A\u4FE1\u606F</span>
                text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;a.*?banner\\&quot;&gt;&lt;/a&gt;&lt;br/&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;powered.*?shrek.wang&lt;/a&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">FilterRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span>commonJsPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-datasourceaspect-\u62E6\u622A\u5668" tabindex="-1"><a class="header-anchor" href="#_5-4-datasourceaspect-\u62E6\u622A\u5668" aria-hidden="true">#</a> 5.4 DataSourceAspect \u62E6\u622A\u5668</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u591A\u6570\u636E\u6E90\u5904\u7406
 * 
 * <span class="token keyword">@author</span> ygn
 */</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceAspect</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(com.ygn.common.annotation.DataSource)&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;|| @within(com.ygn.common.annotation.DataSource)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dsPointCut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;dsPointCut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">setDataSourceType</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> point<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// \u9500\u6BC1\u6570\u636E\u6E90 \u5728\u6267\u884C\u65B9\u6CD5\u4E4B\u540E</span>
            <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">clearDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u9700\u8981\u5207\u6362\u7684\u6570\u636E\u6E90
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">MethodSignature</span> signature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> point<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>signature<span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-\u6570\u636E\u6E90\u5207\u6362\u5904\u7406" tabindex="-1"><a class="header-anchor" href="#_5-5-\u6570\u636E\u6E90\u5207\u6362\u5904\u7406" aria-hidden="true">#</a> 5.5 \u6570\u636E\u6E90\u5207\u6362\u5904\u7406</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u6570\u636E\u6E90\u5207\u6362\u5904\u7406
 * 
 * <span class="token keyword">@author</span> ygn
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDataSourceContextHolder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u4F7F\u7528ThreadLocal\u7EF4\u62A4\u53D8\u91CF\uFF0CThreadLocal\u4E3A\u6BCF\u4E2A\u4F7F\u7528\u8BE5\u53D8\u91CF\u7684\u7EBF\u7A0B\u63D0\u4F9B\u72EC\u7ACB\u7684\u53D8\u91CF\u526F\u672C\uFF0C
     *  \u6240\u4EE5\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u72EC\u7ACB\u5730\u6539\u53D8\u81EA\u5DF1\u7684\u526F\u672C\uFF0C\u800C\u4E0D\u4F1A\u5F71\u54CD\u5176\u5B83\u7EBF\u7A0B\u6240\u5BF9\u5E94\u7684\u526F\u672C\u3002
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> CONTEXT_HOLDER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u8BBE\u7F6E\u6570\u636E\u6E90\u7684\u53D8\u91CF
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setDataSourceType</span><span class="token punctuation">(</span><span class="token class-name">String</span> dsType<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u5207\u6362\u5230{}\u6570\u636E\u6E90&quot;</span><span class="token punctuation">,</span> dsType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        CONTEXT_HOLDER<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dsType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u5F97\u6570\u636E\u6E90\u7684\u53D8\u91CF
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> CONTEXT_HOLDER<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6E05\u7A7A\u6570\u636E\u6E90\u53D8\u91CF
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        CONTEXT_HOLDER<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-6-\u52A8\u6001\u6570\u636E\u6E90" tabindex="-1"><a class="header-anchor" href="#_5-6-\u52A8\u6001\u6570\u636E\u6E90" aria-hidden="true">#</a> 5.6 \u52A8\u6001\u6570\u636E\u6E90</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u52A8\u6001\u6570\u636E\u6E90
 * 
 * <span class="token keyword">@author</span> ygn
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> defaultTargetDataSource<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> targetDataSources<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span>defaultTargetDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">getDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-6-1-abstractroutingdatasource\u5B9E\u73B0\u52A8\u6001\u6570\u636E\u6E90\u5207\u6362" tabindex="-1"><a class="header-anchor" href="#_5-6-1-abstractroutingdatasource\u5B9E\u73B0\u52A8\u6001\u6570\u636E\u6E90\u5207\u6362" aria-hidden="true">#</a> 5.6.1 AbstractRoutingDataSource\u5B9E\u73B0\u52A8\u6001\u6570\u636E\u6E90\u5207\u6362</h4><p>Spring boot\u63D0\u4F9B\u4E86AbstractRoutingDataSource \u6839\u636E\u7528\u6237\u5B9A\u4E49\u7684\u89C4\u5219\u9009\u62E9\u5F53\u524D\u7684\u6570\u636E\u6E90\uFF0C\u8FD9\u6837\u6211\u4EEC\u53EF\u4EE5\u5728\u6267\u884C\u67E5\u8BE2\u4E4B\u524D\uFF0C\u8BBE\u7F6E\u4F7F\u7528\u7684\u6570\u636E\u6E90\u3002\u5B9E\u73B0\u53EF\u52A8\u6001\u8DEF\u7531\u7684\u6570\u636E\u6E90\uFF0C\u5728\u6BCF\u6B21\u6570\u636E\u5E93\u67E5\u8BE2\u64CD\u4F5C\u524D\u6267\u884C\u3002<strong>\u5B83\u7684\u62BD\u8C61\u65B9\u6CD5 determineCurrentLookupKey() \u51B3\u5B9A\u4F7F\u7528\u54EA\u4E2A\u6570\u636E\u6E90</strong>\u3002</p><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>`,41),r={href:"https://doc.ruoyi.vip/ruoyi-vue/document/htsc.html#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90",target:"_blank",rel:"noopener noreferrer"},d=t("\u82E5\u4F9D\u5B98\u65B9\u6587\u6863"),k={href:"https://blog.csdn.net/qq_37502106/article/details/91044952",target:"_blank",rel:"noopener noreferrer"},v=t("spring boot\u4F7F\u7528AbstractRoutingDataSource\u5B9E\u73B0\u52A8\u6001\u6570\u636E\u6E90\u5207\u6362");function m(b,g){const s=i("ExternalLinkIcon");return p(),c("div",null,[u,n("p",null,[n("a",r,[d,a(s)])]),n("p",null,[n("a",k,[v,a(s)])])])}var S=e(l,[["render",m],["__file","C2-\u591A\u6570\u636E\u6E90\u7684\u652F\u6301.html.vue"]]);export{S as default};
