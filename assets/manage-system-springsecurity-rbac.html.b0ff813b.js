import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o,c,a as n,b as e,e as t,d as s,r as l}from"./app.258ed467.js";const i={},u=t(`<h1 id="springsecurity\u6743\u9650\u63A7\u5236-\u5B9E\u73B0\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#springsecurity\u6743\u9650\u63A7\u5236-\u5B9E\u73B0\u601D\u8DEF" aria-hidden="true">#</a> SpringSecurity\u6743\u9650\u63A7\u5236&amp;\u5B9E\u73B0\u601D\u8DEF</h1><h2 id="_1-\u7B80\u4ECB" tabindex="-1"><a class="header-anchor" href="#_1-\u7B80\u4ECB" aria-hidden="true">#</a> 1. \u7B80\u4ECB</h2><p>\u6743\u9650\u63A7\u5236\u662F\u9879\u76EE\u4E2D\u5FC5\u4E0D\u53EF\u5C11\u7684\u90E8\u5206</p><h2 id="_2-\u8868\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_2-\u8868\u7ED3\u6784" aria-hidden="true">#</a> 2. \u8868\u7ED3\u6784</h2><table><thead><tr><th style="text-align:left;">\u5B9E\u4F53</th><th style="text-align:left;">\u8868</th><th style="text-align:left;">\u8BF4\u660E</th></tr></thead><tbody><tr><td style="text-align:left;">SysUser</td><td style="text-align:left;"><code>sys_user</code></td><td style="text-align:left;">\u7528\u6237\u4FE1\u606F</td></tr><tr><td style="text-align:left;">SysRole</td><td style="text-align:left;"><code>sys_role</code></td><td style="text-align:left;">\u7528\u6237\u4FE1\u606F</td></tr><tr><td style="text-align:left;">SysUserRole</td><td style="text-align:left;"><code>sys_user_role</code></td><td style="text-align:left;">\u7528\u6237\u548C\u89D2\u8272\u5173\u8054</td></tr><tr><td style="text-align:left;">SysMenu</td><td style="text-align:left;"><code>sys_menu</code></td><td style="text-align:left;">\u83DC\u5355\u6743\u9650</td></tr><tr><td style="text-align:left;">SysRoleMenu</td><td style="text-align:left;"><code>sys_role_menu</code></td><td style="text-align:left;">\u89D2\u8272\u548C\u83DC\u5355\u5173\u8054</td></tr></tbody></table><p>5 \u4E2A\u8868\u7684\u5173\u7CFB\u6BD4\u8F83\u7B80\u5355\uFF1A</p><ul><li>\u4E00\u4E2A SysUser \uFF0C\u53EF\u4EE5\u62E5\u6709\u591A\u4E2A SysRole \uFF0C\u901A\u8FC7 SysUserRole \u5B58\u50A8\u5173\u8054\u3002</li><li>\u4E00\u4E2A SysRole \uFF0C\u53EF\u4EE5\u62E5\u6709\u591A\u4E2A SysMenu \uFF0C\u901A\u8FC7 SysRoleMenu \u5B58\u50A8\u5173\u8054\u3002</li></ul><h3 id="_2-1-sysuser" tabindex="-1"><a class="header-anchor" href="#_2-1-sysuser" aria-hidden="true">#</a> 2.1 SysUser</h3><p>SysUser\uFF0C\u7528\u6237\u5B9E\u4F53\u7C7B\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysUser.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUser</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>
   
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u7528\u6237\u5E8F\u53F7&quot;</span><span class="token punctuation">,</span> cellType <span class="token operator">=</span> <span class="token class-name">ColumnType</span><span class="token punctuation">.</span><span class="token constant">NUMERIC</span><span class="token punctuation">,</span> prompt <span class="token operator">=</span> <span class="token string">&quot;\u7528\u6237\u7F16\u53F7&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u90E8\u95E8\u7F16\u53F7&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">IMPORT</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> deptId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u767B\u5F55\u540D\u79F0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u7528\u6237\u540D\u79F0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u7528\u6237\u90AE\u7BB1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u624B\u673A\u53F7\u7801&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phonenumber<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u7528\u6237\u6027\u522B&quot;</span><span class="token punctuation">,</span> readConverterExp <span class="token operator">=</span> <span class="token string">&quot;0=\u7537,1=\u5973,2=\u672A\u77E5&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7528\u6237\u5934\u50CF */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u5BC6\u7801 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u76D0\u52A0\u5BC6 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> salt<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u5E10\u53F7\u72B6\u6001&quot;</span><span class="token punctuation">,</span> readConverterExp <span class="token operator">=</span> <span class="token string">&quot;0=\u6B63\u5E38,1=\u505C\u7528&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u5220\u9664\u6807\u5FD7\uFF080\u4EE3\u8868\u5B58\u5728 2\u4EE3\u8868\u5220\u9664\uFF09 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> delFlag<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u6700\u540E\u767B\u5F55IP&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">EXPORT</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginIp<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u6700\u540E\u767B\u5F55\u65F6\u95F4&quot;</span><span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> dateFormat <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">EXPORT</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> loginDate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excels</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u90E8\u95E8\u540D\u79F0&quot;</span><span class="token punctuation">,</span> targetAttr <span class="token operator">=</span> <span class="token string">&quot;deptName&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">EXPORT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u90E8\u95E8\u8D1F\u8D23\u4EBA&quot;</span><span class="token punctuation">,</span> targetAttr <span class="token operator">=</span> <span class="token string">&quot;leader&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">EXPORT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">SysDept</span> dept<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u89D2\u8272\u5BF9\u8C61 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u89D2\u8272\u7EC4 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> roleIds<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u5C97\u4F4D\u7EC4 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postIds<span class="token punctuation">;</span>
    
    <span class="token comment">// ...\u7701\u7565 set/get \u65B9\u6CD5</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u6DFB\u52A0 <code>@Transient</code> \u6CE8\u89E3\u7684\u5B57\u6BB5\uFF0C\u975E\u5B58\u50A8\u5B57\u6BB5\u3002\u540E\u7EED\u7684\u5B9E\u4F53\uFF0C\u8865\u5145\u91CD\u590D\u8D58\u8FF0\u3002</li><li>\u6BCF\u4E2A\u5B57\u6BB5\u6BD4\u8F83\u7B80\u5355\uFF0C\u6839\u636E\u6CE8\u91CA\u7406\u89E3\u4E0B\u5373\u53EF\u3002</li></ul><p>\u5BF9\u5E94\u8868\u7684\u521B\u5EFA SQL \u5982\u4E0B\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_user <span class="token punctuation">(</span>
  user_id           <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>      <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span>    <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237ID&#39;</span><span class="token punctuation">,</span>
  dept_id           <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>      <span class="token keyword">default</span> <span class="token boolean">null</span>               <span class="token keyword">comment</span> <span class="token string">&#39;\u90E8\u95E8ID&#39;</span><span class="token punctuation">,</span>
  user_name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>     <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237\u8D26\u53F7&#39;</span><span class="token punctuation">,</span>
  nick_name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>     <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237\u6635\u79F0&#39;</span><span class="token punctuation">,</span>
  user_type         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>      <span class="token keyword">default</span> <span class="token string">&#39;00&#39;</span>               <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237\u7C7B\u578B\uFF0800\u7CFB\u7EDF\u7528\u6237\uFF09&#39;</span><span class="token punctuation">,</span>
  email             <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237\u90AE\u7BB1&#39;</span><span class="token punctuation">,</span>
  phonenumber       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u624B\u673A\u53F7\u7801&#39;</span><span class="token punctuation">,</span>
  sex               <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token string">&#39;0&#39;</span>                <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237\u6027\u522B\uFF080\u7537 1\u5973 2\u672A\u77E5\uFF09&#39;</span><span class="token punctuation">,</span>
  avatar            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u5934\u50CF\u5730\u5740&#39;</span><span class="token punctuation">,</span>
  password          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u5BC6\u7801&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">status</span>            <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token string">&#39;0&#39;</span>                <span class="token keyword">comment</span> <span class="token string">&#39;\u5E10\u53F7\u72B6\u6001\uFF080\u6B63\u5E38 1\u505C\u7528\uFF09&#39;</span><span class="token punctuation">,</span>
  del_flag          <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token string">&#39;0&#39;</span>                <span class="token keyword">comment</span> <span class="token string">&#39;\u5220\u9664\u6807\u5FD7\uFF080\u4EE3\u8868\u5B58\u5728 2\u4EE3\u8868\u5220\u9664\uFF09&#39;</span><span class="token punctuation">,</span>
  login_ip          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u6700\u540E\u767B\u5F55IP&#39;</span><span class="token punctuation">,</span>
  login_date        <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u6700\u540E\u767B\u5F55\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  create_by         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u8005&#39;</span><span class="token punctuation">,</span>
  create_time       <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  update_by         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u66F4\u65B0\u8005&#39;</span><span class="token punctuation">,</span>
  update_time       <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u66F4\u65B0\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  remark            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token boolean">null</span>               <span class="token keyword">comment</span> <span class="token string">&#39;\u5907\u6CE8&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">auto_increment</span><span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">comment</span> <span class="token operator">=</span> <span class="token string">&#39;\u7528\u6237\u4FE1\u606F\u8868&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-sysrole" tabindex="-1"><a class="header-anchor" href="#_2-2-sysrole" aria-hidden="true">#</a> 2.2 SysRole</h3><p>SysRole\uFF0C\u89D2\u8272\u5B9E\u4F53\u7C7B\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysRole.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysRole</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u89D2\u8272\u5E8F\u53F7&quot;</span><span class="token punctuation">,</span> cellType <span class="token operator">=</span> <span class="token class-name">ColumnType</span><span class="token punctuation">.</span><span class="token constant">NUMERIC</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u89D2\u8272\u540D\u79F0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> roleName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u89D2\u8272\u6743\u9650&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> roleKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u89D2\u8272\u6392\u5E8F&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> roleSort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u6570\u636E\u8303\u56F4&quot;</span><span class="token punctuation">,</span> readConverterExp <span class="token operator">=</span> <span class="token string">&quot;1=\u6240\u6709\u6570\u636E\u6743\u9650,2=\u81EA\u5B9A\u4E49\u6570\u636E\u6743\u9650,3=\u672C\u90E8\u95E8\u6570\u636E\u6743\u9650,4=\u672C\u90E8\u95E8\u53CA\u4EE5\u4E0B\u6570\u636E\u6743\u9650&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> dataScope<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;\u89D2\u8272\u72B6\u6001&quot;</span><span class="token punctuation">,</span> readConverterExp <span class="token operator">=</span> <span class="token string">&quot;0=\u6B63\u5E38,1=\u505C\u7528&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u5220\u9664\u6807\u5FD7\uFF080\u4EE3\u8868\u5B58\u5728 2\u4EE3\u8868\u5220\u9664\uFF09 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> delFlag<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7528\u6237\u662F\u5426\u5B58\u5728\u6B64\u89D2\u8272\u6807\u8BC6 \u9ED8\u8BA4\u4E0D\u5B58\u5728 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u83DC\u5355\u7EC4 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> menuIds<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u90E8\u95E8\u7EC4\uFF08\u6570\u636E\u6743\u9650\uFF09 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> deptIds<span class="token punctuation">;</span>
    
    <span class="token comment">// ...\u7701\u7565 set/get \u65B9\u6CD5</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u6BCF\u4E2A\u5B57\u6BB5\u6BD4\u8F83\u7B80\u5355\uFF0C\u6839\u636E\u6CE8\u91CA\u7406\u89E3\u4E0B\u5373\u53EF\u3002</li></ul><p>\u5BF9\u5E94\u8868\u7684\u521B\u5EFA SQL \u5982\u4E0B\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_role <span class="token punctuation">(</span>
  role_id           <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>      <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span>    <span class="token keyword">comment</span> <span class="token string">&#39;\u89D2\u8272ID&#39;</span><span class="token punctuation">,</span>
  role_name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>     <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u89D2\u8272\u540D\u79F0&#39;</span><span class="token punctuation">,</span>
  role_key          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u89D2\u8272\u6743\u9650\u5B57\u7B26\u4E32&#39;</span><span class="token punctuation">,</span>
  role_sort         <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>          <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u663E\u793A\u987A\u5E8F&#39;</span><span class="token punctuation">,</span>
  data_scope        <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token string">&#39;1&#39;</span>                <span class="token keyword">comment</span> <span class="token string">&#39;\u6570\u636E\u8303\u56F4\uFF081\uFF1A\u5168\u90E8\u6570\u636E\u6743\u9650 2\uFF1A\u81EA\u5B9A\u6570\u636E\u6743\u9650 3\uFF1A\u672C\u90E8\u95E8\u6570\u636E\u6743\u9650 4\uFF1A\u672C\u90E8\u95E8\u53CA\u4EE5\u4E0B\u6570\u636E\u6743\u9650\uFF09&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">status</span>            <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u89D2\u8272\u72B6\u6001\uFF080\u6B63\u5E38 1\u505C\u7528\uFF09&#39;</span><span class="token punctuation">,</span>
  del_flag          <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token string">&#39;0&#39;</span>                <span class="token keyword">comment</span> <span class="token string">&#39;\u5220\u9664\u6807\u5FD7\uFF080\u4EE3\u8868\u5B58\u5728 2\u4EE3\u8868\u5220\u9664\uFF09&#39;</span><span class="token punctuation">,</span>
  create_by         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u8005&#39;</span><span class="token punctuation">,</span>
  create_time       <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  update_by         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u66F4\u65B0\u8005&#39;</span><span class="token punctuation">,</span>
  update_time       <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u66F4\u65B0\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  remark            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token boolean">null</span>               <span class="token keyword">comment</span> <span class="token string">&#39;\u5907\u6CE8&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">auto_increment</span><span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">comment</span> <span class="token operator">=</span> <span class="token string">&#39;\u89D2\u8272\u4FE1\u606F\u8868&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-sysuserrole" tabindex="-1"><a class="header-anchor" href="#_2-3-sysuserrole" aria-hidden="true">#</a> 2.3 SysUserRole</h3><p>SysUserRole\uFF0C\u7528\u6237\u548C\u89D2\u8272\u5173\u8054\u5B9E\u4F53\u7C7B\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysUserRole.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserRole</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** \u7528\u6237ID */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u89D2\u8272ID */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>
    
    <span class="token comment">// ...\u7701\u7565 set/get \u65B9\u6CD5</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u6BCF\u4E2A\u5B57\u6BB5\u6BD4\u8F83\u7B80\u5355\uFF0C\u6839\u636E\u6CE8\u91CA\u7406\u89E3\u4E0B\u5373\u53EF\u3002</li><li><code>roleKey</code> \u5C5E\u6027\uFF0C\u5BF9\u5E94\u7684\u89D2\u8272<strong>\u6807\u8BC6</strong>\u5B57\u7B26\u4E32\uFF0C\u53EF\u4EE5\u5BF9\u5E94\u591A\u4E2A\u89D2\u8272<strong>\u6807\u8BC6</strong>\uFF0C\u4F7F\u7528\u9017\u53F7\u5206\u9694\u3002\u4F8B\u5982\u8BF4\uFF1A<code>&quot;admin,normal&quot;</code> \u3002</li></ul><p>\u5BF9\u5E94\u8868\u7684\u521B\u5EFA SQL \u5982\u4E0B\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_user_role <span class="token punctuation">(</span>
  user_id   <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u7528\u6237ID&#39;</span><span class="token punctuation">,</span>
  role_id   <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u89D2\u8272ID&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">comment</span> <span class="token operator">=</span> <span class="token string">&#39;\u7528\u6237\u548C\u89D2\u8272\u5173\u8054\u8868&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-sysmenu" tabindex="-1"><a class="header-anchor" href="#_2-4-sysmenu" aria-hidden="true">#</a> 2.4 SysMenu</h3><p>SysMenu \uFF0C\u83DC\u5355\u6743\u9650\u5B9E\u4F53\u7C7B\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysMenu.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysMenu</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u83DC\u5355ID */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> menuId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u83DC\u5355\u540D\u79F0 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> menuName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7236\u83DC\u5355\u540D\u79F0 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7236\u83DC\u5355ID */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> parentId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u663E\u793A\u987A\u5E8F */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderNum<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u8DEF\u7531\u5730\u5740 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7EC4\u4EF6\u8DEF\u5F84 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> component<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u662F\u5426\u4E3A\u5916\u94FE\uFF080\u662F 1\u5426\uFF09 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> isFrame<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7C7B\u578B\uFF08M\u76EE\u5F55 C\u83DC\u5355 F\u6309\u94AE\uFF09 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> menuType<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u83DC\u5355\u72B6\u6001:0\u663E\u793A,1\u9690\u85CF */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> visible<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u6743\u9650\u5B57\u7B26\u4E32 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> perms<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u83DC\u5355\u56FE\u6807 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> icon<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u5B50\u83DC\u5355 */</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenu</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenu</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ...\u7701\u7565 set/get \u65B9\u6CD5</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>\u4E2A\u4EBA\u611F\u89C9\uFF0C\u8FD9\u4E2A\u5B9E\u4F53\u6539\u6210 SysResource \u8D44\u6E90\uFF0C\u66F4\u52A0\u5408\u9002\uFF0C\u83DC\u5355\u4EC5\u4EC5\u662F\u5176\u4E2D\u7684\u4E00\u79CD\u3002</p></li><li><p>\u6BCF\u4E2A\u5B57\u6BB5\u6BD4\u8F83\u7B80\u5355\uFF0C\u6211\u4EEC\u6765\u91CD\u70B9\u770B\u51E0\u4E2A\u5B57\u6BB5\u3002</p><ul><li><code>menuType</code> \u5C5E\u6027\uFF0C\u5B9A\u4E49\u4E86\u4E09\u79CD\u7C7B\u578B\u3002\u5176\u4E2D\uFF0C<code>F</code> \u4EE3\u8868\u6309\u94AE\uFF0C\u662F\u4E3A\u4E86\u505A\u9875\u9762\u4E2D\u7684\u529F\u80FD\u7EA7\u7684\u6743\u9650\u3002</li><li><code>perms</code> \u5C5E\u6027\uFF0C\u5BF9\u5E94\u7684\u6743\u9650<strong>\u6807\u8BC6</strong>\u5B57\u7B26\u4E32\u3002\u4E00\u822C\u683C\u5F0F\u4E3A <code>\${\u5927\u6A21\u5757}:\${\u5C0F\u6A21\u5757}:{\u64CD\u4F5C}</code> \u3002\u793A\u4F8B\u5982\u4E0B\uFF1A</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u7528\u6237\u67E5\u8BE2\uFF1Asystem:user:query
\u7528\u6237\u65B0\u589E\uFF1Asystem:user:add
\u7528\u6237\u4FEE\u6539\uFF1Asystem:user:edit
\u7528\u6237\u5220\u9664\uFF1Asystem:user:remove
\u7528\u6237\u5BFC\u51FA\uFF1Asystem:user:export
\u7528\u6237\u5BFC\u5165\uFF1Asystem:user:import
\u91CD\u7F6E\u5BC6\u7801\uFF1Asystem:user:resetPwd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u5BF9\u4E8E\u524D\u7AEF\u6765\u8BF4\uFF0C\u6BCF\u4E2A\u6309\u94AE\u5728\u5C55\u793A\u65F6\uFF0C\u53EF\u4EE5\u5224\u65AD\u7528\u6237\u662F\u5426\u6709\u8BE5\u6309\u94AE\u7684\u6743\u9650\u3002\u5982\u679C\u6CA1\u6709\uFF0C\u5219\u8FDB\u884C\u9690\u85CF\u3002\u5F53\u7136\uFF0C\u524D\u7AEF\u5728\u9996\u6B21\u8FDB\u5165\u7CFB\u7EDF\u7684\u65F6\u5019\uFF0C\u4F1A\u8BF7\u6C42\u4E00\u6B21\u6743\u9650\u5217\u8868\u5230\u672C\u5730\u8FDB\u884C\u7F13\u5B58\u3002</li><li>\u5BF9\u4E8E\u540E\u7AEF\u6765\u8BF4\uFF0C\u6BCF\u4E2A\u63A5\u53E3\u4E0A\u4F1A\u6DFB\u52A0 <code>@PreAuthorize(&quot;@ss.hasPermi(&#39;system:user:list&#39;)&quot;)</code> \u6CE8\u89E3\u3002\u5728\u8BF7\u6C42\u63A5\u53E3\u65F6\uFF0C\u4F1A\u6821\u9A8C\u7528\u6237\u662F\u5426\u6709\u8BE5 URL \u5BF9\u5E94\u7684\u6743\u9650\u3002\u5982\u679C\u6CA1\u6709\uFF0C\u5219\u4F1A\u629B\u51FA\u6743\u9650\u9A8C\u8BC1\u5931\u8D25\u7684\u5F02\u5E38\u3002</li><li>\u4E00\u4E2A <code>perms</code> \u5C5E\u6027\uFF0C\u53EF\u4EE5\u5BF9\u5E94\u591A\u4E2A\u6743\u9650<strong>\u6807\u8BC6</strong>\uFF0C\u4F7F\u7528\u9017\u53F7\u5206\u9694\u3002\u4F8B\u5982\u8BF4\uFF1A<code>&quot;system:user:query,system:user:add&quot;</code> \u3002</li></ul></li></ul><p>\u5BF9\u5E94\u8868\u7684\u521B\u5EFA SQL \u5982\u4E0B\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_menu <span class="token punctuation">(</span>
  menu_id           <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>      <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span>    <span class="token keyword">comment</span> <span class="token string">&#39;\u83DC\u5355ID&#39;</span><span class="token punctuation">,</span>
  menu_name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>     <span class="token operator">not</span> <span class="token boolean">null</span>                   <span class="token keyword">comment</span> <span class="token string">&#39;\u83DC\u5355\u540D\u79F0&#39;</span><span class="token punctuation">,</span>
  parent_id         <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>      <span class="token keyword">default</span> <span class="token number">0</span>                  <span class="token keyword">comment</span> <span class="token string">&#39;\u7236\u83DC\u5355ID&#39;</span><span class="token punctuation">,</span>
  order_num         <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>          <span class="token keyword">default</span> <span class="token number">0</span>                  <span class="token keyword">comment</span> <span class="token string">&#39;\u663E\u793A\u987A\u5E8F&#39;</span><span class="token punctuation">,</span>
  path              <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u8DEF\u7531\u5730\u5740&#39;</span><span class="token punctuation">,</span>
  component         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token boolean">null</span>               <span class="token keyword">comment</span> <span class="token string">&#39;\u7EC4\u4EF6\u8DEF\u5F84&#39;</span><span class="token punctuation">,</span>
  is_frame          <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>          <span class="token keyword">default</span> <span class="token number">1</span>                  <span class="token keyword">comment</span> <span class="token string">&#39;\u662F\u5426\u4E3A\u5916\u94FE\uFF080\u662F 1\u5426\uFF09&#39;</span><span class="token punctuation">,</span>
  menu_type         <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u83DC\u5355\u7C7B\u578B\uFF08M\u76EE\u5F55 C\u83DC\u5355 F\u6309\u94AE\uFF09&#39;</span><span class="token punctuation">,</span>
  visible           <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">default</span> <span class="token number">0</span>                  <span class="token keyword">comment</span> <span class="token string">&#39;\u83DC\u5355\u72B6\u6001\uFF080\u663E\u793A 1\u9690\u85CF\uFF09&#39;</span><span class="token punctuation">,</span>
  perms             <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token boolean">null</span>               <span class="token keyword">comment</span> <span class="token string">&#39;\u6743\u9650\u6807\u8BC6&#39;</span><span class="token punctuation">,</span>
  icon              <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token string">&#39;#&#39;</span>                <span class="token keyword">comment</span> <span class="token string">&#39;\u83DC\u5355\u56FE\u6807&#39;</span><span class="token punctuation">,</span>
  create_by         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u8005&#39;</span><span class="token punctuation">,</span>
  create_time       <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u521B\u5EFA\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  update_by         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>     <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u66F4\u65B0\u8005&#39;</span><span class="token punctuation">,</span>
  update_time       <span class="token keyword">datetime</span>                                   <span class="token keyword">comment</span> <span class="token string">&#39;\u66F4\u65B0\u65F6\u95F4&#39;</span><span class="token punctuation">,</span>
  remark            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>    <span class="token keyword">default</span> <span class="token string">&#39;&#39;</span>                 <span class="token keyword">comment</span> <span class="token string">&#39;\u5907\u6CE8&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>menu_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">auto_increment</span><span class="token operator">=</span><span class="token number">2000</span> <span class="token keyword">comment</span> <span class="token operator">=</span> <span class="token string">&#39;\u83DC\u5355\u6743\u9650\u8868&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-sysrolemenu" tabindex="-1"><a class="header-anchor" href="#_2-5-sysrolemenu" aria-hidden="true">#</a> 2.5 SysRoleMenu</h3><p>SysRoleMenu\uFF0C\u83DC\u5355\u6743\u9650\u5B9E\u4F53\u7C7B\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysRoleMenu.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysRoleMenu</span> <span class="token punctuation">{</span>
    
    <span class="token doc-comment comment">/** \u89D2\u8272ID */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u83DC\u5355ID */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> menuId<span class="token punctuation">;</span>
    
    <span class="token comment">// ...\u7701\u7565 set/get \u65B9\u6CD5</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u6BCF\u4E2A\u5B57\u6BB5\u6BD4\u8F83\u7B80\u5355\uFF0C\u53CB\u81EA\u5DF1\u6839\u636E\u6CE8\u91CA\u7406\u89E3\u4E0B\u5373\u53EF\u3002</li></ul><p>\u5BF9\u5E94\u8868\u7684\u521B\u5EFA SQL \u5982\u4E0B\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_role_menu <span class="token punctuation">(</span>
  role_id   <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u89D2\u8272ID&#39;</span><span class="token punctuation">,</span>
  menu_id   <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;\u83DC\u5355ID&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>role_id<span class="token punctuation">,</span> menu_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">comment</span> <span class="token operator">=</span> <span class="token string">&#39;\u89D2\u8272\u548C\u83DC\u5355\u5173\u8054\u8868&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-securityconfig" tabindex="-1"><a class="header-anchor" href="#_3-securityconfig" aria-hidden="true">#</a> 3. SecurityConfig</h2><p>\u5728SecurityConfig \u914D\u7F6E\u7C7B\uFF0C\u7EE7\u627F WebSecurityConfigurerAdapter \u62BD\u8C61\u7C7B\uFF0C\u5B9E\u73B0 Spring Security \u5728 Web \u573A\u666F\u4E0B\u7684\u81EA\u5B9A\u4E49\u914D\u7F6E\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SecurityConfig.java</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6D89\u53CA\u5230\u7684\u914D\u7F6E\u65B9\u6CD5\u8F83\u591A\uFF0C\u6211\u4EEC\u9010\u4E2A\u6765\u770B\u770B\u3002</p><h3 id="_3-1-\u5B9E\u73B0-authenticationmanager\u8BA4\u8BC1\u7BA1\u7406\u5668" tabindex="-1"><a class="header-anchor" href="#_3-1-\u5B9E\u73B0-authenticationmanager\u8BA4\u8BC1\u7BA1\u7406\u5668" aria-hidden="true">#</a> 3.1 \u5B9E\u73B0 AuthenticationManager\u8BA4\u8BC1\u7BA1\u7406\u5668</h3><p>\u91CD\u5199 <code>#configure(AuthenticationManagerBuilder auth)</code> \u65B9\u6CD5\uFF0C\u5B9E\u73B0 <code>AuthenticationManager</code> \u8BA4\u8BC1\u7BA1\u7406\u5668\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SecurityConfig.java</span>

<span class="token doc-comment comment">/**
 * \u81EA\u5B9A\u4E49\u7528\u6237\u8BA4\u8BC1\u903B\u8F91
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u8EAB\u4EFD\u8BA4\u8BC1\u63A5\u53E3
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span> <span class="token comment">// &lt;X&gt;</span>
            <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">bCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Y&gt;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u5F3A\u6563\u5217\u54C8\u5E0C\u52A0\u5BC6\u5B9E\u73B0
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">bCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>&lt;X&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>AuthenticationManagerBuilder#userDetailsService(userDetailsService)</code> \u65B9\u6CD5\uFF0C\u4F7F\u7528\u81EA\u5B9A\u4E49\u5B9E\u73B0\u7684UserDetailsService\u5B9E\u73B0\u7C7B\uFF0C\u66F4\u52A0<strong>\u7075\u6D3B</strong>\u4E14<strong>\u81EA\u7531</strong>\u7684\u5B9E\u73B0\u8BA4\u8BC1\u7684\u7528\u6237\u4FE1\u606F\u7684\u8BFB\u53D6\u3002\u5728[\u52A0\u8F7D\u7528\u6237\u4FE1\u606F\u4E2D\uFF0C\u6211\u4EEC\u4F1A\u770B\u5230 RuoYi-Vue \u5BF9 UserDetailsService \u7684\u81EA\u5B9A\u4E49\u5B9E\u73B0\u7C7B\u3002</li><li><code>&lt;Y&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>AbstractDaoAuthenticationConfigurer#passwordEncoder(passwordEncoder)</code> \u65B9\u6CD5\uFF0C\u8BBE\u7F6E PasswordEncoder \u5BC6\u7801\u7F16\u7801\u5668\u3002\u8FD9\u91CC\uFF0C\u5C31\u4F7F\u7528\u4E86 bCryptPasswordEncoder \u5F3A\u6563\u5217\u54C8\u5E0C\u52A0\u5BC6\u5B9E\u73B0\u3002</li></ul><h3 id="_3-2-\u914D\u7F6E-url-\u7684\u6743\u9650" tabindex="-1"><a class="header-anchor" href="#_3-2-\u914D\u7F6E-url-\u7684\u6743\u9650" aria-hidden="true">#</a> 3.2 \u914D\u7F6E URL \u7684\u6743\u9650</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SecurityConfig.java</span>

<span class="token doc-comment comment">/**
 * \u8BA4\u8BC1\u5931\u8D25\u5904\u7406\u7C7B
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">AuthenticationEntryPointImpl</span> unauthorizedHandler<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u9000\u51FA\u5904\u7406\u7C7B
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">LogoutSuccessHandlerImpl</span> logoutSuccessHandler<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * token \u8BA4\u8BC1\u8FC7\u6EE4\u5668
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> authenticationTokenFilter<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    httpSecurity
            <span class="token comment">// CRSF\u7981\u7528\uFF0C\u56E0\u4E3A\u4E0D\u4F7F\u7528session</span>
            <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// &lt;X&gt; \u8BA4\u8BC1\u5931\u8D25\u5904\u7406\u7C7B</span>
            <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>unauthorizedHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// \u57FA\u4E8Etoken\uFF0C\u6240\u4EE5\u4E0D\u9700\u8981session</span>
            <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// \u8FC7\u6EE4\u8BF7\u6C42</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// &lt;Y&gt; \u5BF9\u4E8E\u767B\u5F55login \u9A8C\u8BC1\u7801captchaImage \u5141\u8BB8\u533F\u540D\u8BBF\u95EE</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/captchaImage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>
                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;/*.html&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;/**/*.html&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;/**/*.css&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;/**/*.js&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/profile/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/common/download**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/swagger-ui.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/swagger-resources/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/webjars/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/*/api-docs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/druid/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// \u9664\u4E0A\u9762\u5916\u7684\u6240\u6709\u8BF7\u6C42\u5168\u90E8\u9700\u8981\u9274\u6743\u8BA4\u8BC1</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpSecurity<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span>logoutSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Z&gt;</span>
    <span class="token comment">// &lt;P&gt; \u6DFB\u52A0 JWT filter</span>
    httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>authenticationTokenFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>&lt;X&gt;</code> \u5904\uFF0C\u8BBE\u7F6E\u8BA4\u8BC1\u5931\u8D25\u65F6\u7684\u5904\u7406\u5668\u4E3A <code>unauthorizedHandler</code> \u3002\u8BE6\u7EC6\u89E3\u6790\uFF0C\u89C1 AuthenticationEntryPointImpl\u3002</li><li><code>&lt;Y&gt;</code> \u5904\uFF0C\u8BBE\u7F6E\u7528\u4E8E\u767B\u5F55\u7684 <code>/login</code> \u63A5\u53E3\uFF0C\u5141\u8BB8\u533F\u540D\u8BBF\u95EE\u3002\u8FD9\u6837\uFF0C\u540E\u7EED\u6211\u4EEC\u5C31\u53EF\u4EE5\u4F7F\u7528\u81EA\u5B9A\u4E49\u7684\u767B\u5F55\u63A5\u53E3\u3002\u8BE6\u7EC6\u89E3\u6790\uFF0C\u89C1\u767B\u5F55 API \u63A5\u53E3</li><li><code>&lt;Z&gt;</code> \u5904\uFF0C\u8BBE\u7F6E\u767B\u51FA\u6210\u529F\u7684\u5904\u7406\u5668\u4E3A <code>logoutSuccessHandler</code> \u3002\u8BE6\u7EC6\u89E3\u6790\uFF0C\u89C1LogoutSuccessHandlerImpl</li><li><code>&lt;P&gt;</code> \u5904\uFF0C\u6DFB\u52A0 JWT \u8BA4\u8BC1\u8FC7\u6EE4\u5668 <code>authenticationTokenFilter</code> \uFF0C\u7528\u4E8E\u7528\u6237\u4F7F\u7528\u7528\u6237\u540D\u4E0E\u5BC6\u7801\u767B\u5F55\u5B8C\u6210\u540E\uFF0C\u540E\u7EED\u8BF7\u6C42\u57FA\u4E8E JWT \u6765\u8BA4\u8BC1\u3002 \u8BE6\u7EC6\u89E3\u6790\uFF0C\u89C1 JwtAuthenticationTokenFilter\u3002</li></ul><h3 id="_3-3-\u91CD\u5199-authenticationmanagerbean-\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_3-3-\u91CD\u5199-authenticationmanagerbean-\u65B9\u6CD5" aria-hidden="true">#</a> 3.3 \u91CD\u5199 <code>#authenticationManagerBean</code> \u65B9\u6CD5</h3><p>\u91CD\u5199 #authenticationManagerBean \u65B9\u6CD5\uFF0C\u89E3\u51B3\u65E0\u6CD5\u76F4\u63A5\u6CE8\u5165 AuthenticationManager \u7684\u95EE\u9898\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SecurityConfig.java</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
\u5728\u65B9\u6CD5\u4E0A\uFF0C\u989D\u5916\u6DFB\u52A0\u4E86 <span class="token annotation punctuation">@Bean</span> \u6CE8\u89E3\uFF0C\u4FDD\u8BC1\u521B\u5EFA\u51FA <span class="token class-name">AuthenticationManager</span> <span class="token class-name">Bean</span> \u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-\u767B\u5F55-api-\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_4-\u767B\u5F55-api-\u63A5\u53E3" aria-hidden="true">#</a> 4. \u767B\u5F55 API \u63A5\u53E3</h2><h3 id="_4-1-\u767B\u5F55\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_4-1-\u767B\u5F55\u63A5\u53E3" aria-hidden="true">#</a> 4.1 \u767B\u5F55\u63A5\u53E3</h3><p><strong>SysLoginController#login(...)</strong></p><p>\u5728 SysLoginController \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>/login</code> \u63A5\u53E3\uFF0C\u63D0\u4F9B\u767B\u5F55\u529F\u80FD\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span> <span class="token class-name">SysLoginController</span><span class="token punctuation">.</span>java

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">SysLoginService</span> loginService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u767B\u5F55\u65B9\u6CD5
 *
 * <span class="token keyword">@param</span> <span class="token parameter">username</span> \u7528\u6237\u540D
 * <span class="token keyword">@param</span> <span class="token parameter">password</span> \u5BC6\u7801
 * <span class="token keyword">@param</span> <span class="token parameter">code</span> \u9A8C\u8BC1\u7801
 * <span class="token keyword">@param</span> <span class="token parameter">uuid</span> \u552F\u4E00\u6807\u8BC6
 * <span class="token keyword">@return</span> \u7ED3\u679C
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AjaxResult</span> ajax <span class="token operator">=</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u751F\u6210\u4EE4\u724C</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> code<span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ajax<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TOKEN</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ajax<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>\u5728\u5185\u90E8\uFF0C\u4F1A\u8C03\u7528 <code>loginService#login(username, password, code, uuid)</code> \u65B9\u6CD5\uFF0C\u4F1A\u8FDB\u884C\u57FA\u4E8E\u7528\u6237\u540D\u4E0E\u5BC6\u7801\u7684\u767B\u5F55\u8BA4\u8BC1\u3002\u8BA4\u8BC1\u901A\u8FC7\u540E\uFF0C\u8FD4\u56DE\u8EAB\u4EFD TOKEN \u3002</p></li><li><p>\u767B\u5F55\u6210\u529F\u540E\uFF0C\u8BE5\u63A5\u53E3\u54CD\u5E94\u793A\u4F8B\u5982\u4E0B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\u64CD\u4F5C\u6210\u529F&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJIUzUxMiJ9.eyJsb2dpbl91c2VyX2tleSI6ImJkN2Q4OTZiLTU2NTAtNGIyZS1iNjFjLTc0MjlkYmRkNzA1YyJ9.lkU8ot4GecLHs7VAcRAo1fLMOaFryd4W5Q_a2wzPwcOL0Kiwyd4enpnGd79A_aQczXC-JB8vELNcNn7BrtJn9A&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u540E\u7EED\uFF0C\u524D\u7AEF\u5728\u8BF7\u6C42\u540E\u7AEF\u63A5\u53E3\u65F6\uFF0C\u5728\u8BF7\u6C42\u5934\u4E0A\u5E26\u5934\u8BE5 <code>token</code> \u503C\uFF0C\u4F5C\u4E3A\u7528\u6237\u8EAB\u4EFD\u6807\u8BC6\u3002</li></ul></li></ul><h3 id="_4-2-\u767B\u5F55service" tabindex="-1"><a class="header-anchor" href="#_4-2-\u767B\u5F55service" aria-hidden="true">#</a> 4.2 \u767B\u5F55service</h3><p>\u5728 <code>SysLoginService</code>\u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#login(username, password, code, uuid)</code> \u65B9\u6CD5\uFF0C\u8FDB\u884C\u57FA\u4E8E\u7528\u6237\u540D\u4E0E\u5BC6\u7801\u7684\u767B\u5F55\u8BA4\u8BC1\u3002\u8BA4\u8BC1\u901A\u8FC7\u540E\uFF0C\u8FD4\u56DE\u8EAB\u4EFD TOKEN \u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysLoginService.java</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">TokenService</span> tokenService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisCache</span> redisCache<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u767B\u5F55\u9A8C\u8BC1
 *
 * <span class="token keyword">@param</span> <span class="token parameter">username</span> \u7528\u6237\u540D
 * <span class="token keyword">@param</span> <span class="token parameter">password</span> \u5BC6\u7801
 * <span class="token keyword">@param</span> <span class="token parameter">code</span>     \u9A8C\u8BC1\u7801
 * <span class="token keyword">@param</span> <span class="token parameter">uuid</span>     \u552F\u4E00\u6807\u8BC6
 * <span class="token keyword">@return</span> \u7ED3\u679C
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &lt;1&gt; \u9A8C\u8BC1\u56FE\u7247\u9A8C\u8BC1\u7801\u7684\u6B63\u786E\u6027</span>
    <span class="token class-name">String</span> verifyKey <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CAPTCHA_CODE_KEY</span> <span class="token operator">+</span> uuid<span class="token punctuation">;</span> <span class="token comment">// uuid \u7684\u4F5C\u7528\uFF0C\u662F\u83B7\u5F97\u5BF9\u5E94\u7684\u56FE\u7247\u9A8C\u8BC1\u7801</span>
    <span class="token class-name">String</span> captcha <span class="token operator">=</span> redisCache<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>verifyKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u4ECE Redis \u4E2D\uFF0C\u83B7\u5F97\u56FE\u7247\u9A8C\u8BC1\u7801</span>
    redisCache<span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>verifyKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u4ECE Redis \u4E2D\uFF0C\u5220\u9664\u56FE\u7247\u9A8C\u8BC1\u7801</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>captcha <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u56FE\u7247\u9A8C\u8BC1\u7801\u4E0D\u5B58\u5728</span>
        <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.jcaptcha.error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CaptchaExpireException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>code<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>captcha<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u56FE\u7247\u9A8C\u8BC1\u7801\u4E0D\u6B63\u786E</span>
        <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.jcaptcha.expire&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CaptchaException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &lt;2&gt; \u7528\u6237\u9A8C\u8BC1</span>
    <span class="token class-name">Authentication</span> authentication<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u8BE5\u65B9\u6CD5\u4F1A\u53BB\u8C03\u7528 UserDetailsServiceImpl.loadUserByUsername</span>
        authentication <span class="token operator">=</span> authenticationManager
                <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;2.1&gt; \u53D1\u751F\u5F02\u5E38\uFF0C\u8BF4\u660E\u9A8C\u8BC1\u4E0D\u901A\u8FC7\uFF0C\u8BB0\u5F55\u76F8\u5E94\u7684\u767B\u5F55\u5931\u8D25\u65E5\u5FD7</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.password.not.match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserPasswordNotMatchException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &lt;2.2&gt; \u9A8C\u8BC1\u901A\u8FC7\uFF0C\u8BB0\u5F55\u76F8\u5E94\u7684\u767B\u5F55\u6210\u529F\u65E5\u5FD7</span>
    <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_SUCCESS</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.login.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;3&gt; \u751F\u6210 Token</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LoginUser</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tokenService<span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>&lt;1&gt;</code> \u5904\uFF0C\u9A8C\u8BC1\u56FE\u7247\u9A8C\u8BC1\u7801\u7684\u6B63\u786E\u6027\u3002\u8BE5\u9A8C\u8BC1\u7801\u4F1A\u5B58\u50A8\u5728 Redis \u7F13\u5B58\u4E2D\uFF0C\u901A\u8FC7 <code>uuid</code> \u4F5C\u4E3A\u5BF9\u5E94\u7684\u6807\u8BC6\u3002\u751F\u6210\u7684\u903B\u8F91\uFF0C\u770B CaptchaController \u63D0\u4F9B\u7684 <code>/captchaImage</code> \u63A5\u53E3\u3002</li><li><code>&lt;2&gt;</code>\u5904\uFF0C\u8C03\u7528 Spring Security \u7684AuthenticationManager#authenticate(UsernamePasswordAuthenticationToken authentication)\u65B9\u6CD5\uFF0C\u57FA\u4E8E\u7528\u6237\u540D\u4E0E\u5BC6\u7801\u7684\u767B\u5F55\u8BA4\u8BC1\u3002\u5728\u5176\u5185\u90E8\uFF0C\u4F1A\u8C03\u7528\u6211\u4EEC\u5B9A\u4E49\u7684 UserDetailsServiceImpl #loadUserByUsername(String username)\u65B9\u6CD5\uFF0C\u83B7\u5F97\u6307\u5B9A\u7528\u6237\u540D\u5BF9\u5E94\u7684\u7528\u6237\u4FE1\u606F\u3002 <ul><li><code>&lt;2.1&gt;</code> \u5904\uFF0C\u53D1\u751F\u5F02\u5E38\uFF0C\u8BF4\u660E\u8BA4\u8BC1<strong>\u4E0D</strong>\u901A\u8FC7\uFF0C\u8BB0\u5F55\u76F8\u5E94\u7684\u767B\u5F55\u5931\u8D25\u65E5\u5FD7\u3002</li><li><code>&lt;2.2&gt;</code> \u5904\uFF0C<strong>\u672A</strong>\u53D1\u751F\u5F02\u5E38\uFF0C\u8BF4\u660E\u8BA4\u8BC1\u901A\u8FC7\uFF0C\u8BB0\u5F55\u76F8\u5E94\u7684\u767B\u5F55\u6210\u529F\u65E5\u5FD7\u3002</li><li>\u5173\u4E8E\u4E0A\u8FF0\u65E5\u5FD7\uFF0C\u6211\u4EEC\u5728 \u767B\u5F55\u65E5\u5FD7 \u6765\u8BB2\u3002</li></ul></li><li><code>&lt;3&gt;</code> \u5904\uFF0C\u8C03\u7528 TokenService \u7684 <code>#createToken(LoginUser loginUser)</code> \u65B9\u6CD5\uFF0C\u7ED9\u8BA4\u8BC1\u901A\u8FC7\u7684\u7528\u6237\uFF0C\u751F\u6210\u5176\u5BF9\u5E94\u7684\u8BA4\u8BC1 TOKEN \u3002\u8FD9\u6837\uFF0C\u8BE5\u7528\u6237\u7684\u540E\u7EED\u8BF7\u6C42\uFF0C\u5C31\u4F7F\u7528\u8BE5 TOKEN \u4F5C\u4E3A\u8EAB\u4EFD\u6807\u8BC6\u8FDB\u884C\u8BA4\u8BC1\u3002</li></ul><h3 id="_4-3-\u52A0\u8F7D\u7528\u6237\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_4-3-\u52A0\u8F7D\u7528\u6237\u4FE1\u606F" aria-hidden="true">#</a> 4.3 \u52A0\u8F7D\u7528\u6237\u4FE1\u606F</h3><p>\u5728 UserDetailsServiceImpl \u4E2D\uFF0C\u5B9E\u73B0 Spring Security UserDetailsService \u63A5\u53E3\uFF0C\u5B9E\u73B0\u4E86\u8BE5\u63A5\u53E3\u5B9A\u4E49\u7684</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// UserDetailsServiceImpl.java</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ISysUserService</span> userService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">SysPermissionService</span> permissionService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token comment">// &lt;1&gt; \u67E5\u8BE2\u6307\u5B9A\u7528\u6237\u540D\u5BF9\u5E94\u7684 SysUser</span>
    <span class="token class-name">SysUser</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectUserByUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;2&gt; \u5404\u79CD\u6821\u9A8C</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u767B\u5F55\u7528\u6237\uFF1A{} \u4E0D\u5B58\u5728.&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;\u767B\u5F55\u7528\u6237\uFF1A&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot; \u4E0D\u5B58\u5728&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserStatus</span><span class="token punctuation">.</span><span class="token constant">DELETED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getDelFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u767B\u5F55\u7528\u6237\uFF1A{} \u5DF2\u88AB\u5220\u9664.&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token string">&quot;\u5BF9\u4E0D\u8D77\uFF0C\u60A8\u7684\u8D26\u53F7\uFF1A&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot; \u5DF2\u88AB\u5220\u9664&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserStatus</span><span class="token punctuation">.</span><span class="token constant">DISABLE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u767B\u5F55\u7528\u6237\uFF1A{} \u5DF2\u88AB\u505C\u7528.&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token string">&quot;\u5BF9\u4E0D\u8D77\uFF0C\u60A8\u7684\u8D26\u53F7\uFF1A&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot; \u5DF2\u505C\u7528&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &lt;3&gt; \u521B\u5EFA Spring Security UserDetails \u7528\u6237\u660E\u7EC6</span>
    <span class="token keyword">return</span> <span class="token function">createLoginUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">createLoginUser</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> permissionService<span class="token punctuation">.</span><span class="token function">getMenuPermission</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>&lt;1&gt;</code> \u5904\uFF0C\u8C03\u7528 ISysUserService \u7684 <code>#selectUserByUserName(String userName)</code> \u65B9\u6CD5\uFF0C\u67E5\u8BE2\u6307\u5B9A\u7528\u6237\u540D\u5BF9\u5E94\u7684 SysUser \u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysUserServiceImpl.java</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">SysUserMapper</span> userMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SysUser</span> <span class="token function">selectUserByUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectUserByUserName</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// SysUserMapper.XML</span>
<span class="token operator">&lt;</span>sql id<span class="token operator">=</span><span class="token string">&quot;selectUserVo&quot;</span><span class="token operator">&gt;</span>
    select u<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>dept_id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>user_name<span class="token punctuation">,</span> u<span class="token punctuation">.</span>nick_name<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> u<span class="token punctuation">.</span>avatar<span class="token punctuation">,</span> u<span class="token punctuation">.</span>phonenumber<span class="token punctuation">,</span> u<span class="token punctuation">.</span>password<span class="token punctuation">,</span> u<span class="token punctuation">.</span>sex<span class="token punctuation">,</span> u<span class="token punctuation">.</span>status<span class="token punctuation">,</span> u<span class="token punctuation">.</span>del_flag<span class="token punctuation">,</span> u<span class="token punctuation">.</span>login_ip<span class="token punctuation">,</span> u<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> u<span class="token punctuation">.</span>create_by<span class="token punctuation">,</span> u<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span> u<span class="token punctuation">.</span>remark<span class="token punctuation">,</span>
    d<span class="token punctuation">.</span>dept_id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>parent_id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>dept_name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span> d<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> d<span class="token punctuation">.</span>status as dept_status<span class="token punctuation">,</span>
    r<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>role_name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>role_key<span class="token punctuation">,</span> r<span class="token punctuation">.</span>role_sort<span class="token punctuation">,</span> r<span class="token punctuation">.</span>data_scope<span class="token punctuation">,</span> r<span class="token punctuation">.</span>status as role_status
    from sys_user u
	    left join sys_dept d on u<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>dept_id
	    left join sys_user_role ur on u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> ur<span class="token punctuation">.</span>user_id
	    left join sys_role r on r<span class="token punctuation">.</span>role_id <span class="token operator">=</span> ur<span class="token punctuation">.</span>role_id
<span class="token operator">&lt;</span><span class="token operator">/</span>sql<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;selectUserByUserName&quot;</span> parameterType<span class="token operator">=</span><span class="token string">&quot;String&quot;</span> resultMap<span class="token operator">=</span><span class="token string">&quot;SysUserResult&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectUserVo&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
	where u<span class="token punctuation">.</span>user_name <span class="token operator">=</span> #<span class="token punctuation">{</span>userName<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>\u901A\u8FC7\u67E5\u8BE2 <code>sys_user</code> \u8868\uFF0C\u540C\u65F6\u8FDE\u63A5 <code>sys_dept</code>\u3001<code>sys_user_role</code>\u3001<code>sys_role</code> \u8868\uFF0C\u5C06 <code>username</code> \u5BF9\u5E94\u7684 SysUser \u76F8\u5173\u4FE1\u606F\u90FD\u4E00\u6B21\u6027\u67E5\u8BE2\u51FA\u6765\u3002</p></li><li><p>\u8FD4\u56DE\u7ED3\u679C <code>SysUserResult</code> \uFF0C\u5B9E\u9645\u5C31\u662F SysUser \u5B9E\u4F53\u7C7B\u3002</p></li><li><p><code>&lt;2&gt;</code> \u5904\uFF0C\u5404\u79CD\u6821\u9A8C\u3002\u5982\u679C\u6821\u9A8C\u4E0D\u901A\u8FC7\uFF0C\u629B\u51FA UsernameNotFoundException \u6216 BaseException \u5F02\u5E38\u3002</p></li><li><p><code>&lt;3&gt;</code> \u5904\uFF0C\u8C03\u7528 SysPermissionService \u7684 <code>#getMenuPermission(SysUser user)</code> \u65B9\u6CD5\uFF0C\u83B7\u5F97\u7528\u6237\u7684 SysRoleMenu \u7684\u6743\u9650<strong>\u6807\u8BC6</strong>\u5B57\u7B26\u4E32\u7684\u96C6\u5408\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">// SysPermissionService.java</span>
<span class="token variable">@Autowired</span>
private ISysMenuService menuService<span class="token punctuation">;</span>
  
<span class="token keyword">public</span> <span class="token keyword">Set</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> getMenuPermission<span class="token punctuation">(</span>SysUser <span class="token keyword">user</span><span class="token punctuation">)</span> {
    <span class="token keyword">Set</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> roles <span class="token operator">=</span> new HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u7BA1\u7406\u5458\u62E5\u6709\u6240\u6709\u6743\u9650</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">.</span>isAdmin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
        roles<span class="token punctuation">.</span><span class="token keyword">add</span><span class="token punctuation">(</span><span class="token string">&quot;*:*:*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u6240\u6709\u6A21\u5757</span>
    } <span class="token keyword">else</span> {
        <span class="token comment">// \u8BFB\u53D6</span>
        roles<span class="token punctuation">.</span>addAll<span class="token punctuation">(</span>menuService<span class="token punctuation">.</span>selectMenuPermsByUserId<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">.</span>getUserId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }
    <span class="token keyword">return</span> roles<span class="token punctuation">;</span>
}

<span class="token comment">// SysMenuServiceImpl.java</span>
<span class="token variable">@Autowired</span>
private SysMenuMapper menuMapper<span class="token punctuation">;</span>

<span class="token variable">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">Set</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> selectMenuPermsByUserId<span class="token punctuation">(</span>Long userId<span class="token punctuation">)</span> {
    <span class="token comment">// \u8BFB\u53D6 SysMenu \u7684\u6743\u9650\u6807\u8BC6\u6570\u7EC4</span>
    List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> perms <span class="token operator">=</span> menuMapper<span class="token punctuation">.</span>selectMenuPermsByUserId<span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u9010\u4E2A\uFF0C\u6309\u7167\u201C\u9017\u53F7\u201D\u5206\u9694</span>
    <span class="token keyword">Set</span><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> permsSet <span class="token operator">=</span> new HashSet<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String perm : perms<span class="token punctuation">)</span> {
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">)</span> {
            permsSet<span class="token punctuation">.</span>addAll<span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span>asList<span class="token punctuation">(</span>perm<span class="token punctuation">.</span>trim<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }
    <span class="token keyword">return</span> permsSet<span class="token punctuation">;</span>
}

<span class="token comment">// SysMenuMapper.xml</span>
<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectMenuPermsByUserId&quot;</span> parameterType<span class="token operator">=</span><span class="token string">&quot;Long&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;String&quot;</span><span class="token operator">&gt;</span>
	<span class="token keyword">select</span> <span class="token keyword">distinct</span> m<span class="token punctuation">.</span>perms
	<span class="token keyword">from</span> sys_menu m
		 <span class="token keyword">left</span> <span class="token keyword">join</span> sys_role_menu rm <span class="token keyword">on</span> m<span class="token punctuation">.</span>menu_id <span class="token operator">=</span> rm<span class="token punctuation">.</span>menu_id
		 <span class="token keyword">left</span> <span class="token keyword">join</span> sys_user_role ur <span class="token keyword">on</span> rm<span class="token punctuation">.</span>role_id <span class="token operator">=</span> ur<span class="token punctuation">.</span>role_id
	<span class="token keyword">where</span> ur<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token comment">#{userId}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u867D\u7136\u4EE3\u7801\u5F88\u957F\uFF0C\u4F46\u662F\u6838\u5FC3\u7684\u5E76\u4E0D\u591A\u3002</li><li>\u9996\u5148\uFF0C\u5982\u679C SysUser \u662F\u8D85\u7EA7\u7BA1\u7406\u5458\uFF0C\u5219\u5176\u6743\u9650\u6807\u8BC6\u96C6\u5408\u5C31\u662F <code>*:*:*</code> \uFF0C\u6807\u8BC6\u53EF\u4EE5\u6240\u6709\u6A21\u5757\u7684\u6240\u6709\u64CD\u4F5C\u3002</li><li>\u7136\u540E\uFF0C\u67E5\u8BE2 <code>sys_menu</code> \u8868\uFF0C\u540C\u65F6\u8FDE\u63A5 <code>sys_role_menu</code>\u3001<code>sys_user_role</code> \u8868\uFF0C\u5C06 SysUser \u62E5\u6709\u7684 SysMenu \u7684\u6743\u9650\u6807\u8BC6\u6570\u7EC4\uFF0C\u7136\u540E\u4F7F\u7528 <code>&quot;,&quot;</code> \u5206\u9694\u6BCF\u4E2A SysMenu \u5BF9\u5E94\u7684\u6743\u9650\u6807\u8BC6\u3002</li></ul></li></ul><p>\u8FD9\u91CC\uFF0C\u6211\u4EEC\u770B\u5230\u6700\u7EC8\u8FD4\u56DE\u7684\u662F LoginUser \uFF0C\u5B9E\u73B0 Spring Security UserDetails \u63A5\u53E3\uFF0C\u81EA\u5B9A\u4E49\u7684\u7528\u6237\u660E\u7EC6\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// LoginUser.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUser</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span>
   
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7528\u6237\u552F\u4E00\u6807\u8BC6 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> token<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u767B\u5F55\u65F6\u95F4 */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> loginTime<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u8FC7\u671F\u65F6\u95F4 */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> expireTime<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u767B\u5F55IP\u5730\u5740 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ipaddr<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u767B\u5F55\u5730\u70B9 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginLocation<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u6D4F\u89C8\u5668\u7C7B\u578B */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> browser<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u64CD\u4F5C\u7CFB\u7EDF */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> os<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u6743\u9650\u5217\u8868 */</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** \u7528\u6237\u4FE1\u606F */</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUser</span> user<span class="token punctuation">;</span>
    
    <span class="token comment">// ...\u7701\u7565 set/get \u65B9\u6CD5\uFF0C\u4EE5\u53CA\u5404\u79CD\u5B9E\u73B0\u65B9\u6CD5</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-\u521B\u5EFA\u8BA4\u8BC1-token" tabindex="-1"><a class="header-anchor" href="#_5-\u521B\u5EFA\u8BA4\u8BC1-token" aria-hidden="true">#</a> 5. \u521B\u5EFA\u8BA4\u8BC1 Token</h2><p>\u5728 <code>TokenService</code> \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#createToken(LoginUser loginUser)</code> \u65B9\u6CD5\uFF0C\u7ED9\u8BA4\u8BC1\u901A\u8FC7\u7684\u7528\u6237\uFF0C\u751F\u6210\u5176\u5BF9\u5E94\u7684\u8BA4\u8BC1 Token \u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// TokenService.java</span>

<span class="token doc-comment comment">/**
 * \u521B\u5EFA\u4EE4\u724C
 *
 * <span class="token keyword">@param</span> <span class="token parameter">loginUser</span> \u7528\u6237\u4FE1\u606F
 * <span class="token keyword">@return</span> \u4EE4\u724C
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &lt;1&gt; \u8BBE\u7F6E LoginUser \u7684\u7528\u6237\u552F\u4E00\u6807\u8BC6\u3002\u6CE8\u610F\uFF0C\u8FD9\u91CC\u867D\u7136\u53D8\u91CF\u540D\u53EB token \uFF0C\u5176\u5B9E\u4E0D\u662F\u8EAB\u4EFD\u8BA4\u8BC1\u7684 Token</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">IdUtils</span><span class="token punctuation">.</span><span class="token function">fastUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;2&gt; \u8BBE\u7F6E\u7528\u6237\u7EC8\u7AEF\u76F8\u5173\u7684\u4FE1\u606F\uFF0C\u5305\u62EC IP\u3001\u57CE\u5E02\u3001\u6D4F\u89C8\u5668\u3001\u64CD\u4F5C\u7CFB\u7EDF</span>
    <span class="token function">setUserAgent</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &lt;3&gt; \u8BB0\u5F55\u7F13\u5B58</span>
    <span class="token function">refreshToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// &lt;4&gt; \u751F\u6210 JWT \u7684 Token</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">createToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>\u6CE8\u610F\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u4E0D\u4EC5\u4EC5\u4F1A\u751F\u6210\u8BA4\u8BC1 Token \uFF0C\u8FD8\u4F1A\u7F13\u5B58 LoginUser \u5230 Redis \u7F13\u5B58\u4E2D\u3002</p></li><li><p><code>&lt;1&gt;</code> \u5904\uFF0C\u8BBE\u7F6E LoginUser \u7684\u7528\u6237\u552F\u4E00\u6807\u8BC6\uFF0C\u5373 <code>LoginUser.token</code>\u3002\u6CE8\u610F\uFF0C\u8FD9\u91CC\u867D\u7136\u53D8\u91CF\u540D\u53EB <code>token</code> \uFF0C\u5176\u5B9E\u4E0D\u662F\u8EAB\u4EFD\u8BA4\u8BC1\u7684 Token \u3002</p></li><li><p><code>&lt;2&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>#setUserAgent(LoginUser loginUser)</code> \u65B9\u6CD5\uFF0C\u8BBE\u7F6E\u7528\u6237\u7EC8\u7AEF\u76F8\u5173\u7684\u4FE1\u606F\uFF0C\u5305\u62EC IP\u3001\u57CE\u5E02\u3001\u6D4F\u89C8\u5668\u3001\u64CD\u4F5C\u7CFB\u7EDF\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// TokenService.java</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserAgent</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserAgent</span> userAgent <span class="token operator">=</span> <span class="token class-name">UserAgent</span><span class="token punctuation">.</span><span class="token function">parseUserAgentString</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getIpAddr</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setIpaddr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setLoginLocation</span><span class="token punctuation">(</span><span class="token class-name">AddressUtils</span><span class="token punctuation">.</span><span class="token function">getRealAddressByIP</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setBrowser</span><span class="token punctuation">(</span>userAgent<span class="token punctuation">.</span><span class="token function">getBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setOs</span><span class="token punctuation">(</span>userAgent<span class="token punctuation">.</span><span class="token function">getOperatingSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>&lt;3&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>#refreshToken(LoginUser loginUser)</code> \u65B9\u6CD5\uFF0C\u7F13\u5B58 LoginUser \u5230 Redis \u7F13\u5B58\u4E2D\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// application.yaml</span>
# token\u914D\u7F6E
token<span class="token operator">:</span>
    # \u4EE4\u724C\u6709\u6548\u671F\uFF08\u9ED8\u8BA4<span class="token number">30</span>\u5206\u949F\uFF09
    expireTime<span class="token operator">:</span> <span class="token number">30</span>

<span class="token comment">// Constants.java</span>
<span class="token doc-comment comment">/**
 * \u767B\u5F55\u7528\u6237 redis key
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LOGIN_TOKEN_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;login_tokens:&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// TokenService.java</span>
<span class="token comment">// \u4EE4\u724C\u6709\u6548\u671F\uFF08\u9ED8\u8BA430\u5206\u949F\uFF09</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${token.expireTime}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> expireTime<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisCache</span> redisCache<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setLoginTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginUser<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getLoginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expireTime <span class="token operator">*</span> <span class="token constant">MILLIS_MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u6839\u636E uuid \u5C06 loginUser \u7F13\u5B58</span>
    <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token function">getTokenKey</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisCache<span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span> loginUser<span class="token punctuation">,</span> expireTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getTokenKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_TOKEN_KEY</span> <span class="token operator">+</span> uuid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u7F13\u5B58\u7684 Redis Key \u7684<strong>\u7EDF\u4E00\u524D\u7F00</strong>\u4E3A <code>&quot;login_tokens:&quot;</code> \uFF0C\u4F7F\u7528 Login \u7684\u7528\u6237\u552F\u4E00\u6807\u8BC6(<code>LoginUser.token</code>)\u4F5C\u4E3A<strong>\u540E\u7F00</strong>\u3002</li></ul></li><li><p><code>&lt;4&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>#createToken(Map&lt;String, Object&gt; claims)</code> \u65B9\u6CD5\uFF0C\u751F\u6210 JWT \u7684 Token \u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// application.yaml</span>
# token\u914D\u7F6E
token<span class="token operator">:</span>
    # \u4EE4\u724C\u79D8\u94A5
    secret<span class="token operator">:</span> abcdefghijklmnopqrstuvwxyz
    
<span class="token comment">// TokenService.java</span>
<span class="token comment">// \u4EE4\u724C\u79D8\u94A5</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${token.secret}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS512</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0D\u8981\u628A\u8FD9\u91CC\u751F\u6210\u7684 JWT \u7684 Token \uFF0C\u548C\u6211\u4EEC\u4E0A\u9762\u7684 <code>LoginUser.token</code> \u6DF7\u6DC6\u5728\u4E00\u8D77\u3002</p><ul><li>\u56E0\u4E3A <code>LoginUser.token</code> \u6DFB\u52A0\u5230 <code>claims</code> \u4E2D\uFF0C\u6700\u7EC8\u751F\u6210\u4E86 JWT \u7684 Token \u3002\u6240\u4EE5\uFF0C\u540E\u7EED\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u89E3\u7801\u8BE5 JWT \u7684 Token \uFF0C\u4ECE\u800C\u83B7\u5F97 <code>claims</code> \uFF0C\u6700\u7EC8\u83B7\u5F97\u5230\u5BF9\u5E94\u7684 <code>LoginUser.token</code> \u3002</li><li>\u5728 JWT \u7684 Token \u4E2D\uFF0C\u4F7F\u7528 <code>LoginUser.token</code> \u800C\u4E0D\u662F <code>userId</code> \u7684\u597D\u5904\uFF0C\u53EF\u4EE5\u5E26\u6765\u66F4\u597D\u7684\u5B89\u5168\u6027\uFF0C\u907F\u514D\u4E07\u4E00 <code>secret</code> \u79D8\u94A5\u6CC4\u9732\u4E4B\u540E\uFF0C\u9ED1\u5BA2\u53EF\u4EE5\u987A\u5E8F\u751F\u6210 <code>userId</code> \u4ECE\u800C\u751F\u6210\u5BF9\u5E94\u7684 JWT \u7684 Token \uFF0C\u540E\u7EED\u76F4\u63A5\u53EF\u4EE5\u64CD\u4F5C\u8BE5\u7528\u6237\u7684\u6570\u636E\u3002\u4E0D\u8FC7\uFF0C\u8FD9\u4E48\u505A\u4E4B\u540E\u5C31\u4E0D\u662F<strong>\u7EAF\u7CB9</strong>\u7684 JWT \uFF0C\u89E3\u6790\u51FA\u6765\u7684 <code>LoginUser.token</code> \u9700\u8981\u67E5\u8BE2\u5BF9\u5E94\u7684 LoginUser \u7684 Redis \u7F13\u5B58\u3002</li></ul></li></ul><h3 id="_5-1-jwtauthenticationtokenfilter" tabindex="-1"><a class="header-anchor" href="#_5-1-jwtauthenticationtokenfilter" aria-hidden="true">#</a> 5.1 JwtAuthenticationTokenFilter</h3><p>JwtAuthenticationTokenFilter \u4E2D\uFF0C\u7EE7\u627F OncePerRequestFilter \u8FC7\u6EE4\u5668\uFF0C\u5B9E\u73B0\u4E86\u57FA\u4E8E Token \u7684\u8BA4\u8BC1\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// JwtAuthenticationTokenFilter.java</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenService</span> tokenService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;1&gt; \u83B7\u5F97\u5F53\u524D LoginUser</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5982\u679C\u5B58\u5728 LoginUser \uFF0C\u5E76\u4E14\u672A\u8BA4\u8BC1\u8FC7</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// &lt;2&gt; \u6821\u9A8C Token \u6709\u6548\u6027</span>
            tokenService<span class="token punctuation">.</span><span class="token function">verifyToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// &lt;3&gt; \u521B\u5EFA UsernamePasswordAuthenticationToken \u5BF9\u8C61\uFF0C\u8BBE\u7F6E\u5230 SecurityContextHolder \u4E2D</span>
            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authenticationToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            authenticationToken<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &lt;4&gt; \u7EE7\u7EED\u8FC7\u6EE4\u5668</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>&lt;1&gt;</code> \u5904\uFF0C\u8C03\u7528 TokenService \u7684 <code>#getLoginUser(request)</code> \u65B9\u6CD5\uFF0C\u83B7\u5F97\u5F53\u524D LoginUser \u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// application.yaml</span>
# token\u914D\u7F6E
token<span class="token operator">:</span>
    # \u4EE4\u724C\u81EA\u5B9A\u4E49\u6807\u8BC6
    header<span class="token operator">:</span> <span class="token class-name">Authorization</span>

<span class="token comment">// TokenService.jav</span>
<span class="token comment">// \u4EE4\u724C\u81EA\u5B9A\u4E49\u6807\u8BC6</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${token.header}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> header<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u83B7\u53D6\u7528\u6237\u8EAB\u4EFD\u4FE1\u606F
 *
 * <span class="token keyword">@return</span> \u7528\u6237\u4FE1\u606F
 */</span>
<span class="token keyword">public</span> <span class="token class-name">LoginUser</span> <span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &lt;1.1&gt; \u83B7\u53D6\u8BF7\u6C42\u643A\u5E26\u7684\u4EE4\u724C</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;1.2&gt; \u89E3\u6790 JWT \u7684 Token</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &lt;1.3&gt; \u4ECE Redis \u7F13\u5B58\u4E2D\uFF0C\u83B7\u5F97\u5BF9\u5E94\u7684 LoginUser</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token function">getTokenKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisCache<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TOKEN_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        token <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TOKEN_PREFIX</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Claims</span> <span class="token function">parseToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>&lt;1.1&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>#getToken(request)</code> \u65B9\u6CD5\uFF0C\u4ECE\u8BF7\u6C42\u5934 <code>&quot;Authorization&quot;</code> \u4E2D\uFF0C\u83B7\u5F97\u8EAB\u4EFD\u8BA4\u8BC1\u7684 Token \u3002</li><li><code>&lt;1.2&gt;</code> \u5904\uFF0C\u8C03\u7528 <code>#parseToken(token)</code> \u65B9\u6CD5\uFF0C\u89E3\u6790 JWT \u7684 Token \uFF0C\u83B7\u5F97 Claims \u5BF9\u8C61\uFF0C\u4ECE\u800C\u83B7\u5F97\u7528\u6237\u552F\u4E00\u6807\u8BC6(<code>LoginUser.token</code>)\u3002</li><li><code>&lt;1.3&gt;</code> \u5904\uFF0C\u4ECE Redis \u7F13\u5B58\u4E2D\uFF0C\u83B7\u5F97\u5BF9\u5E94\u7684 LoginUser \u3002</li></ul></li><li><p><code>&lt;2&gt;</code> \u5904\uFF0C\u8C03\u7528 TokenService \u7684 <code>#verifyToken(LoginUser loginUser)</code> \u65B9\u6CD5\uFF0C\u9A8C\u8BC1\u4EE4\u724C\u6709\u6548\u671F\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// TokenService.java</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">MILLIS_SECOND</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">MILLIS_MINUTE</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token constant">MILLIS_SECOND</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">MILLIS_MINUTE_TEN</span> <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u9A8C\u8BC1\u4EE4\u724C\u6709\u6548\u671F\uFF0C\u76F8\u5DEE\u4E0D\u8DB3 20 \u5206\u949F\uFF0C\u81EA\u52A8\u5237\u65B0\u7F13\u5B58
 *
 * <span class="token keyword">@param</span> <span class="token parameter">loginUser</span> \u7528\u6237
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> expireTime <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u76F8\u5DEE\u4E0D\u8DB3 20 \u5206\u949F\uFF0C\u81EA\u52A8\u5237\u65B0\u7F13\u5B58</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime <span class="token operator">-</span> currentTime <span class="token operator">&lt;=</span> <span class="token constant">MILLIS_MINUTE_TEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">refreshToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><ul><li>\u5B9E\u9645\u4E0A\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u7684\u76EE\u7684\u4E0D\u662F\u9A8C\u8BC1 Token \u7684\u6709\u6548\u6027\uFF0C\u800C\u662F\u5237\u65B0\u5BF9\u5E94\u7684 LoginUser \u7684\u7F13\u5B58\u7684\u8FC7\u671F\u65F6\u95F4\u3002</li><li>\u8003\u8651\u5230\u907F\u514D\u6BCF\u6B21\u8BF7\u6C42\u90FD\u53BB\u5237\u65B0\u7F13\u5B58\u7684\u8FC7\u671F\u65F6\u95F4\uFF0C\u6240\u4EE5\u8FC7\u671F\u65F6\u95F4\u4E0D\u8DB3 20 \u5206\u949F\uFF0C\u624D\u4F1A\u53BB\u5237\u65B0\u3002</li></ul></li><li><code>&lt;3&gt;</code> \u5904\uFF0C<strong>\u624B\u52A8</strong>\u521B\u5EFA UsernamePasswordAuthenticationToken \u5BF9\u8C61\uFF0C\u8BBE\u7F6E\u5230 SecurityContextHolder \u4E2D\u3002\u{1F608} \u56E0\u4E3A\uFF0C\u6211\u4EEC\u5DF2\u7ECF\u901A\u8FC7 Token \u6765\u5B8C\u6210\u8BA4\u8BC1\u4E86\u3002</li><li><code>&lt;4&gt;</code> \u5904\uFF0C\u7EE7\u7EED\u8FC7\u6EE4\u5668\u3002</li></ul><p>\u4E25\u683C\u6765\u8BF4\uFF0CRuoYi-Vue \u5E76\u4E0D\u662F\u91C7\u7528\u7684<strong>\u65E0\u72B6\u6001</strong>\u7684 JWT \uFF0C\u800C\u662F\u4F7F\u7528 JWT \u7684 Token \u7684\u751F\u6210\u65B9\u5F0F</p></li></ul><h2 id="_6-\u6743\u9650\u9A8C\u8BC1" tabindex="-1"><a class="header-anchor" href="#_6-\u6743\u9650\u9A8C\u8BC1" aria-hidden="true">#</a> 6. \u6743\u9650\u9A8C\u8BC1</h2><p>\u6211\u4EEC\u770B\u5230\u53EF\u4EE5\u901A\u8FC7 Spring Security \u63D0\u4F9B\u7684 <code>@PreAuthorize</code> \u6CE8\u89E3\uFF0C\u5B9E\u73B0\u57FA\u4E8E Spring EL \u8868\u8FBE\u5F0F\u7684\u6267\u884C\u7ED3\u679C\u4E3A <code>true</code> \u65F6\uFF0C\u53EF\u4EE5\u8BBF\u95EE\uFF0C\u4ECE\u800C\u5B9E\u73B0\u7075\u6D3B\u7684\u6743\u9650\u6821\u9A8C\u3002</p><p>\u5728 RuoYi-Vue \u4E2D\uFF0C\u901A\u8FC7 <code>@PreAuthorize</code> \u6CE8\u89E3\u7684\u7279\u6027\uFF0C\u4F7F\u7528\u5176 PermissionService \u63D0\u4F9B\u7684\u6743\u9650\u9A8C\u8BC1\u7684\u65B9\u6CD5\u3002\u4F7F\u7528\u793A\u4F8B\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysDictDataController.java</span>

<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;@ss.hasPermi(&#39;system:dict:list&#39;)&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8BF7\u6C42 <code>/system/dict/data/list</code> \u63A5\u53E3\uFF0C\u4F1A\u8C03\u7528 PermissionService \u7684 <code>#hasPermi(String permission)</code> \u65B9\u6CD5\uFF0C\u6821\u9A8C\u7528\u6237\u662F\u5426\u6709\u6307\u5B9A\u7684\u6743\u9650\u3002</li><li>\u4E3A\u4EC0\u4E48\u8FD9\u91CC\u4F1A\u6709\u4E00\u4E2A <code>@ss</code> \u5462\uFF1F\u5728 Spring EL \u8868\u8FBE\u5F0F\u4E2D\uFF0C\u8C03\u7528\u6307\u5B9A Bean \u540D\u5B57\u7684\u65B9\u6CD5\u65F6\uFF0C\u4F7F\u7528 <code>@</code> + Bean \u7684\u540D\u5B57\u3002\u5728 RuoYi-Vue \u4E2D\uFF0C\u58F0\u660E PermissionService \u7684 Bean \u540D\u5B57\u4E3A <code>ss</code> \u3002</li></ul><h3 id="_6-1-\u5224\u65AD\u662F\u5426\u6709\u6743\u9650" tabindex="-1"><a class="header-anchor" href="#_6-1-\u5224\u65AD\u662F\u5426\u6709\u6743\u9650" aria-hidden="true">#</a> 6.1 \u5224\u65AD\u662F\u5426\u6709\u6743\u9650</h3><p>\u5728 PermissionService \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#hasPermi(String permission)</code> \u65B9\u6CD5\uFF0C\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426<strong>\u6709</strong>\u6307\u5B9A\u7684\u6743\u9650\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// PermissionService.java</span>

<span class="token doc-comment comment">/**
 * \u6240\u6709\u6743\u9650\u6807\u8BC6
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ALL_PERMISSION</span> <span class="token operator">=</span> <span class="token string">&quot;*:*:*&quot;</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">TokenService</span> tokenService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u9A8C\u8BC1\u7528\u6237\u662F\u5426\u5177\u5907\u67D0\u6743\u9650
 *
 * <span class="token keyword">@param</span> <span class="token parameter">permission</span> \u6743\u9650\u5B57\u7B26\u4E32
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u5177\u5907\u67D0\u6743\u9650
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermi</span><span class="token punctuation">(</span><span class="token class-name">String</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5982\u679C\u672A\u8BBE\u7F6E\u9700\u8981\u7684\u6743\u9650\uFF0C\u5F3A\u5236\u4E0D\u5177\u5907\u3002</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u83B7\u5F97\u5F53\u524D LoginUser</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u5982\u679C\u4E0D\u5B58\u5728\uFF0C\u6216\u8005\u6CA1\u6709\u4EFB\u4F55\u6743\u9650\uFF0C\u8BF4\u660E\u6743\u9650\u9A8C\u8BC1\u4E0D\u901A\u8FC7</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u5224\u65AD\u662F\u5426\u5305\u542B\u6743\u9650</span>
    <span class="token keyword">return</span> <span class="token function">hasPermissions</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u5224\u65AD\u662F\u5426\u5305\u542B\u6743\u9650
 *
 * <span class="token keyword">@param</span> <span class="token parameter">permissions</span> \u6743\u9650\u5217\u8868
 * <span class="token keyword">@param</span> <span class="token parameter">permission</span>  \u6743\u9650\u5B57\u7B26\u4E32
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u5177\u5907\u67D0\u6743\u9650
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasPermissions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions<span class="token punctuation">,</span> <span class="token class-name">String</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">ALL_PERMISSION</span><span class="token punctuation">)</span> <span class="token operator">||</span> permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 PermissionService \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#lacksPermi(String permission)</code> \u65B9\u6CD5\uFF0C\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426<strong>\u6CA1\u6709</strong>\u6307\u5B9A\u7684\u6743\u9650\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// PermissionService.java</span>

<span class="token doc-comment comment">/**
 * \u9A8C\u8BC1\u7528\u6237\u662F\u5426\u4E0D\u5177\u5907\u67D0\u6743\u9650\uFF0C\u4E0E hasPermi\u903B\u8F91\u76F8\u53CD
 *
 * <span class="token keyword">@param</span> <span class="token parameter">permission</span> \u6743\u9650\u5B57\u7B26\u4E32
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u4E0D\u5177\u5907\u67D0\u6743\u9650
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lacksPermi</span><span class="token punctuation">(</span><span class="token class-name">String</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">hasPermi</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 PermissionService \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#hasAnyPermi(String permissions)</code> \u65B9\u6CD5\uFF0C\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426<strong>\u6709</strong>\u6307\u5B9A\u7684<strong>\u4EFB\u4E00</strong>\u6743\u9650\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// PermissionService.java</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PERMISSION_DELIMETER</span> <span class="token operator">=</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u9A8C\u8BC1\u7528\u6237\u662F\u5426\u5177\u6709\u4EE5\u4E0B\u4EFB\u610F\u4E00\u4E2A\u6743\u9650
 *
 * <span class="token keyword">@param</span> <span class="token parameter">permissions</span> \u4EE5 PERMISSION_NAMES_DELIMETER \u4E3A\u5206\u9694\u7B26\u7684\u6743\u9650\u5217\u8868
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u5177\u6709\u4EE5\u4E0B\u4EFB\u610F\u4E00\u4E2A\u6743\u9650
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasAnyPermi</span><span class="token punctuation">(</span><span class="token class-name">String</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5982\u679C\u672A\u8BBE\u7F6E\u9700\u8981\u7684\u6743\u9650\uFF0C\u5F3A\u5236\u4E0D\u5177\u5907\u3002</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u83B7\u5F97\u5F53\u524D LoginUser</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u5982\u679C\u4E0D\u5B58\u5728\uFF0C\u6216\u8005\u6CA1\u6709\u4EFB\u4F55\u6743\u9650\uFF0C\u8BF4\u660E\u6743\u9650\u9A8C\u8BC1\u4E0D\u901A\u8FC7</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u5224\u65AD\u662F\u5426\u5305\u542B\u6307\u5B9A\u7684\u4EFB\u4E00\u6743\u9650</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> permission <span class="token operator">:</span> permissions<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">PERMISSION_DELIMETER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasPermissions</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> permission<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-\u5224\u65AD\u662F\u5426\u6709\u89D2\u8272" tabindex="-1"><a class="header-anchor" href="#_6-2-\u5224\u65AD\u662F\u5426\u6709\u89D2\u8272" aria-hidden="true">#</a> 6.2 \u5224\u65AD\u662F\u5426\u6709\u89D2\u8272</h3><p>\u5728 PermissionService \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#hasRole(String role)</code> \u65B9\u6CD5\uFF0C\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426<strong>\u6709</strong>\u6307\u5B9A\u7684\u89D2\u8272\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// PermissionService.java</span>

<span class="token doc-comment comment">/**
 * \u5224\u65AD\u7528\u6237\u662F\u5426\u62E5\u6709\u67D0\u4E2A\u89D2\u8272
 *
 * <span class="token keyword">@param</span> <span class="token parameter">role</span> \u89D2\u8272\u5B57\u7B26\u4E32
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u5177\u5907\u67D0\u89D2\u8272
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5982\u679C\u672A\u8BBE\u7F6E\u9700\u8981\u7684\u89D2\u8272\uFF0C\u5F3A\u5236\u4E0D\u5177\u5907\u3002</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u83B7\u5F97\u5F53\u524D LoginUser</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u5982\u679C\u4E0D\u5B58\u5728\uFF0C\u6216\u8005\u6CA1\u6709\u4EFB\u4F55\u89D2\u8272\uFF0C\u8BF4\u660E\u6743\u9650\u9A8C\u8BC1\u4E0D\u901A\u8FC7</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u5224\u65AD\u662F\u5426\u5305\u542B\u6307\u5B9A\u89D2\u8272</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysRole</span> sysRole <span class="token operator">:</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> roleKey <span class="token operator">=</span> sysRole<span class="token punctuation">.</span><span class="token function">getRoleKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SUPER_ADMIN</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>roleKey<span class="token punctuation">)</span> <span class="token comment">// \u8D85\u7EA7\u7BA1\u7406\u5458\u7684\u7279\u6B8A\u5904\u7406</span>
                <span class="token operator">||</span> roleKey<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 PermissionService \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#lacksRole(String role)</code> \u65B9\u6CD5\uFF0C\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426<strong>\u6CA1\u6709</strong>\u6307\u5B9A\u7684\u89D2\u8272\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// PermissionService.java</span>

<span class="token doc-comment comment">/**
 * \u9A8C\u8BC1\u7528\u6237\u662F\u5426\u4E0D\u5177\u5907\u67D0\u89D2\u8272\uFF0C\u4E0E isRole\u903B\u8F91\u76F8\u53CD\u3002
 *
 * <span class="token keyword">@param</span> <span class="token parameter">role</span> \u89D2\u8272\u540D\u79F0
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u4E0D\u5177\u5907\u67D0\u89D2\u8272
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lacksRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">hasRole</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 PermissionService \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>#hasAnyRoles(String roles)</code> \u65B9\u6CD5\uFF0C\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426<strong>\u6709</strong>\u6307\u5B9A\u7684<strong>\u4EFB\u4E00</strong>\u89D2\u8272\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// PermissionService.java</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROLE_DELIMETER</span> <span class="token operator">=</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u9A8C\u8BC1\u7528\u6237\u662F\u5426\u5177\u6709\u4EE5\u4E0B\u4EFB\u610F\u4E00\u4E2A\u89D2\u8272
 *
 * <span class="token keyword">@param</span> <span class="token parameter">roles</span> \u4EE5 ROLE_NAMES_DELIMETER \u4E3A\u5206\u9694\u7B26\u7684\u89D2\u8272\u5217\u8868
 * <span class="token keyword">@return</span> \u7528\u6237\u662F\u5426\u5177\u6709\u4EE5\u4E0B\u4EFB\u610F\u4E00\u4E2A\u89D2\u8272
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasAnyRoles</span><span class="token punctuation">(</span><span class="token class-name">String</span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5982\u679C\u672A\u8BBE\u7F6E\u9700\u8981\u7684\u89D2\u8272\uFF0C\u5F3A\u5236\u4E0D\u5177\u5907\u3002</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u83B7\u5F97\u5F53\u524D LoginUser</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u5982\u679C\u4E0D\u5B58\u5728\uFF0C\u6216\u8005\u6CA1\u6709\u4EFB\u4F55\u89D2\u8272\uFF0C\u8BF4\u660E\u6743\u9650\u9A8C\u8BC1\u4E0D\u901A\u8FC7</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u5224\u65AD\u662F\u5426\u5305\u542B\u6307\u5B9A\u7684\u4EFB\u4E00\u89D2\u8272</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> role <span class="token operator">:</span> roles<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">ROLE_DELIMETER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasRole</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u8FD9\u91CC\u5B9E\u73B0\u6709\u70B9\u95EE\u9898\uFF0C\u4F1A\u5FAA\u73AF\u8C03\u7528 hasRole \u65B9\u6CD5\uFF0C\u91CD\u590D\u4ECE Redis \u4E2D\u8BFB\u53D6\u5F53\u524D LoginUser</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-\u5404\u79CD\u5904\u7406\u5668" tabindex="-1"><a class="header-anchor" href="#_7-\u5404\u79CD\u5904\u7406\u5668" aria-hidden="true">#</a> 7. \u5404\u79CD\u5904\u7406\u5668</h2><p>\u5728 Ruoyi-Vue \u4E2D\uFF0C\u63D0\u4F9B\u4E86\u5404\u79CD\u5904\u7406\u5668\uFF0C\u5904\u7406\u5404\u79CD\u60C5\u51B5</p><h3 id="_7-1-authenticationentrypointimpl" tabindex="-1"><a class="header-anchor" href="#_7-1-authenticationentrypointimpl" aria-hidden="true">#</a> 7.1 AuthenticationEntryPointImpl</h3><p>\u5728 AuthenticationEntryPointImpl \u4E2D\uFF0C\u5B9E\u73B0 Spring Security AuthenticationEntryPoint \u63A5\u53E3\uFF0C\u5904\u7406\u8BA4\u5931\u8D25\u7684 AuthenticationException \u5F02\u5E38\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// AuthenticationEntryPointImpl.java</span>

<span class="token comment">// \u8BA4\u8BC1\u5931\u8D25\u5904\u7406\u7C7B \u8FD4\u56DE\u672A\u6388\u6743</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationEntryPointImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8970718410437077606L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u54CD\u5E94\u8BA4\u8BC1\u4E0D\u901A\u8FC7</span>
        <span class="token keyword">int</span> code <span class="token operator">=</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BF7\u6C42\u8BBF\u95EE\uFF1A{}\uFF0C\u8BA4\u8BC1\u5931\u8D25\uFF0C\u65E0\u6CD5\u8BBF\u95EE\u7CFB\u7EDF\u8D44\u6E90&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u54CD\u5E94\u8BA4\u8BC1\u4E0D\u901A\u8FC7\u7684 JSON \u5B57\u7B26\u4E32\u3002</li></ul><h3 id="_6-2-globalexceptionhandler" tabindex="-1"><a class="header-anchor" href="#_6-2-globalexceptionhandler" aria-hidden="true">#</a> 6.2 GlobalExceptionHandler</h3><p>\u5728 GlobalExceptionHandler \u4E2D\uFF0C\u5B9A\u4E49\u4E86\u5BF9 Spring Security \u7684\u5F02\u5E38\u5904\u7406\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// GlobalExceptionHandler.java</span>

<span class="token annotation punctuation">@RestControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionHandler</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// \u6CA1\u6709\u8BBF\u95EE\u6743\u9650\u3002\u4F7F\u7528 @PreAuthorize \u6821\u9A8C\u6743\u9650\u4E0D\u901A\u8FC7\u65F6\uFF0C\u5C31\u4F1A\u629B\u51FA AccessDeniedException \u5F02\u5E38</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">handleAuthorizationException</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">,</span> <span class="token string">&quot;\u6CA1\u6709\u6743\u9650\uFF0C\u8BF7\u8054\u7CFB\u7BA1\u7406\u5458\u6388\u6743&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">AccountExpiredException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// \u8D26\u53F7\u5DF2\u8FC7\u671F</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">handleAccountExpiredException</span><span class="token punctuation">(</span><span class="token class-name">AccountExpiredException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// \u7528\u6237\u540D\u4E0D\u5B58\u5728</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">handleUsernameNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... \u7701\u7565\u5BF9\u5176\u5B83\u7684\u5F02\u5E38\u7C7B\u7684\u5904\u7406\u7684\u65B9\u6CD5</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u57FA\u4E8E Spring MVC \u63D0\u4F9B\u7684 <code>@RestControllerAdvice</code> + <code>@ExceptionHandler</code> \u6CE8\u89E3\uFF0C\u5B9E\u73B0\u5168\u5C40\u5F02\u5E38\u7684\u5904\u7406\u3002</li></ul><h3 id="_7-3-logoutsuccesshandlerimpl" tabindex="-1"><a class="header-anchor" href="#_7-3-logoutsuccesshandlerimpl" aria-hidden="true">#</a> 7.3 LogoutSuccessHandlerImpl</h3><p>\u5728 LogoutSuccessHandlerImpl \u4E2D\uFF0C\u5B9E\u73B0 Spring Security LogoutSuccessHandler \u63A5\u53E3\uFF0C\u81EA\u5B9A\u4E49\u9000\u51FA\u7684\u5904\u7406\uFF0C\u4E3B\u52A8\u5220\u9664 LoginUser \u5728 Redis \u4E2D\u7684\u7F13\u5B58\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// LogoutSuccessHandlerImpl.java</span>

<span class="token comment">// \u81EA\u5B9A\u4E49\u9000\u51FA\u5904\u7406\u7C7B \u8FD4\u56DE\u6210\u529F</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogoutSuccessHandlerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenService</span> tokenService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u9000\u51FA\u5904\u7406
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;1&gt; \u83B7\u5F97\u5F53\u524D LoginUser</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5982\u679C\u6709\u767B\u5F55\u7684\u60C5\u51B5\u4E0B</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> userName <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// &lt;2&gt; \u5220\u9664\u7528\u6237\u7F13\u5B58\u8BB0\u5F55</span>
            tokenService<span class="token punctuation">.</span><span class="token function">delLoginUser</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// &lt;3&gt; \u8BB0\u5F55\u7528\u6237\u9000\u51FA\u65E5\u5FD7</span>
            <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGOUT</span><span class="token punctuation">,</span> <span class="token string">&quot;\u9000\u51FA\u6210\u529F&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &lt;4&gt; \u54CD\u5E94\u9000\u51FA\u6210\u529F</span>
        <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">,</span> <span class="token string">&quot;\u9000\u51FA\u6210\u529F&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>&lt;1&gt;</code> \u5904\uFF0C\u8C03\u7528 TokenService \u7684 <code>#getLoginUser(request)</code> \u65B9\u6CD5\uFF0C\u83B7\u5F97\u5F53\u524D LoginUser \u3002</p></li><li><p><code>&lt;2&gt;</code> \u5904\uFF0C\u8C03\u7528 TokenService \u7684 <code>#delLoginUser(String token)</code> \u65B9\u6CD5\uFF0C\u5220\u9664 LoginUser \u7684 Redis \u7F13\u5B58\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// TokenService.java</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delLoginUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token function">getTokenKey</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5220\u9664\u7F13\u5B58</span>
        redisCache<span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>&lt;3&gt;</code> \u5904\uFF0C\u8BB0\u5F55\u76F8\u5E94\u7684\u9000\u51FA\u6210\u529F\u65E5\u5FD7\u3002</p></li><li><p><code>&lt;4&gt;</code> \u5904\uFF0C\u54CD\u5E94\u9000\u51FA\u6210\u529F\u7684 JSON \u5B57\u7B26\u4E32\u3002</p></li></ul><h2 id="_8-\u83B7\u5F97\u7528\u6237\u4FE1\u606F-api-\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_8-\u83B7\u5F97\u7528\u6237\u4FE1\u606F-api-\u63A5\u53E3" aria-hidden="true">#</a> 8. \u83B7\u5F97\u7528\u6237\u4FE1\u606F API \u63A5\u53E3</h2><p>\u5728 SysLoginController \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>/getInfo</code> \u63A5\u53E3\uFF0C\u83B7\u53D6\u767B\u5F55\u7684\u7528\u6237\u4FE1\u606F\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysLoginController.java</span>

<span class="token doc-comment comment">/**
 * \u83B7\u53D6\u7528\u6237\u4FE1\u606F
 *
 * <span class="token keyword">@return</span> \u7528\u6237\u4FE1\u606F
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getInfo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &lt;1&gt; \u83B7\u5F97\u5F53\u524D LoginUser</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SysUser</span> user <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;2&gt; \u89D2\u8272\u6807\u8BC6\u7684\u96C6\u5408</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> permissionService<span class="token punctuation">.</span><span class="token function">getRolePermission</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;3&gt; \u6743\u9650\u96C6\u5408</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> permissionService<span class="token punctuation">.</span><span class="token function">getMenuPermission</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;4&gt; \u8FD4\u56DE\u7ED3\u679C</span>
    <span class="token class-name">AjaxResult</span> ajax <span class="token operator">=</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ajax<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ajax<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;roles&quot;</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ajax<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;permissions&quot;</span><span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ajax<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,113),r=n("li",null,[n("p",null,[n("code",null,"<1>"),s(" \u5904\uFF0C\u8C03\u7528 TokenService \u7684 "),n("code",null,"#getLoginUser(request)"),s(" \u65B9\u6CD5\uFF0C\u83B7\u5F97\u5F53\u524D LoginUser \u3002")])],-1),k=t(`<p><code>&lt;2&gt;</code> \u5904\uFF0C\u8C03\u7528 PermissionService \u7684 <code>#getRolePermission(SysUser user)</code> \u65B9\u6CD5\uFF0C\u83B7\u5F97 LoginUser \u62E5\u6709\u7684\u89D2\u8272<strong>\u6807\u8BC6</strong>\u7684\u96C6\u5408\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysPermissionService.java</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ISysRoleService</span> roleService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u83B7\u53D6\u89D2\u8272\u6570\u636E\u6743\u9650
 *
 * <span class="token keyword">@param</span> <span class="token parameter">user</span> \u7528\u6237\u4FE1\u606F
 * <span class="token keyword">@return</span> \u89D2\u8272\u6743\u9650\u4FE1\u606F
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRolePermission</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u7BA1\u7406\u5458\u62E5\u6709\u6240\u6709\u6743\u9650</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u5982\u679C\u662F\u7BA1\u7406\u5458\uFF0C\u5F3A\u5236\u6DFB\u52A0 admin \u89D2\u8272</span>
        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// \u5982\u679C\u975E\u7BA1\u7406\u5458\uFF0C\u8FDB\u884C\u67E5\u8BE2</span>
        roles<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>roleService<span class="token punctuation">.</span><span class="token function">selectRolePermissionByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// SysRoleServiceImpl.java</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">SysRoleMapper</span> roleMapper<span class="token punctuation">;</span>
    
<span class="token doc-comment comment">/**
 * \u6839\u636E\u7528\u6237ID\u67E5\u8BE2\u6743\u9650
 *
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span> \u7528\u6237ID
 * <span class="token keyword">@return</span> \u6743\u9650\u5217\u8868
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectRolePermissionByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u83B7\u5F97 userId \u62E5\u6709\u7684 SysRole \u6570\u7EC4</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">&gt;</span></span> perms <span class="token operator">=</span> roleMapper<span class="token punctuation">.</span><span class="token function">selectRolePermissionByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u904D\u5386 SysRole \u6570\u7EC4\uFF0C\u751F\u6210\u89D2\u8272\u6807\u8BC6\u6570\u7EC4</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permsSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysRole</span> perm <span class="token operator">:</span> perms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            permsSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span><span class="token function">getRoleKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> permsSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// SysRoleMapper.xml</span>
<span class="token operator">&lt;</span>sql id<span class="token operator">=</span><span class="token string">&quot;selectRoleVo&quot;</span><span class="token operator">&gt;</span>
    select distinct r<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>role_name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>role_key<span class="token punctuation">,</span> r<span class="token punctuation">.</span>role_sort<span class="token punctuation">,</span> r<span class="token punctuation">.</span>data_scope<span class="token punctuation">,</span>
        r<span class="token punctuation">.</span>status<span class="token punctuation">,</span> r<span class="token punctuation">.</span>del_flag<span class="token punctuation">,</span> r<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span> r<span class="token punctuation">.</span>remark 
    from sys_role r
        left join sys_user_role ur on ur<span class="token punctuation">.</span>role_id <span class="token operator">=</span> r<span class="token punctuation">.</span>role_id
        left join sys_user u on u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> ur<span class="token punctuation">.</span>user_id
        left join sys_dept d on u<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>dept_id
<span class="token operator">&lt;</span><span class="token operator">/</span>sql<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;selectRolePermissionByUserId&quot;</span> parameterType<span class="token operator">=</span><span class="token string">&quot;Long&quot;</span> resultMap<span class="token operator">=</span><span class="token string">&quot;SysRoleResult&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectRoleVo&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
	<span class="token constant">WHERE</span> r<span class="token punctuation">.</span>del_flag <span class="token operator">=</span> <span class="token char">&#39;0&#39;</span> and ur<span class="token punctuation">.</span>user_id <span class="token operator">=</span> #<span class="token punctuation">{</span>userId<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),d=n("li",null,[s("\u901A\u8FC7\u67E5\u8BE2 "),n("code",null,"sys_role"),s(" \u8868\uFF0C\u540C\u65F6\u8FDE\u63A5 "),n("code",null,"sys_user_role"),s("\u3001"),n("code",null,"sys_user"),s("\u3001"),n("code",null,"sys_dept"),s(" \u8868\uFF0C\u5C06 "),n("code",null,"userId"),s(" \u5BF9\u5E94\u7684 SysRole \u76F8\u5173\u4FE1\u606F\u90FD\u4E00\u6B21\u6027\u67E5\u8BE2\u51FA\u6765\u3002")],-1),m=s("\u8FD4\u56DE\u7ED3\u679C SysRoleResult \u7684\u5177\u4F53\u5B9A\u4E49\uFF0C\u70B9\u51FB "),v={href:"https://github.com/YunaiV/RuoYi-Vue/blob/master/ruoyi/src/main/resources/mybatis/system/SysRoleMapper.xml#L7-L20",target:"_blank",rel:"noopener noreferrer"},b=s("\u4F20\u9001\u95E8"),g=s(" \u67E5\u770B\uFF0C\u5B9E\u9645\u5C31\u662F SysRole \u5B9E\u4F53\u7C7B\u3002"),y=n("li",null,[n("p",null,[n("code",null,"<3>"),s(" \u5904\uFF0C\u8C03\u7528 SysPermissionService \u7684 "),n("code",null,"#getMenuPermission(SysUser user)"),s(" \u65B9\u6CD5\uFF0C\u83B7\u5F97\u7528\u6237\u7684 SysRoleMenu \u7684\u6743\u9650"),n("strong",null,"\u6807\u8BC6"),s("\u5B57\u7B26\u4E32\u7684\u96C6\u5408\u3002")])],-1),w=n("li",null,[n("p",null,[n("code",null,"<4>"),s(" \u5904\uFF0C\u8FD4\u56DE\u7528\u6237\u4FE1\u606F\u7684 AjaxResult \u7ED3\u679C\u3002")])],-1),f=t(`<p>\u901A\u8FC7\u8C03\u7528\u8BE5 <code>/getInfo</code> \u63A5\u53E3\uFF0C\u524D\u7AEF\u5C31\u53EF\u4EE5\u6839\u636E\u89D2\u8272<strong>\u6807\u8BC6</strong>\u3001\u53C8\u6216\u8005\u6743\u9650<strong>\u6807\u8BC6</strong>\uFF0C\u5B9E\u73B0\u5BF9\u9875\u9762\u7EA7\u522B\u7684<strong>\u6309\u94AE</strong>\u5B9E\u73B0\u6743\u9650\u63A7\u5236\uFF0C\u8FDB\u884C\u6709\u6743\u9650\u65F6\u663E\u793A\uFF0C\u65E0\u6743\u9650\u65F6\u9690\u85CF\u3002</p><h2 id="_9-\u83B7\u53D6\u8DEF\u7531\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_9-\u83B7\u53D6\u8DEF\u7531\u4FE1\u606F" aria-hidden="true">#</a> 9. \u83B7\u53D6\u8DEF\u7531\u4FE1\u606F</h2><p>\u5728 SysLoginController \u4E2D\uFF0C\u5B9A\u4E49\u4E86 <code>/getRouters</code> \u63A5\u53E3\uFF0C\u83B7\u53D6\u83B7\u53D6\u8DEF\u7531\u4FE1\u606F\u3002\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// SysLoginController.java</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getRouters&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">getRouters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u83B7\u5F97\u5F53\u524D LoginUser</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u83B7\u5F97\u7528\u6237\u7684 SysMenu \u6570\u7EC4</span>
    <span class="token class-name">SysUser</span> user <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenu</span><span class="token punctuation">&gt;</span></span> menus <span class="token operator">=</span> menuService<span class="token punctuation">.</span><span class="token function">selectMenuTreeByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u6784\u5EFA\u8DEF\u7531 RouterVo \u6570\u7EC4\u3002\u53EF\u7528\u4E8E Vue \u6784\u5EFA\u7BA1\u7406\u540E\u53F0\u7684\u5DE6\u8FB9\u83DC\u5355</span>
    <span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>menuService<span class="token punctuation">.</span><span class="token function">buildMenus</span><span class="token punctuation">(</span>menus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u53C2\u8003\u6587\u7AE0" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003\u6587\u7AE0" aria-hidden="true">#</a> \u53C2\u8003\u6587\u7AE0</h2>`,5),S={href:"https://doc.ruoyi.vip/ruoyi-vue/document/htsc.html#%E6%9D%83%E9%99%90%E6%B3%A8%E8%A7%A3",target:"_blank",rel:"noopener noreferrer"},h=s("\u82E5\u4F9D\u5B98\u65B9\u6587\u6863"),U={href:"https://www.iocoder.cn/Spring-Boot/Spring-Security/",target:"_blank",rel:"noopener noreferrer"},_=s("\u828B\u9053 Spring Boot \u5B89\u5168\u6846\u67B6 Spring Security \u5165\u95E8");function q(x,L){const a=l("ExternalLinkIcon");return o(),c("div",null,[u,n("ul",null,[r,n("li",null,[k,n("ul",null,[d,n("li",null,[m,n("a",v,[b,e(a)]),g])])]),y,w]),f,n("p",null,[n("a",S,[h,e(a)])]),n("p",null,[n("a",U,[_,e(a)])])])}const T=p(i,[["render",q],["__file","manage-system-springsecurity-rbac.html.vue"]]);export{T as default};
