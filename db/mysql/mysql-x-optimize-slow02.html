<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.59" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://java.isture.com/db/mysql/mysql-x-optimize-slow02.html"><meta property="og:site_name" content="Java学习笔记"><meta property="og:title" content="MySQL - 慢查询的12个原因"><meta property="og:description" content="0. 前言 日常开发中，我们经常会遇到数据库慢查询。那么导致数据慢查询都有哪些常见的原因呢？今天田螺哥就跟大家聊聊导致MySQL慢查询的12个常见原因，以及对应的解决方法。 image-20221204221904146 1. SQL没加索引 很多时候，我们的慢查询，都是因为没有加索引。如果没有加索引的话，会导致全表扫描的。因此，应考虑在where的条..."><meta property="og:type" content="article"><meta property="og:updated_time" content="2023-02-20T13:42:31.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2023-02-20T13:42:31.000Z"><script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?78dc0e0b4e3aedf643d6621778307a6f";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
      </script><title>MySQL - 慢查询的12个原因 | Java学习笔记</title><meta name="description" content="0. 前言 日常开发中，我们经常会遇到数据库慢查询。那么导致数据慢查询都有哪些常见的原因呢？今天田螺哥就跟大家聊聊导致MySQL慢查询的12个常见原因，以及对应的解决方法。 image-20221204221904146 1. SQL没加索引 很多时候，我们的慢查询，都是因为没有加索引。如果没有加索引的话，会导致全表扫描的。因此，应考虑在where的条...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-21064aac.css" as="style"><link rel="stylesheet" href="/assets/style-21064aac.css">
    <link rel="modulepreload" href="/assets/app-db723a5e.js"><link rel="modulepreload" href="/assets/framework-0cf5f349.js"><link rel="modulepreload" href="/assets/mysql-x-optimize-slow02.html-b8dd3a18.js"><link rel="modulepreload" href="/assets/mysql-x-optimize-slow02.html-b7d41651.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="Java学习笔记"><!----><span class="site-name hide-in-pad">Java学习笔记</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="icon iconfont icon-creative"></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java/base/Java-basis-oop.html" class="nav-link" aria-label="Java基础"><!---->Java基础<!----></a></li><li class="dropdown-item"><a href="/java/io/java-io-overview.html" class="nav-link" aria-label="Java IO"><!---->Java IO<!----></a></li><li class="dropdown-item"><a href="/java/collection/java-collection-overview.html" class="nav-link" aria-label="Java集合"><!---->Java集合<!----></a></li><li class="dropdown-item"><a href="/java/thread/java-thread-x-theorty.html" class="nav-link" aria-label="Java并发"><!---->Java并发<!----></a></li><li class="dropdown-item"><a href="/java/java8/java8-lambda.html" class="nav-link" aria-label="Java8"><!---->Java8<!----></a></li><li class="dropdown-item"><a href="/java/jvm/jvm-overview.html" class="nav-link" aria-label="JVM"><!---->JVM<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title"><span class="icon iconfont icon-creative"></span>数据库</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/db/sql/sql-x-basic.html" class="nav-link" aria-label="数据库基础/SQL基础"><!---->数据库基础/SQL基础<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Sql数据库</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/db/mysql/sql-mysql-overview.html" class="nav-link" aria-label="Mysql"><!---->Mysql<!----></a></li><li class="dropdown-subitem"><a href="/db/oracle/oracle-b-sequence.html" class="nav-link" aria-label="Oracle"><!---->Oracle<!----></a></li><li class="dropdown-subitem"><a href="/db/dm/dm-operation-console.html" class="nav-link" aria-label="达梦"><!---->达梦<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>NoSql数据库</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/db/redis/db-redis-introduce.html" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li><li class="dropdown-subitem"><a href="/db/mongodb/mongo-x-basic.html" class="nav-link" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li class="dropdown-subitem"><a href="/db/es/elasticsearch-x-introduce-1.html" class="nav-link" aria-label="Elasticsearch"><!---->Elasticsearch<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架|依赖"><span class="title"><span class="icon iconfont icon-creative"></span>框架|依赖</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/dependencies/spring/spring-overview.html" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li><li class="dropdown-subitem"><a href="/dependencies/spring-boot/springboot-x-overview.html" class="nav-link" aria-label="SpringBoot"><!---->SpringBoot<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ORM</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/dependencies/mybatis/mybatis-y-arch.html" class="nav-link" aria-label="Mybatis"><!---->Mybatis<!----></a></li><li class="dropdown-subitem"><a href="/dependencies/mybatis-plus/mybatis-plus-x-gen-code.html" class="nav-link" aria-label="Mybatis-Plus"><!---->Mybatis-Plus<!----></a></li></ul></li><li class="dropdown-item"><a href="/dependencies/office/office-x-aspose.html" class="nav-link" aria-label="Office文档操作"><!---->Office文档操作<!----></a></li><li class="dropdown-item"><a href="/dependencies/cas/cas-x-overview.html" class="nav-link" aria-label="CAS单点登录"><!---->CAS单点登录<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="开发|测试"><span class="title"><span class="icon iconfont icon-creative"></span>开发|测试</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/develop/devlibrary/dev-lib-lombok.html" class="nav-link" aria-label="开发-常用类库"><span class="icon iconfont icon-creative"></span>开发-常用类库<!----></a></li><li class="dropdown-item"><a href="/develop/security/dev-security-x-injection.html" class="nav-link" aria-label="开发-安全"><span class="icon iconfont icon-creative"></span>开发-安全<!----></a></li><li class="dropdown-item"><a href="/develop/optimization/optimization-x-interface-optimization.html" class="nav-link" aria-label="开发 - 优化"><span class="icon iconfont icon-creative"></span>开发 - 优化<!----></a></li><li class="dropdown-item"><a href="/develop/style/dev-qt-code-style.html" class="nav-link" aria-label="开发 - 规范/风格"><span class="icon iconfont icon-creative"></span>开发 - 规范/风格<!----></a></li><li class="dropdown-item"><a href="/develop/test/ut-overview" class="nav-link" aria-label="测试"><span class="icon iconfont icon-creative"></span>测试<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="软件|部署"><span class="title"><span class="icon iconfont icon-creative"></span>软件|部署</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/deploy/docker/docker-basic-overview.html" class="nav-link" aria-label="Docker"><span class="icon iconfont icon-creative"></span>Docker<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>消息队列</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/deploy/mq/mq-a-overview.html" class="nav-link" aria-label="消息队列"><!---->消息队列<!----></a></li><li class="dropdown-subitem"><a href="/deploy/mq-rabbitmq/rabbitmq-x-overview.html" class="nav-link" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a></li><li class="dropdown-subitem"><a href="/deploy/mq-kafka/kafka-x-overview.html" class="nav-link" aria-label="Kafka"><!---->Kafka<!----></a></li></ul></li><li class="dropdown-item"><a href="/deploy/skywalking/skywalking-x-principle.html" class="nav-link" aria-label="Skywalking"><span class="icon iconfont icon-creative"></span>Skywalking<!----></a></li><li class="dropdown-item"><a href="/deploy/linux/linux-j-monitor-overview.html" class="nav-link" aria-label="Linux"><span class="icon iconfont icon-creative"></span>Linux<!----></a></li><li class="dropdown-item"><a href="/deploy/jenkins/jenkins-overview.html" class="nav-link" aria-label="Jenkins"><span class="icon iconfont icon-creative"></span>Jenkins<!----></a></li><li class="dropdown-item"><a href="/deploy/nginx/nginx-x-overview.html" class="nav-link" aria-label="Nginx"><span class="icon iconfont icon-creative"></span>Nginx<!----></a></li><li class="dropdown-item"><a href="/deploy/deploy/docker-basic-overview" class="nav-link" aria-label="部署"><span class="icon iconfont icon-creative"></span>部署<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="架构|系统"><span class="title"><span class="icon iconfont icon-creative"></span>架构|系统</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/arch/base/arch-basic.html" class="nav-link" aria-label="架构基础"><span class="icon iconfont icon-creative"></span>架构基础<!----></a></li><li class="dropdown-item"><a href="/arch/distributed/arch-id.html" class="nav-link" aria-label="分布式系统"><span class="icon iconfont icon-creative"></span>分布式系统<!----></a></li><li class="dropdown-item"><a href="/arch/microservices/ms-overview.html" class="nav-link" aria-label="微服务"><span class="icon iconfont icon-creative"></span>微服务<!----></a></li><li class="dropdown-item"><a href="/arch/minio/minio-concept.html" class="nav-link" aria-label="对象存储-Minio"><span class="icon iconfont icon-creative"></span>对象存储-Minio<!----></a></li><li class="dropdown-item"><a href="/arch/manage-system/manage-system-technical-selection.html" class="nav-link" aria-label="后台管理系统"><span class="icon iconfont icon-creative"></span>后台管理系统<!----></a></li><li class="dropdown-item"><a href="/arch/mall/mall-sku.html" class="nav-link" aria-label="商城设计"><span class="icon iconfont icon-creative"></span>商城设计<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="语言|平台"><span class="title"><span class="icon iconfont icon-creative"></span>语言|平台</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/language/frontend-layout/flex-layout-overview.html" class="nav-link" aria-label="前端"><span class="icon iconfont icon-creative"></span>前端<!----></a></li><li class="dropdown-item"><a href="/language/python/python-advantage.html" class="nav-link" aria-label="python"><span class="icon iconfont icon-creative"></span>python<!----></a></li><li class="dropdown-item"><a href="/language/weixin/wx-package-Optimization.html" class="nav-link" aria-label="微信"><span class="icon iconfont icon-creative"></span>微信<!----></a></li><li class="dropdown-item"><a href="/language/ai/knowledge-graph-build.html" class="nav-link" aria-label="AI人工智能"><span class="icon iconfont icon-creative"></span>AI人工智能<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="杂项|思考"><span class="title"><span class="icon iconfont icon-creative"></span>杂项|思考</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/think/deepImpression/redis-bigdata-slow-problem.html" class="nav-link" aria-label="印象深刻bug"><span class="icon iconfont icon-creative"></span>印象深刻bug<!----></a></li><li class="dropdown-item"><a href="/think/optimization/optimization-x-frequent-operation-db.html" class="nav-link" aria-label="优化"><span class="icon iconfont icon-creative"></span>优化<!----></a></li><li class="dropdown-item"><a href="/think/misc/misc-x-middleware.html" class="nav-link" aria-label="杂项"><span class="icon iconfont icon-creative"></span>杂项<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/zszdevelop/java-study-gitbook" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">SQL基础</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">Mysql</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/db/mysql/sql-mysql-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL知识体系详解"><!---->MySQL知识体系详解<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-theory.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 数据类型"><!---->MySQL - 数据类型<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-engine.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 存储引擎"><!---->MySQL - 存储引擎<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-transaction.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 事务"><!---->MySQL - 事务<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-transaction-interview.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 事务（面试场景切入）"><!---->MySQL - 事务（面试场景切入）<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-b-tree.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 索引(B+树)"><!---->MySQL - 索引(B+树)<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-cover-index.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 覆盖索引"><!---->MySQL - 覆盖索引<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-performance.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 性能优化"><!---->MySQL - 性能优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="MySQL - 慢查询的12个原因"><!---->MySQL - 慢查询的12个原因<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_0-前言" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="0. 前言"><!---->0. 前言<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_1-sql没加索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. SQL没加索引"><!---->1. SQL没加索引<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-sql-索引不生效" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. SQL 索引不生效"><!---->2. SQL 索引不生效<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-1-隐式的类型转换-索引失效" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 隐式的类型转换，索引失效"><!---->2.1 隐式的类型转换，索引失效<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-2-查询条件包含or-可能导致索引失效" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 查询条件包含or，可能导致索引失效"><!---->2.2 查询条件包含or，可能导致索引失效<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-3-like通配符可能导致索引失效。" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3. like通配符可能导致索引失效。"><!---->2.3. like通配符可能导致索引失效。<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-4-查询条件不满足联合索引的最左匹配原则" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.4 查询条件不满足联合索引的最左匹配原则"><!---->2.4 查询条件不满足联合索引的最左匹配原则<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-5-在索引列上使用mysql的内置函数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.5 在索引列上使用mysql的内置函数"><!---->2.5 在索引列上使用mysql的内置函数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-6-对索引进行列运算-如-、-、-、-索引不生效" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.6 对索引进行列运算（如，+、-、*、/）,索引不生效"><!---->2.6 对索引进行列运算（如，+、-、*、/）,索引不生效<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-7-索引字段上使用-或者-索引可能失效" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.7 索引字段上使用（！= 或者 &lt; &gt;），索引可能失效"><!---->2.7 索引字段上使用（！= 或者 &lt; &gt;），索引可能失效<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-8-索引字段上使用is-null-is-not-null-索引可能失效" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.8 索引字段上使用is null， is not null，索引可能失效"><!---->2.8 索引字段上使用is null， is not null，索引可能失效<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-9-左右连接-关联的字段编码格式不一样" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.9 左右连接，关联的字段编码格式不一样"><!---->2.9 左右连接，关联的字段编码格式不一样<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-10-优化器选错了索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.10 优化器选错了索引"><!---->2.10 优化器选错了索引<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_3-limit深分页问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. limit深分页问题"><!---->3. limit深分页问题<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_3-1-limit深分页为什么会变慢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1 limit深分页为什么会变慢"><!---->3.1 limit深分页为什么会变慢<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_3-2-如何优化深分页问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2 如何优化深分页问题"><!---->3.2 如何优化深分页问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-单表数据量太大" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. 单表数据量太大"><!---->4. 单表数据量太大<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-1-单表数据量太大为什么会变慢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 单表数据量太大为什么会变慢？"><!---->4.1 单表数据量太大为什么会变慢？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-2-一棵b-树可以存多少数据量" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 一棵B+树可以存多少数据量"><!---->4.2 一棵B+树可以存多少数据量<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-3-如何解决单表数据量太大-查询变慢的问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 如何解决单表数据量太大，查询变慢的问题"><!---->4.3 如何解决单表数据量太大，查询变慢的问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_5-join-或者子查询过多" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. join 或者子查询过多"><!---->5. join 或者子查询过多<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_6-in元素过多" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6. in元素过多"><!---->6. in元素过多<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-数据库在刷脏页" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7. 数据库在刷脏页"><!---->7. 数据库在刷脏页<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-1-什么是脏页" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.1 什么是脏页"><!---->7.1 什么是脏页<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-2-一条更新语句是如何执行的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.2 一条更新语句是如何执行的？"><!---->7.2 一条更新语句是如何执行的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-3-为什么会出现脏页呢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.3 为什么会出现脏页呢？"><!---->7.3 为什么会出现脏页呢？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-4-什么时候会刷脏页-flush" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.4 什么时候会刷脏页（flush）？"><!---->7.4 什么时候会刷脏页（flush）？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-5-为什么刷脏页会导致sql变慢呢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.5 为什么刷脏页会导致SQL变慢呢？"><!---->7.5 为什么刷脏页会导致SQL变慢呢？<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-order-by-文件排序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8. order by 文件排序"><!---->8. order by 文件排序<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-1-order-by-的-using-filesort文件排序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.1 order by 的 Using filesort文件排序"><!---->8.1 order by 的 Using filesort文件排序<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-2-order-by文件排序效率为什么较低" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.2 order by文件排序效率为什么较低"><!---->8.2 order by文件排序效率为什么较低<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-3-如何优化order-by的文件排序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.3 如何优化order by的文件排序"><!---->8.3 如何优化order by的文件排序<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_9-拿不到锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="9. 拿不到锁"><!---->9. 拿不到锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_10-delete-in子查询不走索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10. delete + in子查询不走索引！"><!---->10. delete + in子查询不走索引！<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11、group-by使用临时表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11、group by使用临时表"><!---->11、group by使用临时表<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11-1-group-by的执行流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.1 group by的执行流程"><!---->11.1 group by的执行流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11-2-group-by可能会慢在哪里" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2  group by可能会慢在哪里？"><!---->11.2  group by可能会慢在哪里？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11-3-如何优化group-by呢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.3 如何优化group by呢？"><!---->11.3 如何优化group by呢？<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_12-系统硬件或网络资源" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="12. 系统硬件或网络资源"><!---->12. 系统硬件或网络资源<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#最后" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="最后"><!---->最后<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#参考文章" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="参考文章"><!---->参考文章<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-explain.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - Explain使用分析"><!---->MySQL - Explain使用分析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-slow.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 慢查询优化思路与案例"><!---->MySQL - 慢查询优化思路与案例<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-devide.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 分表分库"><!---->MySQL - 分表分库<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-sharding-detail.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 分表分库详解"><!---->MySQL - 分表分库详解<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-sharding-interview.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 分表分库（面试场景切入）"><!---->MySQL - 分表分库（面试场景切入）<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-b-log.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 三大日志(Redo Log、Undo Log、Bin Log)"><!---->MySQL - 三大日志(Redo Log、Undo Log、Bin Log)<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-slave.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 主从复制原理"><!---->MySQL - 主从复制原理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-high-availability.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - MySQL高可用方案"><!---->MySQL - MySQL高可用方案<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-mha.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - MySQL高可用-MHA方案"><!---->MySQL - MySQL高可用-MHA方案<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-y-lock-mvvc.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - MySQL InnoDB的MVCC实现机制"><!---->MySQL - MySQL InnoDB的MVCC实现机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-execute.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 一条SQL语句执行过程"><!---->MySQL - 一条SQL语句执行过程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-specification.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - MySQL使用规范"><!---->MySQL - MySQL使用规范<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-backup.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 备份"><!---->MySQL - 备份<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-slowlog.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL - 慢日志"><!---->MySQL - 慢日志<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-c-index-btree.html" class="nav-link sidebar-link sidebar-page" aria-label="B+TREE索引的优势"><!---->B+TREE索引的优势<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-like.html" class="nav-link sidebar-link sidebar-page" aria-label="like模糊查询优化"><!---->like模糊查询优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/sql-mysql-character-set.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL基础-字符集与排序规则"><!---->MySQL基础-字符集与排序规则<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-y-statistics-group.html" class="nav-link sidebar-link sidebar-page" aria-label="Mysql按日、周、月进行分组统计"><!---->Mysql按日、周、月进行分组统计<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-y-lock-category.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL的乐观锁，悲观锁与MVCC"><!---->MySQL的乐观锁，悲观锁与MVCC<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-sql.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL高性能优化规范建议"><!---->MySQL高性能优化规范建议<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-decompose-connection.html" class="nav-link sidebar-link sidebar-page" aria-label="分解大连接查询"><!---->分解大连接查询<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-bigtable.html" class="nav-link sidebar-link sidebar-page" aria-label="大表优化"><!---->大表优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-bigtable-action.html" class="nav-link sidebar-link sidebar-page" aria-label="大表优化过程"><!---->大表优化过程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-x-optimize-slow2.html" class="nav-link sidebar-link sidebar-page" aria-label="如何调优慢查询SQL"><!---->如何调优慢查询SQL<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-z-backup.html" class="nav-link sidebar-link sidebar-page" aria-label="热备份和冷备份概念"><!---->热备份和冷备份概念<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-c-index.html" class="nav-link sidebar-link sidebar-page" aria-label="索引"><!---->索引<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-c-index-impl.html" class="nav-link sidebar-link sidebar-page" aria-label="索引实现"><!---->索引实现<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-c-index-structure.html" class="nav-link sidebar-link sidebar-page" aria-label="索引常见的数据结构"><!---->索引常见的数据结构<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-c-index-uni.html" class="nav-link sidebar-link sidebar-page" aria-label="联合索引"><!---->联合索引<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-c-index-right.html" class="nav-link sidebar-link sidebar-page" aria-label="联合索引-最左匹配原则成因"><!---->联合索引-最左匹配原则成因<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-y-lock-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="锁机制"><!---->锁机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/db/mysql/mysql-y-lock.html" class="nav-link sidebar-link sidebar-page" aria-label="锁机制锁"><!---->锁机制锁<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Oracle</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">达梦</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Redis</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">MongoDB</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ElasticSearch</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">搜索引擎-Solr</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Neo4j</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->MySQL - 慢查询的12个原因</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://java.isture.com" target="_blank" rel="noopener noreferrer">zszdevelop</a></span><span property="author" content="zszdevelop"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-20T13:42:31.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="category-item category2" role>Mysql</span><span class="category-item category6" role>数据库</span><meta property="articleSection" content="Mysql,数据库"></span><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 28 分钟</span><meta property="timeRequired" content="PT28M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_0-前言" class="router-link-active router-link-exact-active toc-link level2">0. 前言</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_1-sql没加索引" class="router-link-active router-link-exact-active toc-link level2">1. SQL没加索引</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-sql-索引不生效" class="router-link-active router-link-exact-active toc-link level2">2. SQL 索引不生效</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-1-隐式的类型转换-索引失效" class="router-link-active router-link-exact-active toc-link level3">2.1 隐式的类型转换，索引失效</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-2-查询条件包含or-可能导致索引失效" class="router-link-active router-link-exact-active toc-link level3">2.2 查询条件包含or，可能导致索引失效</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-3-like通配符可能导致索引失效。" class="router-link-active router-link-exact-active toc-link level3">2.3. like通配符可能导致索引失效。</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-4-查询条件不满足联合索引的最左匹配原则" class="router-link-active router-link-exact-active toc-link level3">2.4 查询条件不满足联合索引的最左匹配原则</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-5-在索引列上使用mysql的内置函数" class="router-link-active router-link-exact-active toc-link level3">2.5 在索引列上使用mysql的内置函数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-6-对索引进行列运算-如-、-、-、-索引不生效" class="router-link-active router-link-exact-active toc-link level3">2.6 对索引进行列运算（如，+、-、*、/）,索引不生效</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-7-索引字段上使用-或者-索引可能失效" class="router-link-active router-link-exact-active toc-link level3">2.7 索引字段上使用（！= 或者 &lt; &gt;），索引可能失效</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-8-索引字段上使用is-null-is-not-null-索引可能失效" class="router-link-active router-link-exact-active toc-link level3">2.8 索引字段上使用is null， is not null，索引可能失效</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-9-左右连接-关联的字段编码格式不一样" class="router-link-active router-link-exact-active toc-link level3">2.9 左右连接，关联的字段编码格式不一样</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_2-10-优化器选错了索引" class="router-link-active router-link-exact-active toc-link level3">2.10 优化器选错了索引</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_3-limit深分页问题" class="router-link-active router-link-exact-active toc-link level2">3. limit深分页问题</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_3-1-limit深分页为什么会变慢" class="router-link-active router-link-exact-active toc-link level3">3.1 limit深分页为什么会变慢</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_3-2-如何优化深分页问题" class="router-link-active router-link-exact-active toc-link level3">3.2 如何优化深分页问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-单表数据量太大" class="router-link-active router-link-exact-active toc-link level2">4. 单表数据量太大</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-1-单表数据量太大为什么会变慢" class="router-link-active router-link-exact-active toc-link level3">4.1 单表数据量太大为什么会变慢？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-2-一棵b-树可以存多少数据量" class="router-link-active router-link-exact-active toc-link level3">4.2 一棵B+树可以存多少数据量</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_4-3-如何解决单表数据量太大-查询变慢的问题" class="router-link-active router-link-exact-active toc-link level3">4.3 如何解决单表数据量太大，查询变慢的问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_5-join-或者子查询过多" class="router-link-active router-link-exact-active toc-link level2">5. join 或者子查询过多</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_6-in元素过多" class="router-link-active router-link-exact-active toc-link level2">6. in元素过多</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-数据库在刷脏页" class="router-link-active router-link-exact-active toc-link level2">7. 数据库在刷脏页</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-1-什么是脏页" class="router-link-active router-link-exact-active toc-link level3">7.1 什么是脏页</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-2-一条更新语句是如何执行的" class="router-link-active router-link-exact-active toc-link level3">7.2 一条更新语句是如何执行的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-3-为什么会出现脏页呢" class="router-link-active router-link-exact-active toc-link level3">7.3 为什么会出现脏页呢？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-4-什么时候会刷脏页-flush" class="router-link-active router-link-exact-active toc-link level3">7.4 什么时候会刷脏页（flush）？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_7-5-为什么刷脏页会导致sql变慢呢" class="router-link-active router-link-exact-active toc-link level3">7.5 为什么刷脏页会导致SQL变慢呢？</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-order-by-文件排序" class="router-link-active router-link-exact-active toc-link level2">8. order by 文件排序</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-1-order-by-的-using-filesort文件排序" class="router-link-active router-link-exact-active toc-link level3">8.1 order by 的 Using filesort文件排序</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-2-order-by文件排序效率为什么较低" class="router-link-active router-link-exact-active toc-link level3">8.2 order by文件排序效率为什么较低</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_8-3-如何优化order-by的文件排序" class="router-link-active router-link-exact-active toc-link level3">8.3 如何优化order by的文件排序</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_9-拿不到锁" class="router-link-active router-link-exact-active toc-link level2">9. 拿不到锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_10-delete-in子查询不走索引" class="router-link-active router-link-exact-active toc-link level2">10. delete + in子查询不走索引！</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11、group-by使用临时表" class="router-link-active router-link-exact-active toc-link level2">11、group by使用临时表</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11-1-group-by的执行流程" class="router-link-active router-link-exact-active toc-link level3">11.1 group by的执行流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11-2-group-by可能会慢在哪里" class="router-link-active router-link-exact-active toc-link level3">11.2  group by可能会慢在哪里？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_11-3-如何优化group-by呢" class="router-link-active router-link-exact-active toc-link level3">11.3 如何优化group by呢？</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#_12-系统硬件或网络资源" class="router-link-active router-link-exact-active toc-link level2">12. 系统硬件或网络资源</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#最后" class="router-link-active router-link-exact-active toc-link level2">最后</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/db/mysql/mysql-x-optimize-slow02.html#参考文章" class="router-link-active router-link-exact-active toc-link level2">参考文章</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="mysql-慢查询的12个原因" tabindex="-1"><a class="header-anchor" href="#mysql-慢查询的12个原因" aria-hidden="true">#</a> MySQL - 慢查询的12个原因</h1><h2 id="_0-前言" tabindex="-1"><a class="header-anchor" href="#_0-前言" aria-hidden="true">#</a> 0. 前言</h2><p>日常开发中，我们经常会遇到<strong>数据库慢查询</strong>。那么导致数据慢查询都有哪些常见的原因呢？今天田螺哥就跟大家聊聊导致MySQL慢查询的12个常见原因，以及对应的解决方法。</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204221904146.png" alt="image-20221204221904146" tabindex="0" loading="lazy"><figcaption>image-20221204221904146</figcaption></figure><h2 id="_1-sql没加索引" tabindex="-1"><a class="header-anchor" href="#_1-sql没加索引" aria-hidden="true">#</a> 1. SQL没加索引</h2><p>很多时候，我们的慢查询，都是因为<strong>没有加索引</strong>。如果没有加索引的话，会导致全表扫描的。因此，应考虑在<code>where</code>的条件列，<strong>建立索引</strong>，尽量避免全表扫描。</p><p><strong>反例：</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_info <span class="token keyword">where</span> name <span class="token operator">=</span><span class="token string">&#39;捡田螺的小男孩公众号&#39;</span> <span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222110021.png" alt="image-20221204222110021" tabindex="0" loading="lazy"><figcaption>image-20221204222110021</figcaption></figure><p><strong>正例：</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">//添加索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> user_info <span class="token keyword">add</span> <span class="token keyword">index</span> idx_name <span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222139505.png" alt="image-20221204222139505" tabindex="0" loading="lazy"><figcaption>image-20221204222139505</figcaption></figure><p>你也可以通过命令<code>show create table</code>，整张表的索引情况。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> user_info<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-sql-索引不生效" tabindex="-1"><a class="header-anchor" href="#_2-sql-索引不生效" aria-hidden="true">#</a> 2. SQL 索引不生效</h2><p>有时候我们明明加了索引了，但是索引却不生效。在哪些场景，索引会不生效呢？主要有以下十大经典场景：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222211038.png" alt="image-20221204222211038" tabindex="0" loading="lazy"><figcaption>image-20221204222211038</figcaption></figure><h3 id="_2-1-隐式的类型转换-索引失效" tabindex="-1"><a class="header-anchor" href="#_2-1-隐式的类型转换-索引失效" aria-hidden="true">#</a> 2.1 隐式的类型转换，索引失效</h3><p>我们创建一个用户user表</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  userId <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  age  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> idx_userid <span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>userId</code>字段为<strong>字串类型</strong>，是B+树的普通索引，如果查询条件传了一个<strong>数字</strong>过去，会导致索引失效。如下：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222253710.png" alt="image-20221204222253710" tabindex="0" loading="lazy"><figcaption>image-20221204222253710</figcaption></figure><p>如果给数字加上<code>&#39;&#39;</code>,也就是说，传的是一个字符串呢，<strong>当然是走索引</strong>，如下图：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222316243.png" alt="image-20221204222316243" tabindex="0" loading="lazy"><figcaption>image-20221204222316243</figcaption></figure><blockquote><p>为什么第一条语句<strong>未加单引号就不走索引</strong>了呢？这是因为不加单引号时，是字符串跟数字的比较，它们类型不匹配，MySQL会做<strong>隐式的类型转换</strong>，把它们转换为浮点数再做比较。隐式的类型转换，索引会失效。</p></blockquote><h3 id="_2-2-查询条件包含or-可能导致索引失效" tabindex="-1"><a class="header-anchor" href="#_2-2-查询条件包含or-可能导致索引失效" aria-hidden="true">#</a> 2.2 查询条件包含or，可能导致索引失效</h3><p>我们还是用这个表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  userId <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  age  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> idx_userid <span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>userId</code>加了索引，但是<code>age</code>没有加索引的。我们使用了<code>or</code>，以下SQL是不走索引的，如下：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222439531.png" alt="image-20221204222439531" tabindex="0" loading="lazy"><figcaption>image-20221204222439531</figcaption></figure><p>对于<code>or</code>+没有索引的<code>age</code>这种情况，假设它走了<code>userId</code>的索引，但是走到<code>age</code>查询条件时，它还得全表扫描，也就是需要三步过程：<strong>全表扫描+索引扫描+合并</strong>。如果它一开始就走<strong>全表扫描</strong>，直接一遍扫描就完事。Mysql优化器出于效率与成本考虑，遇到<code>or</code>条件，让索引失效，看起来也合情合理嘛。</p><p><strong>注意</strong>：如果<code>or</code>条件的列都加了索引，<strong>索引可能会走也可能不走</strong>，大家可以自己试一试哈。但是平时大家使用的时候，还是要注意一下这个<code>or</code>，学会用<code>explain</code>分析。遇到不走索引的时候，考虑拆开两条SQL。</p><h3 id="_2-3-like通配符可能导致索引失效。" tabindex="-1"><a class="header-anchor" href="#_2-3-like通配符可能导致索引失效。" aria-hidden="true">#</a> 2.3. like通配符可能导致索引失效。</h3><p>并不是用了<code>like</code>通配符，索引一定会失效，而是like查询是以<code>%</code>开头，才会导致索引失效。</p><p>like查询以<code>%</code>开头，索引失效</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> userId <span class="token operator">like</span> <span class="token string">&#39;%123&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222633501.png" alt="image-20221204222633501" tabindex="0" loading="lazy"><figcaption>image-20221204222633501</figcaption></figure><p>把<code>%</code>放后面，发现索引还是正常走的，如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> userId <span class="token operator">like</span> <span class="token string">&#39;123%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222658398.png" alt="image-20221204222658398" tabindex="0" loading="lazy"><figcaption>image-20221204222658398</figcaption></figure><p>既然<code>like</code>查询以<code>%</code>开头，会导致索引失效。我们如何优化呢？</p><ul><li>使用覆盖索引</li><li>把<code>%</code>放后面</li></ul><h3 id="_2-4-查询条件不满足联合索引的最左匹配原则" tabindex="-1"><a class="header-anchor" href="#_2-4-查询条件不满足联合索引的最左匹配原则" aria-hidden="true">#</a> 2.4 查询条件不满足联合索引的最左匹配原则</h3><p>MySQl建立联合索引时，会遵循最左前缀匹配的原则，即最左优先。如果你建立一个<code>（a,b,c）</code>的联合索引，相当于建立了<code>(a)、(a,b)、(a,b,c)</code>三个索引。</p><p>假设有以下表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  user_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  age  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> idx_userid_name <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有一个联合索引<code>idx_userid_name</code>，我们执行这个SQL，查询条件是<code>name</code>，索引是无效：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>explain select * from user where name =&#39;捡田螺的小男孩&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>因为查询条件列<code>name</code>不是联合索引<code>idx_userid_name</code>中的第一个列，索引不生效</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222843874.png" alt="image-20221204222843874" tabindex="0" loading="lazy"><figcaption>image-20221204222843874</figcaption></figure><p>在联合索引中，查询条件满足<strong>最左匹配原则</strong>时，索引才正常生效。</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204222934626.png" alt="image-20221204222934626" tabindex="0" loading="lazy"><figcaption>image-20221204222934626</figcaption></figure><h3 id="_2-5-在索引列上使用mysql的内置函数" tabindex="-1"><a class="header-anchor" href="#_2-5-在索引列上使用mysql的内置函数" aria-hidden="true">#</a> 2.5 在索引列上使用mysql的内置函数</h3><p>表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>login_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_userId<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_login_time<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>login_Time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然<code>login_time</code>加了索引，但是因为使用了<code>mysql</code>的内置函数<code>Date_ADD()</code>，索引直接GG，如图：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223030874.png" alt="image-20221204223030874" tabindex="0" loading="lazy"><figcaption>image-20221204223030874</figcaption></figure><p>一般这种情况怎么优化呢？可以把<strong>内置函数的逻辑转移到右边</strong>，如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">explain</span>  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> login_time <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span><span class="token string">&#39;2022-05-22 00:00:00&#39;</span><span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-6-对索引进行列运算-如-、-、-、-索引不生效" tabindex="-1"><a class="header-anchor" href="#_2-6-对索引进行列运算-如-、-、-、-索引不生效" aria-hidden="true">#</a> 2.6 对索引进行列运算（如，+、-、*、/）,索引不生效</h3><p>表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_age<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然<code>age</code>加了索引，但是因为它进行运算，索引直接迷路了。。。如图：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223124501.png" alt="image-20221204223124501" tabindex="0" loading="lazy"><figcaption>image-20221204223124501</figcaption></figure><p>所以<strong>不可以对索引列进行运算，可以在代码处理好，再传参进去</strong>。</p><h3 id="_2-7-索引字段上使用-或者-索引可能失效" tabindex="-1"><a class="header-anchor" href="#_2-7-索引字段上使用-或者-索引可能失效" aria-hidden="true">#</a> 2.7 索引字段上使用（！= 或者 &lt; &gt;），索引可能失效</h3><p>表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_age<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然<code>age</code>加了索引，但是使用了<code>！= </code>或者<code>&lt; &gt;，not in</code>这些时，索引如同虚设。如下：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223223570.png" alt="image-20221204223223570" tabindex="0" loading="lazy"><figcaption>image-20221204223223570</figcaption></figure><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223235494.png" alt="image-20221204223235494" tabindex="0" loading="lazy"><figcaption>image-20221204223235494</figcaption></figure><p>其实这个也是跟<code>mySQL优化器</code>有关，如果优化器觉得即使走了索引，还是需要扫描很多很多行的哈，它觉得不划算，<strong>不如直接不走索引</strong>。平时我们用<code>！= </code>或者<code>&lt; &gt;，not in</code>的时候，留点心眼哈。</p><h3 id="_2-8-索引字段上使用is-null-is-not-null-索引可能失效" tabindex="-1"><a class="header-anchor" href="#_2-8-索引字段上使用is-null-is-not-null-索引可能失效" aria-hidden="true">#</a> 2.8 索引字段上使用is null， is not null，索引可能失效</h3><p>表结构:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_card<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>单个<code>name</code>字段加上索引，并查询<code>name</code>为非空的语句，其实会走索引的，如下:</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223314545.png" alt="image-20221204223314545" tabindex="0" loading="lazy"><figcaption>image-20221204223314545</figcaption></figure><p>单个<code>card</code>字段加上索引，并查询name为非空的语句，其实会走索引的，如下:</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223334347.png" alt="image-20221204223334347" tabindex="0" loading="lazy"><figcaption>image-20221204223334347</figcaption></figure><p>但是它两用or连接起来，索引就失效了，如下：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223409620.png" alt="image-20221204223409620" tabindex="0" loading="lazy"><figcaption>image-20221204223409620</figcaption></figure><p>很多时候，也是因为数据量问题，导致了MySQL优化器放弃走索引。同时，平时我们用explain分析SQL的时候，如果<code>type=range</code>,要注意一下哈，因为这个可能因为数据量问题，导致索引无效。</p><h3 id="_2-9-左右连接-关联的字段编码格式不一样" tabindex="-1"><a class="header-anchor" href="#_2-9-左右连接-关联的字段编码格式不一样" aria-hidden="true">#</a> 2.9 左右连接，关联的字段编码格式不一样</h3><p>新建两个表，一个<code>user</code>，一个<code>user_job</code></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user_job<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>job<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>user</code>表的<code>name</code>字段编码是<code>utf8mb4</code>，而<code>user_job</code>表的<code>name</code>字段编码为<code>utf8</code>。</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223521748.png" alt="image-20221204223521748" tabindex="0" loading="lazy"><figcaption>image-20221204223521748</figcaption></figure><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223533548.png" alt="image-20221204223533548" tabindex="0" loading="lazy"><figcaption>image-20221204223533548</figcaption></figure><p>执行左外连接查询,<code>user_job</code>表还是走全表扫描，如下：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223549208.png" alt="image-20221204223549208" tabindex="0" loading="lazy"><figcaption>image-20221204223549208</figcaption></figure><p>如果把它们的<code>name</code>字段改为编码一致，相同的SQL，还是会走索引。</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204223613432.png" alt="image-20221204223613432" tabindex="0" loading="lazy"><figcaption>image-20221204223613432</figcaption></figure><p>所以大家在做表关联时，注意一下<strong>关联字段的编码问题</strong>哈。</p><h3 id="_2-10-优化器选错了索引" tabindex="-1"><a class="header-anchor" href="#_2-10-优化器选错了索引" aria-hidden="true">#</a> 2.10 优化器选错了索引</h3><p>MySQL 中一张表是可以支持多个索引的。你写<code>SQL</code>语句的时候，没有主动指定使用哪个索引的话，用哪个索引是由<code>MySQL</code>来确定的。</p><p>我们日常开发中，不断地删除历史数据和新增数据的场景，有可能会导致MySQL选错索引。那么有哪些解决方案呢？</p><ul><li>使用<code>force index</code> 强行选择某个索引</li><li>修改你的SQl，引导它使用我们期望的索引</li><li>优化你的业务逻辑</li><li>优化你的索引，新建一个更合适的索引，或者删除误用的索引。</li></ul><h2 id="_3-limit深分页问题" tabindex="-1"><a class="header-anchor" href="#_3-limit深分页问题" aria-hidden="true">#</a> 3. limit深分页问题</h2><p>limit深分页问题，会导致慢查询，应该大家都司空见惯了吧。</p><h3 id="_3-1-limit深分页为什么会变慢" tabindex="-1"><a class="header-anchor" href="#_3-1-limit深分页为什么会变慢" aria-hidden="true">#</a> 3.1 limit深分页为什么会变慢</h3><p>limit深分页为什么会导致<strong>SQL变慢</strong>呢？假设我们有表结构如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> account <span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键Id&#39;</span><span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;账户名&#39;</span><span class="token punctuation">,</span>
  balance <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额&#39;</span><span class="token punctuation">,</span>
  create_time <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  update_time <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> idx_name <span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> idx_create_time <span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> <span class="token comment">//索引</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1570068</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>REDUNDANT <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;账户表&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你知道以下<code>SQL</code>，执行过程是怎样的嘛？</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>balance <span class="token keyword">from</span> account <span class="token keyword">where</span> create_time<span class="token operator">&gt;</span> <span class="token string">&#39;2020-09-19&#39;</span> <span class="token keyword">limit</span> <span class="token number">100000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个SQL的执行流程：</p><ol><li>通过普通二级索引树<code>idx_create_time</code>，过滤<code>create_time</code>条件，找到满足条件的主键<code>id</code>。</li><li>通过<code>主键id</code>，回到<code>id主键索引树</code>，找到满足记录的行，然后取出需要展示的列（回表过程）</li><li>扫描满足条件的<code>100010</code>行，然后扔掉前<code>100000</code>行，返回。</li></ol><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204224433513.png" alt="image-20221204224433513" tabindex="0" loading="lazy"><figcaption>image-20221204224433513</figcaption></figure><p><code>limit</code>深分页，导致<code>SQL</code>变慢原因有两个：</p><ul><li><code>limit</code>语句会先扫描<code>offset+n</code>行，然后再丢弃掉前<code>offset</code>行，返回后<code>n</code>行数据。也就是说<code>limit 100000,10</code>，就会扫描<code>100010</code>行，而limit <code>0,10</code>，只扫描<code>10</code>行。</li><li><code>limit 100000,10</code> 扫描更多的行数，也意味着<strong>回表更多的次数</strong>。</li></ul><h3 id="_3-2-如何优化深分页问题" tabindex="-1"><a class="header-anchor" href="#_3-2-如何优化深分页问题" aria-hidden="true">#</a> 3.2 如何优化深分页问题</h3><p>我们可以通过减少回表次数来优化。一般有<strong>标签记录法和延迟关联法</strong>。</p><h4 id="_3-2-1-标签记录法" tabindex="-1"><a class="header-anchor" href="#_3-2-1-标签记录法" aria-hidden="true">#</a> 3.2.1 <strong>标签记录法</strong></h4><blockquote><p>就是标记一下上次查询到哪一条了，下次再来查的时候，从该条开始往下扫描。就好像看书一样，上次看到哪里了，你就折叠一下或者夹个书签，下次来看的时候，直接就翻到啦。</p></blockquote><p>假设上一次记录到<code>100000</code>，则SQL可以修改为：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>select  id,name,balance FROM account where id &gt; 100000 limit 10;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这样的话，后面无论翻多少页，性能都会不错的，因为命中了<code>id索引</code>。但是这种方式有局限性：需要一种类似连续自增的字段。</p><h4 id="_3-2-2-延迟关联法" tabindex="-1"><a class="header-anchor" href="#_3-2-2-延迟关联法" aria-hidden="true">#</a> 3.2.2 <strong>延迟关联法</strong></h4><p>延迟关联法，就是把条件转移到<strong>主键索引树</strong>，然后减少回表。如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>select  acct1.id,acct1.name,acct1.balance FROM account acct1 INNER JOIN (SELECT a.id FROM account a WHERE a.create_time &gt; &#39;2020-09-19&#39; limit 100000, 10) AS acct2 on acct1.id= acct2.id;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>优化思路</strong>就是，先通过<code>idx_create_time</code>二级索引树查询到满足条件的<code>主键ID</code>，再与原表通过<code>主键ID</code>内连接，这样后面直接走了主键索引了，同时也减少了回表。</p><h2 id="_4-单表数据量太大" tabindex="-1"><a class="header-anchor" href="#_4-单表数据量太大" aria-hidden="true">#</a> 4. 单表数据量太大</h2><h3 id="_4-1-单表数据量太大为什么会变慢" tabindex="-1"><a class="header-anchor" href="#_4-1-单表数据量太大为什么会变慢" aria-hidden="true">#</a> 4.1 单表数据量太大为什么会变慢？</h3><p>一个表的数据量达到好几千万或者上亿时，加索引的效果没那么明显啦。性能之所以会变差，是因为维护索引的<code>B+</code>树结构层级变得更高了，查询一条数据时，需要经历的磁盘IO变多，因此查询性能变慢。</p><h3 id="_4-2-一棵b-树可以存多少数据量" tabindex="-1"><a class="header-anchor" href="#_4-2-一棵b-树可以存多少数据量" aria-hidden="true">#</a> 4.2 一棵B+树可以存多少数据量</h3><p><strong>大家是否还记得，一个B+树大概可以存放多少数据量呢？</strong></p><p>InnoDB存储引擎最小储存单元是页，一页大小就是<code>16k</code>。</p><p>B+树叶子存的是数据，内部节点存的是键值+指针。索引组织表通过非叶子节点的二分查找法以及指针确定数据在哪个页中，进而再去数据页中找到需要的数据；</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204224710967.png" alt="image-20221204224710967" tabindex="0" loading="lazy"><figcaption>image-20221204224710967</figcaption></figure><p>假设B+树的高度为<code>2</code>的话，即有一个根结点和若干个叶子结点。这棵B+树的存放总记录数为=根结点指针数*单个叶子节点记录行数。</p><ul><li>如果一行记录的数据大小为1k，那么单个叶子节点可以存的记录数 =16k/1k =16.</li><li>非叶子节点内存放多少指针呢？我们假设主键ID为<strong>bigint类型，长度为8字节</strong>(<strong>面试官问你int类型，一个int就是32位，4字节</strong>)，而指针大小在InnoDB源码中设置为6字节，所以就是8+6=14字节，16k/14B =16*1024B/14B = 1170</li></ul><p>因此，一棵高度为2的B+树，能存放<code>1170 * 16=18720</code>条这样的数据记录。同理一棵高度为3的B+树，能存放<code>1170 *1170 *16 =21902400</code>，也就是说，可以存放两千万左右的记录。B+树高度一般为1-3层，已经满足千万级别的数据存储。</p><p>如果B+树想存储更多的数据，那树结构层级就会更高，查询一条数据时，需要经历的磁盘IO变多，因此查询性能变慢。</p><h3 id="_4-3-如何解决单表数据量太大-查询变慢的问题" tabindex="-1"><a class="header-anchor" href="#_4-3-如何解决单表数据量太大-查询变慢的问题" aria-hidden="true">#</a> 4.3 如何解决单表数据量太大，查询变慢的问题</h3><p>一般超过千万级别，我们可以考虑<strong>分库分表</strong>了。</p><p>分库分表可能导致的问题：</p><ul><li>事务问题</li><li>跨库问题</li><li>排序问题</li><li>分页问题</li><li>分布式ID</li></ul><p>因此，大家在评估是否分库分表前，先考虑下，是否可以把部分历史数据归档先，如果可以的话，先不要急着<strong>分库分表</strong>。如果真的要分库分表，综合考虑和评估方案。比如可以考虑垂直、水平分库分表。水平分库分表策略的话，<strong>range范围、hash取模、range+hash取模混合</strong>等等。</p><h2 id="_5-join-或者子查询过多" tabindex="-1"><a class="header-anchor" href="#_5-join-或者子查询过多" aria-hidden="true">#</a> 5. join 或者子查询过多</h2><p>一般来说，不建议使用子查询，可以把子查询改成<code>join</code>来优化。而数据库有个规范约定就是：<strong>尽量不要有超过3个以上的表连接</strong>。为什么要这么建议呢? 我们来聊聊，<code>join</code>哪些方面可能导致慢查询吧。</p><p>MySQL中，join的执行算法，分别是：<code>Index Nested-Loop Join</code>和<code>Block Nested-Loop Join</code>。</p><ul><li><code>Index Nested-Loop Join</code>：这个join算法，跟我们写程序时的嵌套查询类似，并且可以用上<strong>被驱动表的索引</strong>。</li><li><code>Block Nested-Loop Join</code>：这种join算法，<strong>被驱动表上没有可用的索引</strong>,它会先把驱动表的数据读入线程内存<code>join_buffer</code>中，再扫描被驱动表，把被驱动表的每一行取出来，跟<code>join_buffer</code>中的数据做对比，满足join条件的，作为结果集的一部分返回。</li></ul><p><code>join</code>过多的问题：</p><blockquote><p>一方面，过多的表连接，会大大增加SQL复杂度。另外一方面，如果可以使用被驱动表的<strong>索引</strong>那还好，并且使用<strong>小表来做驱动表</strong>，<strong>查询效率更佳</strong>。如果被驱动表<strong>没有可用的索引</strong>，join是在<code>join_buffer</code>内存做的，如果匹配的数据量比较小或者<code>join_buffer</code>设置的比较大，速度也不会太慢。但是，如果<code>join</code>的数据量比较大时，mysql会采用在硬盘上创建临时表的方式进行多张表的关联匹配，这种显然效率就极低，本来磁盘的 IO 就不快，还要关联。</p></blockquote><p>一般情况下，如果业务需要的话，关联<code>2~3</code>个表是可以接受的，但是<strong>关联的字段需要加索引</strong>哈。如果需要关联更多的表，建议从代码层面进行拆分，在业务层先查询一张表的数据，然后以关联字段作为条件查询关联表形成<code>map</code>，然后在业务层进行数据的拼装。</p><h2 id="_6-in元素过多" tabindex="-1"><a class="header-anchor" href="#_6-in元素过多" aria-hidden="true">#</a> 6. in元素过多</h2><p>如果使用了<code>in</code>，即使后面的条件加了索引，还是要注意<code>in</code>后面的元素不要过多哈。<code>in</code>元素一般建议不要超过<code>500</code>个，如果超过了，建议分组，每次<code>500</code>一组进行哈。</p><p><strong>反例：</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> user_id<span class="token punctuation">,</span>name <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> user_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3.</span><span class="token punctuation">.</span><span class="token number">.1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果我们对<code>in的条件</code>不做任何限制的话，该查询语句一次性可能会查询出非常多的数据，很容易导致接口超时。尤其有时候，我们是用的子查询，in后面的子查询，你都不知道数量有多少那种，更容易采坑（<strong>所以我把in元素过多抽出来作为一个小节</strong>）。如下这种子查询：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> user_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> author_id <span class="token keyword">from</span> artilce <span class="token keyword">where</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>正例是，<strong>分批进行</strong>，每批500个：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> user_id<span class="token punctuation">,</span>name <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> user_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3.</span><span class="token punctuation">.</span><span class="token number">.500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果传参的ids太多，还可以做个参数校验什么的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>userIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;单次查询的用户Id不能超过500&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-数据库在刷脏页" tabindex="-1"><a class="header-anchor" href="#_7-数据库在刷脏页" aria-hidden="true">#</a> 7. 数据库在刷脏页</h2><h3 id="_7-1-什么是脏页" tabindex="-1"><a class="header-anchor" href="#_7-1-什么是脏页" aria-hidden="true">#</a> 7.1 什么是脏页</h3><p>当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“<strong>脏页</strong>”。内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了，称为“<strong>干净页</strong>”。一般有更新SQL才可能会导致脏页，我们回忆一下：一条更新语句是如何执行的</p><h3 id="_7-2-一条更新语句是如何执行的" tabindex="-1"><a class="header-anchor" href="#_7-2-一条更新语句是如何执行的" aria-hidden="true">#</a> 7.2 一条更新语句是如何执行的？</h3><p>以下的这个更新SQL，如何执行的呢？</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">update</span> t <span class="token keyword">set</span> c<span class="token operator">=</span>c<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">666</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>对于这条更新SQL，执行器会先找引擎取<code>id=666</code>这一行。如果这行所在的数据页本来就在内存中的话，就直接返回给执行器。如果不在内存，就去磁盘读入内存，再返回。</li><li>执行器拿到引擎给的行数据后，给这一行<code>C</code>的值加一，得到新的一行数据，再调用引擎接口写入这行新数据。</li><li>引擎将这行新数据更新到内存中，同时将这个更新操作记录到<code>redo log</code>里面，但是此时<code>redo log </code>是处于<code>prepare</code>状态的哈。</li><li>执行器生成这个操作的<code>binlog</code>，并把<code>binlog</code>写入磁盘。</li><li>执行器调用引擎的提交事务接口，引擎把刚刚写入的<code>redo log</code>改成提交（commit）状态，更新完成。</li></ol><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204225312611.png" alt="image-20221204225312611" tabindex="0" loading="lazy"><figcaption>image-20221204225312611</figcaption></figure><p>InnoDB 在处理更新语句的时候，只做了写日志这一个磁盘操作。这个日志叫作<code>redo log</code>（重做日志）。平时更新SQL执行得很快，其实是因为它只是在写内存和<code>redo log</code>日志，等到空闲的时候，才把<code>redo log</code>日志里的数据同步到磁盘中。</p><blockquote><p>有些小伙伴可能有疑惑，<code>redo log</code>日志不是在磁盘嘛？那为什么不慢？其实是因为写<code>redo log</code>的过程是顺序写磁盘的。<strong>磁盘顺序写</strong>会减少寻道等待时间，速度比随机写要快很多的。</p></blockquote><h3 id="_7-3-为什么会出现脏页呢" tabindex="-1"><a class="header-anchor" href="#_7-3-为什么会出现脏页呢" aria-hidden="true">#</a> 7.3 为什么会出现脏页呢？</h3><p>更新SQL只是在写内存和<code>redo log</code>日志，等到空闲的时候，才把<code>redo log</code>日志里的数据同步到磁盘中。这时内存数据页跟磁盘数据页内容不一致,就出现脏页。</p><h3 id="_7-4-什么时候会刷脏页-flush" tabindex="-1"><a class="header-anchor" href="#_7-4-什么时候会刷脏页-flush" aria-hidden="true">#</a> 7.4 什么时候会刷脏页（flush）？</h3><p>InnoDB存储引擎的<code>redo log</code>大小是固定，且是环型写入的，如下图（图片来源于MySQL 实战 45 讲）：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204225419282.png" alt="image-20221204225419282" tabindex="0" loading="lazy"><figcaption>image-20221204225419282</figcaption></figure><p>那什么时候会刷脏页？有几种场景：</p><ol><li><code>redo log</code>写满了，要刷脏页。这种情况要尽量避免的。因为出现这种情况时，整个系统就不能再接受更新啦，即所有的更新都必须堵住。</li><li>内存不够了，需要新的内存页，就要淘汰一些数据页，这时候会刷脏页</li></ol><blockquote><p>InnoDB 用缓冲池（buffer pool）管理内存,而当要读入的数据页没有在内存的时候，就必须到缓冲池中申请一个数据页。这时候只能把最久不使用的数据页从内存中淘汰掉：如果要淘汰的是一个干净页，就直接释放出来复用；但如果是脏页呢，就必须<strong>将脏页先刷到磁盘</strong>，变成干净页后才能复用。</p></blockquote><ol><li>MySQL 认为<strong>系统空闲</strong>的时候，也会刷一些脏页</li><li>MySQL 正常关闭时，会把内存的脏页都 flush 到磁盘上</li></ol><h3 id="_7-5-为什么刷脏页会导致sql变慢呢" tabindex="-1"><a class="header-anchor" href="#_7-5-为什么刷脏页会导致sql变慢呢" aria-hidden="true">#</a> 7.5 为什么刷脏页会导致SQL变慢呢？</h3><ol><li><code>redo log</code>写满了，要刷脏页，这时候会导致系统所有的更新堵住，写性能都跌为0了，肯定慢呀。一般要杜绝出现这个情况。</li><li>一个查询要淘汰的脏页个数太多，一样会导致查询的响应时间明显变长。</li></ol><h2 id="_8-order-by-文件排序" tabindex="-1"><a class="header-anchor" href="#_8-order-by-文件排序" aria-hidden="true">#</a> 8. order by 文件排序</h2><p><code>order by</code>就一定会导致慢查询吗？<strong>不是这样的哈</strong>，因为<code>order by</code>平时用得多，并且数据量一上来，还是走<strong>文件排序</strong>的话，很容易有慢SQL的。听我娓娓道来，<code>order by</code>哪些时候可能会导致慢SQL哈。</p><h3 id="_8-1-order-by-的-using-filesort文件排序" tabindex="-1"><a class="header-anchor" href="#_8-1-order-by-的-using-filesort文件排序" aria-hidden="true">#</a> 8.1 order by 的 Using filesort文件排序</h3><p>我们平时经常需要用到<code>order by</code> ，主要就是用来给某些字段排序的。比如以下SQL:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>select name,age,city from staff where city = &#39;深圳&#39; order by age limit 10;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它表示的意思就是：<strong>查询前10个，来自深圳员工的姓名、年龄、城市，并且按照年龄小到大排序。</strong></p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204225551385.png" alt="image-20221204225551385" tabindex="0" loading="lazy"><figcaption>image-20221204225551385</figcaption></figure><p>查看<code>explain</code>执行计划的时候，可以看到<code>Extra</code>这一列，有一个<code>Using filesort</code>，它表示用到<strong>文件排序</strong>。</p><h3 id="_8-2-order-by文件排序效率为什么较低" tabindex="-1"><a class="header-anchor" href="#_8-2-order-by文件排序效率为什么较低" aria-hidden="true">#</a> 8.2 order by文件排序效率为什么较低</h3><p><code>order by</code>用到文件排序时，为什么查询效率会相对低呢？</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204225626742.png" alt="image-20221204225626742" tabindex="0" loading="lazy"><figcaption>image-20221204225626742</figcaption></figure><p><code>order by</code>排序，分为全字段排序和rowid排序。它是拿<code>max_length_for_sort_data</code>和结果行数据长度对比，如果结果行数据长度超过<code>max_length_for_sort_data</code>这个值，就会走<strong>rowid排序</strong>，相反，则走<strong>全字段排序</strong>。</p><h4 id="_8-2-1-rowid排序" tabindex="-1"><a class="header-anchor" href="#_8-2-1-rowid排序" aria-hidden="true">#</a> 8.2.1 rowid排序</h4><p>rowid排序，一般需要<strong>回表去找满足条件的数据，所以效率会慢一点</strong>。以下这个SQL，使用<code>rowid</code>排序，执行过程是这样：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>select name,age,city from staff where city = &#39;深圳&#39; order by age limit 10;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>MySQL 为对应的线程初始化<code>sort_buffer</code>，放入需要排序的<code>age</code>字段，以及<code>主键id</code>；</li><li>从索引树<code>idx_city</code>， 找到第一个满足 <code>city=&#39;深圳’</code>条件的<code>主键id</code>，也就是图中的<code>id=9</code>；</li><li>到<code>主键id索引树</code>拿到<code>id=9</code>的这一行数据， 取<code>age和主键id</code>的值，存到<code>sort_buffer</code>；</li><li>从索引树<code>idx_city</code>拿到下一个记录的<code>主键id</code>，即图中的<code>id=13</code>；</li><li>重复步骤 3、4 直到<code>city</code>的值不等于深圳为止；</li><li>前面5步已经查找到了所有<code>city</code>为深圳的数据，在<code>sort_buffer</code>中，将所有数据根据age进行排序；</li><li>遍历排序结果，取前10行，并按照<code>id</code>的值回到原表中，取出<code>city、name 和 age</code>三个字段返回给客户端。</li></ol><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204225732688.png" alt="image-20221204225732688" tabindex="0" loading="lazy"><figcaption>image-20221204225732688</figcaption></figure><h4 id="_8-2-2-全字段排序" tabindex="-1"><a class="header-anchor" href="#_8-2-2-全字段排序" aria-hidden="true">#</a> 8.2.2 全字段排序</h4><p>同样的SQL，如果是走全字段排序是这样的：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>select name,age,city from staff where city = &#39;深圳&#39; order by age limit 10;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>MySQL 为对应的线程初始化<code>sort_buffer</code>，放入需要查询的<code>name、age、city</code>字段；</li><li>从索引树<code>idx_city</code>， 找到第一个满足 <code>city=&#39;深圳’</code>条件的主键 id，也就是图中的<code>id=9</code>；</li><li>到主键<code>id索引树</code>拿到<code>id=9</code>的这一行数据， 取<code>name、age、city</code>三个字段的值，存到<code>sort_buffer</code>；</li><li>从索引树<code>idx_city </code>拿到下一个记录的主键<code>id</code>，即图中的<code>id=13</code>；</li><li>重复步骤 3、4 直到<code>city</code>的值不等于深圳为止；</li><li>前面5步已经查找到了所有<code>city</code>为深圳的数据，在<code>sort_buffer</code>中，将所有数据根据<code>age</code>进行排序；</li><li>按照排序结果取前10行返回给客户端。</li></ol><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204225800181.png" alt="image-20221204225800181" tabindex="0" loading="lazy"><figcaption>image-20221204225800181</figcaption></figure><p><code>sort_buffer</code>的大小是由一个参数控制的：<code>sort_buffer_size</code>。</p><ul><li>如果要排序的数据小于<code>sort_buffer_size</code>，排序在<code>sort_buffer</code>内存中完成</li><li>如果要排序的数据大于<code>sort_buffer_size</code>，则借助磁盘文件来进行排序。</li></ul><blockquote><p>借助磁盘文件排序的话，<strong>效率就更慢一点</strong>。因为先把数据放入<code>sort_buffer</code>，当快要满时。会排一下序，然后把<code>sort_buffer</code>中的数据，放到临时磁盘文件，等到所有满足条件数据都查完排完，再用归并算法把磁盘的临时排好序的小文件，合并成一个有序的大文件。</p></blockquote><h3 id="_8-3-如何优化order-by的文件排序" tabindex="-1"><a class="header-anchor" href="#_8-3-如何优化order-by的文件排序" aria-hidden="true">#</a> 8.3 如何优化order by的文件排序</h3><p><code>order by</code>使用<strong>文件排序</strong>，效率会低一点。我们怎么优化呢？</p><ul><li>因为数据是无序的，所以就需要排序。如果数据本身是有序的，那就不会再用到文件排序啦。而索引数据本身是有序的，我们通过建立索引来优化<code>order by</code>语句。</li><li>我们还可以通过调整<code>max_length_for_sort_data</code>、<code>sort_buffer_size</code>等参数优化；</li></ul><h2 id="_9-拿不到锁" tabindex="-1"><a class="header-anchor" href="#_9-拿不到锁" aria-hidden="true">#</a> 9. 拿不到锁</h2><p>有时候，我们查询一条很简单的SQL，但是却等待很长的时间，不见结果返回。一般这种时候就是表被锁住了，或者要查询的某一行或者几行被锁住了。我们只能慢慢等待锁被释放。</p><blockquote><p>举一个生活的例子哈，你和别人合租了一间房子，这个房子只有一个卫生间的话。假设某一时刻，你们都想去卫生间，但是对方比你早了一点点。那么此时你只能等对方出来后才能进去。</p></blockquote><p>这时候，我们可以用<code>show processlist</code>命令，看看当前语句处于什么状态哈。</p><h2 id="_10-delete-in子查询不走索引" tabindex="-1"><a class="header-anchor" href="#_10-delete-in子查询不走索引" aria-hidden="true">#</a> 10. delete + in子查询不走索引！</h2><p>之前见到过一个生产慢SQL问题，当<code>delete</code>遇到<code>in</code>子查询时，即使有索引，也是不走索引的。而对应的<code>select + in</code>子查询，却可以走索引。</p><p>MySQL版本是5.7，假设当前有两张表account和old_account,表结构如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>old_account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键Id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;账户名&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1570068</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>REDUNDANT <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;老的账户表&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键Id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;账户名&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;余额&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1570068</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>REDUNDANT <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;账户表&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行的SQL如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> account <span class="token keyword">where</span> name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name <span class="token keyword">from</span> old_account<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看执行计划，发现不走索引：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204230004584.png" alt="image-20221204230004584" tabindex="0" loading="lazy"><figcaption>image-20221204230004584</figcaption></figure><p>但是如果把<code>delete</code>换成<code>select</code>，就会走索引。如下：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204230022294.png" alt="image-20221204230022294" tabindex="0" loading="lazy"><figcaption>image-20221204230022294</figcaption></figure><p>为什么<code>select + in</code>子查询会走索引，<code>delete + in</code>子查询却不会走索引呢？</p><p>我们执行以下SQL看看：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> account <span class="token keyword">where</span> name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name <span class="token keyword">from</span> old_account<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">WARNINGS</span><span class="token punctuation">;</span> <span class="token comment">//可以查看优化后,最终执行的sql</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>结果如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> 
semi <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>old_account<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>test2<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>old_account<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以发现，实际执行的时候，MySQL对<code>select in</code>子查询做了优化，把子查询改成<code>join</code>的方式，所以可以走索引。但是很遗憾，对于<code>delete in</code>子查询，MySQL却没有对它做这个优化。</p><p>日常开发中，大家注意一下这个场景哈，大家有兴趣可以看下这篇文章哈：<a href="https://mp.weixin.qq.com/s?__biz=Mzg3NzU5NTIwNg==&amp;mid=2247495170&amp;idx=1&amp;sn=ce914de3abdb0d887e286b680b25111f&amp;chksm=cf22312bf855b83d31a00da110626747df8e69fca1bc310642c56e39d663b006a8105f9fb1e1&amp;token=1495321435&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">生产问题分析！delete in子查询不走索引？！<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_11、group-by使用临时表" tabindex="-1"><a class="header-anchor" href="#_11、group-by使用临时表" aria-hidden="true">#</a> 11、group by使用临时表</h2><p><code>group by</code>一般用于分组统计，它表达的逻辑就是根据<strong>一定的规则，进行分组</strong>。日常开发中，我们使用得比较频繁。如果不注意，很容易产生慢SQL。</p><h3 id="_11-1-group-by的执行流程" tabindex="-1"><a class="header-anchor" href="#_11-1-group-by的执行流程" aria-hidden="true">#</a> 11.1 group by的执行流程</h3><p>假设有表结构：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>staff<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>id_card<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;身份证号码&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;姓名&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;年龄&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>city<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;城市&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">15</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;员工表&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们查看一下这个SQL的执行计划：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> city <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> num <span class="token keyword">from</span> staff <span class="token keyword">group</span> <span class="token keyword">by</span> city<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230109210157321.png" alt="image-20230109210157321" tabindex="0" loading="lazy"><figcaption>image-20230109210157321</figcaption></figure><ul><li>Extra 这个字段的<code>Using temporary</code>表示在执行分组的时候使用了<strong>临时表</strong></li><li>Extra 这个字段的<code>Using filesort</code>表示使用了<strong>文件排序</strong></li></ul><p><code>group by</code>是怎么使用到临时表和排序了呢？我们来看下这个SQL的执行流程</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>select city ,count(*) as num from staff group by city;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>创建内存临时表，表里有两个字段<code>city和num</code>；</li><li>全表扫描<code>staff</code>的记录，依次取出<code>city = &#39;X&#39;</code>的记录。</li></ol><ul><li>判断临时表中是否有为 <code>city=&#39;X&#39;</code>的行，没有就插入一个记录<code> (X,1)</code>;</li><li>如果临时表中有<code>city=&#39;X&#39;</code>的行，就将X这一行的num值加 1；</li></ul><ol start="3"><li>遍历完成后，再根据字段<code>city</code>做排序，得到结果集返回给客户端。这个流程的执行图如下：</li></ol><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20221204230153215.png" alt="image-20221204230153215" tabindex="0" loading="lazy"><figcaption>image-20221204230153215</figcaption></figure><p><strong>临时表的排序是怎样的呢？</strong></p><p>就是把需要排序的字段，放到sort buffer，排完就返回。在这里注意一点哈，排序分<strong>全字段排序和rowid排序</strong></p><ul><li>如果是全字段排序，需要查询返回的字段，都放入sort buffer，根据排序字段排完，直接返回</li><li>如果是rowid排序，只是需要排序的字段放入sort buffer，然后多一次回表操作，再返回。</li></ul><h3 id="_11-2-group-by可能会慢在哪里" tabindex="-1"><a class="header-anchor" href="#_11-2-group-by可能会慢在哪里" aria-hidden="true">#</a> 11.2 group by可能会慢在哪里？</h3><p><code>group by</code>使用不当，很容易就会产生慢SQL 问题。因为它既用到临时表，又默认用到排序。有时候还可能用到磁盘临时表。</p><ul><li>如果执行过程中，会发现<code>内存临时表</code>大小到达了上限（控制这个上限的参数就是tmp_table_size），会把内存临时表转成磁盘临时表。</li><li>如果数据量很大，很可能这个查询需要的磁盘临时表，就会占用大量的磁盘空间。</li></ul><h3 id="_11-3-如何优化group-by呢" tabindex="-1"><a class="header-anchor" href="#_11-3-如何优化group-by呢" aria-hidden="true">#</a> 11.3 如何优化group by呢？</h3><p>从哪些方向去优化呢？</p><ul><li>方向1：既然它默认会排序，我们不给它排是不是就行啦。</li><li>方向2：既然临时表是影响<code>group by</code>性能的X因素，我们是不是可以不用临时表？</li></ul><p>我们一起来想下，执行<code>group by</code>语句为什么需要临时表呢？<code>group by</code>的语义逻辑，就是统计不同的值出现的个数。如果这个这些值一开始就是有序的，我们是不是直接往下扫描统计就好了，就不用临时表来记录并统计结果啦?</p><p>可以有这些优化方案：</p><ul><li>group by 后面的字段加索引</li><li>order by null 不用排序</li><li>尽量只使用内存临时表</li><li>使用SQL_BIG_RESULT</li></ul><h2 id="_12-系统硬件或网络资源" tabindex="-1"><a class="header-anchor" href="#_12-系统硬件或网络资源" aria-hidden="true">#</a> 12. 系统硬件或网络资源</h2><ul><li>如果数据库服务器内存、硬件资源，或者网络资源配置不是很好，就会慢一些哈。这时候可以升级配置。这就好比你的计算机有时候很卡，你可以加个内存条什么的一个道理。</li><li>如果数据库压力本身很大，比如高并发场景下，大量请求到数据库来，数据库服务器<code>CPU</code>占用很高或者<code>IO利用率</code>很高，这种情况下所有语句的执行都有可能变慢的哈。</li></ul><h2 id="最后" tabindex="-1"><a class="header-anchor" href="#最后" aria-hidden="true">#</a> 最后</h2><p>如果测试环境数据库的一些参数配置，和生产环境参数配置不一致的话，也容易产生慢SQL哈。之前见过一个慢SQL的生产案例，就是测试环境用了<code>index merge</code>，所以查看explain执行计划时，是可以走索引的，但是到了生产，却全表扫描，最后排查发现是生产环境配置把<code>index merge</code>关闭了。大家是否还遇到其他场景的慢SQL呢？如果有的话，欢迎评论区留言交流哈</p><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章" aria-hidden="true">#</a> 参考文章</h2><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NzU5NTIwNg==&amp;mid=2247499624&amp;idx=1&amp;sn=561b9cb7fe831ca7cb2d9fd65691e85e&amp;chksm=cf222041f855a957ac50c0a53baaec6d26be32427259b2974450620f33a8c834419fe535e83d&amp;token=1921274367&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">盘点MySQL慢查询的12个原因<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://mp.weixin.qq.com/s/ARMelvGnqxeWs8wCeV2r7A" target="_blank" rel="noopener noreferrer">从11s到170ms！看看人家的接口优化技巧，那叫一个优雅<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zszdevelop/java-study-gitbook/edit/main/docs/db/mysql/mysql-x-optimize-slow02.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zszdevelop@163.com">zszdevelop</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/db/mysql/sql-mysql-performance.html" class="nav-link prev" aria-label="MySQL - 性能优化"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->MySQL - 性能优化</div></a><a href="/db/mysql/mysql-x-optimize-explain.html" class="nav-link next" aria-label="MySQL - Explain使用分析"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">MySQL - Explain使用分析<!----></div></a></nav><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href='https://beian.miit.gov.cn' target='_blank' style='color: var(--c-text-lighter);>闽ICP备18001806号-1</a></div><div class="copyright">Copyright © 2023 zszdevelop</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-db723a5e.js" defer></script>
  </body>
</html>
