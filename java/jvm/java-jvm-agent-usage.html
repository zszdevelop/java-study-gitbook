<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.59" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://zszdevelop.github.io/java-study-gitbook/java-study-gitbook/java/jvm/java-jvm-agent-usage.html"><meta property="og:site_name" content="Javaå­¦ä¹ ç¬”è®°"><meta property="og:title" content="è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†"><meta property="og:description" content="æœ¬æ–‡è½¬è½½è‡ª ç¾å›¢æŠ€æœ¯å›¢é˜Ÿèƒ¡å¥çš„Java åŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µ (https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html), é€šè¿‡å­¦ä¹ java agentæ–¹å¼è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†è§£ç›®å‰å¾ˆå¤šå¤§å‚å¼€æºçš„ä¸€äº›åŸºäºæ­¤çš„è°ƒè¯•å·¥å…·ã€‚ 1. ç®€ä»‹ æ–­ç‚¹è°ƒè¯•æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„è°ƒè¯•æ‰‹æ®µ..."><meta property="og:type" content="article"><meta property="og:updated_time" content="2023-02-20T13:42:31.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2023-02-20T13:42:31.000Z"><script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?78dc0e0b4e3aedf643d6621778307a6f";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
      </script><title>è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç† | Javaå­¦ä¹ ç¬”è®°</title><meta name="description" content="æœ¬æ–‡è½¬è½½è‡ª ç¾å›¢æŠ€æœ¯å›¢é˜Ÿèƒ¡å¥çš„Java åŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µ (https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html), é€šè¿‡å­¦ä¹ java agentæ–¹å¼è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†è§£ç›®å‰å¾ˆå¤šå¤§å‚å¼€æºçš„ä¸€äº›åŸºäºæ­¤çš„è°ƒè¯•å·¥å…·ã€‚ 1. ç®€ä»‹ æ–­ç‚¹è°ƒè¯•æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„è°ƒè¯•æ‰‹æ®µ...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/java-study-gitbook/assets/style-f9854aed.css" as="style"><link rel="stylesheet" href="/java-study-gitbook/assets/style-f9854aed.css">
    <link rel="modulepreload" href="/java-study-gitbook/assets/app-d7a104d1.js"><link rel="modulepreload" href="/java-study-gitbook/assets/framework-0cf5f349.js"><link rel="modulepreload" href="/java-study-gitbook/assets/java-jvm-agent-usage.html-1aa6d330.js"><link rel="modulepreload" href="/java-study-gitbook/assets/java-jvm-agent-usage.html-d5a27f08.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/java-study-gitbook/" class="brand"><img class="logo" src="/java-study-gitbook/logo.svg" alt="Javaå­¦ä¹ ç¬”è®°"><!----><span class="site-name hide-in-pad">Javaå­¦ä¹ ç¬”è®°</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="icon iconfont icon-creative"></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/java/base/Java-basis-oop.html" class="nav-link" aria-label="JavaåŸºç¡€"><!---->JavaåŸºç¡€<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/java/io/java-io-overview.html" class="nav-link" aria-label="Java IO"><!---->Java IO<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/java/collection/java-collection-overview.html" class="nav-link" aria-label="Javaé›†åˆ"><!---->Javaé›†åˆ<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/java/thread/java-thread-x-theorty.html" class="nav-link" aria-label="Javaå¹¶å‘"><!---->Javaå¹¶å‘<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/java/java8/java8-lambda.html" class="nav-link" aria-label="Java8"><!---->Java8<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/java/jvm/jvm-overview.html" class="nav-link" aria-label="JVM"><!---->JVM<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ•°æ®åº“"><span class="title"><span class="icon iconfont icon-creative"></span>æ•°æ®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/db/sql/sql-x-basic.html" class="nav-link" aria-label="æ•°æ®åº“åŸºç¡€/SQLåŸºç¡€"><!---->æ•°æ®åº“åŸºç¡€/SQLåŸºç¡€<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Sqlæ•°æ®åº“</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-study-gitbook/db/mysql/sql-mysql-overview.html" class="nav-link" aria-label="Mysql"><!---->Mysql<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/db/oracle/oracle-b-sequence.html" class="nav-link" aria-label="Oracle"><!---->Oracle<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/db/dm/dm-operation-console.html" class="nav-link" aria-label="è¾¾æ¢¦"><!---->è¾¾æ¢¦<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>NoSqlæ•°æ®åº“</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-study-gitbook/db/redis/db-redis-introduce.html" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/db/mongodb/mongo-x-basic.html" class="nav-link" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/db/es/elasticsearch-x-introduce-1.html" class="nav-link" aria-label="Elasticsearch"><!---->Elasticsearch<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/db/neo4j/neo4j-x-tutorial.html" class="nav-link" aria-label="Neo4J"><!---->Neo4J<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ¡†æ¶|ä¾èµ–"><span class="title"><span class="icon iconfont icon-creative"></span>æ¡†æ¶|ä¾èµ–</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-study-gitbook/dependencies/spring/spring-overview.html" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/dependencies/spring-boot/springboot-x-overview.html" class="nav-link" aria-label="SpringBoot"><!---->SpringBoot<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ORM</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-study-gitbook/dependencies/mybatis/mybatis-y-arch.html" class="nav-link" aria-label="Mybatis"><!---->Mybatis<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/dependencies/mybatis-plus/mybatis-plus-x-gen-code.html" class="nav-link" aria-label="Mybatis-Plus"><!---->Mybatis-Plus<!----></a></li></ul></li><li class="dropdown-item"><a href="/java-study-gitbook/dependencies/office/office-x-aspose.html" class="nav-link" aria-label="Officeæ–‡æ¡£æ“ä½œ"><!---->Officeæ–‡æ¡£æ“ä½œ<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/dependencies/cas/cas-x-overview.html" class="nav-link" aria-label="CASå•ç‚¹ç™»å½•"><!---->CASå•ç‚¹ç™»å½•<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="å¼€å‘|æµ‹è¯•"><span class="title"><span class="icon iconfont icon-creative"></span>å¼€å‘|æµ‹è¯•</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/develop/devlibrary/dev-lib-lombok.html" class="nav-link" aria-label="å¼€å‘-å¸¸ç”¨ç±»åº“"><span class="icon iconfont icon-creative"></span>å¼€å‘-å¸¸ç”¨ç±»åº“<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/develop/security/dev-security-x-injection.html" class="nav-link" aria-label="å¼€å‘-å®‰å…¨"><span class="icon iconfont icon-creative"></span>å¼€å‘-å®‰å…¨<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/develop/optimization/optimization-x-interface-optimization.html" class="nav-link" aria-label="å¼€å‘ - ä¼˜åŒ–"><span class="icon iconfont icon-creative"></span>å¼€å‘ - ä¼˜åŒ–<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/develop/style/dev-qt-code-style.html" class="nav-link" aria-label="å¼€å‘ - è§„èŒƒ/é£æ ¼"><span class="icon iconfont icon-creative"></span>å¼€å‘ - è§„èŒƒ/é£æ ¼<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/develop/test/ut-overview" class="nav-link" aria-label="æµ‹è¯•"><span class="icon iconfont icon-creative"></span>æµ‹è¯•<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è½¯ä»¶|éƒ¨ç½²"><span class="title"><span class="icon iconfont icon-creative"></span>è½¯ä»¶|éƒ¨ç½²</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/deploy/docker/docker-basic-overview.html" class="nav-link" aria-label="Docker"><span class="icon iconfont icon-creative"></span>Docker<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æ¶ˆæ¯é˜Ÿåˆ—</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-study-gitbook/deploy/mq/mq-a-overview.html" class="nav-link" aria-label="æ¶ˆæ¯é˜Ÿåˆ—"><!---->æ¶ˆæ¯é˜Ÿåˆ—<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/deploy/mq-rabbitmq/rabbitmq-x-overview.html" class="nav-link" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a></li><li class="dropdown-subitem"><a href="/java-study-gitbook/deploy/mq-kafka/kafka-x-overview.html" class="nav-link" aria-label="Kafka"><!---->Kafka<!----></a></li></ul></li><li class="dropdown-item"><a href="/java-study-gitbook/deploy/skywalking/skywalking-x-principle.html" class="nav-link" aria-label="Skywalking"><span class="icon iconfont icon-creative"></span>Skywalking<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/deploy/linux/linux-j-monitor-overview.html" class="nav-link" aria-label="Linux"><span class="icon iconfont icon-creative"></span>Linux<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/deploy/jenkins/jenkins-overview.html" class="nav-link" aria-label="Jenkins"><span class="icon iconfont icon-creative"></span>Jenkins<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/deploy/nginx/nginx-x-overview.html" class="nav-link" aria-label="Nginx"><span class="icon iconfont icon-creative"></span>Nginx<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/deploy/deploy/docker-basic-overview" class="nav-link" aria-label="éƒ¨ç½²"><span class="icon iconfont icon-creative"></span>éƒ¨ç½²<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ¶æ„|ç³»ç»Ÿ"><span class="title"><span class="icon iconfont icon-creative"></span>æ¶æ„|ç³»ç»Ÿ</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/arch/base/arch-basic.html" class="nav-link" aria-label="æ¶æ„åŸºç¡€"><span class="icon iconfont icon-creative"></span>æ¶æ„åŸºç¡€<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/arch/distributed/arch-id.html" class="nav-link" aria-label="åˆ†å¸ƒå¼ç³»ç»Ÿ"><span class="icon iconfont icon-creative"></span>åˆ†å¸ƒå¼ç³»ç»Ÿ<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/arch/microservices/ms-overview.html" class="nav-link" aria-label="å¾®æœåŠ¡"><span class="icon iconfont icon-creative"></span>å¾®æœåŠ¡<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/arch/minio/minio-concept.html" class="nav-link" aria-label="å¯¹è±¡å­˜å‚¨-Minio"><span class="icon iconfont icon-creative"></span>å¯¹è±¡å­˜å‚¨-Minio<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/arch/manage-system/manage-system-technical-selection.html" class="nav-link" aria-label="åå°ç®¡ç†ç³»ç»Ÿ"><span class="icon iconfont icon-creative"></span>åå°ç®¡ç†ç³»ç»Ÿ<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/arch/mall/mall-sku.html" class="nav-link" aria-label="å•†åŸè®¾è®¡"><span class="icon iconfont icon-creative"></span>å•†åŸè®¾è®¡<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è¯­è¨€|å¹³å°"><span class="title"><span class="icon iconfont icon-creative"></span>è¯­è¨€|å¹³å°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/language/frontend-layout/flex-layout-overview.html" class="nav-link" aria-label="å‰ç«¯"><span class="icon iconfont icon-creative"></span>å‰ç«¯<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/language/python/python-advantage.html" class="nav-link" aria-label="python"><span class="icon iconfont icon-creative"></span>python<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/language/weixin/wx-package-Optimization.html" class="nav-link" aria-label="å¾®ä¿¡"><span class="icon iconfont icon-creative"></span>å¾®ä¿¡<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/language/ai/knowledge-graph-build.html" class="nav-link" aria-label="AIäººå·¥æ™ºèƒ½"><span class="icon iconfont icon-creative"></span>AIäººå·¥æ™ºèƒ½<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ‚é¡¹|æ€è€ƒ"><span class="title"><span class="icon iconfont icon-creative"></span>æ‚é¡¹|æ€è€ƒ</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java-study-gitbook/think/deepImpression/redis-bigdata-slow-problem.html" class="nav-link" aria-label="å°è±¡æ·±åˆ»bug"><span class="icon iconfont icon-creative"></span>å°è±¡æ·±åˆ»bug<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/think/optimization/optimization-x-frequent-operation-db.html" class="nav-link" aria-label="ä¼˜åŒ–"><span class="icon iconfont icon-creative"></span>ä¼˜åŒ–<!----></a></li><li class="dropdown-item"><a href="/java-study-gitbook/think/misc/misc-x-middleware.html" class="nav-link" aria-label="æ‚é¡¹"><span class="icon iconfont icon-creative"></span>æ‚é¡¹<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/zszdevelop/java-study-gitbook" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">JavaåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java-IO</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Javaé›†åˆ</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å¤šçº¿ç¨‹ä¸å¹¶å‘</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java8</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">Jvm</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/java-study-gitbook/java/jvm/jvm-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="JVMç›¸å…³çŸ¥è¯†ä½“ç³»è¯¦è§£"><!---->JVMç›¸å…³çŸ¥è¯†ä½“ç³»è¯¦è§£<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-class.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - ç±»å­—èŠ‚ç è¯¦è§£"><!---->JVM åŸºç¡€ - ç±»å­—èŠ‚ç è¯¦è§£<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-class-enhancer.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - å­—èŠ‚ç çš„å¢å¼ºæŠ€æœ¯"><!---->JVM åŸºç¡€ - å­—èŠ‚ç çš„å¢å¼ºæŠ€æœ¯<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-classload.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - Java ç±»åŠ è½½æœºåˆ¶"><!---->JVM åŸºç¡€ - Java ç±»åŠ è½½æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-struct.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - JVM å†…å­˜ç»“æ„"><!---->JVM åŸºç¡€ - JVM å†…å­˜ç»“æ„<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-heap-s.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - Javaå†…å­˜ç»“æ„(ç²¾ç®€ç‰ˆ)"><!---->JVM åŸºç¡€ - Javaå†…å­˜ç»“æ„(ç²¾ç®€ç‰ˆ)<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-x-introduce.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - Java å†…å­˜æ¨¡å‹å¼•å…¥"><!---->JVM åŸºç¡€ - Java å†…å­˜æ¨¡å‹å¼•å…¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-jmm.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM åŸºç¡€ - Java å†…å­˜æ¨¡å‹è¯¦è§£"><!---->JVM åŸºç¡€ - Java å†…å­˜æ¨¡å‹è¯¦è§£<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc.html" class="nav-link sidebar-link sidebar-page" aria-label="GC - Java åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†"><!---->GC - Java åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-g1.html" class="nav-link sidebar-link sidebar-page" aria-label="GC - Java åƒåœ¾å›æ”¶å™¨ä¹‹G1è¯¦è§£"><!---->GC - Java åƒåœ¾å›æ”¶å™¨ä¹‹G1è¯¦è§£<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-g1-supplement.html" class="nav-link sidebar-link sidebar-page" aria-label="GC - Java åƒåœ¾å›æ”¶å™¨ä¹‹G1ï¼ˆè¡¥å……ï¼‰"><!---->GC - Java åƒåœ¾å›æ”¶å™¨ä¹‹G1ï¼ˆè¡¥å……ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-cms-gc.html" class="nav-link sidebar-link sidebar-page" aria-label="GC - Java åƒåœ¾å›æ”¶å™¨ä¹‹CMS GCé—®é¢˜åˆ†æä¸è§£å†³"><!---->GC - Java åƒåœ¾å›æ”¶å™¨ä¹‹CMS GCé—®é¢˜åˆ†æä¸è§£å†³<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-param.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - JVM è°ƒä¼˜å‚æ•°"><!---->è°ƒè¯•æ’é”™ - JVM è°ƒä¼˜å‚æ•°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-oom.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java å†…å­˜åˆ†æä¹‹å †å†…å­˜å’ŒMetaSpaceå†…å­˜"><!---->è°ƒè¯•æ’é”™ - Java å†…å­˜åˆ†æä¹‹å †å†…å­˜å’ŒMetaSpaceå†…å­˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-oom-offheap.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java å†…å­˜åˆ†æä¹‹å †å¤–å†…å­˜"><!---->è°ƒè¯•æ’é”™ - Java å†…å­˜åˆ†æä¹‹å †å¤–å†…å­˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-thread-dump.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java çº¿ç¨‹åˆ†æä¹‹çº¿ç¨‹Dumpåˆ†æ"><!---->è°ƒè¯•æ’é”™ - Java çº¿ç¨‹åˆ†æä¹‹çº¿ç¨‹Dumpåˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-oom-tool.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹JVMå¯è§†åŒ–å·¥å…·"><!---->è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹JVMå¯è§†åŒ–å·¥å…·<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-agent-arthas.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹åº”ç”¨åœ¨çº¿è°ƒè¯•Arthas"><!---->è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹åº”ç”¨åœ¨çº¿è°ƒè¯•Arthas<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-agent-arthas-problem.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Arthas é‡åˆ°çš„é—®é¢˜"><!---->è°ƒè¯•æ’é”™ - Arthas é‡åˆ°çš„é—®é¢˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-debug-idea.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•"><!---->è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†"><!---->è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_1-ç®€ä»‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. ç®€ä»‹"><!---->1. ç®€ä»‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_2-agentçš„å®ç°æ¨¡å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. Agentçš„å®ç°æ¨¡å¼"><!---->2. Agentçš„å®ç°æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_2-1-é€šè¿‡java-instrumentation-api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 é€šè¿‡Java Instrumentation API"><!---->2.1 é€šè¿‡Java Instrumentation API<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-å¯åŠ¨æ—¶åŠ è½½agent" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. å¯åŠ¨æ—¶åŠ è½½Agent"><!---->3. å¯åŠ¨æ—¶åŠ è½½Agent<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-1-å‚æ•°è§£æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1 å‚æ•°è§£æ"><!---->3.1 å‚æ•°è§£æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-2-æ‰§è¡ŒåŠ è½½æ“ä½œ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2 æ‰§è¡ŒåŠ è½½æ“ä½œ"><!---->3.2 æ‰§è¡ŒåŠ è½½æ“ä½œ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-3-instrumentåŠ¨æ€é“¾æ¥åº“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3  instrumentåŠ¨æ€é“¾æ¥åº“"><!---->3.3  instrumentåŠ¨æ€é“¾æ¥åº“<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-è¿è¡Œæ—¶åŠ è½½agent" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. è¿è¡Œæ—¶åŠ è½½Agent"><!---->4. è¿è¡Œæ—¶åŠ è½½Agent<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-1-attachlistener" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 AttachListener"><!---->4.1 AttachListener<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-2-è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°"><!---->4.2 è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-3-loadå‘½ä»¤çš„å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 loadå‘½ä»¤çš„å®ç°"><!---->4.3 loadå‘½ä»¤çš„å®ç°<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_5-åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶"><!---->5. åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_6-é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6. é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚"><!---->6. é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-java-debug-tool" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7. Java-debug-tool"><!---->7. Java-debug-tool<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-1-java-debug-toolæ•´ä½“æ¶æ„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.1  Java-debug-toolæ•´ä½“æ¶æ„"><!---->7.1  Java-debug-toolæ•´ä½“æ¶æ„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-2-java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.2 Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ"><!---->7.2 Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-3-java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.3 Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°"><!---->7.3 Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-4-java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.4 Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ"><!---->7.4 Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#å‚è€ƒæ–‡ç« " class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å‚è€ƒæ–‡ç« "><!---->å‚è€ƒæ–‡ç« <!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-help.html" class="nav-link sidebar-link sidebar-page" aria-label="GCä¸­å¯¹è±¡è‡ªæ•‘"><!---->GCä¸­å¯¹è±¡è‡ªæ•‘<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-log.html" class="nav-link sidebar-link sidebar-page" aria-label="gcæ—¥å¿—åˆ†æ"><!---->gcæ—¥å¿—åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-optimization-size.html" class="nav-link sidebar-link sidebar-page" aria-label="Javaå †è®¾ç½®å¤šå¤§åˆé€‚"><!---->Javaå †è®¾ç½®å¤šå¤§åˆé€‚<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-adapter.html" class="nav-link sidebar-link sidebar-page" aria-label="Javaå¦‚ä½•é€‰æ‹©åˆé€‚çš„åƒåœ¾å›æ”¶å™¨"><!---->Javaå¦‚ä½•é€‰æ‹©åˆé€‚çš„åƒåœ¾å›æ”¶å™¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-tools-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="JDKç›‘æ§å’Œæ•…éšœå¤„ç†å·¥å…·æ±‡æ€»"><!---->JDKç›‘æ§å’Œæ•…éšœå¤„ç†å·¥å…·æ±‡æ€»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-optimization-jstack.html" class="nav-link sidebar-link sidebar-page" aria-label="jstackç­‰å‘½ä»¤çš„å®ç°åŸç†"><!---->jstackç­‰å‘½ä»¤çš„å®ç°åŸç†<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-dispatch.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM å†…å­˜åˆ†é…ä¸å›æ”¶"><!---->JVM å†…å­˜åˆ†é…ä¸å›æ”¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-tools-visualvm.html" class="nav-link sidebar-link sidebar-page" aria-label="macç‰ˆideaé…ç½®visualvm"><!---->macç‰ˆideaé…ç½®visualvm<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-tools-mat-use.html" class="nav-link sidebar-link sidebar-page" aria-label="MATä½¿ç”¨"><!---->MATä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-tools-mat.html" class="nav-link sidebar-link sidebar-page" aria-label="MATå®‰è£…"><!---->MATå®‰è£…<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-tools-mat-shallow.html" class="nav-link sidebar-link sidebar-page" aria-label="Shallow heapå’ŒRetained heap"><!---->Shallow heapå’ŒRetained heap<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-classload-tomcat.html" class="nav-link sidebar-link sidebar-page" aria-label="tomcatç±»åŠ è½½å™¨"><!---->tomcatç±»åŠ è½½å™¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="åƒåœ¾æ”¶é›†å™¨"><!---->åƒåœ¾æ”¶é›†å™¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-orth.html" class="nav-link sidebar-link sidebar-page" aria-label="åƒåœ¾æ”¶é›†å™¨åƒåœ¾æ”¶é›†ç®—æ³•"><!---->åƒåœ¾æ”¶é›†å™¨åƒåœ¾æ”¶é›†ç®—æ³•<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-optimization.html" class="nav-link sidebar-link sidebar-page" aria-label="å¦‚ä½•åˆç†çš„è§„åˆ’ JVM æ€§èƒ½è°ƒä¼˜"><!---->å¦‚ä½•åˆç†çš„è§„åˆ’ JVM æ€§èƒ½è°ƒä¼˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-object-die.html" class="nav-link sidebar-link sidebar-page" aria-label="å¯¹è±¡å·²ç»æ­»äº¡ï¼Ÿ"><!---->å¯¹è±¡å·²ç»æ­»äº¡ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-classload1.html" class="nav-link sidebar-link sidebar-page" aria-label="ç±»åŠ è½½å™¨"><!---->ç±»åŠ è½½å™¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-classload-interview.html" class="nav-link sidebar-link sidebar-page" aria-label="ç±»åŠ è½½å™¨ï¼ˆå¸¸è§é¢è¯•ï¼‰"><!---->ç±»åŠ è½½å™¨ï¼ˆå¸¸è§é¢è¯•ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/jvm.html" class="nav-link sidebar-link sidebar-page" aria-label="ç±»åŠ è½½è¿‡ç¨‹"><!---->ç±»åŠ è½½è¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-classload-simplify.html" class="nav-link sidebar-link sidebar-page" aria-label="ç±»åŠ è½½è¿‡ç¨‹(ç²¾ç®€ç‰ˆ)"><!---->ç±»åŠ è½½è¿‡ç¨‹(ç²¾ç®€ç‰ˆ)<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-gc-fullgc.html" class="nav-link sidebar-link sidebar-page" aria-label="çº¿ä¸Šå¦‚ä½•æ’æŸ¥FullGC(ç³»ç»Ÿ CPU çªç„¶é£™å‡ä¸” GC é¢‘ç¹ï¼Œä½ è¯¥å¦‚ä½•æ’æŸ¥)"><!---->çº¿ä¸Šå¦‚ä½•æ’æŸ¥FullGC(ç³»ç»Ÿ CPU çªç„¶é£™å‡ä¸” GC é¢‘ç¹ï¼Œä½ è¯¥å¦‚ä½•æ’æŸ¥)<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-tools-mat-peoject.html" class="nav-link sidebar-link sidebar-page" aria-label="è®°ä¸€æ¬¡MATåˆ†æçº¿ä¸Šé¡¹ç›®è¿‡ç¨‹"><!---->è®°ä¸€æ¬¡MATåˆ†æçº¿ä¸Šé¡¹ç›®è¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-debug-tools-linux.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹Linuxå‘½ä»¤"><!---->è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹Linuxå‘½ä»¤<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java-study-gitbook/java/jvm/java-jvm-debug-tools-list.html" class="nav-link sidebar-link sidebar-page" aria-label="è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹å·¥å…·å•"><!---->è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹å·¥å…·å•<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java-ç¼–è¯‘</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://java.isture.com" target="_blank" rel="noopener noreferrer">zszdevelop</a></span><span property="author" content="zszdevelop"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-20T13:42:31.000Z"></span><span class="category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="category-item category4" role>Java</span><span class="category-item category1" role>JVM</span><meta property="articleSection" content="Java,JVM"></span><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 30 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT30M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_1-ç®€ä»‹" class="router-link-active router-link-exact-active toc-link level2">1. ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_2-agentçš„å®ç°æ¨¡å¼" class="router-link-active router-link-exact-active toc-link level2">2. Agentçš„å®ç°æ¨¡å¼</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_2-1-é€šè¿‡java-instrumentation-api" class="router-link-active router-link-exact-active toc-link level3">2.1 é€šè¿‡Java Instrumentation API</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-å¯åŠ¨æ—¶åŠ è½½agent" class="router-link-active router-link-exact-active toc-link level2">3. å¯åŠ¨æ—¶åŠ è½½Agent</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-1-å‚æ•°è§£æ" class="router-link-active router-link-exact-active toc-link level3">3.1 å‚æ•°è§£æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-2-æ‰§è¡ŒåŠ è½½æ“ä½œ" class="router-link-active router-link-exact-active toc-link level3">3.2 æ‰§è¡ŒåŠ è½½æ“ä½œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_3-3-instrumentåŠ¨æ€é“¾æ¥åº“" class="router-link-active router-link-exact-active toc-link level3">3.3  instrumentåŠ¨æ€é“¾æ¥åº“</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-è¿è¡Œæ—¶åŠ è½½agent" class="router-link-active router-link-exact-active toc-link level2">4. è¿è¡Œæ—¶åŠ è½½Agent</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-1-attachlistener" class="router-link-active router-link-exact-active toc-link level3">4.1 AttachListener</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-2-è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°" class="router-link-active router-link-exact-active toc-link level3">4.2 è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_4-3-loadå‘½ä»¤çš„å®ç°" class="router-link-active router-link-exact-active toc-link level3">4.3 loadå‘½ä»¤çš„å®ç°</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_5-åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶" class="router-link-active router-link-exact-active toc-link level2">5. åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_6-é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚" class="router-link-active router-link-exact-active toc-link level2">6. é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-java-debug-tool" class="router-link-active router-link-exact-active toc-link level2">7. Java-debug-tool</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-1-java-debug-toolæ•´ä½“æ¶æ„" class="router-link-active router-link-exact-active toc-link level3">7.1  Java-debug-toolæ•´ä½“æ¶æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-2-java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ" class="router-link-active router-link-exact-active toc-link level3">7.2 Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-3-java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°" class="router-link-active router-link-exact-active toc-link level3">7.3 Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#_7-4-java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ" class="router-link-active router-link-exact-active toc-link level3">7.4 Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java-study-gitbook/java/jvm/java-jvm-agent-usage.html#å‚è€ƒæ–‡ç« " class="router-link-active router-link-exact-active toc-link level2">å‚è€ƒæ–‡ç« </a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="è°ƒè¯•æ’é”™-javaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•æ’é”™-javaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†" aria-hidden="true">#</a> è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†</h1><blockquote><p>æœ¬æ–‡è½¬è½½è‡ª ç¾å›¢æŠ€æœ¯å›¢é˜Ÿèƒ¡å¥çš„<a href="https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html" target="_blank" rel="noopener noreferrer">Java åŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, é€šè¿‡å­¦ä¹ java agentæ–¹å¼è¿›è¡ŒåŠ¨æ€è°ƒè¯•äº†è§£ç›®å‰å¾ˆå¤šå¤§å‚å¼€æºçš„ä¸€äº›åŸºäºæ­¤çš„è°ƒè¯•å·¥å…·ã€‚</p></blockquote><h2 id="_1-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#_1-ç®€ä»‹" aria-hidden="true">#</a> 1. ç®€ä»‹</h2><p>æ–­ç‚¹è°ƒè¯•æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„è°ƒè¯•æ‰‹æ®µï¼Œå®ƒå¯ä»¥è·å–åˆ°æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å˜é‡ä¿¡æ¯ï¼Œå¹¶å¯ä»¥è§‚å¯Ÿåˆ°æ–¹æ³•çš„æ‰§è¡Œè·¯å¾„ã€‚ä½†æ–­ç‚¹è°ƒè¯•ä¼šåœ¨æ–­ç‚¹ä½ç½®åœé¡¿ï¼Œä½¿å¾—æ•´ä¸ªåº”ç”¨åœæ­¢å“åº”ã€‚åœ¨çº¿ä¸Šåœé¡¿åº”ç”¨æ˜¯è‡´å‘½çš„ï¼ŒåŠ¨æ€è°ƒè¯•æŠ€æœ¯ç»™äº†æˆ‘ä»¬åˆ›é€ æ–°çš„è°ƒè¯•æ¨¡å¼çš„æƒ³è±¡ç©ºé—´ã€‚æœ¬æ–‡å°†ç ”ç©¶Javaè¯­è¨€ä¸­çš„åŠ¨æ€è°ƒè¯•æŠ€æœ¯ï¼Œé¦–å…ˆæ¦‚æ‹¬JavaåŠ¨æ€è°ƒè¯•æ‰€æ¶‰åŠçš„æŠ€æœ¯åŸºç¡€ï¼Œæ¥ç€ä»‹ç»æˆ‘ä»¬åœ¨JavaåŠ¨æ€è°ƒè¯•é¢†åŸŸçš„æ€è€ƒåŠå®è·µï¼Œé€šè¿‡ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯ï¼Œè®¾è®¡å¹¶å®ç°äº†ä¸€ç§å…·å¤‡åŠ¨æ€æ€§çš„æ–­ç‚¹è°ƒè¯•å·¥å…·Java-debug-toolï¼Œæ˜¾è‘—æé«˜äº†æ•…éšœæ’æŸ¥æ•ˆç‡ã€‚</p><p>JVMTI (JVM Tool Interface)æ˜¯Javaè™šæ‹Ÿæœºå¯¹å¤–æä¾›çš„Nativeç¼–ç¨‹æ¥å£ï¼Œé€šè¿‡JVMTIï¼Œå¤–éƒ¨è¿›ç¨‹å¯ä»¥è·å–åˆ°è¿è¡Œæ—¶JVMçš„è¯¸å¤šä¿¡æ¯ï¼Œæ¯”å¦‚çº¿ç¨‹ã€GCç­‰ã€‚Agentæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç›®æ ‡JVMçš„ç‰¹å®šç¨‹åºï¼Œå®ƒçš„èŒè´£æ˜¯è´Ÿè´£ä»ç›®æ ‡JVMä¸­è·å–æ•°æ®ï¼Œç„¶åå°†æ•°æ®ä¼ é€’ç»™å¤–éƒ¨è¿›ç¨‹ã€‚åŠ è½½Agentçš„æ—¶æœºå¯ä»¥æ˜¯ç›®æ ‡JVMå¯åŠ¨ä¹‹æ—¶ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ç›®æ ‡JVMè¿è¡Œæ—¶è¿›è¡ŒåŠ è½½ï¼Œè€Œåœ¨ç›®æ ‡JVMè¿è¡Œæ—¶è¿›è¡ŒAgentåŠ è½½å…·å¤‡åŠ¨æ€æ€§ï¼Œå¯¹äºæ—¶æœºæœªçŸ¥çš„Debugåœºæ™¯æ¥è¯´éå¸¸å®ç”¨ã€‚ä¸‹é¢å°†è¯¦ç»†åˆ†æJava AgentæŠ€æœ¯çš„å®ç°ç»†èŠ‚ã€‚</p><h2 id="_2-agentçš„å®ç°æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-agentçš„å®ç°æ¨¡å¼" aria-hidden="true">#</a> 2. Agentçš„å®ç°æ¨¡å¼</h2><p>JVMTIæ˜¯ä¸€å¥—Nativeæ¥å£ï¼Œåœ¨Java SE 5ä¹‹å‰ï¼Œè¦å®ç°ä¸€ä¸ªAgentåªèƒ½é€šè¿‡ç¼–å†™Nativeä»£ç æ¥å®ç°ã€‚ä»Java SE 5å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨Javaçš„Instrumentationæ¥å£(java.lang.instrument)æ¥ç¼–å†™Agentã€‚æ— è®ºæ˜¯é€šè¿‡Nativeçš„æ–¹å¼è¿˜æ˜¯é€šè¿‡Java Instrumentationæ¥å£çš„æ–¹å¼æ¥ç¼–å†™Agentï¼Œå®ƒä»¬çš„å·¥ä½œéƒ½æ˜¯å€ŸåŠ©JVMTIæ¥è¿›è¡Œå®Œæˆï¼Œä¸‹é¢ä»‹ç»é€šè¿‡Java Instrumentationæ¥å£ç¼–å†™Agentçš„æ–¹æ³•ã€‚</p><h3 id="_2-1-é€šè¿‡java-instrumentation-api" tabindex="-1"><a class="header-anchor" href="#_2-1-é€šè¿‡java-instrumentation-api" aria-hidden="true">#</a> 2.1 é€šè¿‡Java Instrumentation API</h3><ul><li>å®ç°Agentå¯åŠ¨æ–¹æ³•</li></ul><p>Java Agentæ”¯æŒç›®æ ‡JVMå¯åŠ¨æ—¶åŠ è½½ï¼Œä¹Ÿæ”¯æŒåœ¨ç›®æ ‡JVMè¿è¡Œæ—¶åŠ è½½ï¼Œè¿™ä¸¤ç§ä¸åŒçš„åŠ è½½æ¨¡å¼ä¼šä½¿ç”¨ä¸åŒçš„å…¥å£å‡½æ•°ï¼Œå¦‚æœéœ€è¦åœ¨ç›®æ ‡JVMå¯åŠ¨çš„åŒæ—¶åŠ è½½Agentï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>JVMå°†é¦–å…ˆå¯»æ‰¾[1]ï¼Œå¦‚æœæ²¡æœ‰å‘ç°[1]ï¼Œå†å¯»æ‰¾[2]ã€‚å¦‚æœå¸Œæœ›åœ¨ç›®æ ‡JVMè¿è¡Œæ—¶åŠ è½½Agentï¼Œåˆ™éœ€è¦å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤ç»„æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°AgentArgsæ˜¯éšåŒ â€œâ€“ javaagentâ€ä¸€èµ·ä¼ å…¥çš„ç¨‹åºå‚æ•°ï¼Œå¦‚æœè¿™ä¸ªå­—ç¬¦ä¸²ä»£è¡¨äº†å¤šä¸ªå‚æ•°ï¼Œå°±éœ€è¦è‡ªå·±è§£æè¿™äº›å‚æ•°ã€‚instæ˜¯Instrumentationç±»å‹çš„å¯¹è±¡ï¼Œæ˜¯JVMè‡ªåŠ¨ä¼ å…¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿è¿™ä¸ªå‚æ•°è¿›è¡Œç±»å¢å¼ºç­‰æ“ä½œã€‚</p><ul><li>æŒ‡å®šMain-Class</li></ul><p>Agentéœ€è¦æ‰“åŒ…æˆä¸€ä¸ªjaråŒ…ï¼Œåœ¨ManiFestå±æ€§ä¸­æŒ‡å®šâ€œPremain-Classâ€æˆ–è€…â€œAgent-Classâ€ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Premain</span><span class="token operator">-</span><span class="token class-name">Class</span><span class="token operator">:</span> <span class="token keyword">class</span>
<span class="token class-name">Agent</span><span class="token operator">-</span><span class="token class-name">Class</span><span class="token operator">:</span> <span class="token keyword">class</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æŒ‚è½½åˆ°ç›®æ ‡JVM</li></ul><p>å°†ç¼–å†™çš„Agentæ‰“æˆjaråŒ…åï¼Œå°±å¯ä»¥æŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šå»äº†ã€‚å¦‚æœé€‰æ‹©åœ¨ç›®æ ‡JVMå¯åŠ¨æ—¶åŠ è½½Agentï¼Œåˆ™å¯ä»¥ä½¿ç”¨ â€œ-javaagent:[=]â€œï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥ä½¿ç”¨â€œJava -Helpâ€æ¥æŸ¥çœ‹ã€‚å¦‚æœæƒ³è¦åœ¨è¿è¡Œæ—¶æŒ‚è½½Agentåˆ°ç›®æ ‡JVMï¼Œå°±éœ€è¦åšä¸€äº›é¢å¤–çš„å¼€å‘äº†ã€‚</p><p>com.sun.tools.attach.VirtualMachine è¿™ä¸ªç±»ä»£è¡¨ä¸€ä¸ªJVMæŠ½è±¡ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªç±»æ‰¾åˆ°ç›®æ ‡JVMï¼Œå¹¶ä¸”å°†AgentæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šã€‚ä¸‹é¢æ˜¯ä½¿ç”¨com.sun.tools.attach.VirtualMachineè¿›è¡ŒåŠ¨æ€æŒ‚è½½Agentçš„ä¸€èˆ¬å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attachAgentToTargetJVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VirtualMachineDescriptor</span><span class="token punctuation">&gt;</span></span> virtualMachineDescriptors <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VirtualMachineDescriptor</span> targetVM <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineDescriptor</span> descriptor <span class="token operator">:</span> virtualMachineDescriptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                targetVM <span class="token operator">=</span> descriptor<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetVM <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;could not find the target jvm by process id:&quot;</span> <span class="token operator">+</span> configure<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">VirtualMachine</span> virtualMachine <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            virtualMachine <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>targetVM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            virtualMachine<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">&quot;{agent}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;{params}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualMachine <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                virtualMachine<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆé€šè¿‡æŒ‡å®šçš„è¿›ç¨‹IDæ‰¾åˆ°ç›®æ ‡JVMï¼Œç„¶åé€šè¿‡AttachæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šï¼Œæ‰§è¡ŒåŠ è½½Agentæ“ä½œã€‚VirtualMachineçš„Attachæ–¹æ³•å°±æ˜¯ç”¨æ¥å°†AgentæŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šå»çš„ï¼Œè€ŒDetachåˆ™æ˜¯å°†Agentä»ç›®æ ‡JVMå¸è½½ã€‚å…³äºAgentæ˜¯å¦‚ä½•æŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šçš„å…·ä½“æŠ€æœ¯ç»†èŠ‚ï¼Œå°†åœ¨ä¸‹æ–‡ä¸­è¿›è¡Œåˆ†æã€‚</p><h2 id="_3-å¯åŠ¨æ—¶åŠ è½½agent" tabindex="-1"><a class="header-anchor" href="#_3-å¯åŠ¨æ—¶åŠ è½½agent" aria-hidden="true">#</a> 3. å¯åŠ¨æ—¶åŠ è½½Agent</h2><h3 id="_3-1-å‚æ•°è§£æ" tabindex="-1"><a class="header-anchor" href="#_3-1-å‚æ•°è§£æ" aria-hidden="true">#</a> 3.1 å‚æ•°è§£æ</h3><p>åˆ›å»ºJVMæ—¶ï¼ŒJVMä¼šè¿›è¡Œå‚æ•°è§£æï¼Œå³è§£æé‚£äº›ç”¨æ¥é…ç½®JVMå¯åŠ¨çš„å‚æ•°ï¼Œæ¯”å¦‚å †å¤§å°ã€GCç­‰ï¼›æœ¬æ–‡ä¸»è¦å…³æ³¨è§£æçš„å‚æ•°ä¸º-agentlibã€ -agentpathã€ -javaagentï¼Œè¿™å‡ ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šAgentï¼ŒJVMä¼šæ ¹æ®è¿™å‡ ä¸ªå‚æ•°åŠ è½½Agentã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹JVMæ˜¯å¦‚ä½•è§£æè¿™å‡ ä¸ªå‚æ•°çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// -agentlib and -agentpath</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">&quot;-agentlib:&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>is_absolute_path <span class="token operator">=</span> <span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">&quot;-agentpath:&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>tail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pos <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token char">&#39;=&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_t len <span class="token operator">=</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">:</span> pos <span class="token operator">-</span> tail<span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token function">NEW_C_HEAP_ARRAY</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> mtArguments<span class="token punctuation">)</span><span class="token punctuation">,</span> tail<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        name<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>options <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pos <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          options <span class="token operator">=</span> os<span class="token operator">::</span><span class="token function">strdup_check_oom</span><span class="token punctuation">(</span>pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> mtArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token class-name">INCLUDE_JVMTI</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">valid_jdwp_agent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> is_absolute_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token operator">::</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Debugging agents are not supported in this VM\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token constant">JNI_ERR</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
#endif <span class="token comment">// !INCLUDE_JVMTI</span>
        <span class="token function">add_init_agent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">,</span> is_absolute_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment">// -javaagent</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">&quot;-javaagent:&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
#<span class="token keyword">if</span> <span class="token operator">!</span><span class="token class-name">INCLUDE_JVMTI</span>
      <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token operator">::</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Instrumentation agents are not supported in this VM\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">JNI_ERR</span><span class="token punctuation">;</span>
#<span class="token keyword">else</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size_t length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>options <span class="token operator">=</span> <span class="token function">NEW_C_HEAP_ARRAY</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> mtArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">jio_snprintf</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_init_agent</span><span class="token punctuation">(</span><span class="token string">&quot;instrument&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// java agents need module java.instrument</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">create_numbered_property</span><span class="token punctuation">(</span><span class="token string">&quot;jdk.module.addmods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java.instrument&quot;</span><span class="token punctuation">,</span> addmods_count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token constant">JNI_ENOMEM</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
#endif <span class="token comment">// !INCLUDE_JVMTI</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µæˆªå–è‡ªhotspot/src/share/vm/runtime/arguments.cppä¸­çš„ Arguments::parse_each_vm_init_arg(const JavaVMInitArgs* args, bool* patch_mod_javabase, Flag::Flags origin) å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨æ¥è§£æä¸€ä¸ªå…·ä½“çš„JVMå‚æ•°ã€‚è¿™æ®µä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯è§£æå‡ºéœ€è¦åŠ è½½çš„Agentè·¯å¾„ï¼Œç„¶åè°ƒç”¨add_init_agentå‡½æ•°è¿›è¡Œè§£æç»“æœçš„å­˜å‚¨ã€‚ä¸‹é¢å…ˆçœ‹ä¸€ä¸‹add_init_agentå‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// -agentlib and -agentpath arguments</span>
  <span class="token keyword">static</span> <span class="token class-name">AgentLibraryList</span> _agentList<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_init_agent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> options<span class="token punctuation">,</span> bool absolute_path<span class="token punctuation">)</span>
    <span class="token punctuation">{</span> _agentList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AgentLibrary</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">,</span> absolute_path<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AgentLibraryListæ˜¯ä¸€ä¸ªç®€å•çš„é“¾è¡¨ç»“æ„ï¼Œadd_init_agentå‡½æ•°å°†è§£æå¥½çš„ã€éœ€è¦åŠ è½½çš„Agentæ·»åŠ åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ï¼Œç­‰å¾…åç»­çš„å¤„ç†ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œè§£æ-javaagentå‚æ•°æœ‰ä¸€äº›ç‰¹åˆ«ä¹‹å¤„ï¼Œè¿™ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šä¸€ä¸ªæˆ‘ä»¬é€šè¿‡Java Instrumentation APIæ¥ç¼–å†™çš„Agentï¼ŒJava Instrumentation APIåº•å±‚ä¾èµ–çš„æ˜¯JVMTIï¼Œå¯¹-JavaAgentçš„å¤„ç†ä¹Ÿè¯´æ˜äº†è¿™ä¸€ç‚¹ï¼Œåœ¨è°ƒç”¨add_init_agentå‡½æ•°æ—¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯â€œinstrumentâ€ï¼Œå…³äºåŠ è½½Agentè¿™ä¸ªé—®é¢˜åœ¨ä¸‹ä¸€å°èŠ‚è¿›è¡Œå±•å¼€ã€‚åˆ°æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å¯åŠ¨JVMæ—¶æŒ‡å®šçš„Agentå·²ç»è¢«JVMè§£æå®Œå­˜æ”¾åœ¨äº†ä¸€ä¸ªé“¾è¡¨ç»“æ„ä¸­ã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹JVMæ˜¯å¦‚ä½•åŠ è½½è¿™äº›Agentçš„ã€‚</p><h3 id="_3-2-æ‰§è¡ŒåŠ è½½æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_3-2-æ‰§è¡ŒåŠ è½½æ“ä½œ" aria-hidden="true">#</a> 3.2 æ‰§è¡ŒåŠ è½½æ“ä½œ</h3><p>åœ¨åˆ›å»ºJVMè¿›ç¨‹çš„å‡½æ•°ä¸­ï¼Œè§£æå®ŒJVMå‚æ•°ä¹‹åï¼Œä¸‹é¢çš„è¿™æ®µä»£ç å’ŒåŠ è½½Agentç›¸å…³ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// Launch -agentlib/-agentpath and converted -Xrun agents</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arguments</span><span class="token operator">::</span><span class="token function">init_agents_at_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">create_vm_init_agents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> bool <span class="token function">init_agents_at_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>_agentList<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“JVMåˆ¤æ–­å‡ºä¸Šä¸€å°èŠ‚ä¸­è§£æå‡ºæ¥çš„Agentä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œå°±è¦å»è°ƒç”¨å‡½æ•°create_vm_init_agentsæ¥åŠ è½½Agentï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹create_vm_init_agentså‡½æ•°æ˜¯å¦‚ä½•åŠ è½½Agentçš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">Threads</span><span class="token operator">::</span><span class="token function">create_vm_init_agents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">AgentLibrary</span><span class="token operator">*</span> agent<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>agent <span class="token operator">=</span> <span class="token class-name">Arguments</span><span class="token operator">::</span><span class="token function">agents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> agent <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> agent <span class="token operator">=</span> agent<span class="token operator">-&gt;</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OnLoadEntry_t</span>  on_load_entry <span class="token operator">=</span> <span class="token function">lookup_agent_on_load</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>on_load_entry <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Invoke the Agent_OnLoad function</span>
      jint err <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>on_load_entry<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>main_vm<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>create_vm_init_agentsè¿™ä¸ªå‡½æ•°é€šè¿‡éå†Agenté“¾è¡¨æ¥é€ä¸ªåŠ è½½Agentã€‚é€šè¿‡è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆé€šè¿‡lookup_agent_on_loadæ¥åŠ è½½Agentå¹¶ä¸”æ‰¾åˆ°Agent_OnLoadå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯Agentçš„å…¥å£å‡½æ•°ã€‚å¦‚æœæ²¡æ‰¾åˆ°è¿™ä¸ªå‡½æ•°ï¼Œåˆ™è®¤ä¸ºæ˜¯åŠ è½½äº†ä¸€ä¸ªä¸åˆæ³•çš„Agentï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™æ ·Agentçš„ä»£ç å°±å¼€å§‹æ‰§è¡Œèµ·æ¥äº†ã€‚å¯¹äºä½¿ç”¨Java Instrumentation APIæ¥ç¼–å†™Agentçš„æ–¹å¼æ¥è¯´ï¼Œåœ¨è§£æé˜¶æ®µè§‚å¯Ÿåˆ°åœ¨add_init_agentå‡½æ•°é‡Œé¢ä¼ é€’è¿›å»çš„æ˜¯ä¸€ä¸ªå«åšâ€instrumentâ€çš„å­—ç¬¦ä¸²ï¼Œå…¶å®è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚åœ¨Linuxé‡Œé¢ï¼Œ<a href="http://xn--libinstrument-2h1us8wmmp987bfm3n.so" target="_blank" rel="noopener noreferrer">è¿™ä¸ªåº“å«åšlibinstrument.so<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œåœ¨BSDç³»ç»Ÿä¸­å«åšlibinstrument.dylibï¼Œè¯¥åŠ¨æ€é“¾æ¥åº“åœ¨{JAVA_HOME}/jre/lib/ç›®å½•ä¸‹ã€‚</p><h3 id="_3-3-instrumentåŠ¨æ€é“¾æ¥åº“" tabindex="-1"><a class="header-anchor" href="#_3-3-instrumentåŠ¨æ€é“¾æ¥åº“" aria-hidden="true">#</a> 3.3 instrumentåŠ¨æ€é“¾æ¥åº“</h3><p>libinstrumentç”¨æ¥æ”¯æŒä½¿ç”¨Java Instrumentation APIæ¥ç¼–å†™Agentï¼Œåœ¨libinstrumentä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç±»ç§°ä¸ºï¼šJPLISAgent(Java Programming Language Instrumentation Services Agent)ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆå§‹åŒ–æ‰€æœ‰é€šè¿‡Java Instrumentation APIç¼–å†™çš„Agentï¼Œå¹¶ä¸”ä¹Ÿæ‰¿æ‹…ç€é€šè¿‡JVMTIå®ç°Java Instrumentationä¸­æš´éœ²APIçš„è´£ä»»ã€‚</p><p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨JVMå¯åŠ¨çš„æ—¶å€™ï¼ŒJVMä¼šé€šè¿‡-javaagentå‚æ•°åŠ è½½Agentã€‚æœ€å¼€å§‹åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢æ‰¾åˆ°JVMTIçš„å…¥å£æ–¹æ³•ï¼šAgent_OnLoadã€‚ä¸‹é¢å°±æ¥åˆ†æä¸€ä¸‹åœ¨libinstrumentåŠ¨æ€é“¾æ¥åº“ä¸­ï¼ŒAgent_OnLoadå‡½æ•°æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token constant">JNIEXPORT</span> jint <span class="token constant">JNICALL</span>
<span class="token class-name">DEF_Agent_OnLoad</span><span class="token punctuation">(</span><span class="token class-name">JavaVM</span> <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>tail<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initerror <span class="token operator">=</span> <span class="token function">createNewJPLISAgent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> initerror <span class="token operator">==</span> <span class="token constant">JPLIS_INIT_ERROR_NONE</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseArgumentTail</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token operator">&amp;</span>jarfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">&quot;-javaagent: memory allocation failure.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">JNI_ERR</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        attributes <span class="token operator">=</span> <span class="token function">readAttributes</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        premainClass <span class="token operator">=</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">&quot;Premain-Class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* Save the jarfile name */</span>
        agent<span class="token operator">-&gt;</span>mJarfile <span class="token operator">=</span> jarfile<span class="token punctuation">;</span>
        <span class="token comment">/*
         * Convert JAR attributes into agent capabilities
         */</span>
        <span class="token function">convertCapabilityAttributes</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * Track (record) the agent class name and options data
         */</span>
        initerror <span class="token operator">=</span> <span class="token function">recordCommandLineData</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> premainClass<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ç‰‡æ®µæ˜¯ç»è¿‡ç²¾ç®€çš„libinstrumentä¸­Agent_OnLoadå®ç°çš„ï¼Œå¤§æ¦‚çš„æµç¨‹å°±æ˜¯ï¼šå…ˆåˆ›å»ºä¸€ä¸ªJPLISAgentï¼Œç„¶åå°†ManiFestä¸­è®¾å®šçš„ä¸€äº›å‚æ•°è§£æå‡ºæ¥ï¼Œ æ¯”å¦‚(Premain-Class)ç­‰ã€‚åˆ›å»ºäº†JPLISAgentä¹‹åï¼Œè°ƒç”¨initializeJPLISAgentå¯¹è¿™ä¸ªAgentè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚è·Ÿè¿›initializeJPLISAgentçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">JPLISInitializationError</span> <span class="token function">initializeJPLISAgent</span><span class="token punctuation">(</span><span class="token class-name">JPLISAgent</span> <span class="token operator">*</span>agent<span class="token punctuation">,</span> <span class="token class-name">JavaVM</span> <span class="token operator">*</span>vm<span class="token punctuation">,</span> jvmtiEnv <span class="token operator">*</span>jvmtienv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* check what capabilities are available */</span>
    <span class="token function">checkCapabilities</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* check phase - if live phase then we don&#39;t need the VMInit event */</span>
    jvmtierror <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>jvmtienv<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetPhase</span><span class="token punctuation">(</span>jvmtienv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* now turn on the VMInit event */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> jvmtierror <span class="token operator">==</span> <span class="token constant">JVMTI_ERROR_NONE</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jvmtiEventCallbacks callbacks<span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">callbacks<span class="token punctuation">.</span></span>VMInit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>eventHandlerVMInit<span class="token punctuation">;</span>
        jvmtierror <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>jvmtienv<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">SetEventCallbacks</span><span class="token punctuation">(</span>jvmtienv<span class="token punctuation">,</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span><span class="token function">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> jvmtierror <span class="token operator">==</span> <span class="token constant">JVMTI_ERROR_NONE</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jvmtierror <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>jvmtienv<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span>jvmtienv<span class="token punctuation">,</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span><span class="token constant">JVMTI_EVENT_VM_INIT</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>jvmtierror <span class="token operator">==</span> <span class="token constant">JVMTI_ERROR_NONE</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token constant">JPLIS_INIT_ERROR_NONE</span> <span class="token operator">:</span> <span class="token constant">JPLIS_INIT_ERROR_FAILURE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œæˆ‘ä»¬å…³æ³¨callbacks.VMInit = &amp;eventHandlerVMInit;è¿™è¡Œä»£ç ï¼Œè¿™é‡Œè®¾ç½®äº†ä¸€ä¸ªVMInitäº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œè¡¨ç¤ºåœ¨JVMåˆå§‹åŒ–çš„æ—¶å€™ä¼šå›è°ƒeventHandlerVMInitå‡½æ•°ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ç»†èŠ‚ï¼ŒçŒœæµ‹å°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨äº†Premainæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">JNICALL</span>  <span class="token function">eventHandlerVMInit</span><span class="token punctuation">(</span> jvmtiEnv <span class="token operator">*</span>jvmtienv<span class="token punctuation">,</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>jnienv<span class="token punctuation">,</span>jthread thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   success <span class="token operator">=</span> <span class="token function">processJavaStart</span><span class="token punctuation">(</span> environment<span class="token operator">-&gt;</span>mAgent<span class="token punctuation">,</span> jnienv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
jboolean  <span class="token function">processJavaStart</span><span class="token punctuation">(</span><span class="token class-name">JPLISAgent</span> <span class="token operator">*</span>agent<span class="token punctuation">,</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>jnienv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token function">createInstrumentationImpl</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     *  Load the Java agent, and call the premain.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">startJavaAgent</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> jnienv<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span>mAgentClassName<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span>mOptionsString<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span>mPremainCaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
jboolean <span class="token function">startJavaAgent</span><span class="token punctuation">(</span> <span class="token class-name">JPLISAgent</span> <span class="token operator">*</span>agent<span class="token punctuation">,</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>jnienv<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>classname<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>optionsString<span class="token punctuation">,</span>jmethodID agentMainMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...  </span>
  <span class="token function">invokeJavaAgentMainMethod</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span>agent<span class="token operator">-&gt;</span>mInstrumentationImpl<span class="token punctuation">,</span>agentMainMethod<span class="token punctuation">,</span> classNameObject<span class="token punctuation">,</span>optionsStringObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹åˆ°è¿™é‡Œï¼ŒInstrumentå·²ç»å®ä¾‹åŒ–ï¼ŒinvokeJavaAgentMainMethodè¿™ä¸ªæ–¹æ³•å°†æˆ‘ä»¬çš„premainæ–¹æ³•æ‰§è¡Œèµ·æ¥äº†ã€‚æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®Instrumentå®ä¾‹æ¥åšæˆ‘ä»¬æƒ³è¦åšçš„äº‹æƒ…äº†ã€‚</p><h2 id="_4-è¿è¡Œæ—¶åŠ è½½agent" tabindex="-1"><a class="header-anchor" href="#_4-è¿è¡Œæ—¶åŠ è½½agent" aria-hidden="true">#</a> 4. è¿è¡Œæ—¶åŠ è½½Agent</h2><p>æ¯”èµ·JVMå¯åŠ¨æ—¶åŠ è½½Agentï¼Œè¿è¡Œæ—¶åŠ è½½Agentå°±æ¯”è¾ƒæœ‰è¯±æƒ‘åŠ›äº†ï¼Œå› ä¸ºè¿è¡Œæ—¶åŠ è½½Agentçš„èƒ½åŠ›ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¼ºçš„åŠ¨æ€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™åŠ è½½Agentæ¥è¿›è¡Œä¸€äº›å·¥ä½œã€‚å› ä¸ºæ˜¯åŠ¨æ€çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§éœ€æ±‚æ¥åŠ è½½æ‰€éœ€è¦çš„Agentï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹åŠ¨æ€åŠ è½½Agentçš„ç›¸å…³æŠ€æœ¯ç»†èŠ‚ã€‚</p><h3 id="_4-1-attachlistener" tabindex="-1"><a class="header-anchor" href="#_4-1-attachlistener" aria-hidden="true">#</a> 4.1 AttachListener</h3><p>Attachæœºåˆ¶é€šè¿‡Attach Listenerçº¿ç¨‹æ¥è¿›è¡Œç›¸å…³äº‹åŠ¡çš„å¤„ç†ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹Attach Listenerçº¿ç¨‹æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Starts the Attach Listener thread</span>
<span class="token keyword">void</span> <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºçº¿ç¨‹ç›¸å…³éƒ¨åˆ†ä»£ç è¢«å»æ‰äº†</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> thread_name<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Attach Listener&quot;</span><span class="token punctuation">;</span>
  <span class="token class-name">Handle</span> string <span class="token operator">=</span> java_lang_String<span class="token operator">::</span><span class="token function">create_from_str</span><span class="token punctuation">(</span>thread_name<span class="token punctuation">,</span> <span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span> <span class="token class-name">MutexLocker</span> <span class="token function">mu</span><span class="token punctuation">(</span><span class="token class-name">Threads_lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JavaThread</span><span class="token operator">*</span> listener_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attach_listener_thread_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªçº¿ç¨‹å¯åŠ¨ä¹‹åéƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªå…¥å£æ¥æ‰§è¡Œä»£ç ï¼ŒAttach Listenerçº¿ç¨‹çš„å…¥å£æ˜¯attach_listener_thread_entryï¼Œä¸‹é¢çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">attach_listener_thread_entry</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token constant">TRAPS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">set_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">AttachOperation</span><span class="token operator">*</span> op <span class="token operator">=</span> <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// find the function to dispatch too</span>
      <span class="token class-name">AttachOperationFunctionInfo</span><span class="token operator">*</span> info <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> funcs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> funcs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          info <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
       <span class="token comment">// dispatch to the function that implements this operation</span>
        res <span class="token operator">=</span> <span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä¸ªå‡½æ•°æ‰§è¡Œé€»è¾‘ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>æ‹‰å–ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼šAttachListener::dequeueã€‚</li><li>æŸ¥è¯¢åŒ¹é…çš„å‘½ä»¤å¤„ç†å‡½æ•°ã€‚</li><li>æ‰§è¡ŒåŒ¹é…åˆ°çš„å‘½ä»¤æ‰§è¡Œå‡½æ•°ã€‚</li></ul><p>å…¶ä¸­ç¬¬äºŒæ­¥é‡Œé¢å­˜åœ¨ä¸€ä¸ªå‘½ä»¤å‡½æ•°è¡¨ï¼Œæ•´ä¸ªè¡¨å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">AttachOperationFunctionInfo</span> funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;agentProperties&quot;</span><span class="token punctuation">,</span>  get_agent_properties <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;datadump&quot;</span><span class="token punctuation">,</span>         data_dump <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;dumpheap&quot;</span><span class="token punctuation">,</span>         dump_heap <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>             load_agent <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;properties&quot;</span><span class="token punctuation">,</span>       get_system_properties <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;threaddump&quot;</span><span class="token punctuation">,</span>       thread_dump <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;inspectheap&quot;</span><span class="token punctuation">,</span>      heap_inspection <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;setflag&quot;</span><span class="token punctuation">,</span>          set_flag <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;printflag&quot;</span><span class="token punctuation">,</span>        print_flag <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;jcmd&quot;</span><span class="token punctuation">,</span>             jcmd <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>               <span class="token constant">NULL</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºåŠ è½½Agentæ¥è¯´ï¼Œå‘½ä»¤å°±æ˜¯â€œloadâ€ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†Attach Listenerå¤§æ¦‚çš„å·¥ä½œæ¨¡å¼ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ¸…æ¥šä»»åŠ¡ä»å“ªæ¥ï¼Œè¿™ä¸ªç§˜å¯†å°±è—åœ¨AttachListener::dequeueè¿™è¡Œä»£ç é‡Œé¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹dequeueè¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">LinuxAttachOperation</span><span class="token operator">*</span> <span class="token class-name">LinuxAttachListener</span><span class="token operator">::</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// wait for client to connect</span>
    struct sockaddr addr<span class="token punctuation">;</span>
    socklen_t len <span class="token operator">=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RESTARTABLE</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// get the credentials of the peer and check the effective uid/guid</span>
    <span class="token comment">// - check with jeff on this.</span>
    struct ucred cred_info<span class="token punctuation">;</span>
    socklen_t optlen <span class="token operator">=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>cred_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">getsockopt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token constant">SOL_SOCKET</span><span class="token punctuation">,</span> <span class="token constant">SO_PEERCRED</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cred_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>optlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">::</span><span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// peer credential look okay so we read the request</span>
    <span class="token class-name">LinuxAttachOperation</span><span class="token operator">*</span> op <span class="token operator">=</span> <span class="token function">read_request</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> op<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯Linuxä¸Šçš„å®ç°ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚ä¸Šé¢çš„ä»£ç è¡¨é¢ï¼ŒAttach Listeneråœ¨æŸä¸ªç«¯å£ç›‘å¬ç€ï¼Œé€šè¿‡acceptæ¥æ¥æ”¶ä¸€ä¸ªè¿æ¥ï¼Œç„¶åä»è¿™ä¸ªè¿æ¥é‡Œé¢å°†è¯·æ±‚è¯»å–å‡ºæ¥ï¼Œç„¶åå°†è¯·æ±‚åŒ…è£…æˆä¸€ä¸ªAttachOperationç±»å‹çš„å¯¹è±¡ï¼Œä¹‹åå°±ä¼šä»è¡¨é‡ŒæŸ¥è¯¢å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚</p><p>Attach Listenerä½¿ç”¨ä¸€ç§è¢«ç§°ä¸ºâ€œæ‡’åŠ è½½â€çš„ç­–ç•¥è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒJVMå¯åŠ¨çš„æ—¶å€™Attach Listenerå¹¶ä¸ä¸€å®šä¼šå¯åŠ¨èµ·æ¥ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ç§â€œæ‡’åŠ è½½â€ç­–ç•¥çš„å…·ä½“å®ç°æ–¹æ¡ˆã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// Start Attach Listener if +StartAttachListener or it can&#39;t be started lazily</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">DisableAttachMechanism</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">vm_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StartAttachListener</span> <span class="token operator">||</span> <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">init_at_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">// Attach Listener is started lazily except in the case when</span>
<span class="token comment">// +ReduseSignalUsage is used</span>
bool <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">init_at_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ReduceSignalUsage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç æˆªå–è‡ªcreate_vmå‡½æ•°ï¼ŒDisableAttachMechanismã€StartAttachListenerå’ŒReduceSignalUsageè¿™ä¸‰ä¸ªå˜é‡é»˜è®¤éƒ½æ˜¯falseï¼Œæ‰€ä»¥AttachListener::init();è¿™è¡Œä»£ç ä¸ä¼šåœ¨create_vmçš„æ—¶å€™æ‰§è¡Œï¼Œè€Œvm_startä¼šæ‰§è¡Œã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ç»†èŠ‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">vm_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> fn<span class="token punctuation">[</span><span class="token constant">UNIX_PATH_MAX</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  struct stat64 st<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
  <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token constant">UNIX_PATH_MAX</span><span class="token punctuation">,</span> <span class="token string">&quot;%s/.java_pid%d&quot;</span><span class="token punctuation">,</span>
           os<span class="token operator">::</span><span class="token function">get_temp_directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token operator">::</span><span class="token function">current_process_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token constant">UNIX_PATH_MAX</span><span class="token punctuation">,</span> <span class="token string">&quot;java_pid file name buffer overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">RESTARTABLE</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">stat64</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">unlink</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log_debug</span><span class="token punctuation">(</span>attach<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to remove stale attach pid file at %s&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯åœ¨Linuxä¸Šçš„å®ç°ï¼Œæ˜¯å°†/tmp/ç›®å½•ä¸‹çš„.java_pid{pid}æ–‡ä»¶åˆ é™¤ï¼Œåé¢åœ¨åˆ›å»ºAttach Listenerçº¿ç¨‹çš„æ—¶å€™ä¼šåˆ›å»ºå‡ºæ¥è¿™ä¸ªæ–‡ä»¶ã€‚ä¸Šé¢è¯´åˆ°ï¼ŒAttachListener::init()è¿™è¡Œä»£ç ä¸ä¼šåœ¨create_vmçš„æ—¶å€™æ‰§è¡Œï¼Œè¿™è¡Œä»£ç çš„å®ç°å·²ç»åœ¨ä¸Šæ–‡ä¸­åˆ†æäº†ï¼Œå°±æ˜¯åˆ›å»ºAttach Listenerçº¿ç¨‹ï¼Œå¹¶ç›‘å¬å…¶ä»–JVMçš„å‘½ä»¤è¯·æ±‚ã€‚ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™è¡Œä»£ç æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯â€œæ‡’åŠ è½½â€åˆ°åº•æ˜¯æ€ä¹ˆåŠ è½½èµ·æ¥çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// Signal Dispatcher needs to be started before VMInit event is posted</span>
  os<span class="token operator">::</span><span class="token function">signal_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯create_vmä¸­çš„ä¸€æ®µä»£ç ï¼Œçœ‹èµ·æ¥è·Ÿä¿¡å·ç›¸å…³ï¼Œå…¶å®Attachæœºåˆ¶å°±æ˜¯ä½¿ç”¨ä¿¡å·æ¥å®ç°â€œæ‡’åŠ è½½â€œçš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä»”ç»†åœ°åˆ†æä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> os<span class="token operator">::</span><span class="token function">signal_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ReduceSignalUsage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Setup JavaThread for processing signals</span>
    <span class="token constant">EXCEPTION_MARK</span><span class="token punctuation">;</span>
    <span class="token class-name">Klass</span><span class="token operator">*</span> k <span class="token operator">=</span> <span class="token class-name">SystemDictionary</span><span class="token operator">::</span><span class="token function">resolve_or_fail</span><span class="token punctuation">(</span>vmSymbols<span class="token operator">::</span><span class="token function">java_lang_Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token constant">CHECK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instanceKlassHandle klass <span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    instanceHandle thread_oop <span class="token operator">=</span> klass<span class="token operator">-&gt;</span><span class="token function">allocate_instance_handle</span><span class="token punctuation">(</span><span class="token constant">CHECK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> thread_name<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Signal Dispatcher&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">Handle</span> string <span class="token operator">=</span> java_lang_String<span class="token operator">::</span><span class="token function">create_from_str</span><span class="token punctuation">(</span>thread_name<span class="token punctuation">,</span> <span class="token constant">CHECK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Initialize thread_oop to put it into the system threadGroup</span>
    <span class="token class-name">Handle</span> thread_group <span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> <span class="token class-name">Universe</span><span class="token operator">::</span><span class="token function">system_thread_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JavaValue</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token constant">T_VOID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JavaCalls</span><span class="token operator">::</span><span class="token function">call_special</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span> thread_oop<span class="token punctuation">,</span>klass<span class="token punctuation">,</span>vmSymbols<span class="token operator">::</span><span class="token function">object_initializer_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>vmSymbols<span class="token operator">::</span><span class="token function">threadgroup_string_void_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           thread_group<span class="token punctuation">,</span>string<span class="token punctuation">,</span><span class="token constant">CHECK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">KlassHandle</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> <span class="token class-name">SystemDictionary</span><span class="token operator">::</span><span class="token class-name">ThreadGroup_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JavaCalls</span><span class="token operator">::</span><span class="token function">call_special</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span>thread_group<span class="token punctuation">,</span>group<span class="token punctuation">,</span>vmSymbols<span class="token operator">::</span><span class="token function">add_method_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>vmSymbols<span class="token operator">::</span><span class="token function">thread_void_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>thread_oop<span class="token punctuation">,</span><span class="token constant">CHECK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    os<span class="token operator">::</span><span class="token function">signal_init_pd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span> <span class="token class-name">MutexLocker</span> <span class="token function">mu</span><span class="token punctuation">(</span><span class="token class-name">Threads_lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">JavaThread</span><span class="token operator">*</span> signal_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>signal_thread_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Handle ^BREAK</span>
    os<span class="token operator">::</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token constant">SIGBREAK</span><span class="token punctuation">,</span> os<span class="token operator">::</span><span class="token function">user_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JVMåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å®ç°ä¿¡å·å¤„ç†ï¼Œè¿™ä¸ªçº¿ç¨‹å«â€œSignal Dispatcherâ€ï¼Œä¸€ä¸ªçº¿ç¨‹åˆ›å»ºä¹‹åéœ€è¦æœ‰ä¸€ä¸ªå…¥å£ï¼Œâ€œSignal Dispatcherâ€çš„å…¥å£æ˜¯signal_thread_entryï¼š</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827213507409.png" alt="image-20220827213507409" tabindex="0" loading="lazy"><figcaption>image-20220827213507409</figcaption></figure><p>è¿™æ®µä»£ç æˆªå–è‡ªsignal_thread_entryå‡½æ•°ï¼Œæˆªå–ä¸­çš„å†…å®¹æ˜¯å’ŒAttachæœºåˆ¶ä¿¡å·å¤„ç†ç›¸å…³çš„ä»£ç ã€‚è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œå½“æ¥æ”¶åˆ°â€œSIGBREAKâ€ä¿¡å·ï¼Œå°±æ‰§è¡Œæ¥ä¸‹æ¥çš„ä»£ç ï¼Œè¿™ä¸ªä¿¡å·æ˜¯éœ€è¦Attachåˆ°JVMä¸Šçš„ä¿¡å·å‘å‡ºæ¥ï¼Œè¿™ä¸ªåé¢ä¼šå†åˆ†æã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¥å…³é”®çš„ä»£ç ï¼šAttachListener::is_init_trigger()ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>bool <span class="token class-name">AttachListener</span><span class="token operator">::</span><span class="token function">is_init_trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">init_at_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">is_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>               <span class="token comment">// initialized at startup or already initialized</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">char</span> fn<span class="token punctuation">[</span><span class="token constant">PATH_MAX</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">sprintf</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">&quot;.attach_pid%d&quot;</span><span class="token punctuation">,</span> os<span class="token operator">::</span><span class="token function">current_process_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
  struct stat64 st<span class="token punctuation">;</span>
  <span class="token function">RESTARTABLE</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">stat64</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log_trace</span><span class="token punctuation">(</span>attach<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to find attach file: %s, trying alternate&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;%s/.attach_pid%d&quot;</span><span class="token punctuation">,</span> os<span class="token operator">::</span><span class="token function">get_temp_directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token operator">::</span><span class="token function">current_process_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RESTARTABLE</span><span class="token punctuation">(</span><span class="token operator">::</span><span class="token function">stat64</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// simple check to avoid starting the attach mechanism when</span>
    <span class="token comment">// a bogus user creates the file</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_uid <span class="token operator">==</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆæ£€æŸ¥äº†ä¸€ä¸‹æ˜¯å¦åœ¨JVMå¯åŠ¨æ—¶å¯åŠ¨äº†Attach Listenerï¼Œæˆ–è€…æ˜¯å¦å·²ç»å¯åŠ¨è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ‰ç»§ç»­æ‰§è¡Œï¼Œåœ¨/tmpç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå«åš.attach_pid%dçš„æ–‡ä»¶ï¼Œç„¶åæ‰§è¡ŒAttachListenerçš„initå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥åˆ›å»ºAttach Listenerçº¿ç¨‹çš„å‡½æ•°ï¼Œä¸Šé¢å·²ç»æåˆ°å¤šæ¬¡å¹¶è¿›è¡Œäº†åˆ†æã€‚åˆ°æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“Attachæœºåˆ¶çš„å¥¥ç§˜æ‰€åœ¨ï¼Œä¹Ÿå°±æ˜¯Attach Listenerçº¿ç¨‹çš„åˆ›å»ºä¾é Signal Dispatcherçº¿ç¨‹ï¼ŒSignal Dispatcheræ˜¯ç”¨æ¥å¤„ç†ä¿¡å·çš„çº¿ç¨‹ï¼Œå½“Signal Dispatcherçº¿ç¨‹æ¥æ”¶åˆ°â€œSIGBREAKâ€ä¿¡å·ä¹‹åï¼Œå°±ä¼šæ‰§è¡Œåˆå§‹åŒ–Attach Listenerçš„å·¥ä½œã€‚</p><h3 id="_4-2-è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°" tabindex="-1"><a class="header-anchor" href="#_4-2-è¿è¡Œæ—¶åŠ è½½agentçš„å®ç°" aria-hidden="true">#</a> 4.2 è¿è¡Œæ—¶åŠ è½½Agentçš„å®ç°</h3><p>æˆ‘ä»¬ç»§ç»­åˆ†æï¼Œåˆ°åº•æ˜¯å¦‚ä½•å°†ä¸€ä¸ªAgentæŒ‚è½½åˆ°è¿è¡Œç€çš„ç›®æ ‡JVMä¸Šï¼Œåœ¨ä¸Šæ–‡ä¸­æåˆ°äº†ä¸€æ®µä»£ç ï¼Œç”¨æ¥è¿›è¡Œè¿è¡Œæ—¶æŒ‚è½½Agentï¼Œå¯ä»¥å‚è€ƒä¸Šæ–‡ä¸­å±•ç¤ºçš„å…³äºâ€œattachAgentToTargetJvmâ€æ–¹æ³•çš„ä»£ç ã€‚è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å…³é”®æ˜¯è°ƒç”¨VirtualMachineçš„attachæ–¹æ³•è¿›è¡ŒAgentæŒ‚è½½çš„åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹VirtualMachineçš„attachæ–¹æ³•å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">VirtualMachine</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">String</span> var0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;id cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span> var1 <span class="token operator">=</span> <span class="token class-name">AttachProvider</span><span class="token punctuation">.</span><span class="token function">providers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">(</span><span class="token string">&quot;no providers installed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">AttachNotSupportedException</span> var2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Iterator</span> var3 <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>var3<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AttachProvider</span> var4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AttachProvider</span><span class="token punctuation">)</span>var3<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> var4<span class="token punctuation">.</span><span class="token function">attachVirtualMachine</span><span class="token punctuation">(</span>var0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AttachNotSupportedException</span> var6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    var2 <span class="token operator">=</span> var6<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> var2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•é€šè¿‡attachVirtualMachineæ–¹æ³•è¿›è¡Œattachæ“ä½œï¼Œåœ¨MacOSç³»ç»Ÿä¸­ï¼ŒAttachProviderçš„å®ç°ç±»æ˜¯BsdAttachProviderã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹BsdAttachProviderçš„attachVirtualMachineæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">VirtualMachine</span> <span class="token function">attachVirtualMachine</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkAttachPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">testAttachable</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BsdVirtualMachine</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BsdVirtualMachine</span><span class="token punctuation">(</span><span class="token class-name">AttachProvider</span> var1<span class="token punctuation">,</span> <span class="token class-name">String</span> var2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> var3 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findSocketFile</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> var4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token string">&quot;.attach_pid&quot;</span> <span class="token operator">+</span> var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">createAttachFile</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">sendQuitTo</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> var5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> var6 <span class="token operator">=</span> <span class="token number">200L</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> var8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> var6<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> var21<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findSocketFile</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>var5<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>var5 <span class="token operator">&lt;=</span> var8 <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            var4<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> var24 <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>var24<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">findSocketFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> var2 <span class="token operator">=</span> <span class="token string">&quot;.java_pid&quot;</span> <span class="token operator">+</span> var1<span class="token punctuation">;</span>
    <span class="token class-name">File</span> var3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> var3<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> var3<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>findSocketFileæ–¹æ³•ç”¨æ¥æŸ¥è¯¢ç›®æ ‡JVMä¸Šæ˜¯å¦å·²ç»å¯åŠ¨äº†Attach Listenerï¼Œå®ƒé€šè¿‡æ£€æŸ¥â€tmp/â€œç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨java_pid{pid}æ¥è¿›è¡Œå®ç°ã€‚å¦‚æœå·²ç»å­˜åœ¨äº†ï¼Œåˆ™è¯´æ˜Attachæœºåˆ¶å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„å‘½ä»¤äº†ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡connectè¿æ¥åˆ°ç›®æ ‡JVMè¿›è¡Œå‘½ä»¤çš„å‘é€ï¼Œæ¯”å¦‚å¯ä»¥å‘é€â€œloadâ€å‘½ä»¤æ¥åŠ è½½Agentã€‚å¦‚æœjava_pid{pid}æ–‡ä»¶è¿˜ä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦é€šè¿‡sendQuitToæ–¹æ³•å‘ç›®æ ‡JVMå‘é€ä¸€ä¸ªâ€œSIGBREAKâ€ä¿¡å·ï¼Œè®©å®ƒåˆå§‹åŒ–Attach Listenerçº¿ç¨‹å¹¶å‡†å¤‡æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå‘é€äº†ä¿¡å·ä¹‹åå®¢æˆ·ç«¯ä¼šå¾ªç¯ç­‰å¾…java_pid{pid}è¿™ä¸ªæ–‡ä»¶ï¼Œä¹‹åå†é€šè¿‡connectè¿æ¥åˆ°ç›®æ ‡JVMä¸Šã€‚</p><h3 id="_4-3-loadå‘½ä»¤çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#_4-3-loadå‘½ä»¤çš„å®ç°" aria-hidden="true">#</a> 4.3 loadå‘½ä»¤çš„å®ç°</h3><p>ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ï¼Œâ€œloadâ€å‘½ä»¤åœ¨JVMå±‚é¢çš„å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> jint <span class="token function">load_agent</span><span class="token punctuation">(</span><span class="token class-name">AttachOperation</span><span class="token operator">*</span> op<span class="token punctuation">,</span> outputStream<span class="token operator">*</span> out<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// get agent name and options</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> agent <span class="token operator">=</span> op<span class="token operator">-&gt;</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> absParam <span class="token operator">=</span> op<span class="token operator">-&gt;</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> options <span class="token operator">=</span> op<span class="token operator">-&gt;</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// If loading a java agent then need to ensure that the java.instrument module is loaded</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> <span class="token string">&quot;instrument&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token operator">*</span> <span class="token constant">THREAD</span> <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResourceMark</span> <span class="token function">rm</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HandleMark</span> <span class="token function">hm</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JavaValue</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token constant">T_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Handle</span> h_module_name <span class="token operator">=</span> java_lang_String<span class="token operator">::</span><span class="token function">create_from_str</span><span class="token punctuation">(</span><span class="token string">&quot;java.instrument&quot;</span><span class="token punctuation">,</span> <span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JavaCalls</span><span class="token operator">::</span><span class="token function">call_static</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span><span class="token class-name">SystemDictionary</span><span class="token operator">::</span><span class="token function">module_Modules_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>vmSymbols<span class="token operator">::</span><span class="token function">loadModule_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           vmSymbols<span class="token operator">::</span><span class="token function">loadModule_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>h_module_name<span class="token punctuation">,</span><span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token class-name">JvmtiExport</span><span class="token operator">::</span><span class="token function">load_agent_library</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> absParam<span class="token punctuation">,</span> options<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°å…ˆç¡®ä¿åŠ è½½äº†java.instrumentæ¨¡å—ï¼Œä¹‹åçœŸæ­£æ‰§è¡ŒAgentåŠ è½½çš„å‡½æ•°æ˜¯ load_agent_library ,è¿™ä¸ªå‡½æ•°çš„å¥—è·¯å°±æ˜¯åŠ è½½AgentåŠ¨æ€é“¾æ¥åº“ï¼Œå¦‚æœæ˜¯é€šè¿‡Java instrument APIå®ç°çš„Agentï¼Œåˆ™åŠ è½½çš„æ˜¯libinstrumentåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶åé€šè¿‡libinstrumenté‡Œé¢çš„ä»£ç å®ç°è¿è¡Œagentmainæ–¹æ³•çš„é€»è¾‘ï¼Œè¿™ä¸€éƒ¨åˆ†å†…å®¹å’Œlibinstrumentå®ç°premainæ–¹æ³•è¿è¡Œçš„é€»è¾‘å…¶å®å·®ä¸å¤šï¼Œè¿™é‡Œä¸å†åšåˆ†æã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹Java AgentæŠ€æœ¯å·²ç»æœ‰äº†ä¸€ä¸ªå…¨é¢è€Œç»†è‡´çš„äº†è§£ã€‚</p><h2 id="_5-åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#_5-åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶" aria-hidden="true">#</a> 5. åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹çš„é™åˆ¶</h2><p>ä¸Šæ–‡ä¸­å·²ç»è¯¦ç»†åˆ†æäº†AgentæŠ€æœ¯çš„å®ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨Java Instrumentation APIæ¥å®ŒæˆåŠ¨æ€ç±»ä¿®æ”¹çš„åŠŸèƒ½ï¼Œåœ¨Instrumentationæ¥å£ä¸­ï¼Œé€šè¿‡addTransformeræ–¹æ³•æ¥å¢åŠ ä¸€ä¸ªç±»è½¬æ¢å™¨ï¼Œç±»è½¬æ¢å™¨ç”±ç±»ClassFileTransformeræ¥å£å®ç°ã€‚ClassFileTransformeræ¥å£ä¸­å”¯ä¸€çš„æ–¹æ³•transformç”¨äºå®ç°ç±»è½¬æ¢ï¼Œå½“ç±»è¢«åŠ è½½çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨transformæ–¹æ³•ï¼Œè¿›è¡Œç±»è½¬æ¢ã€‚åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Instrumentationçš„redefineClassesæ–¹æ³•è¿›è¡Œç±»é‡å®šä¹‰ï¼Œåœ¨æ–¹æ³•ä¸Šæœ‰ä¸€æ®µæ³¨é‡Šéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>     <span class="token operator">*</span> <span class="token class-name">The</span> redefinition may change method bodies<span class="token punctuation">,</span> the constant pool and attributes<span class="token punctuation">.</span>
     <span class="token operator">*</span> <span class="token class-name">The</span> redefinition must not add<span class="token punctuation">,</span> remove or rename fields or methods<span class="token punctuation">,</span> change the
     <span class="token operator">*</span> signatures of methods<span class="token punctuation">,</span> or change <span class="token class-name"><span class="token namespace">inheritance<span class="token punctuation">.</span></span>  These</span> restrictions maybe be
     <span class="token operator">*</span> lifted in future <span class="token class-name"><span class="token namespace">versions<span class="token punctuation">.</span></span>  The</span> <span class="token keyword">class</span> file bytes are not checked<span class="token punctuation">,</span> verified and installed
     <span class="token operator">*</span> until after the transformations have been applied<span class="token punctuation">,</span> <span class="token keyword">if</span> the resultant bytes are in
     <span class="token operator">*</span> error <span class="token keyword">this</span> method will <span class="token keyword">throw</span> an exception<span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé¢æåˆ°ï¼Œæˆ‘ä»¬ä¸å¯ä»¥å¢åŠ ã€åˆ é™¤æˆ–è€…é‡å‘½åå­—æ®µå’Œæ–¹æ³•ï¼Œæ”¹å˜æ–¹æ³•çš„ç­¾åæˆ–è€…ç±»çš„ç»§æ‰¿å…³ç³»ã€‚è®¤è¯†åˆ°è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå½“æˆ‘ä»¬é€šè¿‡ASMè·å–åˆ°å¢å¼ºçš„å­—èŠ‚ç ä¹‹åï¼Œå¦‚æœå¢å¼ºåçš„å­—èŠ‚ç æ²¡æœ‰éµå®ˆè¿™äº›è§„åˆ™ï¼Œé‚£ä¹ˆè°ƒç”¨redefineClassesæ–¹æ³•æ¥è¿›è¡Œç±»çš„é‡å®šä¹‰å°±ä¼šå¤±è´¥ã€‚é‚£redefineClassesæ–¹æ³•å…·ä½“æ˜¯æ€ä¹ˆå®ç°ç±»çš„é‡å®šä¹‰çš„å‘¢? å®ƒå¯¹è¿è¡Œæ—¶çš„JVMä¼šé€ æˆä»€ä¹ˆæ ·çš„å½±å“å‘¢? ä¸‹é¢æ¥åˆ†æredefineClassesçš„å®ç°ç»†èŠ‚ã€‚</p><h2 id="_6-é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#_6-é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚" aria-hidden="true">#</a> 6. é‡å®šä¹‰ç±»å­—èŠ‚ç çš„å®ç°ç»†èŠ‚</h2><p>ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°ï¼ŒlibinstrumentåŠ¨æ€é“¾æ¥åº“ä¸­ï¼ŒJPLISAgentä¸ä»…å®ç°äº†Agentå…¥å£ä»£ç æ‰§è¡Œçš„è·¯ç”±ï¼Œè€Œä¸”è¿˜æ˜¯Javaä»£ç ä¸JVMTIä¹‹é—´çš„ä¸€é“æ¡¥æ¢ã€‚æˆ‘ä»¬åœ¨Javaä»£ç ä¸­è°ƒç”¨Java Instrumentation APIçš„redefineClassesï¼Œå…¶å®ä¼šè°ƒç”¨libinstrumentä¸­çš„ç›¸å…³ä»£ç ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™æ¡è·¯å¾„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redefineClasses</span><span class="token punctuation">(</span><span class="token class-name">ClassDefinition</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRedefineClassesSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;redefineClasses is not supported in this environment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;null passed as &#39;definitions&#39; in redefineClasses&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var2 <span class="token operator">&lt;</span> var1<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var1<span class="token punctuation">[</span>var2<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;element of &#39;definitions&#39; is null in redefineClasses&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var1<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">redefineClasses0</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mNativeAgent<span class="token punctuation">,</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">redefineClasses0</span><span class="token punctuation">(</span><span class="token keyword">long</span> var1<span class="token punctuation">,</span> <span class="token class-name">ClassDefinition</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯InstrumentationImplä¸­çš„redefineClasseså®ç°ï¼Œè¯¥æ–¹æ³•çš„å…·ä½“å®ç°ä¾èµ–ä¸€ä¸ªNativeæ–¹æ³•redefineClasses()ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨libinstrumentä¸­æ‰¾åˆ°è¿™ä¸ªNativeæ–¹æ³•çš„å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token constant">JNIEXPORT</span> <span class="token keyword">void</span> <span class="token constant">JNICALL</span> <span class="token class-name">Java_sun_instrument_InstrumentationImpl_redefineClasses0</span>
  <span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span> jnienv<span class="token punctuation">,</span> jobject implThis<span class="token punctuation">,</span> jlong agent<span class="token punctuation">,</span> jobjectArray classDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">redefineClasses</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">JPLISAgent</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span>agent<span class="token punctuation">,</span> classDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>redefineClassesè¿™ä¸ªå‡½æ•°çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œä»£ç å¾ˆé•¿ã€‚ä¸‹é¢æ˜¯ä¸€æ®µå…³é”®çš„ä»£ç ç‰‡æ®µï¼š</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827214120788.png" alt="image-20220827214120788" tabindex="0" loading="lazy"><figcaption>image-20220827214120788</figcaption></figure><p>é‡å®šä¹‰ç±»çš„è¯·æ±‚ä¼šè¢«JVMåŒ…è£…æˆä¸€ä¸ªVM_RedefineClassesç±»å‹çš„VM_Operationï¼ŒVM_Operationæ˜¯JVMå†…éƒ¨çš„ä¸€äº›æ“ä½œçš„åŸºç±»ï¼ŒåŒ…æ‹¬GCæ“ä½œç­‰ã€‚VM_Operationç”±VMThreadæ¥æ‰§è¡Œï¼Œæ–°çš„VM_Operationæ“ä½œä¼šè¢«æ·»åŠ åˆ°VMThreadçš„è¿è¡Œé˜Ÿåˆ—ä¸­å»ï¼ŒVMThreadä¼šä¸æ–­ä»é˜Ÿåˆ—é‡Œé¢æ‹‰å–VM_Operationå¹¶è°ƒç”¨å…¶doitç­‰å‡½æ•°æ‰§è¡Œå…·ä½“çš„æ“ä½œã€‚VM_RedefineClasseså‡½æ•°çš„æµç¨‹è¾ƒä¸ºå¤æ‚ï¼Œä¸‹é¢æ˜¯VM_RedefineClassesçš„å¤§è‡´æµç¨‹ï¼š</p><ul><li>åŠ è½½æ–°çš„å­—èŠ‚ç ï¼Œåˆå¹¶å¸¸é‡æ± ï¼Œå¹¶ä¸”å¯¹æ–°çš„å­—èŠ‚ç è¿›è¡Œæ ¡éªŒå·¥ä½œ</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// Load the caller&#39;s new class definition(s) into _scratch_classes.</span>
  <span class="token comment">// Constant pool merging work is done here as needed. Also calls</span>
  <span class="token comment">// compare_and_normalize_class_versions() to verify the class</span>
  <span class="token comment">// definition(s).</span>
  jvmtiError <span class="token function">load_new_class_versions</span><span class="token punctuation">(</span><span class="token constant">TRAPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ¸…é™¤æ–¹æ³•ä¸Šçš„æ–­ç‚¹</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// Remove all breakpoints in methods of this class</span>
  <span class="token class-name">JvmtiBreakpoints</span><span class="token operator">&amp;</span> jvmti_breakpoints <span class="token operator">=</span> <span class="token class-name">JvmtiCurrentBreakpoints</span><span class="token operator">::</span><span class="token function">get_jvmti_breakpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jvmti_breakpoints<span class="token punctuation">.</span><span class="token function">clearall_in_class_at_safepoint</span><span class="token punctuation">(</span><span class="token function">the_class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>JITé€†ä¼˜åŒ–</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// Deoptimize all compiled code that depends on this class</span>
  <span class="token function">flush_dependent_code</span><span class="token punctuation">(</span>the_class<span class="token punctuation">,</span> <span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿›è¡Œå­—èŠ‚ç æ›¿æ¢å·¥ä½œï¼Œéœ€è¦è¿›è¡Œæ›´æ–°ç±»itable/vtableç­‰æ“ä½œ</li><li>è¿›è¡Œç±»é‡å®šä¹‰é€šçŸ¥</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token class-name">SystemDictionary</span><span class="token operator">::</span><span class="token function">notice_modification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>VM_RedefineClasseså®ç°æ¯”è¾ƒå¤æ‚çš„ï¼Œè¯¦ç»†å®ç°å¯ä»¥å‚è€ƒ <a href="https://github.com/pandening/openjdk/blob/0301fc792ffd3c7b506ef78887af250e0e3ae09e/src/hotspot/share/prims/jvmtiEnv.cpp#L456" target="_blank" rel="noopener noreferrer">RedefineClasses <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„å®ç°ã€‚</p><h2 id="_7-java-debug-tool" tabindex="-1"><a class="header-anchor" href="#_7-java-debug-tool" aria-hidden="true">#</a> 7. Java-debug-tool</h2><p>Java-debug-toolæ˜¯ä¸€ä¸ªä½¿ç”¨Java Instrument APIæ¥å®ç°çš„åŠ¨æ€è°ƒè¯•å·¥å…·ï¼Œå®ƒé€šè¿‡åœ¨ç›®æ ‡JVMä¸Šå¯åŠ¨ä¸€ä¸ªTcpServeræ¥å’Œè°ƒè¯•å®¢æˆ·ç«¯é€šä¿¡ã€‚è°ƒè¯•å®¢æˆ·ç«¯é€šè¿‡å‘½ä»¤è¡Œæ¥å‘é€è°ƒè¯•å‘½ä»¤ç»™TcpServerï¼ŒTcpServerä¸­æœ‰ä¸“é—¨ç”¨æ¥å¤„ç†å‘½ä»¤çš„handlerï¼Œhandlerå¤„ç†å®Œå‘½ä»¤ä¹‹åä¼šå°†ç»“æœå‘é€å›å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡å¤„ç†å°†è°ƒè¯•ç»“æœå±•ç¤ºå‡ºæ¥ã€‚ä¸‹é¢å°†è¯¦ç»†ä»‹ç»Java-debug-toolçš„æ•´ä½“è®¾è®¡å’Œå®ç°ã€‚</p><h3 id="_7-1-java-debug-toolæ•´ä½“æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_7-1-java-debug-toolæ•´ä½“æ¶æ„" aria-hidden="true">#</a> 7.1 Java-debug-toolæ•´ä½“æ¶æ„</h3><p>Java-debug-toolåŒ…æ‹¬ä¸€ä¸ªJava Agentå’Œä¸€ä¸ªç”¨äºå¤„ç†è°ƒè¯•å‘½ä»¤çš„æ ¸å¿ƒAPIï¼Œæ ¸å¿ƒAPIé€šè¿‡ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½è¿›æ¥ï¼Œä»¥ä¿è¯ç›®æ ‡JVMçš„ç±»ä¸ä¼šè¢«æ±¡æŸ“ã€‚æ•´ä½“ä¸ŠJava-debug-toolçš„è®¾è®¡æ˜¯ä¸€ä¸ªClient-Serverçš„æ¶æ„ï¼Œå‘½ä»¤å®¢æˆ·ç«¯éœ€è¦å®Œæ•´çš„å®Œæˆä¸€ä¸ªå‘½ä»¤ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªè°ƒè¯•å‘½ä»¤ã€‚Java-debug-toolæ”¯æŒå¤šäººåŒæ—¶è¿›è¡Œè°ƒè¯•ï¼Œä¸‹é¢æ˜¯æ•´ä½“æ¶æ„å›¾ï¼š</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827215704590.png" alt="image-20220827215704590" tabindex="0" loading="lazy"><figcaption>image-20220827215704590</figcaption></figure><p>ä¸‹é¢å¯¹æ¯ä¸€å±‚åšç®€å•ä»‹ç»ï¼š</p><ul><li>äº¤äº’å±‚ï¼šè´Ÿè´£å°†ç¨‹åºå‘˜çš„è¾“å…¥è½¬æ¢æˆè°ƒè¯•äº¤äº’åè®®ï¼Œå¹¶ä¸”å°†è°ƒè¯•ä¿¡æ¯å‘ˆç°å‡ºæ¥ã€‚</li><li>è¿æ¥ç®¡ç†å±‚ï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œä»è¿æ¥ä¸­è¯»è°ƒè¯•åè®®æ•°æ®å¹¶è§£ç ï¼Œå¯¹è°ƒè¯•ç»“æœç¼–ç å¹¶å°†å…¶å†™åˆ°è¿æ¥ä¸­å»ï¼›åŒæ—¶å°†é‚£äº›è¶…æ—¶æœªæ´»åŠ¨çš„è¿æ¥å…³é—­ã€‚</li><li>ä¸šåŠ¡é€»è¾‘å±‚ï¼šå®ç°è°ƒè¯•å‘½ä»¤å¤„ç†ï¼ŒåŒ…æ‹¬å‘½ä»¤åˆ†å‘ã€æ•°æ®æ”¶é›†ã€æ•°æ®å¤„ç†ç­‰è¿‡ç¨‹ã€‚</li><li>åŸºç¡€å®ç°å±‚ï¼šJava-debug-toolå®ç°çš„åº•å±‚ä¾èµ–ï¼Œé€šè¿‡Java Instrumentationæä¾›çš„APIè¿›è¡Œç±»æŸ¥æ‰¾ã€ç±»é‡å®šä¹‰ç­‰èƒ½åŠ›ï¼ŒJava Instrumentationåº•å±‚ä¾èµ–JVMTIæ¥å®Œæˆå…·ä½“çš„åŠŸèƒ½ã€‚</li></ul><p>åœ¨Agentè¢«æŒ‚è½½åˆ°ç›®æ ‡JVMä¸Šä¹‹åï¼ŒJava-debug-toolä¼šå®‰æ’ä¸€ä¸ªSpyåœ¨ç›®æ ‡JVMå†…æ´»åŠ¨ï¼Œè¿™ä¸ªSpyè´Ÿè´£å°†ç›®æ ‡JVMå†…éƒ¨çš„ç›¸å…³è°ƒè¯•æ•°æ®è½¬ç§»åˆ°å‘½ä»¤å¤„ç†æ¨¡å—ï¼Œå‘½ä»¤å¤„ç†æ¨¡å—ä¼šå¤„ç†è¿™äº›æ•°æ®ï¼Œç„¶åç»™å®¢æˆ·ç«¯è¿”å›è°ƒè¯•ç»“æœã€‚å‘½ä»¤å¤„ç†æ¨¡å—ä¼šå¢å¼ºç›®æ ‡ç±»çš„å­—èŠ‚ç æ¥è¾¾åˆ°æ•°æ®è·å–çš„ç›®çš„ï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥å…±äº«ä¸€ä»½å¢å¼ºè¿‡çš„å­—èŠ‚ç ï¼Œæ— éœ€é‡å¤å¢å¼ºã€‚ä¸‹é¢ä»Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆã€å‘½ä»¤è®¾è®¡ä¸å®ç°ç­‰è§’åº¦è¯¦ç»†è¯´æ˜ã€‚</p><h3 id="_7-2-java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#_7-2-java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ" aria-hidden="true">#</a> 7.2 Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºæ–¹æ¡ˆ</h3><p>Java-debug-toolä½¿ç”¨å­—èŠ‚ç å¢å¼ºæ¥è·å–åˆ°æ–¹æ³•è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ–¹æ³•å…¥å‚ã€å‡ºå‚ç­‰ï¼Œå¯ä»¥åœ¨ä¸åŒçš„å­—èŠ‚ç ä½ç½®è¿›è¡Œå¢å¼ºï¼Œè¿™ç§è¡Œä¸ºå¯ä»¥ç§°ä¸ºâ€œæ’æ¡©â€ï¼Œæ¯ä¸ªâ€œæ¡©â€ç”¨äºè·å–æ•°æ®å¹¶å°†ä»–è½¬å‚¨å‡ºå»ã€‚Java-debug-toolå…·å¤‡å¼ºå¤§çš„æ’æ¡©èƒ½åŠ›ï¼Œä¸åŒçš„æ¡©è´Ÿè´£è·å–ä¸åŒç±»åˆ«çš„æ•°æ®ï¼Œä¸‹é¢æ˜¯Java-debug-toolç›®å‰æ‰€æ”¯æŒçš„â€œæ¡©â€ï¼š</p><ul><li>æ–¹æ³•è¿›å…¥ç‚¹ï¼šç”¨äºè·å–æ–¹æ³•å…¥å‚ä¿¡æ¯ã€‚</li><li>Fieldsè·å–ç‚¹1ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰è·å–åˆ°å¯¹è±¡çš„å­—æ®µä¿¡æ¯ã€‚</li><li>å˜é‡å­˜å‚¨ç‚¹ï¼šè·å–å±€éƒ¨å˜é‡ä¿¡æ¯ã€‚</li><li>Fieldsè·å–ç‚¹2ï¼šåœ¨æ–¹æ³•é€€å‡ºå‰è·å–åˆ°å¯¹è±¡çš„å­—æ®µä¿¡æ¯ã€‚</li><li>æ–¹æ³•é€€å‡ºç‚¹ï¼šç”¨äºè·å–æ–¹æ³•è¿”å›å€¼ã€‚</li><li>æŠ›å‡ºå¼‚å¸¸ç‚¹ï¼šç”¨äºè·å–æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ã€‚</li><li>é€šè¿‡ä¸Šé¢è¿™äº›ä»£ç æ¡©ï¼ŒJava-debug-toolå¯ä»¥æ”¶é›†åˆ°ä¸°å¯Œçš„æ–¹æ³•æ‰§è¡Œä¿¡æ¯ï¼Œç»è¿‡å¤„ç†å¯ä»¥è¿”å›æ›´åŠ å¯è§†åŒ–çš„è°ƒè¯•ç»“æœã€‚</li></ul><h4 id="_7-2-1-å­—èŠ‚ç å¢å¼º" tabindex="-1"><a class="header-anchor" href="#_7-2-1-å­—èŠ‚ç å¢å¼º" aria-hidden="true">#</a> 7.2.1 å­—èŠ‚ç å¢å¼º</h4><p>Java-debug-toolåœ¨å®ç°ä¸Šä½¿ç”¨äº†ASMå·¥å…·æ¥è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œå¹¶ä¸”æ¯ä¸ªæ’æ¡©ç‚¹éƒ½å¯ä»¥è¿›è¡Œé…ç½®ï¼Œå¦‚æœä¸æƒ³è¦ä»€ä¹ˆä¿¡æ¯ï¼Œåˆ™æ²¡å¿…è¦è¿›è¡Œå¯¹åº”çš„æ’æ¡©æ“ä½œã€‚è¿™ç§å¯é…ç½®çš„è®¾è®¡æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬ä»…ä»…æ˜¯æƒ³è¦çŸ¥é“æ–¹æ³•çš„å…¥å‚å’Œå‡ºå‚ï¼Œä½†Java-debug-toolå´ç»™æˆ‘ä»¬è¿”å›äº†æ‰€æœ‰çš„è°ƒè¯•ä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åœ¨ä¼—å¤šçš„è¾“å‡ºä¸­æ‰¾åˆ°æˆ‘ä»¬æ‰€å…³æ³¨çš„å†…å®¹ã€‚å¦‚æœå¯ä»¥è¿›è¡Œé…ç½®ï¼Œåˆ™é™¤äº†å…¥å‚ç‚¹å’Œå‡ºå‚ç‚¹å¤–å…¶ä»–çš„æ¡©éƒ½ä¸æ’ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¿«é€Ÿçœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„è°ƒè¯•æ•°æ®ï¼Œè¿™ç§è®¾è®¡çš„æœ¬è´¨æ˜¯ä¸ºäº†è®©è°ƒè¯•è€…æ›´åŠ ä¸“æ³¨ã€‚ä¸‹é¢æ˜¯Java-debug-toolçš„å­—èŠ‚ç å¢å¼ºå·¥ä½œæ–¹å¼ï¼š</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827214841150.png" alt="image-20220827214841150" tabindex="0" loading="lazy"><figcaption>image-20220827214841150</figcaption></figure><p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“è°ƒè¯•è€…å‘å‡ºè°ƒè¯•å‘½ä»¤ä¹‹åï¼ŒJava-debug-toolä¼šè¯†åˆ«å‘½ä»¤å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œå¦‚æœå‘½ä»¤éœ€è¦å¢å¼ºå­—èŠ‚ç ï¼Œåˆ™åˆ¤æ–­å½“å‰ç±»+å½“å‰æ–¹æ³•æ˜¯å¦å·²ç»è¢«å¢å¼ºè¿‡ã€‚ä¸Šæ–‡å·²ç»æåˆ°ï¼Œå­—èŠ‚ç æ›¿æ¢æ˜¯æœ‰ä¸€å®šæŸè€—çš„ï¼Œè¿™ç§å…·æœ‰æŸè€—çš„æ“ä½œå‘ç”Ÿçš„æ¬¡æ•°è¶Šå°‘è¶Šå¥½ï¼Œæ‰€ä»¥å­—èŠ‚ç æ›¿æ¢æ“ä½œä¼šè¢«è®°å½•èµ·æ¥ï¼Œåç»­å‘½ä»¤ç›´æ¥ä½¿ç”¨å³å¯ï¼Œä¸éœ€è¦é‡å¤è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œå­—èŠ‚ç å¢å¼ºè¿˜æ¶‰åŠå¤šä¸ªè°ƒè¯•å®¢æˆ·ç«¯çš„ååŒå·¥ä½œé—®é¢˜ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯å¢å¼ºäº†ä¸€ä¸ªç±»çš„å­—èŠ‚ç ä¹‹åï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å°±é”å®šäº†è¯¥å­—èŠ‚ç ï¼Œå…¶ä»–å®¢æˆ·ç«¯å˜æˆåªè¯»ï¼Œæ— æ³•å¯¹è¯¥ç±»è¿›è¡Œå­—èŠ‚ç å¢å¼ºï¼Œåªæœ‰å½“æŒæœ‰é”çš„å®¢æˆ·ç«¯ä¸»åŠ¨é‡Šæ”¾é”æˆ–è€…æ–­å¼€è¿æ¥ä¹‹åï¼Œå…¶ä»–å®¢æˆ·ç«¯æ‰èƒ½ç»§ç»­å¢å¼ºè¯¥ç±»çš„å­—èŠ‚ç ã€‚</p><p>å­—èŠ‚ç å¢å¼ºæ¨¡å—æ”¶åˆ°å­—èŠ‚ç å¢å¼ºè¯·æ±‚ä¹‹åï¼Œä¼šåˆ¤æ–­æ¯ä¸ªå¢å¼ºç‚¹æ˜¯å¦éœ€è¦æ’æ¡©ï¼Œè¿™ä¸ªåˆ¤æ–­çš„æ ¹æ®å°±æ˜¯ä¸Šæ–‡æåˆ°çš„æ’æ¡©é…ç½®ï¼Œä¹‹åå­—èŠ‚ç å¢å¼ºæ¨¡å—ä¼šç”Ÿæˆæ–°çš„å­—èŠ‚ç ï¼ŒJava-debug-toolå°†æ‰§è¡Œå­—èŠ‚ç æ›¿æ¢æ“ä½œï¼Œä¹‹åå°±å¯ä»¥è¿›è¡Œè°ƒè¯•æ•°æ®æ”¶é›†äº†ã€‚</p><p>ç»è¿‡å­—èŠ‚ç å¢å¼ºä¹‹åï¼ŒåŸæ¥çš„æ–¹æ³•ä¸­ä¼šæ’å…¥æ”¶é›†è¿è¡Œæ—¶æ•°æ®çš„ä»£ç ï¼Œè¿™äº›ä»£ç åœ¨æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™æ‰§è¡Œï¼Œè·å–åˆ°è¯¸å¦‚æ–¹æ³•å…¥å‚ã€å±€éƒ¨å˜é‡ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å°†ä¼ é€’ç»™æ•°æ®æ”¶é›†è£…ç½®è¿›è¡Œå¤„ç†ã€‚æ•°æ®æ”¶é›†çš„å·¥ä½œé€šè¿‡Adviceå®Œæˆï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åŒä¸€æ—¶é—´åªèƒ½æ³¨å†Œä¸€ä¸ªAdviceåˆ°Java-debug-toolè°ƒè¯•æ¨¡å—ä¸Šï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶æ³¨å†Œè‡ªå·±çš„Adviceåˆ°è°ƒè¯•æ¨¡å—ä¸Šã€‚Adviceè´Ÿè´£æ”¶é›†æ•°æ®å¹¶è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°æ®ç¬¦åˆè°ƒè¯•å‘½ä»¤çš„è¦æ±‚ï¼ŒJava-debug-toolå°±ä¼šå¸è½½è¿™ä¸ªAdviceï¼ŒAdviceçš„æ•°æ®å°±ä¼šè¢«è½¬ç§»åˆ°Java-debug-toolçš„å‘½ä»¤ç»“æœå¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†ç»“æœå‘é€åˆ°å®¢æˆ·ç«¯ã€‚</p><h4 id="_7-2-2-adviceçš„å·¥ä½œæ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_7-2-2-adviceçš„å·¥ä½œæ–¹å¼" aria-hidden="true">#</a> 7.2.2 Adviceçš„å·¥ä½œæ–¹å¼</h4><p>Adviceæ˜¯è°ƒè¯•æ•°æ®æ”¶é›†å™¨ï¼Œä¸åŒçš„è°ƒè¯•ç­–ç•¥ä¼šå¯¹åº”ä¸åŒçš„Adviceã€‚Adviceæ˜¯å·¥ä½œåœ¨ç›®æ ‡JVMçš„çº¿ç¨‹å†…éƒ¨çš„ï¼Œå®ƒéœ€è¦è½»é‡çº§å’Œé«˜æ•ˆï¼Œæ„å‘³ç€Adviceä¸èƒ½åšå¤ªè¿‡äºå¤æ‚çš„äº‹æƒ…ï¼Œå®ƒçš„æ ¸å¿ƒæ¥å£â€œmatchâ€ç”¨æ¥åˆ¤æ–­æœ¬æ¬¡æ”¶é›†åˆ°çš„è°ƒè¯•æ•°æ®æ˜¯å¦æ»¡è¶³è°ƒè¯•éœ€æ±‚ã€‚å¦‚æœæ»¡è¶³ï¼Œé‚£ä¹ˆJava-debug-toolå°±ä¼šå°†å…¶å¸è½½ï¼Œå¦åˆ™ä¼šç»§ç»­è®©ä»–æ”¶é›†è°ƒè¯•æ•°æ®ï¼Œè¿™ç§â€œåŠ è½½Adviceâ€ -&gt; â€œå¸è½½Adviceâ€çš„å·¥ä½œæ¨¡å¼å…·å¤‡å¾ˆå¥½çš„çµæ´»æ€§ã€‚</p><p>å…³äºAdviceï¼Œéœ€è¦è¯´æ˜çš„å¦å¤–ä¸€ç‚¹å°±æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºå®ƒåŠ è½½ä¹‹åä¼šè¿è¡Œåœ¨ç›®æ ‡JVMçš„çº¿ç¨‹ä¸­ï¼Œç›®æ ‡JVMçš„æ–¹æ³•ææœ‰å¯èƒ½æ˜¯å¤šçº¿ç¨‹è®¿é—®çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´ï¼ŒAdviceéœ€è¦æœ‰èƒ½åŠ›å¤„ç†å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ–¹æ³•çš„èƒ½åŠ›ï¼Œå¦‚æœAdviceå¤„ç†ä¸å½“ï¼Œåˆ™å¯èƒ½ä¼šæ”¶é›†åˆ°æ‚ä¹±æ— ç« çš„è°ƒè¯•æ•°æ®ã€‚ä¸‹é¢çš„å›¾ç‰‡å±•ç¤ºäº†Adviceå’ŒJava-debug-toolè°ƒè¯•åˆ†ææ¨¡å—ã€ç›®æ ‡æ–¹æ³•æ‰§è¡Œä»¥åŠè°ƒè¯•å®¢æˆ·ç«¯ç­‰æ¨¡å—çš„å…³ç³»ã€‚</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827215219210.png" alt="image-20220827215219210" tabindex="0" loading="lazy"><figcaption>image-20220827215219210</figcaption></figure><p>Adviceçš„é¦–æ¬¡æŒ‚è½½ç”±Java-debug-toolçš„å‘½ä»¤å¤„ç†å™¨å®Œæˆï¼Œå½“ä¸€æ¬¡è°ƒè¯•æ•°æ®æ”¶é›†å®Œæˆä¹‹åï¼Œè°ƒè¯•æ•°æ®å¤„ç†æ¨¡å—ä¼šè‡ªåŠ¨å¸è½½Adviceï¼Œç„¶åè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè°ƒè¯•æ•°æ®ç¬¦åˆAdviceçš„ç­–ç•¥ï¼Œåˆ™ç›´æ¥å°†æ•°æ®äº¤ç”±æ•°æ®å¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™ä¼šæ¸…ç©ºè°ƒè¯•æ•°æ®ï¼Œå¹¶å†æ¬¡å°†AdviceæŒ‚è½½åˆ°ç›®æ ‡æ–¹æ³•ä¸Šå»ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒè¯•æ•°æ®ã€‚éé¦–æ¬¡æŒ‚è½½ç”±è°ƒè¯•æ•°æ®å¤„ç†æ¨¡å—è¿›è¡Œï¼Œå®ƒå€ŸåŠ©AdviceæŒ‰éœ€å–æ•°æ®ï¼Œå¦‚æœä¸ç¬¦åˆéœ€æ±‚ï¼Œåˆ™ç»§ç»­æŒ‚è½½Adviceæ¥è·å–æ•°æ®ï¼Œå¦åˆ™å¯¹è°ƒè¯•æ•°æ®è¿›è¡Œå¤„ç†å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h3 id="_7-3-java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°" tabindex="-1"><a class="header-anchor" href="#_7-3-java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°" aria-hidden="true">#</a> 7.3 Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°</h3><h4 id="_7-3-1-å‘½ä»¤æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#_7-3-1-å‘½ä»¤æ‰§è¡Œ" aria-hidden="true">#</a> 7.3.1 å‘½ä»¤æ‰§è¡Œ</h4><p>ä¸Šæ–‡å·²ç»å®Œæ•´çš„æè¿°äº†Java-debug-toolçš„è®¾è®¡ä»¥åŠæ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆï¼Œæœ¬å°èŠ‚å°†è¯¦ç»†ä»‹ç»Java-debug-toolçš„å‘½ä»¤è®¾è®¡ä¸å®ç°ã€‚é¦–å…ˆéœ€è¦å°†ä¸€ä¸ªè°ƒè¯•å‘½ä»¤çš„æ‰§è¡Œæµç¨‹æè¿°æ¸…æ¥šï¼Œä¸‹é¢æ˜¯ä¸€å¼ ç”¨æ¥è¡¨ç¤ºå‘½ä»¤è¯·æ±‚å¤„ç†æµç¨‹çš„å›¾ç‰‡ï¼š</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827215332611.png" alt="image-20220827215332611" tabindex="0" loading="lazy"><figcaption>image-20220827215332611</figcaption></figure><p>ä¸Šå›¾ç®€å•çš„æè¿°äº†Java-debug-toolçš„å‘½ä»¤å¤„ç†æ–¹å¼ï¼Œå®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯ä¹‹åï¼Œä¼šè¿›è¡Œä¸€äº›åè®®è§£æã€åè®®è®¤è¯ã€åè®®å¡«å……ç­‰å·¥ä½œï¼Œä¹‹åå°†è¿›è¡Œå‘½ä»¤åˆ†å‘ã€‚æœåŠ¡ç«¯å¦‚æœå‘ç°å®¢æˆ·ç«¯çš„å‘½ä»¤ä¸åˆæ³•ï¼Œåˆ™ä¼šç«‹å³è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦åˆ™å†è¿›è¡Œå‘½ä»¤å¤„ç†ã€‚å‘½ä»¤å¤„ç†å±äºå…¸å‹çš„ä¸‰æ®µå¼å¤„ç†ï¼Œå‰ç½®å‘½ä»¤å¤„ç†ã€å‘½ä»¤å¤„ç†ä»¥åŠåç½®å‘½ä»¤å¤„ç†ï¼ŒåŒæ—¶ä¼šå¯¹å‘½ä»¤å¤„ç†è¿‡ç¨‹ä¸­çš„å¼‚å¸¸ä¿¡æ¯è¿›è¡Œæ•è·å¤„ç†ï¼Œä¸‰æ®µå¼å¤„ç†çš„å¥½å¤„æ˜¯å‘½ä»¤å¤„ç†è¢«æ‹†æˆäº†å¤šä¸ªé˜¶æ®µï¼Œå¤šä¸ªé˜¶æ®µè´Ÿè´£ä¸åŒçš„èŒè´£ã€‚å‰ç½®å‘½ä»¤å¤„ç†ç”¨æ¥åšä¸€äº›å‘½ä»¤æƒé™æ§åˆ¶çš„å·¥ä½œï¼Œå¹¶å¡«å……ä¸€äº›ç±»ä¼¼å‘½ä»¤å¤„ç†å¼€å§‹æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå‘½ä»¤å¤„ç†å°±æ˜¯é€šè¿‡å­—èŠ‚ç å¢å¼ºï¼ŒæŒ‚è½½Adviceè¿›è¡Œæ•°æ®æ”¶é›†ï¼Œå†ç»è¿‡æ•°æ®å¤„ç†æ¥äº§ç”Ÿå‘½ä»¤ç»“æœçš„è¿‡ç¨‹ï¼Œåç½®å¤„ç†åˆ™ç”¨æ¥å¤„ç†ä¸€äº›è¿æ¥å…³é—­ã€å­—èŠ‚ç è§£é”ç­‰äº‹é¡¹ã€‚</p><p>Java-debug-toolå…è®¸å®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´åˆ™è®¤ä¸ºå‘½ä»¤æ²¡æœ‰ç»“æœï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è®¾ç½®è‡ªå·±çš„è¶…æ—¶æ—¶é—´ï¼Œå°±ä½¿ç”¨é»˜è®¤çš„è¶…æ—¶æ—¶é—´è¿›è¡Œè¶…æ—¶æ§åˆ¶ã€‚Java-debug-toolé€šè¿‡è®¾è®¡äº†ä¸¤é˜¶æ®µçš„è¶…æ—¶æ£€æµ‹æœºåˆ¶æ¥å®ç°å‘½ä»¤æ‰§è¡Œè¶…æ—¶åŠŸèƒ½ï¼šé¦–å…ˆï¼Œç¬¬ä¸€é˜¶æ®µè¶…æ—¶è§¦å‘ï¼Œåˆ™Java-debug-toolä¼šå‹å¥½çš„è­¦å‘Šå‘½ä»¤å¤„ç†æ¨¡å—å¤„ç†æ—¶é—´å·²ç»è¶…æ—¶ï¼Œéœ€è¦ç«‹å³åœæ­¢å‘½ä»¤æ‰§è¡Œï¼Œè¿™å…è®¸å‘½ä»¤è‡ªå·±åšä¸€äº›ç°åœºæ¸…ç†å·¥ä½œï¼Œå½“ç„¶éœ€è¦å‘½ä»¤æ‰§è¡Œçº¿ç¨‹è‡ªå·±æ„ŸçŸ¥åˆ°è¿™ç§è¶…æ—¶è­¦å‘Šï¼›å½“ç¬¬äºŒé˜¶æ®µè¶…æ—¶è§¦å‘ï¼Œåˆ™Java-debug-toolè®¤ä¸ºå‘½ä»¤å¿…é¡»ç»“æŸæ‰§è¡Œï¼Œä¼šå¼ºè¡Œæ‰“æ–­å‘½ä»¤æ‰§è¡Œçº¿ç¨‹ã€‚è¶…æ—¶æœºåˆ¶çš„ç›®çš„æ˜¯ä¸ºäº†ä¸è®©å‘½ä»¤æ‰§è¡Œå¤ªé•¿æ—¶é—´ï¼Œå‘½ä»¤å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ”¶é›†åˆ°è°ƒè¯•æ•°æ®ï¼Œåˆ™åº”è¯¥åœæ­¢æ‰§è¡Œï¼Œå¹¶æ€è€ƒæ˜¯å¦è°ƒè¯•äº†ä¸€ä¸ªé”™è¯¯çš„æ–¹æ³•ã€‚å½“ç„¶ï¼Œè¶…æ—¶æœºåˆ¶è¿˜å¯ä»¥å®šæœŸæ¸…ç†é‚£äº›å› ä¸ºæœªçŸ¥åŸå› æ–­å¼€è¿æ¥çš„å®¢æˆ·ç«¯æŒæœ‰çš„è°ƒè¯•èµ„æºï¼Œæ¯”å¦‚å­—èŠ‚ç é”ã€‚</p><h4 id="_7-3-2-è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾" tabindex="-1"><a class="header-anchor" href="#_7-3-2-è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾" aria-hidden="true">#</a> 7.3.2 è·å–æ–¹æ³•æ‰§è¡Œè§†å›¾</h4><p>Java-debug-toolé€šè¿‡ä¸‹é¢çš„ä¿¡æ¯æ¥å‘è°ƒè¯•è€…å‘ˆç°å‡ºä¸€æ¬¡æ–¹æ³•æ‰§è¡Œçš„è§†å›¾ï¼š</p><ul><li>æ­£åœ¨è°ƒè¯•çš„æ–¹æ³•ä¿¡æ¯ã€‚</li><li>æ–¹æ³•è°ƒç”¨å †æ ˆã€‚</li><li>è°ƒè¯•è€—æ—¶ï¼ŒåŒ…æ‹¬å¯¹ç›®æ ‡JVMé€ æˆçš„STWæ—¶é—´ã€‚</li><li>æ–¹æ³•å…¥å‚ï¼ŒåŒ…æ‹¬å…¥å‚çš„ç±»å‹åŠå‚æ•°å€¼ã€‚</li><li>æ–¹æ³•çš„æ‰§è¡Œè·¯å¾„ã€‚</li><li>ä»£ç æ‰§è¡Œè€—æ—¶ã€‚</li><li>å±€éƒ¨å˜é‡ä¿¡æ¯ã€‚</li><li>æ–¹æ³•è¿”å›ç»“æœã€‚</li><li>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ã€‚</li><li>å¯¹è±¡å­—æ®µå€¼å¿«ç…§ã€‚</li></ul><p>ä¸‹å›¾å±•ç¤ºäº†Java-debug-toolè·å–åˆ°æ­£åœ¨è¿è¡Œçš„æ–¹æ³•çš„æ‰§è¡Œè§†å›¾çš„ä¿¡æ¯</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827215451243.png" alt="image-20220827215451243" tabindex="0" loading="lazy"><figcaption>image-20220827215451243</figcaption></figure><h3 id="_7-4-java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_7-4-java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ" aria-hidden="true">#</a> 7.4 Java-debug-toolä¸åŒç±»äº§å“å¯¹æ¯”åˆ†æ</h3><p>Java-debug-toolçš„åŒç±»äº§å“ä¸»è¦æ˜¯greysï¼Œå…¶ä»–ç±»ä¼¼çš„å·¥å…·å¤§éƒ¨åˆ†éƒ½æ˜¯åŸºäºgreysè¿›è¡Œçš„äºŒæ¬¡å¼€å‘ï¼Œæ‰€ä»¥ç›´æ¥é€‰æ‹©greysæ¥å’ŒJava-debug-toolè¿›è¡Œå¯¹æ¯”ã€‚</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220827215923102.png" alt="image-20220827215923102" tabindex="0" loading="lazy"><figcaption>image-20220827215923102</figcaption></figure><p>æœ¬æ–‡è¯¦ç»†å‰–æäº†JavaåŠ¨æ€è°ƒè¯•å…³é”®æŠ€æœ¯çš„å®ç°ç»†èŠ‚ï¼Œå¹¶ä»‹ç»äº†æˆ‘ä»¬åŸºäºJavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯ç»“åˆå®é™…æ•…éšœæ’æŸ¥åœºæ™¯è¿›è¡Œçš„ä¸€ç‚¹æ¢ç´¢å®è·µï¼›åŠ¨æ€è°ƒè¯•æŠ€æœ¯ä¸ºç ”å‘äººå‘˜è¿›è¡Œçº¿ä¸Šé—®é¢˜æ’æŸ¥æä¾›äº†ä¸€ç§æ–°çš„æ€è·¯ï¼Œæˆ‘ä»¬åŸºäºåŠ¨æ€è°ƒè¯•æŠ€æœ¯è§£å†³äº†ä¼ ç»Ÿæ–­ç‚¹è°ƒè¯•å­˜åœ¨çš„é—®é¢˜ï¼Œä½¿å¾—å¯ä»¥å°†æ–­ç‚¹è°ƒè¯•è¿™ç§æŠ€æœ¯åº”ç”¨åœ¨çº¿ä¸Šï¼Œä»¥çº¿ä¸‹è°ƒè¯•çš„æ€ç»´æ¥è¿›è¡Œçº¿ä¸Šè°ƒè¯•ï¼Œæé«˜é—®é¢˜æ’æŸ¥æ•ˆç‡ã€‚</p><h2 id="å‚è€ƒæ–‡ç« " tabindex="-1"><a class="header-anchor" href="#å‚è€ƒæ–‡ç« " aria-hidden="true">#</a> å‚è€ƒæ–‡ç« </h2><p><a href="https://pdai.tech/md/java/jvm/java-jvm-agent-usage.html" target="_blank" rel="noopener noreferrer"><strong>è°ƒè¯•æ’é”™ - JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zszdevelop/java-study-gitbook/edit/main/docs/java/jvm/java-jvm-agent-usage.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: zszdevelop@163.com">zszdevelop</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/java-study-gitbook/java/jvm/java-jvm-debug-idea.html" class="nav-link prev" aria-label="è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->è°ƒè¯•æ’é”™ - Java é—®é¢˜æ’æŸ¥ä¹‹ä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•å’Œè¿œç¨‹è°ƒè¯•</div></a><a href="/java-study-gitbook/java/jvm/java-jvm-gc-help.html" class="nav-link next" aria-label="GCä¸­å¯¹è±¡è‡ªæ•‘"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">GCä¸­å¯¹è±¡è‡ªæ•‘<!----></div></a></nav><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href='https://beian.miit.gov.cn' target='_blank' style='color: var(--c-text-lighter);>é—½ICPå¤‡18001806å·-1</a></div><div class="copyright">Copyright Â© 2023 zszdevelop</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/java-study-gitbook/assets/app-d7a104d1.js" defer></script>
  </body>
</html>
